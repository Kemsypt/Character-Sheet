<!doctype html>
<html lang="en" data-theme="midnight">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>D2&D 5e Character Sheet â€” Template</title>

  <style>
    :root{
      --page-max: 1200px;

      --bg0:#070A14;
      --bg1:#0B1020;

      --surface: rgba(255,255,255,0.06);
      --surface2: rgba(255,255,255,0.10);
      --line: rgba(255,255,255,0.14);

      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --faint: rgba(255,255,255,0.56);

      --green:#7CF59C;
      --blue:#5DB2FF;
      --red:#FB7185;

      --accent:#d8c08a;
      --shadow: 0 18px 60px rgba(0,0,0,0.55);

      --radius: 18px;
      --radius-sm: 14px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    html[data-theme="parchment"]{
      --bg0:#FBF6E9;
      --bg1:#F4E9D1;
      --surface: rgba(25,18,8,0.06);
      --surface2: rgba(25,18,8,0.10);
      --line: rgba(25,18,8,0.12);
      --text: rgba(25,18,8,0.92);
      --muted: rgba(25,18,8,0.72);
      --faint: rgba(25,18,8,0.56);
      --accent:#7C3AED;
      --shadow: 0 14px 45px rgba(25,18,8,0.18);
    }

    html[data-theme="forest"]{
      --bg0:#07120D;
      --bg1:#0A1A12;
      --surface: rgba(236,253,245,0.06);
      --surface2: rgba(236,253,245,0.10);
      --line: rgba(236,253,245,0.13);
      --text: rgba(236,253,245,0.93);
      --muted: rgba(236,253,245,0.72);
      --faint: rgba(236,253,245,0.56);
      --accent:#34D399;
      --shadow: 0 16px 55px rgba(0,0,0,0.45);
    }

    body[data-wide="on"]{ --page-max: 100%; }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(900px 520px at 20% 10%, rgba(255,255,255,0.06), transparent 55%),
        radial-gradient(700px 520px at 80% 0%, rgba(125,211,252,0.06), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    /* =======================
      TOP BAR
    ======================= */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(18px);
      background: linear-gradient(180deg, rgba(8,10,16,0.92), rgba(8,10,16,0.70));
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }
    .topbar-inner{
      max-width: var(--page-max);
      margin: 0 auto;
      padding: 14px 16px 10px;

      display: grid;
      grid-template-columns: minmax(240px, 320px) 1fr;
      gap: 14px;
      align-items: start;
    }

    .id-block{
      min-width: 0;
      padding: 6px 2px;
      display: grid;
      grid-template-columns: 100px 1fr;
      align-items: center;
      gap: 20px;
    }
    .id-text{
      min-width: 0;
      display:flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }
    .id-text{
      min-width: 0;
      display:flex;
      flex-direction: column;
      align-items: flex-start;
      text-align: left;
    }
    .id-name{
      margin:0;
      font-size: 44px;
      letter-spacing: 0.02em;
      font-weight: 900;
      line-height: 0.98;
      max-width: 100%;
      overflow: hidden;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
    }
    .id-name-line{
      display: block;
    }
    .id-sub{
      margin-top: 8px;
      color: var(--muted);
      font-weight: 650;
      font-size: 14px;
      line-height: 1.2;
      max-width: 100%;
      overflow: hidden;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
    }
    .id-portrait{
      width: 100px;
      height: 150px;
      border-radius: 18px;
      object-fit: cover;
      object-position: center;
      transform: scale(var(--pz, 1)) rotate(var(--pr, 0deg));
      transform-origin: center;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      box-shadow: var(--shadow);
    }

    .cap{
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.04));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .head-right{
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: stretch;
    }

    .top-row,
    .bottom-row{
      display: flex;
      gap: 10px;
      align-items: stretch;
      flex-wrap: wrap;
      min-width: 0;
    }

    .stat-cap, .chip-cap{ min-height: 74px; }

    .stat-cap{
      width: 72px;
      padding: 10px 10px;
      display:flex;
      flex-direction: column;
      gap: 6px;
      justify-content: center;
      align-items: center;
      flex: 0 0 auto;
    }
    .stat-k{
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--faint);
      font-weight: 900;
    }
    .stat-v{
      font-size: 18px;
      font-weight: 900;
      color: var(--text);
    }

    .chip-cap{
      padding: 10px 12px;
      display:flex;
      flex-direction: column;
      justify-content:center;
      align-items: stretch;
      min-width: 0;
      position: relative;
    }
    .chip-k{
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--faint);
      font-weight: 900;
      white-space: nowrap;
    }
    .chip-row{
      display:flex;
      gap: 8px;
      align-items:center;
      margin-top: 6px;
    }
    .chip-icon{
      width: 18px;
      height: 18px;
      display: inline-block;
    }

    .chip-money{ width: 120px; }
    .chip-status{ width: 120px; }
    .chip-rest{ width: 190px; }

    .pill-btn{
      width: 100%;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 999px;
      font-weight: 900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
      justify-content: space-between;
    }
    .pill-btn:hover{
      background: rgba(0,0,0,0.28);
      border-color: rgba(255,255,255,0.22);
    }
    .pill-btn .mono{font-family: var(--mono);}
    .pill-btn[aria-pressed="true"]{
      border-color: rgba(216,192,138,0.45);
      background: linear-gradient(180deg, rgba(216,192,138,0.30), rgba(216,192,138,0.14));
    }
    .pill-btn.compact{
      justify-content: center;
      padding: 9px 10px;
      gap: 8px;
    }
    .chip-money .pill-btn::after,
    .chip-status .pill-btn::after{
      content: none !important;
    }

    /* Rest split buttons */
    .split{
      display:flex;
      gap: 8px;
      margin-top: 6px;
    }
    .split .pill-btn{
      padding: 9px 10px;
      justify-content: center;
      gap: 8px;
    }
    .split .pill-btn.short{ border-color: rgba(93,178,255,0.30); }
    .split .pill-btn.long{ border-color: rgba(124,245,156,0.30); }

    /* Tooltip (Status hover) */
    .tooltip{
      position: absolute;
      left: 12px;
      top: calc(100% + 10px);
      z-index: 90;
      width: max-content;
      max-width: 360px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(10,12,18,0.94);
      box-shadow: var(--shadow);
      color: var(--text);
      opacity: 0;
      transform: translateY(-4px);
      pointer-events: none;
      transition: opacity 120ms ease, transform 120ms ease;
      font-size: 12px;
      line-height: 1.45;
    }
    .tooltip .t-title{
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 950;
      margin-bottom: 6px;
    }
    .chip-status:hover .tooltip,
    .chip-status:focus-within .tooltip{
      opacity: 1;
      transform: translateY(0);
    }

    /* HP capsule */
    .hp-cap{
      flex: 1 1 520px;
      min-width: min(520px, 100%);
      padding: 10px 12px;
      min-height: 60px;

      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 12px;
    }
    .hp-left{
      display:flex;
      align-items: baseline;
      gap: 10px;
      min-width: 140px;
    }
    .hp-text{
      font-weight: 950;
      font-size: 16px;
    }
    .hp-text .num{font-family: var(--mono);}
    .hp-mod{
      color: var(--blue);
      font-weight: 900;
    }

    /* Temp HP scales to fit inside bar (no overflow) */
    .hp-bar{
      position: relative;
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.10);
      min-width: 140px;
      overflow: hidden;
    }
    .hp-green{
      position:absolute;
      left:0; top:0; bottom:0;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(124,245,156,0.95), rgba(124,245,156,0.70));
      z-index: 1;
    }
    .hp-green.is-warning{
      background: linear-gradient(180deg, rgba(251,191,36,0.95), rgba(251,191,36,0.70));
    }
    .hp-green.is-danger{
      background: linear-gradient(180deg, rgba(248,113,113,0.98), rgba(248,113,113,0.75));
    }
    .hp-temp{
      position:absolute;
      top:0; bottom:0;
      left: 0%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(93,178,255,0.95), rgba(93,178,255,0.70));
      box-shadow: 0 0 14px rgba(93,178,255,0.15);
      z-index: 2;
    }

    .hp-controls{
      display:flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
    }
    .hp-stepper{
      display:flex;
      align-items:center;
      gap: 4px;
    }
    .hp-stepper-buttons{
      display:flex;
      flex-direction: column;
      gap: 2px;
    }
    .hp-stepper-btn{
      width: 18px;
      height: 16px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      font-size: 10px;
      line-height: 1;
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0;
    }
    .hp-stepper-btn:hover{
      border-color: rgba(255,255,255,0.22);
      background: rgba(0,0,0,0.28);
    }
    .amt{
      width: 56px;
      text-align:center;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.20);
      color: var(--text);
      outline: none;
      font-weight: 900;
      font-family: var(--mono);
    }
    .hp-amt{
      -moz-appearance: textfield;
    }
    .hp-amt::-webkit-outer-spin-button,
    .hp-amt::-webkit-inner-spin-button{
      -webkit-appearance: none;
      margin: 0;
    }
    .hp-btn{
      height: 36px;
      min-width: 36px;
      padding: 0 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      cursor:pointer;
      font-weight: 950;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .hp-btn:hover{
      border-color: rgba(255,255,255,0.22);
      background: rgba(0,0,0,0.28);
    }
    .hp-btn.temp{ border-color: rgba(93,178,255,0.35); }
    .hp-btn.damage{ border-color: rgba(251,113,133,0.35); }
    .hp-btn.heal{ border-color: rgba(124,245,156,0.35); }

    /* Tabs */
    .tabs{
      max-width: var(--page-max);
      margin: 0 auto;
      padding: 0 16px 14px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }
    .tab{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: rgba(255,255,255,0.78);
      padding: 9px 14px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 13px;
      cursor:pointer;
    }
    .tab:hover{background: rgba(0,0,0,0.28);}
    .tab[aria-selected="true"]{
      background: linear-gradient(180deg, rgba(216,192,138,0.30), rgba(216,192,138,0.16));
      border-color: rgba(216,192,138,0.40);
      color: rgba(255,255,255,0.92);
    }
    .tab-spacer{
      flex: 1 1 auto;
    }

    /* Actions sub-tabs */
    .subtabs{
      margin-top: 10px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }
    .subtab{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.16);
      color: rgba(255,255,255,0.78);
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
    }
    .subtab:hover{background: rgba(0,0,0,0.26);}
    .subtab[aria-selected="true"]{
      background: rgba(216,192,138,0.16);
      border-color: rgba(216,192,138,0.36);
      color: rgba(255,255,255,0.92);
    }

    /* Responsive */
    @media (max-width: 980px){
      .topbar-inner{ grid-template-columns: 1fr; }
      .chip-money, .chip-status, .chip-rest{ width: auto; flex: 1 1 170px; }
      .hp-cap{ grid-template-columns: 1fr; }
      .hp-left{ min-width: 0; }
      .tooltip{ max-width: calc(100vw - 40px); }
      .inventory-grid{ grid-template-columns: 1fr; }
    }

    /* =======================
      CONTENT AREA
    ======================= */
    .wrap{
      max-width: var(--page-max);
      margin: 0 auto;
      padding: 18px 16px 72px;
      position: relative;
      z-index: 2;
    }
    .panel{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-header{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 12px;
      background: rgba(255,255,255,0.06);
    }
    .panel-title-row{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .panel-title{
      margin:0;
      font-size: 12px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 950;
    }
    .panel-body{padding: 14px 16px;}

    table{width:100%; border-collapse: collapse; font-size: 13px;}
    th,td{padding: 10px 10px; border-bottom: 1px solid rgba(255,255,255,0.10); vertical-align: top;}
    th{color: var(--faint); font-weight: 950; text-transform: uppercase; letter-spacing: 0.12em; font-size: 11px;}
    .right{text-align:right}
    .muted{color: var(--muted)}
    .num{font-family: var(--mono);}

    .tag{
      font-size: 11px;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      padding: 4px 8px;
      border-radius: 999px;
      white-space:nowrap;
      font-weight: 850;
    }
    .spell-import-controls{
      display: grid;
      gap: 12px;
    }
    .spell-import-toolbar{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
    }
    .spell-import-toolbar input,
    .spell-import-toolbar select{
      flex: 1 1 180px;
    }
    .spell-import-filters{
      display:grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }
    .spell-filter-group{
      display:grid;
      gap: 8px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.04);
    }
    .spell-filter-list{
      display:flex;
      flex-wrap:wrap;
      gap: 6px;
    }
    .spell-filter-item{
      display:flex;
      align-items:center;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }
    .spell-import-list{
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 8px;
      max-height: 360px;
      overflow: auto;
      display:flex;
      flex-direction: column;
      gap: 8px;
      background: rgba(255,255,255,0.03);
    }
    .spell-import-row{
      display:grid;
      grid-template-columns: auto 1fr;
      gap: 10px;
      padding: 8px;
      border-radius: 10px;
      background: rgba(255,255,255,0.04);
    }
    .spell-import-name{
      font-weight: 800;
    }
    .spell-import-meta{
      color: var(--muted);
      font-size: 12px;
      display:flex;
      flex-wrap:wrap;
      gap: 6px;
    }

    .spell-import-layout{
      display:grid;
      grid-template-columns: minmax(0, 1fr) 360px;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .spell-import-layout{ grid-template-columns: 1fr; }
    }

    .spell-filter-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .spell-filter-actions{
      display:flex;
      gap: 6px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .spell-filter-chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.04);
      cursor:pointer;
      font: inherit;
      line-height: 1.1;
      user-select:none;
    }
    .spell-filter-chip[aria-pressed="true"]{
      border-color: rgba(216,192,138,0.55);
      background: rgba(216,192,138,0.16);
    }

    .spell-import-check{
      accent-color: var(--accent);
      transform: scale(1.45);
      transform-origin: top left;
      margin-top: 2px;
      cursor:pointer;
    }

    .spell-import-row{
      grid-template-columns: auto 1fr auto;
      align-items:start;
    }

    .spell-import-info{
      padding: 6px 10px;
      border-radius: 10px;
      white-space: nowrap;
      align-self:start;
    }

    .spell-import-selected{
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 10px;
      background: rgba(0,0,0,0.10);
      max-height: min(70vh, 720px);
      overflow:auto;
    }
    .spell-selected-summary{
      display:flex;
      flex-direction:column;
      gap: 8px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      margin-bottom: 10px;
    }
    .spell-selected-breakdown{
      display:flex;
      gap: 6px;
      flex-wrap:wrap;
    }
    .spell-selected-list{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .spell-selected-row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items:center;
      padding: 8px;
      border-radius: 12px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .spell-selected-name{
      font-weight: 800;
      line-height: 1.1;
    }
    .spell-selected-remove{
      width: 30px;
      height: 30px;
      border-radius: 10px;
    }

    #spellImportDialog{
      width: min(1040px, calc(100vw - 28px));
    }

    .spellbook-card{
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 12px;
      background: rgba(255,255,255,0.04);
      box-shadow: none;
      position: relative;
    }
    .spellbook-add-btn{
      padding: 10px 14px;
      font-size: 12px;
      border-radius: 14px;
      min-width: 160px;
      text-align: center;
    }
    #sp_list{
      display: grid;
      gap: 15px;
    }
    .spellbook-card[data-has-style="true"]{
      border-color: var(--sb-hi);
      background: linear-gradient(180deg, color-mix(in srgb, var(--sb-mid) 30%, transparent), rgba(255,255,255,0.03));
    }
    .spellbook-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .spellbook-head-actions{
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .spellbook-delete{
      border-color: rgba(248,113,113,0.45);
      color: #fecaca;
    }
    .spellbook-name-btn{
      background: transparent;
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 12px;
      padding: 6px 10px;
      color: var(--text);
      font-weight: 950;
      letter-spacing: 0.01em;
      cursor: default;
    }
    body[data-edit="on"] .spellbook-name-btn{
      cursor: pointer;
    }
    .spellbook-card[data-has-style="true"] .spellbook-name-btn{
      border-color: color-mix(in srgb, var(--sb-hi) 55%, rgba(255,255,255,0.10));
      color: var(--sb-text);
    }
    .spellbook-metrics{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 8px;
    }
    .spellbook-metric{
      padding: 6px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.2);
      font-weight: 950;
      font-size: 12px;
      display:flex;
      align-items:center;
      gap: 6px;
    }
    .spellbook-metric strong{
      font-size: 14px;
      letter-spacing: 0.02em;
    }

    .spell-remove-btn{
      width: 30px;
      height: 30px;
      border-radius: 10px;
    }
    .spell-name-row{
      display:flex;
      align-items:center;
      gap: 6px;
    }
    .spell-remove{
      width: 28px;
      height: 28px;
      border-radius: 9px;
      font-size: 12px;
    }
    .dice-inline{
      border: none;
      background: transparent;
      padding: 0;
      font-weight: 900;
      text-decoration: underline;
      color: var(--text);
      cursor: pointer;
    }

    .spell-summary{
      min-height: 18px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.16);
    }

    #spellInfoBody .spell-info-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 780px){
      #spellInfoBody .spell-info-grid{ grid-template-columns: 1fr; }
    }
    #spellInfoBody .spell-info-kv{
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
    }
    #spellInfoBody .spell-info-k{
      font-weight: 900;
      margin-bottom: 4px;
    }
    #spellInfoBody .spell-info-desc p{ margin: 0 0 10px 0; }


    [data-tabpanel]{display:none;}
    [data-tabpanel][data-active="true"]{display:block;}
    [data-subpanel]{display:none;}
    [data-subpanel][data-active="true"]{display:block;}

    /* =======================
      MAIN TAB (Bio + portrait right, aligned to hero top)
    ======================= */
    .main-grid{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap: 12px;
      align-items: start;
    }
    @media (max-width: 980px){
      .main-grid{ grid-template-columns: 1fr; }
    }

    .hero{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
      border-radius: 18px;
      padding: 14px 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .hero-name{
      font-size: 34px;
      font-weight: 950;
      margin: 0;
      letter-spacing: 0.01em;
      line-height: 1.05;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .hero-tagline{
      margin: -6px 0 0;
      color: var(--muted);
      font-weight: 800;
      font-size: 13px;
    }
    .chips{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 2px;
    }

    .card{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      border-radius: 16px;
      padding: 12px 12px;
    }
    .card h4{
      margin:0 0 8px;
      font-size: 12px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 950;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }
    .kv{
      display:grid;
      grid-template-columns: 150px 1fr;
      gap: 8px 12px;
      font-size: 13px;
    }
    .kv .k{
      color: var(--faint);
      font-weight: 900;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 11px;
      padding-top: 2px;
    }
    .kv .v{
      color: var(--text);
      font-weight: 750;
      min-width: 0;
    }

    /* Smaller milestone/XP toggle */
    .progress-toggle{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }
    .seg{
      display:flex;
      gap: 6px;
      align-items:center;
      padding: 4px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
    }
    .seg button{
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: 6px 8px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 900;
      font-size: 11px;
      letter-spacing: 0.02em;
    }
    .seg button[aria-pressed="true"]{
      color: var(--text);
      border-color: rgba(216,192,138,0.35);
      background: rgba(216,192,138,0.14);
    }
    .seg button:hover{ color: var(--text); }

    .portrait-frame{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      border-radius: 20px;
      overflow:hidden;
      box-shadow: var(--shadow);
      aspect-ratio: 2 / 3;
      position: relative;
    }
    .portrait-img{
      position: absolute;
      left: 50%;
      top: 50%;
      width: 120%;
      height: auto;
      min-width: 100%;
      min-height: 100%;
      transform: translate(-50%, -50%) translate(var(--px, 0%), var(--py, 0%)) scale(var(--pz, 1)) rotate(var(--pr, 0deg));
      transform-origin: center;
      filter: saturate(1.05) contrast(1.03);
      cursor: pointer;
    }
    .portrait-overlay{
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(60% 45% at 55% 20%, rgba(255,255,255,0.10), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,0.05), rgba(0,0,0,0.35));
      mix-blend-mode: screen;
      opacity: 0.65;
    }
    .portrait-vignette{
      position:absolute;
      inset:0;
      pointer-events:none;
      box-shadow: inset 0 0 80px rgba(0,0,0,0.55);
      opacity: 0.85;
    }
    .portrait-editor-grid{
      display:grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 16px;
      align-items: start;
    }
    @media (max-width: 820px){
      .portrait-editor-grid{ grid-template-columns: 1fr; }
    }
    .portrait-preview{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      border-radius: 16px;
      overflow: hidden;
      aspect-ratio: 2 / 3;
      width: min(280px, 100%);
      position: relative;
      cursor: grab;
      user-select: none;
      touch-action: none;
    }
    .portrait-preview.is-dragging{
      cursor: grabbing;
    }

    /* Main "Quick Combat" row under hero */
    .quickstats{
      display:grid;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap: 10px;
      margin-top: 8px;
    }
    @media (max-width: 980px){
      .quickstats{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    .qs{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.14);
      border-radius: 16px;
      padding: 10px 10px;
      display:flex;
      flex-direction: column;
      gap: 6px;
      align-items:center;
      justify-content:center;
      min-height: 70px;
    }
    .qs .k{
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--faint);
      font-weight: 950;
    }
    .qs .v{
      font-size: 16px;
      font-weight: 950;
      font-family: var(--mono);
    }

    /* XP box (shown when XP mode) */
    .xpbox{
      margin-top: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.14);
      border-radius: 16px;
      padding: 10px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .xpgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 700px){
      .xpgrid{ grid-template-columns: 1fr; }
    }
    .field{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      border-radius: 14px;
      padding: 10px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }
    .field label{
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--faint);
      font-weight: 950;
    }
    .field .val{
      font-family: var(--mono);
      font-weight: 950;
      color: var(--text);
      white-space: nowrap;
    }
    .field input{
      width: 130px;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.20);
      color: var(--text);
      outline: none;
      font-weight: 900;
      font-family: var(--mono);
      text-align:right;
    }

    /* =======================
      ABILITIES PAGE (layout)
    ======================= */
    .abil-wrap{ display:flex; flex-direction: column; gap: 12px; }

    .abil-grid{
      display:grid;
      grid-template-columns: repeat(6, minmax(0,1fr));
      gap: 10px;
    }
    @media (max-width: 1100px){
      .abil-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }
    @media (max-width: 700px){
      .abil-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }

    .abil-card{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      border-radius: 16px;
      padding: 10px;
      display:flex;
      flex-direction: column;
      gap: 8px;
      min-height: 140px;
    }
    .abil-head{
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--accent);
      font-weight: 950;
      margin-top: 2px;
    }
    .abil-box{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      border-radius: 14px;
      padding: 10px 10px;
      display:flex;
      flex-direction: column;
      align-items:center;
      justify-content:center;
      gap: 6px;
    }
    .abil-score{ font-size: 20px; font-weight: 950; font-family: var(--mono); }
    .abil-subk{
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--faint);
      font-weight: 950;
    }
    .abil-subv{ font-size: 13px; font-weight: 950; font-family: var(--mono); }
    .save-pill{
      margin-top: 6px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      padding: 7px 10px;
      border-radius: 999px;
      font-family: var(--mono);
      font-weight: 950;
      font-size: 12px;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      justify-content: center;
    }
    .save-pill.pro{
      border-color: rgba(216,192,138,0.40);
      background: rgba(216,192,138,0.12);
    }

    .skills-head{
      display:flex;
      align-items:flex-end;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .legend{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .dot{
      width: 10px; height: 10px; border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.30);
      display:inline-block;
      transform: translateY(1px);
    }
    .dot.fill{ background: rgba(255,255,255,0.18); border-color: rgba(255,255,255,0.40); }
    .dot.gold{ background: rgba(216,192,138,0.18); border-color: rgba(216,192,138,0.50); }

    .skills-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 980px){
      .skills-grid{ grid-template-columns: 1fr; }
    }
    .skill-col{ display:flex; flex-direction: column; gap: 10px; }
    .skill-row{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
      border-radius: 14px;
      padding: 10px 12px;
      display:grid;
      grid-template-columns: minmax(0, 1fr) 70px 52px;
      align-items:center;
      gap: 12px;
    }
    .skill-row.has-remove{
      grid-template-columns: minmax(0, 1fr) 70px 52px auto;
    }
    .skill-row .dot-btn{
      border: none;
      background: transparent;
      padding: 0;
      cursor: pointer;
    }
    .rollable{
      cursor: pointer;
    }
    .rollable:hover{
      border-color: rgba(255,255,255,0.22);
      background: rgba(0,0,0,0.22);
    }
    body[data-edit="on"] .skill-row .dot-btn:focus-visible{
      outline: 2px solid rgba(216,192,138,0.6);
      outline-offset: 2px;
    }
    .skill-remove{
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 11px;
      cursor: pointer;
    }
    .skill-remove:hover{ background: rgba(216,192,138,0.14); }

    .save-pill.is-editable{
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease;
    }
    body[data-edit="on"] .save-pill.is-editable:hover{
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.35);
    }
    .ability-remove{
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 11px;
      cursor: pointer;
      align-self: flex-end;
    }
    .skill-left{ display:flex; align-items:center; gap: 10px; min-width: 0; }
    .skill-name{
      font-weight: 900;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .skill-mid{
      font-size: 12px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--accent);
      font-weight: 950;
      text-align: center;
    }
    .skill-right{ font-family: var(--mono); font-weight: 950; text-align: right; }
    .skill-row .skill-remove{ justify-self: end; }

    /* =======================
      BUTTONS / DIALOGS
    ======================= */
    dialog{
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(10,12,18,0.92);
      color: var(--text);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 0;
      width: min(720px, calc(100vw - 28px));
      z-index: 120;
    }
    #coinAdjustDialog{
      width: 300px;
    }
    dialog::backdrop{background: rgba(0,0,0,0.62); backdrop-filter: blur(6px);}
    .dlg-head{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: rgba(255,255,255,0.06);
    }
    .dlg-title{
      margin:0;
      font-size: 12px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 950;
    }
    .dlg-body{padding: 14px 16px;}
    .icon-btn{
      width: 36px; height: 36px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      cursor:pointer;
      font-weight: 900;
    }
    .status-layout{
      display:grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 0.9fr);
      gap: 12px;
    }
    @media (max-width: 900px){
      .status-layout{ grid-template-columns: 1fr; }
    }
    .cond-list{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .cond-btn{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 850;
      text-align:left;
    }
    .cond-btn:hover{ border-color: rgba(255,255,255,0.2); background: rgba(0,0,0,0.28); }
    .status-current{
      display:flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
    }
    .status-item{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.2);
      padding: 10px 12px;
      border-radius: 12px;
      display:flex;
      flex-direction: column;
      gap: 4px;
    }
    .status-item .name{
      font-weight: 900;
    }
    .status-item .meta{
      font-size: 12px;
      color: var(--muted);
    }

    .btn{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: var(--muted);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      cursor:pointer;
      font-weight: 900;
    }
    .btn:hover{background: rgba(0,0,0,0.28); color: var(--text);}
    .btn.primary{
      border-color: rgba(216,192,138,0.40);
      background: rgba(216,192,138,0.18);
      color: var(--text);
    }
    .btn.danger{
      border-color: rgba(251,113,133,0.40);
      background: rgba(251,113,133,0.10);
      color: var(--text);
    }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content: space-between;
    }
    .small{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }

    .checkgrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px 12px;
      margin-top: 8px;
    }
    @media (max-width: 520px){
      .checkgrid{ grid-template-columns: 1fr; }
    }
    .check{
      display:flex;
      gap: 10px;
      align-items:center;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      cursor:pointer;
      user-select:none;
    }
    .check:hover{ border-color: rgba(255,255,255,0.20); background: rgba(0,0,0,0.25); }
    .check input{ accent-color: var(--accent); }
    .select{
      width: 100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      font-weight: 850;
      outline: none;
    }

    .gear{
      font-size: 22px;
      line-height: 1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transform: translateY(1px);
    }

    /* Settings + Lock FABs */
    .fab-wrap{
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 140;
      display:flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end;
    }
    .fab{
      width: 52px;
      height: 52px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.22);
      box-shadow: var(--shadow);
      color: var(--text);
      cursor:pointer;
      display:grid;
      place-items:center;
      transition: transform 120ms ease, border-color 120ms ease, background 120ms ease;
    }
    .fab:hover{transform: translateY(-2px);}
    .fab[aria-pressed="true"]{
      border-color: rgba(216,192,138,0.45);
      background: rgba(216,192,138,0.14);
    }

    .dice-panel{
      position: fixed;
      right: 90px;
      bottom: 90px;
      width: 360px;
      max-width: calc(100vw - 40px);
      min-height: 420px;
      max-height: calc(100vh - 140px);
      background: rgba(10,12,18,0.96);
      border: 1px solid rgba(255,255,255,0.16);
      border-radius: 16px;
      box-shadow: var(--shadow);
      z-index: 130;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }
    .dice-panel[data-open="true"]{ display:flex; }
    .dice-head{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      cursor: grab;
      background: rgba(255,255,255,0.06);
    }
    .dice-head:active{ cursor: grabbing; }
    .dice-body{
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap: 12px;
      flex: 1 1 auto;
      overflow: auto;
    }
    .dice-row{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
    }
    .dice-set-grid{
      display:flex;
      flex-direction: column;
      gap: 8px;
    }
    .dice-set{
      display:grid;
      grid-template-columns: auto auto minmax(0, 1fr) auto minmax(0, 1fr);
      gap: 8px;
      align-items:center;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.2);
    }
    .dice-set-custom{
      grid-template-columns: auto auto minmax(0, 1fr) auto minmax(0, 1fr) auto minmax(0, 1fr);
    }
    .dice-label{
      font-weight: 900;
      color: var(--text);
      font-size: 13px;
    }
    .dice-actions{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items:center;
    }
    .dice-actions .btn{
      flex: 1 1 110px;
      justify-content: center;
    }
    .dice-results{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 10px;
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    .dice-summary.is-max{ color: var(--green); }
    .dice-summary.is-min{ color: var(--red); }
    .dice-detail-row{
      display:flex;
      flex-wrap: wrap;
      gap: 6px 8px;
      align-items:center;
    }
    .dice-detail-label{
      font-weight: 900;
      color: var(--muted);
    }
    .dice-detail-rolls{
      display:flex;
      flex-wrap: wrap;
      gap: 6px;
      color: var(--text);
    }
    .dice-detail-total{
      font-weight: 900;
      color: var(--text);
    }
    .dice-roll{
      font-weight: 900;
      color: var(--text);
    }
    .dice-roll.is-max{ color: var(--green); }
    .dice-roll.is-min{ color: var(--red); }
    .dice-roll.is-unused{ opacity: 0.45; text-decoration: line-through; }
    .dice-roll.is-chosen{ text-shadow: 0 0 10px rgba(255,255,255,0.18); }
    .dice-roll-group{
      display:inline-flex;
      align-items:center;
      gap: 4px;
      color: var(--muted);
    }
    .dice-history{
      max-height: 200px;
      overflow: auto;
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    .dice-history-item{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      flex-direction: column;
      gap: 4px;
    }
    .dice-history-summary{
      font-weight: 900;
      color: var(--text);
    }
    .dice-history-summary.is-max{ color: var(--green); }
    .dice-history-summary.is-min{ color: var(--red); }
    .dice-history-rolls{
      display:flex;
      flex-direction: column;
      gap: 4px;
    }

    .dice-roll-flash{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 210;
    }
    .dice-roll-alert{
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      opacity: 1;
      pointer-events: none;
    }
    .dice-roll-alert.is-dismissed{
      animation: diceDismiss 3s ease-out forwards;
    }
    .dice-roll-flash-inner{
      font-size: clamp(32px, 5vw, 64px);
      font-weight: 950;
      padding: 14px 26px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.4);
      background: rgba(5,8,14,0.86);
      color: var(--text);
      box-shadow: var(--shadow);
    }
    .dice-roll-flash-inner.is-max{ color: var(--green); border-color: rgba(124,245,156,0.6); }
    .dice-roll-flash-inner.is-min{ color: var(--red); border-color: rgba(251,113,133,0.6); }

    .dice-roll-animation{
      position: fixed;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      z-index: 205;
      opacity: 0;
    }
    .dice-roll-animation[data-active="true"]{
      opacity: 1;
    }
    .dice-roll-animation .dice-cube{
      width: 60px;
      height: 60px;
      margin: 0 6px;
      animation: diceTumble 0.9s ease-in-out infinite;
      filter: drop-shadow(0 8px 14px rgba(0,0,0,0.4));
      display: block;
      object-fit: contain;
    }
    .dice-roll-animation .dice-cube:nth-child(2){ animation-delay: 0.1s; }
    .dice-roll-animation .dice-cube:nth-child(3){ animation-delay: 0.2s; }

    @keyframes diceDismiss{
      0%{ opacity: 1; transform: translate(-50%, -50%) translateY(0); }
      100%{ opacity: 0; transform: translate(-50%, -50%) translateY(-500px); }
    }
    @keyframes diceTumble{
      0%{ transform: translateY(0) rotate(0deg); }
      35%{ transform: translateY(-12px) rotate(140deg); }
      70%{ transform: translateY(6px) rotate(280deg); }
      100%{ transform: translateY(0) rotate(360deg); }
    }

    .radio-row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .radio{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      cursor:pointer;
      color: var(--muted);
      user-select:none;
      font-weight: 850;
    }
    .radio input{accent-color: var(--accent);}
    .radio:hover{color: var(--text); border-color: rgba(255,255,255,0.22);}

    .toggle{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
      margin-top: 12px;
    }
    .toggle strong{font-weight: 950;}
    .switch{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      cursor:pointer;
      user-select:none;
      color: var(--muted);
      font-weight: 850;
    }
    .switch input{accent-color: var(--accent); transform: scale(1.1);}

    /* =======================
      EDIT MODE (lock toggle)
    ======================= */
    .editable{
      outline: none;
      border-radius: 8px;
      padding: 2px 4px;
      margin: -2px -4px;
      transition: background 120ms ease, box-shadow 120ms ease;
    }
    body[data-edit="on"] .editable{ cursor: text; }
    body[data-edit="on"] .editable:hover{ background: rgba(216,192,138,0.10); }
    body[data-edit="on"] .editable:focus{
      background: rgba(216,192,138,0.12);
      box-shadow: 0 0 0 2px rgba(216,192,138,0.20);
    }

    /* Small icon button for "add custom" */
    .mini{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      cursor:pointer;
      font-weight: 950;
      display:grid;
      place-items:center;
    }
    .mini:hover{ background: rgba(0,0,0,0.28); border-color: rgba(255,255,255,0.22); }

    /* Coin purse styling */
    .coin-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 640px){
      .coin-grid{ grid-template-columns: 1fr; }
    }
    .coin-card{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      cursor: pointer;
    }
    .coin-card:hover{
      border-color: rgba(216,192,138,0.35);
      background: rgba(216,192,138,0.10);
    }
    .coin-left{
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .coin-ic{
      width: 36px; height: 36px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      overflow: hidden;
    }
    .coin-ic img{
      width: 26px;
      height: 26px;
      object-fit: contain;
      display: block;
    }
    .coin-meta{
      display:flex;
      flex-direction: column;
      gap: 2px;
    }
    .coin-name{
      font-weight: 950;
    }
    .coin-val{
      font-size: 12px;
      color: var(--muted);
      font-family: var(--mono);
    }
    .coin-amt{
      font-family: var(--mono);
      font-weight: 950;
      font-size: 16px;
    }
    .coin-card.is-standard .coin-ic{
      border: none;
      background: transparent;
      box-shadow: none;
    }

    /* Inventory attunement */
    .attune{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 12px;
    }
    .attune-row{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
      border-radius: 14px;
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap: 8px;
      cursor: pointer;
    }
    .attune-row:hover{
      border-color: rgba(216,192,138,0.45);
      background: rgba(216,192,138,0.10);
    }
    .attune-row strong{ font-weight: 950; }
    .attune-slot{
      color: var(--muted);
      font-weight: 850;
    }
    .attune-notes{
      font-size: 12px;
      color: var(--muted);
    }

    .inventory-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }
    .inventory-section{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      border-radius: 16px;
      padding: 10px;
      display:flex;
      flex-direction: column;
      gap: 8px;
      min-height: 120px;
      position: relative;
    }
    .inventory-section[draggable="true"]{
      cursor: grab;
    }
    .inventory-section.drag-over{
      border-color: rgba(216,192,138,0.4);
      box-shadow: 0 0 0 2px rgba(216,192,138,0.2) inset;
    }
    .inventory-section.drag-over::before{
      content:"";
      position: absolute;
      left: 12px;
      right: 12px;
      top: -6px;
      height: 3px;
      border-radius: 999px;
      background: linear-gradient(90deg, transparent, rgba(216,192,138,0.9), transparent);
      box-shadow: 0 0 14px rgba(216,192,138,0.9);
    }
    .inventory-section-header{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }
    .inventory-section-title{
      border: none;
      background: transparent;
      color: var(--text);
      font-weight: 900;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 12px;
      cursor: pointer;
      padding: 0;
      text-align: left;
    }
    .inventory-section-actions{
      display:flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .inventory-section-body table{
      width: 100%;
      border-collapse: collapse;
    }
    .inventory-section-body th,
    .inventory-section-body td{
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding: 8px 6px;
      font-size: 12px;
      vertical-align: middle;
    }
    .inventory-input{
      width: 100%;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.2);
      color: var(--text);
      font-weight: 700;
    }
    .inventory-input[readonly]{
      opacity: 0.75;
      cursor: default;
    }
    .qty-stepper{
      display:flex;
      align-items:center;
      gap: 6px;
    }
    .qty-stepper input{
      width: 56px;
      text-align: center;
    }
    .qty-stepper-buttons{
      display:flex;
      flex-direction: column;
      gap: 4px;
    }
    .qty-stepper-btn{
      width: 22px;
      height: 22px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      cursor: pointer;
      font-size: 10px;
      line-height: 1;
    }
    .inventory-basic-list{
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    .inventory-basic-item{
      display:flex;
      gap: 6px;
      align-items:center;
    }
    .inventory-basic-item button{
      flex: 0 0 auto;
    }
    .equipped-list{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
    }
    .equipped-row{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 8px;
      display:flex;
      flex-direction: column;
      gap: 6px;
    }

    .notes-subtabs{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      margin-bottom: 8px;
    }
    .notes-tab-dock{
      display:none;
      padding: 8px 16px 12px;
      border-top: 1px solid rgba(255,255,255,0.08);
      border-bottom: 1px solid rgba(255,255,255,0.12);
      background: linear-gradient(180deg, rgba(8,10,16,0.86), rgba(8,10,16,0.64));
    }
    .notes-tab-dock[data-active="true"]{
      display:block;
    }
    .notes-tab{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: rgba(255,255,255,0.78);
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
    }
    .notes-tab[aria-selected="true"]{
      background: rgba(216,192,138,0.16);
      border-color: rgba(216,192,138,0.36);
      color: rgba(255,255,255,0.92);
    }
    .notes-tab-add{
      border-style: dashed;
      font-weight: 950;
    }
    .notes-legend{
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items:center;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 12px;
    }
    .notes-legend span{
      display:inline-flex;
      align-items:center;
      gap: 6px;
    }
    .notes-toolbar{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items:center;
    }
    .notes-search-row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      margin: 10px 0 14px;
    }
    .notes-search{
      flex: 1 1 240px;
    }
    .notes-section{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
      border-radius: 16px;
      padding: 12px;
      margin-bottom: 14px;
    }
    .notes-section-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .notes-section-title{
      font-weight: 900;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 12px;
    }
    .notes-section-actions{
      display:flex;
      gap: 6px;
      align-items:center;
      flex-wrap: wrap;
    }
    .notes-section-body{
      display:grid;
      gap: 12px;
      margin-top: 10px;
    }
    .notes-section.collapsed .notes-section-body{
      display:none;
    }
    .notes-section.collapsed .notes-section-toggle{
      transform: rotate(-90deg);
    }
    .note-card{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.20);
      border-radius: 14px;
      padding: 10px;
      display:flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
    }
    .note-card[data-status="done"]{
      border-color: rgba(124,245,156,0.6);
      background: rgba(124,245,156,0.14);
    }
    .note-card[data-status="failed"]{
      border-color: rgba(148,163,184,0.6);
      background: rgba(148,163,184,0.18);
    }
    .note-card[data-status="important"]{
      border-color: rgba(251,113,133,0.7);
      background: rgba(251,113,133,0.18);
    }
    .note-card.is-starred{
      border-color: var(--note-star, rgba(216,192,138,0.55));
      box-shadow: 0 0 0 1px var(--note-star, rgba(216,192,138,0.45)) inset;
    }
    .note-card.is-starred .note-title{
      color: var(--note-star, var(--text));
    }
    .note-card[draggable="true"]{
      cursor: grab;
    }
    .note-card.drop-target::before{
      content:"";
      position: absolute;
      left: 10px;
      right: 10px;
      top: -6px;
      height: 3px;
      border-radius: 999px;
      background: linear-gradient(90deg, transparent, rgba(216,192,138,0.9), transparent);
      box-shadow: 0 0 14px rgba(216,192,138,0.9);
    }
    .note-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
    }
    .note-title{
      font-weight: 900;
      font-size: 13px;
    }
    .note-title-btn{
      border: none;
      background: transparent;
      padding: 0;
      margin: 0;
      font: inherit;
      color: inherit;
      text-align: left;
      cursor: pointer;
    }
    .note-actions{
      display:flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items:center;
    }
    .note-icon-btn{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.2);
      color: var(--text);
      border-radius: 8px;
      padding: 4px 6px;
      font-size: 12px;
      cursor:pointer;
    }
    .note-icon-btn[aria-pressed="true"]{
      border-color: rgba(216,192,138,0.45);
      background: rgba(216,192,138,0.18);
    }
    .note-body{
      min-height: 48px;
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 13px;
      line-height: 1.5;
      white-space: normal;
    }
    .note-body img{
      max-width: 100%;
      border-radius: 10px;
      display: block;
      margin: 6px 0;
    }
    .note-list{
      margin: 0;
      padding-left: 18px;
    }
    .note-list li{
      margin: 4px 0;
    }
    .note-body mark{
      background: rgba(93,178,255,0.35);
      color: var(--text);
      padding: 0 2px;
      border-radius: 4px;
    }
    .note-editor-toolbar{
      display:flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 8px 0;
      align-items: center;
    }
    .note-editor-rich{
      min-height: 180px;
      resize: vertical;
      overflow: auto;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.24);
      color: var(--text);
    }
    .note-editor-rich img{
      max-width: 100%;
      height: auto;
      resize: both;
      overflow: auto;
      display: inline-block;
      border-radius: 10px;
    }
    .note-editor-rich:focus{
      outline: 2px solid rgba(216,192,138,0.4);
      outline-offset: 2px;
    }
    .notes-empty{
      font-size: 12px;
      color: var(--muted);
    }
    .note-star-palette{
      position: fixed;
      display: none;
      grid-template-columns: repeat(6, 24px);
      gap: 8px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(8,10,16,0.96);
      box-shadow: var(--shadow);
      z-index: 120;
    }
    .note-star-palette[data-active="true"]{
      display: grid;
    }
    .note-star-swatch{
      width: 22px;
      height: 22px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.3);
      background: var(--swatch);
      cursor: pointer;
      padding: 0;
    }

    .debug-panel{
      position: fixed;
      bottom: 16px;
      right: 16px;
      width: min(420px, calc(100vw - 32px));
      max-height: 45vh;
      overflow: auto;
      border: 1px solid rgba(93,178,255,0.35);
      background: rgba(7,10,20,0.92);
      border-radius: 14px;
      padding: 12px;
      font-family: var(--mono);
      font-size: 11px;
      color: #dbeafe;
      display: none;
      z-index: 120;
      box-shadow: var(--shadow);
    }
    .debug-panel[data-active="true"]{
      display: block;
    }
    .debug-panel-title{
      font-weight: 900;
      margin-bottom: 6px;
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }
  </style>
</head>

<body data-edit="off" data-wide="off">
  <header class="topbar">
    <div class="topbar-inner">
      <!-- Name block -->
      <div class="id-block">
        <img class="id-portrait" id="tb_portrait" alt="Character portrait thumbnail" />
        <div class="id-text">
          <h1 class="id-name" id="tb_name">Elaria Thornbloom</h1>
          <div class="id-sub" id="tb_sub">Wood Elf â€¢ Druid 10</div>
        </div>
      </div>

      <!-- Right side -->
      <div class="head-right">
        <!-- TOP ROW: AC, INIT, SPD, PROF, MONEY, STATUS, INSP -->
        <div class="top-row" aria-label="Top stats row">
          <div class="cap stat-cap" title="Armor Class">
            <div class="stat-k">AC</div>
            <div class="stat-v" id="tb_ac">16</div>
          </div>

          <div class="cap stat-cap" title="Initiative">
            <div class="stat-k">INIT</div>
            <div class="stat-v" id="tb_init">+3</div>
          </div>

          <div class="cap stat-cap" title="Speed">
            <div class="stat-k">SPD</div>
            <div class="stat-v" id="tb_speed">35</div>
          </div>

          <div class="cap stat-cap" title="Proficiency Bonus">
            <div class="stat-k">PROF</div>
            <div class="stat-v" id="tb_pb">+4</div>
          </div>

          <div class="cap chip-cap chip-money" title="Gold">
            <div class="chip-k">GOLD</div>
            <div class="chip-row">
              <button class="pill-btn" id="moneyBtn" type="button" aria-haspopup="dialog" title="Open coin purse">
                <img class="chip-icon" id="tb_money_icon" src="https://i.imgur.com/bbdjD7q.png" alt="Gold" />
                <span class="mono" id="tb_money_total">â€” gp</span>
              </button>
            </div>
          </div>

          <div class="cap chip-cap chip-status" title="Status / Conditions">
            <div class="chip-k">STATUS</div>
            <div class="chip-row">
              <button class="pill-btn" id="statusBtn" type="button" aria-haspopup="dialog" title="Select conditions">
                <span id="tb_status">None</span>
              </button>
            </div>

            <!-- hover tooltip -->
            <div class="tooltip" id="statusTooltip" aria-hidden="true">
              <div class="t-title">Active Status</div>
              <div id="statusTooltipText" class="small" style="color: var(--text);"></div>
            </div>
          </div>

        </div>

        <!-- SECOND ROW: HP + Rest -->
        <div class="bottom-row" aria-label="Health row">
          <div class="cap hp-cap" title="Health">
            <div class="hp-left">
              <div class="hp-text">
                <span class="num" id="tb_hp_cur">73</span>/<span class="num" id="tb_hp_max">73</span>
              </div>
              <div class="hp-mod" id="tb_temp_label">+0</div>
            </div>

            <div class="hp-bar" aria-label="Health bar">
              <div class="hp-green" id="hpGreen"></div>
              <div class="hp-temp" id="hpTemp"></div>
            </div>

            <div class="hp-controls" aria-label="Health controls">
              <div class="hp-stepper" aria-label="Health amount">
                <input class="amt hp-amt" id="hpAmt" type="number" value="12" min="0" inputmode="numeric" />
                <div class="hp-stepper-buttons">
                  <button class="hp-stepper-btn" id="hpAmtUp" type="button" title="Increase amount">â–²</button>
                  <button class="hp-stepper-btn" id="hpAmtDown" type="button" title="Decrease amount">â–¼</button>
                </div>
              </div>
              <button class="hp-btn damage" id="btnDamage" type="button" title="Damage (uses temp first)">âˆ’</button>
              <button class="hp-btn heal" id="btnHeal" type="button" title="Heal (up to max)">+</button>
              <button class="hp-btn temp" id="btnTemp" type="button" title="Set Temp HP (takes the higher)">â›¨</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <nav class="tabs" role="tablist" aria-label="Character sheet tabs">
      <button class="tab" role="tab" aria-selected="true"  aria-controls="tab-main"      id="tabbtn-main"      data-tab="main">Main</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="tab-abilities" id="tabbtn-abilities" data-tab="abilities">Abilities</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="tab-actions"   id="tabbtn-actions"   data-tab="actions">Actions</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="tab-spells"    id="tabbtn-spells"    data-tab="spells">Spell Book</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="tab-inventory" id="tabbtn-inventory" data-tab="inventory">Inventory</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="tab-creatures" id="tabbtn-creatures" data-tab="creatures">Creatures</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="tab-notes"     id="tabbtn-notes"     data-tab="notes">Notes</button>
      <span class="tab-spacer" aria-hidden="true"></span>
      <button class="tab rest-tab" id="restTabBtn" type="button" aria-haspopup="dialog" aria-label="Open rest options">ðŸŒ™ Rest</button>
    </nav>

    <div class="notes-tab-dock" id="notesTabDock" data-active="false" aria-label="Notes categories">
      <div class="notes-subtabs" id="notesSubtabs" role="tablist" aria-label="Notes categories"></div>
    </div>
  </header>

  <main class="wrap">
    <!-- MAIN -->
    <section class="panel" id="tab-main" data-tabpanel data-active="true" role="tabpanel" aria-labelledby="tabbtn-main">
      <div class="panel-header">
        <h2 class="panel-title">Character Bio</h2>
        <div class="chips" id="mainChips"></div>
      </div>

      <div class="panel-body">
        <div class="main-grid">
          <!-- LEFT -->
          <div style="display:flex; flex-direction:column; gap:12px;">
            <div class="hero" id="heroBlock">
              <h3 class="hero-name editable" id="mainName">Elaria Thornbloom</h3>
              <div class="hero-tagline editable" id="mainTagline">Of the order of History</div>
              <div class="chips" id="mainSummaryLine"></div>

              <!-- NEW: Quick combat block under hero -->
              <div class="quickstats" aria-label="Main quick stats">
                <div class="qs">
                  <div class="k">HP</div>
                  <div class="v">
                    <span class="num editable" id="m_hp_cur">73</span>/<span class="num editable" id="m_hp_max">73</span>
                    <span class="muted" id="m_hp_temp"></span>
                  </div>
                </div>
                <div class="qs"><div class="k">AC</div><div class="v"><span class="num editable" id="m_ac">16</span></div></div>
                <div class="qs"><div class="k">INIT</div><div class="v"><span class="num editable" id="m_init">+3</span></div></div>
                <div class="qs"><div class="k">PROF</div><div class="v"><span class="num editable" id="m_prof">+4</span></div></div>
                <div class="qs"><div class="k">SPD</div><div class="v"><span class="num editable" id="m_spd">35</span></div></div>
              </div>
            </div>

            <div class="card" id="xpCard" style="display:none;">
              <h4>Progress</h4>
              <div class="xpbox" id="xpBox">
                <div class="xpgrid">
                  <div class="field">
                    <label>Current XP</label>
                    <div style="display:flex; gap:8px; align-items:center;">
                      <input id="xpCurrent" type="number" min="0" value="0" inputmode="numeric" />
                      <span class="val">xp</span>
                    </div>
                  </div>
                  <div class="field">
                    <label>Next Level</label>
                    <div class="val"><span id="xpNext">300</span> xp</div>
                  </div>
                  <div class="field">
                    <label>Level</label>
                    <div class="val">Lv <span id="xpLevel">1</span></div>
                  </div>
                  <div class="field">
                    <label>To Next</label>
                    <div class="val"><span id="xpToNext">300</span> xp</div>
                  </div>
                </div>

                <div class="row">
                  <div class="small">Add XP updates thresholds. Use â€œLevel Upâ€ when ready.</div>
                  <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
                    <input class="amt" id="xpAddAmt" type="number" min="0" value="0" inputmode="numeric" style="width:86px;" />
                    <button class="btn primary" id="xpAddBtn" type="button">Add XP</button>
                    <button class="btn" id="xpLevelUpBtn" type="button" style="display:none;">Level Up</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <h4>Identity</h4>
              <div class="kv">
                <div class="k">Player</div><div class="v editable" id="mainPlayer">Lukas Schulze</div>
                <div class="k">Pronouns</div><div class="v editable" id="mainPronouns">she / her</div>
                <div class="k">Campaign / Party</div><div class="v editable" id="mainCampaign">The Verdant Accord</div>
              </div>
            </div>

            <div class="card">
              <h4>Build</h4>
              <div class="kv">
                <div class="k">Class & Level</div><div class="v editable" id="mainClasses">Druid 10</div>
                <div class="k">Total Level</div><div class="v"><span class="num editable" id="mainTotalLevel">10</span></div>
                <div class="k">Race / Species</div><div class="v editable" id="mainRace">Wood Elf</div>
                <div class="k">Background</div><div class="v editable" id="mainBackground">Sage</div>
                <div class="k">Alignment</div><div class="v editable" id="mainAlignment">Neutral Good</div>
              </div>
            </div>

            <div class="card">
              <h4>Defense</h4>
              <div class="kv">
                <div class="k">Hit Dice</div><div class="v editable" id="defHitDice">Druid d8 Ã—10</div>
                <div class="k">Healing Surges</div><div class="v editable" id="defSurges">â€”</div>
                <div class="k">Death Saves</div><div class="v editable" id="defDeathSaves">0 success / 0 fail</div>
              </div>

              <div style="height:10px"></div>

              <div class="kv">
                <div class="k">AC: Armor</div><div class="v editable" id="defArmor">Leather (11)</div>
                <div class="k">AC: Shield</div><div class="v editable" id="defShield">None</div>
                <div class="k">AC: Dex Cap</div><div class="v editable" id="defDexCap">+3</div>
                <div class="k">AC: Magic</div><div class="v editable" id="defMagic">+0</div>
                <div class="k">AC: Other</div><div class="v editable" id="defOther">â€”</div>
              </div>

              <div style="height:10px"></div>

              <div class="kv">
                <div class="k">Resistances</div><div class="v editable" id="defResist">â€”</div>
                <div class="k">Immunities</div><div class="v editable" id="defImmune">â€”</div>
                <div class="k">Vulnerabilities</div><div class="v editable" id="defVuln">â€”</div>
                <div class="k">Condition Immunities</div><div class="v editable" id="defCondImmune">â€”</div>
                <div class="k">Senses</div><div class="v editable" id="defSenses">Darkvision 60 ft.</div>
                <div class="k">Passive Scores</div><div class="v editable" id="defPassive">Perception 14 â€¢ Insight 13 â€¢ Investigation 12</div>
              </div>
            </div>

            <div class="card">
              <h4>Roleplay</h4>
              <div class="kv">
                <div class="k">Traits</div><div class="v editable" id="mainTraits">Curious, patient, speaks softlyâ€”until the wild answers back.</div>
                <div class="k">Ideals</div><div class="v editable" id="mainIdeals">Knowledge should protect life, not dominate it.</div>
                <div class="k">Bonds</div><div class="v editable" id="mainBonds">A living grove-archive entrusted to her care.</div>
                <div class="k">Flaws</div><div class="v editable" id="mainFlaws">Will take dangerous risks to preserve a rare creature or secret.</div>
              </div>
            </div>

            <div class="card">
              <h4>Appearance</h4>
              <div class="kv">
                <div class="k">Description</div><div class="v editable" id="mainDesc">Pale-haired wanderer draped in living greens; carries a staff carved like roots.</div>
                <div class="k">Age</div><div class="v editable" id="mainAge">148</div>
                <div class="k">Weight / Size</div><div class="v editable" id="mainSize">Lean â€¢ Medium</div>
                <div class="k">Hair / Eyes / Skin</div><div class="v editable" id="mainHES">White hair â€¢ amber eyes â€¢ sun-kissed skin</div>
                <div class="k">Marks</div><div class="v editable" id="mainMarks">Vine-like tattoos along the left arm; scar at the collarbone.</div>
              </div>
            </div>
          </div>

          <!-- RIGHT PORTRAIT (600x900), aligned with hero top -->
          <div class="portrait-frame" aria-label="Character portrait">
            <div style="position:relative;">
              <img class="portrait-img" id="portraitImg" alt="Character portrait" />
              <div class="portrait-overlay"></div>
              <div class="portrait-vignette"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ABILITIES -->
    <section class="panel" id="tab-abilities" data-tabpanel data-active="false" role="tabpanel" aria-labelledby="tabbtn-abilities">
      <div class="panel-header">
        <h2 class="panel-title">Ability Scores</h2>
        <button class="mini" id="addAbilityBtn" type="button" title="Add custom ability (edit mode only)" style="display:none;">ï¼‹</button>
      </div>
      <div class="panel-body">
        <div class="abil-wrap">
          <div class="abil-grid" id="abilGrid"></div>

          <div class="panel" style="box-shadow:none;">
            <div class="panel-header skills-head">
              <h3 class="panel-title">Skills</h3>
              <div style="display:flex; gap:10px; align-items:center;">
                <div class="legend" aria-label="Proficiency legend">
                  <span>Proficiency:</span>
                  <span><span class="dot"></span> none</span>
                  <span><span class="dot fill"></span> half</span>
                  <span><span class="dot gold"></span> proficiency</span>
                  <span><span class="dot gold" style="box-shadow:0 0 0 2px rgba(216,192,138,0.22) inset;"></span> expertise</span>
                </div>
                <button class="mini" id="addSkillBtn" type="button" title="Add custom skill (edit mode only)" style="display:none;">ï¼‹</button>
              </div>
            </div>
            <div class="panel-body" style="padding-top:12px;">
              <div class="skills-grid" id="skillsGrid"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ACTIONS (with subtabs) -->
    <section class="panel" id="tab-actions" data-tabpanel data-active="false" role="tabpanel" aria-labelledby="tabbtn-actions">
      <div class="panel-header">
        <h2 class="panel-title">Combat</h2>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <span class="tag">Spell DC: <span class="num editable" id="sp_dc">16</span></span>
          <span class="tag">Spell Atk: <span class="num editable" id="sp_atk">+8</span></span>
        </div>
      </div>


      <div class="subtabs" role="tablist" aria-label="Combat sub-tabs">
          <button class="subtab" role="tab" aria-selected="true"  data-subtab="actions">Actions</button>
          <button class="subtab" role="tab" aria-selected="false" data-subtab="bonus">Bonus Actions</button>
          <button class="subtab" role="tab" aria-selected="false" data-subtab="reactions">Reactions</button>
          <button class="subtab" role="tab" aria-selected="false" data-subtab="free">Free Actions</button>
        </div>

      <div class="panel-body">
        <div style="height:10px"></div>

        <div data-subpanel="actions" id="sub-actions" data-active="true">
          <div class="panel" style="box-shadow:none;">
            <div class="panel-header"><h3 class="panel-title">Actions</h3></div>
            <div class="panel-body" style="padding:0;">
              <table>
                <thead><tr><th>Action</th><th class="right">To Hit / DC</th><th>Damage / Effect</th><th>Notes</th></tr></thead>
                <tbody id="c_attacks"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div data-subpanel="bonus" id="sub-bonus" data-active="false">
          <div class="panel" style="box-shadow:none;">
            <div class="panel-header"><h3 class="panel-title">Bonus Actions</h3></div>
            <div class="panel-body">
              <ul style="margin:0; padding-left:18px;" id="c_bonus"></ul>
            </div>
          </div>
        </div>

        <div data-subpanel="reactions" id="sub-reactions" data-active="false">
          <div class="panel" style="box-shadow:none;">
            <div class="panel-header"><h3 class="panel-title">Reactions</h3></div>
            <div class="panel-body">
              <ul style="margin:0; padding-left:18px;" id="c_reactions"></ul>
            </div>
          </div>
        </div>

        <div data-subpanel="free" id="sub-free" data-active="false">
          <div class="panel" style="box-shadow:none;">
            <div class="panel-header"><h3 class="panel-title">Free Actions</h3></div>
            <div class="panel-body">
              <ul style="margin:0; padding-left:18px;" id="c_free"></ul>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SPELLS -->
    <section class="panel" id="tab-spells" data-tabpanel data-active="false" role="tabpanel" aria-labelledby="tabbtn-spells">
      <div class="panel-header">
        <div class="panel-title-row">
          <h2 class="panel-title">Spell Book</h2>
        <button class="btn spellbook-add-btn" id="addSpellbookBtn" type="button" title="Add spellbook (edit mode only)" style="display:none;">Add new spellbook</button>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <span class="tag">Prepared: <span class="num" id="sp_prep">14</span></span>
          <span class="tag">Ability: Wisdom</span>
        </div>
      </div>
      <div class="panel-body" id="sp_list"></div>
    </section>

    <!-- INVENTORY -->
    <section class="panel" id="tab-inventory" data-tabpanel data-active="false" role="tabpanel" aria-labelledby="tabbtn-inventory">
      <div class="panel-header">
        <div class="panel-title-row">
          <h2 class="panel-title">Inventory</h2>
          <button class="btn" id="addBagBtn" type="button">Add Bag</button>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <span class="tag">Encumbrance: <span id="i_enc">Light</span></span>
          <button class="tag" id="inventoryCurrencyBtn" type="button">Currency: <span id="i_money">â€”</span></button>
        </div>
      </div>

      <div class="panel-body">
        <div class="inventory-grid" id="inventoryGrid"></div>
      </div>
    </section>



    <!-- CREATURES -->
    <section class="panel" id="tab-creatures" data-tabpanel data-active="false" role="tabpanel" aria-labelledby="tabbtn-creatures">
      <div class="panel-header">
        <h2 class="panel-title">Creatures</h2>
        <button class="mini" id="addCreatureBtn" type="button" title="Add creature (edit mode only)" style="display:none;">ï¼‹</button>
      </div>

      <div class="subtabs" role="tablist" aria-label="Creatures sub-tabs">
        <button class="subtab" role="tab" aria-selected="true"  data-subtab="companions">Companions</button>
        <button class="subtab" role="tab" aria-selected="false" data-subtab="summons">Summons</button>
        <button class="subtab" role="tab" aria-selected="false" data-subtab="wildshapes">Wild Shapes</button>
      </div>

      <div class="panel-body">
        <div data-subpanel="companions" data-active="true">
          <div class="card">
            <h4>Companions</h4>
            <div class="muted">Add companion creatures, mounts, familiars, etc.</div>
            <div id="creatures_companions" style="margin-top:10px;"></div>
          </div>
        </div>
        <div data-subpanel="summons" data-active="false">
          <div class="card">
            <h4>Summons</h4>
            <div class="muted">Track creatures created by spells or abilities.</div>
            <div id="creatures_summons" style="margin-top:10px;"></div>
          </div>
        </div>
        <div data-subpanel="wildshapes" data-active="false">
          <div class="card">
            <h4>Wild Shapes</h4>
            <div class="muted">Store wild shape stat blocks and notes.</div>
            <div id="creatures_wildshapes" style="margin-top:10px;"></div>
          </div>
        </div>
      </div>
    </section>
    <!-- NOTES -->
    <section class="panel" id="tab-notes" data-tabpanel data-active="false" role="tabpanel" aria-labelledby="tabbtn-notes">
      <div class="panel-header">
        <h2 class="panel-title">Notes</h2>
        <div class="notes-toolbar">
          <button class="btn" id="addQuickNoteBtn" type="button">Quick Note</button>
          <button class="btn" id="addAdvancedNoteBtn" type="button">Advance Note</button>
          <button class="btn" id="addNoteSectionBtn" type="button">New Section</button>
        </div>
      </div>
      <div class="panel-body">
        <div class="notes-legend" id="notesLegend">
          <span>â˜… Starred</span>
          <span>âœ“ Completed</span>
          <span>âœ• Failed</span>
          <span>â— Important</span>
        </div>
        <div class="notes-search-row">
          <input class="select notes-search" id="notesSearchInput" placeholder="Search notes..." />
          <button class="btn" id="notesSearchClear" type="button">Clear</button>
        </div>
        <div class="note-star-palette" id="noteStarPalette" data-active="false" aria-hidden="true">
          <button class="note-star-swatch" type="button" data-star-color="#f5d06f" style="--swatch:#f5d06f;" aria-label="Gold"></button>
          <button class="note-star-swatch" type="button" data-star-color="#f97316" style="--swatch:#f97316;" aria-label="Orange"></button>
          <button class="note-star-swatch" type="button" data-star-color="#ef4444" style="--swatch:#ef4444;" aria-label="Red"></button>
          <button class="note-star-swatch" type="button" data-star-color="#facc15" style="--swatch:#facc15;" aria-label="Yellow"></button>
          <button class="note-star-swatch" type="button" data-star-color="#22c55e" style="--swatch:#22c55e;" aria-label="Green"></button>
          <button class="note-star-swatch" type="button" data-star-color="#14b8a6" style="--swatch:#14b8a6;" aria-label="Teal"></button>
          <button class="note-star-swatch" type="button" data-star-color="#38bdf8" style="--swatch:#38bdf8;" aria-label="Sky"></button>
          <button class="note-star-swatch" type="button" data-star-color="#3b82f6" style="--swatch:#3b82f6;" aria-label="Blue"></button>
          <button class="note-star-swatch" type="button" data-star-color="#8b5cf6" style="--swatch:#8b5cf6;" aria-label="Purple"></button>
          <button class="note-star-swatch" type="button" data-star-color="#ec4899" style="--swatch:#ec4899;" aria-label="Pink"></button>
          <button class="note-star-swatch" type="button" data-star-color="#a3e635" style="--swatch:#a3e635;" aria-label="Lime"></button>
          <button class="note-star-swatch" type="button" data-star-color="#94a3b8" style="--swatch:#94a3b8;" aria-label="Slate"></button>
        </div>
        <div id="notesSections"></div>
      </div>
    </section>
  </main>

  <dialog id="noteEditorDialog" aria-label="Edit note">
    <div class="dlg-head">
      <h3 class="dlg-title" id="noteEditorDialogTitle">Note Editor</h3>
      <button class="icon-btn" id="noteEditorClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <label class="small" for="noteEditorTitleInput">Title</label>
      <input class="select" id="noteEditorTitleInput" placeholder="Note title" />

      <div class="note-editor-toolbar" id="noteEditorToolbar">
        <button class="btn" type="button" data-cmd="bold"><strong>B</strong></button>
        <button class="btn" type="button" data-cmd="italic"><em>I</em></button>
        <button class="btn" type="button" data-cmd="underline"><span style="text-decoration:underline;">U</span></button>
        <button class="btn" type="button" data-cmd="strikeThrough"><span style="text-decoration:line-through;">S</span></button>
        <button class="btn" type="button" data-cmd="insertUnorderedList">â€¢ List</button>
        <button class="btn" type="button" data-cmd="insertOrderedList">1. List</button>
        <button class="btn" type="button" data-cmd="justifyLeft">Left</button>
        <button class="btn" type="button" data-cmd="justifyCenter">Center</button>
        <button class="btn" type="button" data-cmd="justifyRight">Right</button>
        <button class="btn" type="button" data-cmd="justifyFull">Justify</button>
        <label class="btn">
          Text
          <input type="color" id="noteTextColor" value="#ffffff" style="width:0; height:0; opacity:0; position:absolute;" />
        </label>
        <label class="btn">
          Highlight
          <input type="color" id="noteHighlightColor" value="#5db2ff" style="width:0; height:0; opacity:0; position:absolute;" />
        </label>
        <select class="select" id="noteFontSize" style="width:auto; min-width:90px;">
          <option value="12">12px</option>
          <option value="14" selected>14px</option>
          <option value="16">16px</option>
          <option value="18">18px</option>
          <option value="20">20px</option>
          <option value="24">24px</option>
        </select>
        <button class="btn" type="button" id="noteInsertLink">Link</button>
        <button class="btn" type="button" id="noteInsertImage">Image URL</button>
      </div>

      <div class="note-editor-rich select" id="noteEditorBody" contenteditable="true" spellcheck="true"></div>

      <div class="row" style="margin-top:10px; justify-content:flex-end;">
        <button class="btn" id="noteEditorCancel" type="button">Cancel</button>
        <button class="btn primary" id="noteEditorSave" type="button">Save Note</button>
      </div>
    </div>
  </dialog>

  <dialog id="addBagDialog" aria-label="Add inventory section">
    <div class="dlg-head">
      <h3 class="dlg-title">Add Bag</h3>
      <button class="icon-btn" id="addBagClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <label class="small" for="addBagTitle">Title</label>
      <input class="select" id="addBagTitle" placeholder="New section title" />

      <label class="small" for="addBagType" style="margin-top:10px;">Type</label>
      <select class="select" id="addBagType">
        <option value="detailed">Detailed (Item / Qty / Notes)</option>
        <option value="basic">Basic (simple list)</option>
      </select>

      <label class="small" for="addBagSpan" style="margin-top:10px;">Width</label>
      <select class="select" id="addBagSpan">
        <option value="1">1/3 width</option>
        <option value="2">2/3 width</option>
        <option value="3" selected>Full width</option>
      </select>

      <div class="card" style="margin-top:12px;">
        <h4>Common Packs</h4>
        <div class="small">Add a classic D&amp;D pack (1/3 width).</div>
        <div class="row" style="margin-top:10px; justify-content:flex-start;">
          <button class="btn" type="button" data-pack="explorers-pack">Explorerâ€™s Pack</button>
          <button class="btn" type="button" data-pack="burglar-pack">Burglarâ€™s Pack</button>
          <button class="btn" type="button" data-pack="diplomat-pack">Diplomatâ€™s Pack</button>
          <button class="btn" type="button" data-pack="priest-pack">Priestâ€™s Pack</button>
          <button class="btn" type="button" data-pack="scholar-pack">Scholarâ€™s Pack</button>
          <button class="btn" type="button" data-pack="disguise-kit">Disguise Kit</button>
        </div>
      </div>

      <div class="row" style="margin-top:12px; justify-content:flex-end;">
        <button class="btn" id="addBagCancel" type="button">Cancel</button>
        <button class="btn primary" id="addBagApply" type="button">Add Section</button>
      </div>
    </div>
  </dialog>

  <dialog id="inventorySectionDialog" aria-label="Edit inventory section">
    <div class="dlg-head">
      <h3 class="dlg-title">Edit Section</h3>
      <button class="icon-btn" id="inventorySectionClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <label class="small" for="inventorySectionTitle">Title</label>
      <input class="select" id="inventorySectionTitle" placeholder="Section title" />

      <label class="small" for="inventorySectionSpan" style="margin-top:10px;">Width</label>
      <select class="select" id="inventorySectionSpan">
        <option value="1">1/3 width</option>
        <option value="2">2/3 width</option>
        <option value="3">Full width</option>
      </select>

      <div class="row" style="margin-top:12px; justify-content:flex-end;">
        <button class="btn" id="inventorySectionCancel" type="button">Cancel</button>
        <button class="btn primary" id="inventorySectionSave" type="button">Save</button>
      </div>
    </div>
  </dialog>

  <!-- Spell import dialog -->
  <dialog id="spellImportDialog" aria-label="Spell importer">
    <div class="dlg-head">
      <h3 class="dlg-title">Spell Importer</h3>
      <button class="icon-btn" id="spellImportClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div class="spell-import-layout">
        <div class="spell-import-controls">
          <div class="spell-import-toolbar">
            <input class="select" id="spellImportSearch" placeholder="Search spells by name" />
            <select class="select" id="spellImportSort">
              <option value="name">Sort: Name</option>
              <option value="level">Sort: Level</option>
              <option value="time">Sort: Time</option>
              <option value="school">Sort: School</option>
              <option value="concentration">Sort: Concentration</option>
              <option value="range">Sort: Range</option>
            </select>
            <button class="btn primary" id="spellImportApplyFilters" type="button" disabled>Apply Filters</button>
          </div>
          <div class="small muted" id="spellImportTargetLabel" style="margin-top:-4px;">Importing into: â€”</div>

          <div class="spell-import-filters">
            <div class="spell-filter-group">
              <div class="spell-filter-head">
                <div class="small">Spell Level</div>
                <div class="spell-filter-actions">
                  <button class="tag" type="button" data-level-action="select-all">Select all</button>
                  <button class="tag" type="button" data-level-action="unselect-all">Unselect all</button>
                </div>
              </div>
              <div class="spell-filter-list" id="spellImportLevelFilters"></div>
            </div>
            <div class="spell-filter-group">
              <div class="spell-filter-head">
                <div class="small">Class Filters</div>
                <div class="spell-filter-actions">
                  <button class="tag" type="button" data-class-action="select-all">Select all</button>
                  <button class="tag" type="button" data-class-action="unselect-all">Unselect all</button>
                </div>
              </div>
              <div class="spell-filter-list" id="spellImportClassFilters"></div>
            </div>
          </div>

          <div class="spell-import-list" id="spellImportList">
            <div class="muted">Loading spellsâ€¦</div>
          </div>

          <div style="display:flex; gap:8px; justify-content:space-between; flex-wrap:wrap; align-items:center;">
            <div class="small muted"><span id="spellImportSelectedCount">0</span> selected</div>
            <div style="display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;">
              <button class="btn" id="spellImportCancel" type="button">Cancel</button>
              <button class="btn primary" id="spellImportConfirm" type="button" disabled>Import Selected</button>
            </div>
          </div>
        </div>

        <aside class="spell-import-selected" aria-label="Selected spells">
          <div class="spell-selected-summary">
            <div class="small" style="font-weight:900;">Selected</div>
            <div class="small muted" id="spellImportSelectedTotals">0 spells selected</div>
            <div class="spell-selected-breakdown" id="spellImportSelectedBreakdown"></div>
          </div>
          <div class="spell-selected-list" id="spellImportSelectedList">
            <div class="muted">No spells selected.</div>
          </div>
        </aside>
      </div>
    </div>
  </dialog>

  <dialog id="spellInfoDialog" aria-label="Spell details">
    <div class="dlg-head">
      <h3 class="dlg-title" id="spellInfoTitle">Spell</h3>
      <button class="icon-btn" id="spellInfoClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div id="spellInfoBody"></div>
    </div>
  </dialog>

  <dialog id="spellbookEditDialog" aria-label="Edit spellbook">
    <div class="dlg-head">
      <h3 class="dlg-title">Spellbook</h3>
      <button class="icon-btn" id="spellbookEditClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div class="card">
        <h4>Name</h4>
        <input class="select" id="spellbookEditName" placeholder="Spellbook name" />
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <h4>Spellcasting Modifier</h4>
        <div class="small">Sets the save DC shown for spells in this book.</div>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:10px; margin-top:10px;">
          <div class="field" style="justify-content:flex-start;">
            <label style="min-width:110px;">Ability</label>
            <select class="select" id="spellbookEditModType">
              <option value="int">Intelligence</option>
              <option value="wis">Wisdom</option>
              <option value="cha">Charisma</option>
              <option value="custom">Custom</option>
            </select>
          </div>
          <div class="field" style="justify-content:flex-start;">
            <label style="min-width:110px;">Custom Mod</label>
            <input class="select" id="spellbookEditModCustom" type="number" value="0" />
          </div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <h4>Colours</h4>
        <div class="small">Frame highlight, midtone, and text.</div>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:10px; margin-top:10px;">
          <div class="field" style="justify-content:flex-start;">
            <label style="min-width:110px;">Highlight</label>
            <input id="spellbookEditHi" type="color" class="select" style="padding:4px; height:40px;" />
          </div>
          <div class="field" style="justify-content:flex-start;">
            <label style="min-width:110px;">Midtone</label>
            <input id="spellbookEditMid" type="color" class="select" style="padding:4px; height:40px;" />
          </div>
          <div class="field" style="justify-content:flex-start;">
            <label style="min-width:110px;">Text</label>
            <input id="spellbookEditText" type="color" class="select" style="padding:4px; height:40px;" />
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="small" style="font-weight:900;">Presets</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;" id="spellbookPresetRow">
          <button class="tag" type="button" data-sb-preset="Warlock">Warlock</button>
          <button class="tag" type="button" data-sb-preset="Wizard">Wizard</button>
          <button class="tag" type="button" data-sb-preset="Sorcerer">Sorcerer</button>
          <button class="tag" type="button" data-sb-preset="Fire">Fire</button>
          <button class="tag" type="button" data-sb-preset="Water">Water</button>
          <button class="tag" type="button" data-sb-preset="Earth">Earth</button>
          <button class="tag" type="button" data-sb-preset="Air">Air</button>
          <button class="tag" type="button" data-sb-preset="Wildmagic">Wildmagic</button>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="row">
        <button class="btn" id="spellbookEditCancel" type="button">Cancel</button>
        <button class="btn primary" id="spellbookEditSave" type="button">Save</button>
      </div>
    </div>
  </dialog>


  <!-- Coin purse dialog (nicer) -->
  <dialog id="coinDialog" aria-label="Coin purse">
    <div class="dlg-head">
      <h3 class="dlg-title">Coin Purse</h3>
      <button class="icon-btn" id="coinClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div class="row">
        <div class="small">Total value</div>
        <div style="font-weight:950; font-size:18px;">
          <span id="coinTotal" class="num">â€”</span>
          <span class="muted" style="font-size:12px; font-weight:900;">gp</span>
        </div>
      </div>

      <div class="coin-grid" id="coinCards"></div>

      <div style="height:10px"></div>

      <div class="card" id="customCurrencyPanel" style="display:none;">
        <h4>Custom Currency</h4>
        <div class="small">Add or remove custom coin types while in edit mode.</div>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:10px; margin-top:10px;">
          <input class="select" id="customCoinName" placeholder="Name" />
          <input class="select" id="customCoinKey" placeholder="Code (e.g. tc)" />
          <input class="select" id="customCoinValue" type="number" step="0.01" min="0" placeholder="gp value" />
          <input class="select" id="customCoinIcon" placeholder="Icon URL (optional)" />
          <button class="btn primary" id="addCustomCoinBtn" type="button">Add</button>
        </div>
        <div style="height:10px"></div>
        <div id="customCoinList"></div>
      </div>

      <div class="small">
        Values: pp=10gp, gp=1gp, ep=0.5gp, sp=0.1gp, cp=0.01gp.
      </div>
    </div>
  </dialog>

  <!-- Rest dialog -->
  <dialog id="restDialog" aria-label="Rest options">
    <div class="dlg-head">
      <h3 class="dlg-title">Rest</h3>
      <button class="icon-btn" id="restClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div class="card">
        <div class="small muted">Choose a rest action.</div>
        <div style="height:12px"></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="restShortBtn" type="button">Open Short Rest</button>
          <button class="btn primary" id="restLongBtn" type="button">Apply Long Rest</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Coin adjust dialog -->
  <dialog id="coinAdjustDialog" aria-label="Adjust coin amount">
    <div class="dlg-head">
      <h3 class="dlg-title" id="coinAdjustTitle">Adjust Coin</h3>
      <button class="icon-btn" id="coinAdjustClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div class="card">
        <div class="small muted" id="coinAdjustHint">Update the amount for this coin type.</div>
        <div style="height:12px"></div>
        <div class="row">
          <div class="small">Current</div>
          <div style="font-weight:900;" id="coinAdjustCurrent">0</div>
        </div>
        <div style="height:12px"></div>
        <div class="seg" id="coinAdjustMode" role="group" aria-label="Coin adjustment mode">
          <button type="button" data-coin-mode="set" aria-pressed="true">Set</button>
          <button type="button" data-coin-mode="add" aria-pressed="false">Add</button>
          <button type="button" data-coin-mode="remove" aria-pressed="false">Remove</button>
        </div>
        <div style="height:12px"></div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <input class="select" id="coinAdjustValue" type="number" min="0" step="1" inputmode="numeric" aria-label="Coin amount" />
          <button class="btn primary" id="coinAdjustApply" type="button">Apply</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Attunement detail dialog -->
  <dialog id="attuneDialog" aria-label="Attunement detail">
    <div class="dlg-head">
      <h3 class="dlg-title" id="attuneDialogTitle">Attunement</h3>
      <button class="icon-btn" id="attuneClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div class="card">
        <div class="small muted" id="attuneDialogBrief"></div>
        <div style="height:10px"></div>
        <div id="attuneDialogDetail"></div>
      </div>
    </div>
  </dialog>

  <!-- Status dialog -->
  <dialog id="statusDialog" aria-label="Status and conditions">
    <div class="dlg-head">
      <h3 class="dlg-title">Status</h3>
      <button class="icon-btn" id="statusClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div class="status-layout">
        <div>
          <div class="card">
            <h4>Conditions</h4>
            <div class="small">Click a condition to add it with a duration.</div>
            <div class="cond-list" id="condList"></div>
          </div>

          <div style="height:10px"></div>

          <div class="card">
            <h4>Exhaustion</h4>
            <div class="small">Set exhaustion level (0â€“6). Included in Status display.</div>
            <div style="display:flex; gap:10px; align-items:center; margin-top:8px;">
              <select class="select" id="exhaustSel" aria-label="Exhaustion level">
                <option value="0">0 â€” None</option>
                <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                <option value="4">4</option><option value="5">5</option><option value="6">6</option>
              </select>
            </div>
          </div>
        </div>

        <div class="card">
          <h4>Active Statuses</h4>
          <div class="small">Ordered by shortest remaining duration.</div>
          <div class="status-current" id="currentStatusList"></div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="row">
        <button class="btn danger" id="clearStatusBtn" type="button">Clear All</button>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn" id="cancelStatusBtn" type="button">Close</button>
        </div>
      </div>
    </div>
  </dialog>

  <dialog id="statusAddDialog" aria-label="Add condition duration">
    <div class="dlg-head">
      <h3 class="dlg-title" id="statusAddTitle">Add Condition</h3>
      <button class="icon-btn" id="statusAddClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div class="card">
        <div class="small muted" id="statusAddDesc"></div>
        <div style="height:12px"></div>
        <div class="field" style="justify-content:flex-start;">
          <label style="min-width:90px;">Duration</label>
          <input class="amt" id="statusAddValue" type="number" min="1" value="1" inputmode="numeric" style="width:90px;" />
          <select class="select" id="statusAddUnit" aria-label="Duration unit">
            <option value="turns">Turns</option>
            <option value="seconds">Seconds</option>
            <option value="minutes">Minutes</option>
            <option value="hours">Hours</option>
            <option value="days">Days</option>
            <option value="indefinite">Indefinite</option>
            <option value="permanent">Permanent</option>
          </select>
        </div>
        <div style="height:12px"></div>
        <div style="display:flex; justify-content:flex-end;">
          <button class="btn primary" id="statusAddApply" type="button">Add Status</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Short Rest dialog -->
  <dialog id="shortRestDialog" aria-label="Short rest tools">
    <div class="dlg-head">
      <h3 class="dlg-title">Short Rest</h3>
      <button class="icon-btn" id="shortRestClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div class="card">
        <h4>Hit Dice</h4>
        <div class="small">
          Spend hit dice to heal. Each die heals <strong>roll + Con mod</strong>.
        </div>

        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px;">
          <span class="tag">Die: <span class="num" id="hdDieLabel">d8</span></span>
          <span class="tag">Remaining: <span class="num" id="hdRemain">â€”</span>/<span class="num" id="hdTotal">â€”</span></span>
          <span class="tag">Con Mod: <span class="num" id="hdCon">â€”</span></span>
        </div>

        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px;">
          <label class="small" for="hdSpend">Spend</label>
          <input class="amt" id="hdSpend" type="number" min="0" value="1" inputmode="numeric" />
          <button class="btn primary" id="rollHdBtn" type="button">Roll &amp; Heal</button>
        </div>

        <div class="small" id="hdResult" style="margin-top:10px;"></div>
      </div>

      <div style="height:12px"></div>

      <div class="row">
        <div class="small">Completing the rest applies short-rest resets (example: Wild Shape).</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn" id="shortRestCancel" type="button">Close</button>
          <button class="btn primary" id="completeShortRestBtn" type="button">Complete Short Rest</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Settings dialog -->
  <dialog id="settingsDialog" aria-label="Settings">
    <div class="dlg-head">
      <h3 class="dlg-title">Settings</h3>
      <button class="icon-btn" id="settingsClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div style="font-weight:950;">Theme</div>
      <div class="muted" style="font-size:12px; margin-top:4px;">Choose a palette. Saved to localStorage.</div>

      <div class="radio-row" role="radiogroup" aria-label="Theme selection">
        <label class="radio"><input type="radio" name="theme" value="midnight" /> Midnight</label>
        <label class="radio"><input type="radio" name="theme" value="parchment" /> Parchment</label>
        <label class="radio"><input type="radio" name="theme" value="forest" /> Forest</label>
      </div>

      <div class="toggle">
        <div>
          <strong>Wide Screen</strong>
          <div class="muted" style="font-size:12px; margin-top:4px;">Let the sheet expand to full screen width.</div>
        </div>
        <label class="switch" for="wideToggle">
          <input id="wideToggle" type="checkbox" />
          <span>Enabled</span>
        </label>
      </div>

      <div class="toggle">
        <div>
          <strong>Debug Mode</strong>
          <div class="muted" style="font-size:12px; margin-top:4px;">Show a debug panel with logs and data fetch status.</div>
        </div>
        <label class="switch" for="debugToggle">
          <input id="debugToggle" type="checkbox" />
          <span>Enabled</span>
        </label>
      </div>

      

      <div style="height:12px"></div>

      <div class="card">
        <h4>Spell Cache</h4>
        <div class="small">The sheet can cache spell details for offline use (Info button + spell summaries).</div>
        <div class="row" style="align-items:center; justify-content:space-between; margin-top:10px;">
          <div class="small muted" id="spellCacheStatus">Cache: not loaded</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
            <button class="btn" id="refreshSpellCacheBtn" type="button">Re-download spells</button>
            <button class="btn" id="clearSpellCacheBtn" type="button">Clear spell cache</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h4>Progress Mode</h4>
        <div class="small">Choose milestone or XP progression for the main view.</div>
        <div class="progress-toggle" style="margin-top:10px;">
          <div class="seg" role="group" aria-label="Progress toggle">
            <button id="btnModeMilestone" type="button" aria-pressed="true">Milestone</button>
            <button id="btnModeXP" type="button" aria-pressed="false">XP</button>
          </div>
          <span class="tag" id="progressValue">Milestone</span>
        </div>
      </div>

      <div class="card">
        <h4>Character Data</h4>
        <div class="small">Export your character as JSON or import a saved file.</div>
        <div class="row" style="margin-top:10px; justify-content:flex-start;">
          <button class="btn" id="exportCharacterBtn" type="button">Export JSON</button>
          <label class="btn" for="importCharacterInput">Import JSON</label>
          <input id="importCharacterInput" type="file" accept="application/json" style="display:none;" />
        </div>
        <div style="height:8px"></div>
        <button class="btn danger" id="deleteCharacterBtn" type="button">Delete Character</button>
        <div class="small muted" style="margin-top:6px;">Type "delete" to confirm wiping all data.</div>
      </div>

      <div style="height:12px"></div>

      <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
        <button class="btn" id="resetTheme" type="button">Reset</button>
        <button class="btn primary" id="saveTheme" type="button">Save</button>
      </div>
    </div>
  </dialog>

  <!-- Portrait edit dialog -->
  <dialog id="portraitDialog" aria-label="Edit portrait">
    <div class="dlg-head">
      <h3 class="dlg-title">Portrait</h3>
      <button class="icon-btn" id="portraitClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div class="portrait-editor-grid">
        <div>
          <div class="card">
            <h4>Image URL</h4>
            <div class="small">Paste a new portrait URL to replace the image.</div>
            <div style="display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap;">
              <input class="select" id="portraitUrl" type="url" placeholder="https://..." />
              <button class="btn primary" id="portraitApplyUrl" type="button">Load</button>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="card">
            <h4>Adjustments</h4>
            <div class="field" style="margin-top:8px;">
              <label>Zoom</label>
              <div style="display:flex; align-items:center; gap:8px;">
                <input id="portraitZoom" type="range" min="0.8" max="2.4" step="0.01" style="width:180px;">
                <span class="val" id="portraitZoomVal">1.00</span>
              </div>
            </div>
            <div class="field" style="margin-top:8px;">
              <label>Rotate</label>
              <div style="display:flex; align-items:center; gap:8px;">
                <input id="portraitRotate" type="range" min="-15" max="15" step="1" style="width:180px;">
                <span class="val" id="portraitRotateVal">0Â°</span>
              </div>
            </div>
            <div class="field" style="margin-top:8px;">
              <label>Position X</label>
              <div style="display:flex; align-items:center; gap:8px;">
                <input id="portraitPosX" type="range" min="-40" max="40" step="1" style="width:180px;">
                <span class="val" id="portraitPosXVal">0%</span>
              </div>
            </div>
            <div class="field" style="margin-top:8px;">
              <label>Position Y</label>
              <div style="display:flex; align-items:center; gap:8px;">
                <input id="portraitPosY" type="range" min="-40" max="40" step="1" style="width:180px;">
                <span class="val" id="portraitPosYVal">0%</span>
              </div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
              <button class="btn" id="portraitReset" type="button">Reset</button>
            </div>
          </div>
        </div>

        <div>
          <div class="portrait-preview" id="portraitPreview" aria-label="Portrait position preview">
            <img class="portrait-img" id="portraitPreviewImg" alt="Portrait preview" />
            <div class="portrait-overlay"></div>
            <div class="portrait-vignette"></div>
          </div>
          <div class="small" style="margin-top:8px;">
            Drag inside the preview to reposition. Position: <strong id="portraitPosLabel">0% / 0%</strong>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div class="small">Changes apply instantly to the main portrait &amp; thumbnail.</div>
        <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
          <button class="btn primary" id="portraitDone" type="button">Done</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Add custom skill dialog -->
  <dialog id="addSkillDialog" aria-label="Add custom skill">
    <div class="dlg-head">
      <h3 class="dlg-title">Add Skill</h3>
      <button class="icon-btn" id="addSkillClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div class="card">
        <h4>Skill Details</h4>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
          <div class="field" style="justify-content:flex-start;">
            <label style="min-width:110px;">Name</label>
            <input id="newSkillName" class="select" placeholder="e.g., Tactics" />
          </div>
          <div class="field" style="justify-content:flex-start;">
            <label style="min-width:110px;">Ability</label>
            <select id="newSkillAbility" class="select"></select>
          </div>
        </div>
        <div class="small" style="margin-top:10px;">Proficiency can be changed later by editing the data model; this template defaults to â€œnoneâ€.</div>
      </div>
      <div style="height:12px"></div>
      <div class="row">
        <button class="btn" id="addSkillCancel" type="button">Cancel</button>
        <button class="btn primary" id="addSkillConfirm" type="button">Add Skill</button>
      </div>
    </div>
  </dialog>

  <!-- Add custom ability dialog -->
  <dialog id="addAbilityDialog" aria-label="Add custom ability">
    <div class="dlg-head">
      <h3 class="dlg-title">Add Ability</h3>
      <button class="icon-btn" id="addAbilityClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div class="card">
        <h4>Ability Details</h4>
        <div class="small">Creates a new ability score card. (Example: â€œLCKâ€ or â€œSANâ€.)</div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
          <div class="field" style="justify-content:flex-start;">
            <label style="min-width:110px;">Label</label>
            <input id="newAbilityLabel" class="select" placeholder="e.g., LCK" />
          </div>
          <div class="field" style="justify-content:flex-start;">
            <label style="min-width:110px;">Score</label>
            <input id="newAbilityScore" type="number" min="1" value="10" class="select" style="font-family:var(--mono);" />
          </div>
        </div>
      </div>
      <div style="height:12px"></div>
      <div class="row">
        <button class="btn" id="addAbilityCancel" type="button">Cancel</button>
        <button class="btn primary" id="addAbilityConfirm" type="button">Add Ability</button>
      </div>
    </div>
  </dialog>

  <!-- FABs: Lock + Settings -->
  <div class="fab-wrap" aria-label="Quick controls">
    <button class="fab" id="diceFab" type="button" aria-label="Open dice roller" aria-pressed="false" title="Dice Roller">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M4 8.2 12 3l8 5.2v7.6L12 21l-8-5.2V8.2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        <path d="M8.5 9.5h.01M12 12h.01M15.5 14.5h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
    <button class="fab" id="lockFab" type="button" aria-label="Toggle edit lock" aria-pressed="false" title="Unlock to edit">
      <svg id="lockIconClosed" width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M7 11V8a5 5 0 0 1 10 0v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M7 11h10a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
      </svg>
      <svg id="lockIconOpen" width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="display:none;">
        <path d="M17 11V8a5 5 0 0 0-9.7-1.7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M7 11h10a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
      </svg>
    </button>

    <button class="fab" id="settingsFab" type="button" aria-label="Open settings" title="Settings">
      <span aria-hidden="true" class="gear">âš™</span>
    </button>
  </div>

  <div class="debug-panel" id="debugPanel" data-active="false" aria-live="polite">
    <div class="debug-panel-title">Debug Log</div>
    <div id="debugLog"></div>
  </div>

  <div class="dice-panel" id="dicePanel" data-open="false" aria-label="Dice roller">
    <div class="dice-head" id="diceDragHandle">
      <div class="note-title">Dice Roller</div>
      <button class="icon-btn" id="diceClose" type="button" aria-label="Close dice roller">âœ•</button>
    </div>
    <div class="dice-body">
      <div class="dice-set-grid" id="diceSetGrid" aria-label="Dice sets">
        <div class="dice-set" data-sides="4">
          <div class="dice-label">d4</div>
          <label class="small" for="diceCount4">#</label>
          <input class="amt dice-count" id="diceCount4" type="number" min="0" value="0" inputmode="numeric" />
          <label class="small" for="diceMod4">Mod</label>
          <input class="amt dice-mod" id="diceMod4" type="number" value="0" inputmode="numeric" />
        </div>
        <div class="dice-set" data-sides="6">
          <div class="dice-label">d6</div>
          <label class="small" for="diceCount6">#</label>
          <input class="amt dice-count" id="diceCount6" type="number" min="0" value="0" inputmode="numeric" />
          <label class="small" for="diceMod6">Mod</label>
          <input class="amt dice-mod" id="diceMod6" type="number" value="0" inputmode="numeric" />
        </div>
        <div class="dice-set" data-sides="8">
          <div class="dice-label">d8</div>
          <label class="small" for="diceCount8">#</label>
          <input class="amt dice-count" id="diceCount8" type="number" min="0" value="0" inputmode="numeric" />
          <label class="small" for="diceMod8">Mod</label>
          <input class="amt dice-mod" id="diceMod8" type="number" value="0" inputmode="numeric" />
        </div>
        <div class="dice-set" data-sides="10">
          <div class="dice-label">d10</div>
          <label class="small" for="diceCount10">#</label>
          <input class="amt dice-count" id="diceCount10" type="number" min="0" value="0" inputmode="numeric" />
          <label class="small" for="diceMod10">Mod</label>
          <input class="amt dice-mod" id="diceMod10" type="number" value="0" inputmode="numeric" />
        </div>
        <div class="dice-set" data-sides="12">
          <div class="dice-label">d12</div>
          <label class="small" for="diceCount12">#</label>
          <input class="amt dice-count" id="diceCount12" type="number" min="0" value="0" inputmode="numeric" />
          <label class="small" for="diceMod12">Mod</label>
          <input class="amt dice-mod" id="diceMod12" type="number" value="0" inputmode="numeric" />
        </div>
        <div class="dice-set" data-sides="20">
          <div class="dice-label">d20</div>
          <label class="small" for="diceCount20">#</label>
          <input class="amt dice-count" id="diceCount20" type="number" min="0" value="1" inputmode="numeric" />
          <label class="small" for="diceMod20">Mod</label>
          <input class="amt dice-mod" id="diceMod20" type="number" value="0" inputmode="numeric" />
        </div>
        <div class="dice-set" data-sides="100">
          <div class="dice-label">d100</div>
          <label class="small" for="diceCount100">#</label>
          <input class="amt dice-count" id="diceCount100" type="number" min="0" value="0" inputmode="numeric" />
          <label class="small" for="diceMod100">Mod</label>
          <input class="amt dice-mod" id="diceMod100" type="number" value="0" inputmode="numeric" />
        </div>
        <div class="dice-set dice-set-custom" data-custom="true">
          <div class="dice-label" id="diceCustomLabel">d?</div>
          <label class="small" for="diceCustomSides">Sides</label>
          <input class="amt dice-sides" id="diceCustomSides" type="number" min="2" value="20" inputmode="numeric" />
          <label class="small" for="diceCountCustom">#</label>
          <input class="amt dice-count" id="diceCountCustom" type="number" min="0" value="0" inputmode="numeric" />
          <label class="small" for="diceModCustom">Mod</label>
          <input class="amt dice-mod" id="diceModCustom" type="number" value="0" inputmode="numeric" />
        </div>
      </div>
      <div class="dice-actions">
        <button class="btn primary" id="diceRollBtn" type="button">Roll</button>
        <button class="btn" id="diceAdvBtn" type="button">Advantage</button>
        <button class="btn" id="diceDisBtn" type="button">Disadvantage</button>
      </div>
      <div class="dice-results">
        <div class="small dice-summary" id="diceSummary">Ready to roll.</div>
        <div class="small" id="diceDetail"></div>
        <div class="dice-history" id="diceHistory"></div>
      </div>
    </div>
  </div>

  <div class="dice-roll-animation" id="diceRollAnimation" aria-hidden="true">
    <img class="dice-cube" alt="D20" src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/84/Twenty_sided_dice.svg/330px-Twenty_sided_dice.svg.png" />
    <img class="dice-cube" alt="D20" src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/84/Twenty_sided_dice.svg/330px-Twenty_sided_dice.svg.png" />
    <img class="dice-cube" alt="D20" src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/84/Twenty_sided_dice.svg/330px-Twenty_sided_dice.svg.png" />
  </div>
  <div class="dice-roll-flash" id="diceRollFlash" aria-hidden="true"></div>
  </div>

  <script>
    /**********************************************************************
     * State
     **********************************************************************/
    const PORTRAIT_URL = "https://i.pinimg.com/736x/1d/bc/14/1dbc1450cd029714c234af43363dd87b.jpg";

    const XP_THRESHOLDS = [
      { lvl:1, xp:0 },
      { lvl:2, xp:300 },
      { lvl:3, xp:900 },
      { lvl:4, xp:2700 },
      { lvl:5, xp:6500 },
      { lvl:6, xp:14000 },
      { lvl:7, xp:23000 },
      { lvl:8, xp:34000 },
      { lvl:9, xp:48000 },
      { lvl:10, xp:64000 },
      { lvl:11, xp:85000 },
      { lvl:12, xp:100000 },
      { lvl:13, xp:120000 },
      { lvl:14, xp:140000 },
      { lvl:15, xp:165000 },
      { lvl:16, xp:195000 },
      { lvl:17, xp:225000 },
      { lvl:18, xp:265000 },
      { lvl:19, xp:305000 },
      { lvl:20, xp:355000 }
    ];

    const CONDITIONS = [
      "Blinded","Charmed","Deafened","Frightened","Grappled","Incapacitated",
      "Invisible","Paralyzed","Petrified","Poisoned","Prone","Restrained",
      "Stunned","Unconscious"
    ];

    const CONDITION_DETAILS = {
      Blinded: "A blinded creature canâ€™t see and automatically fails any ability check that requires sight. Attack rolls against it have advantage, and its attack rolls have disadvantage.",
      Charmed: "A charmed creature canâ€™t attack the charmer or target the charmer with harmful abilities or magical effects. The charmer has advantage on social checks to interact with it.",
      Deafened: "A deafened creature canâ€™t hear and automatically fails any ability check that requires hearing.",
      Frightened: "A frightened creature has disadvantage on ability checks and attack rolls while the source of fear is in line of sight, and it canâ€™t willingly move closer to the source.",
      Grappled: "A grappled creatureâ€™s speed becomes 0, and it canâ€™t benefit from bonuses to speed. The condition ends if the grappler is incapacitated or the creature is moved away.",
      Incapacitated: "An incapacitated creature canâ€™t take actions or reactions.",
      Invisible: "An invisible creature is impossible to see without special senses. Attack rolls against it have disadvantage, and its attack rolls have advantage.",
      Paralyzed: "A paralyzed creature is incapacitated and canâ€™t move or speak. It automatically fails Str/Dex saves, attack rolls against it have advantage, and hits are critical within 5 ft.",
      Petrified: "A petrified creature is transformed to stone, is incapacitated, canâ€™t move or speak, is unaware, automatically fails Str/Dex saves, and has resistance to all damage.",
      Poisoned: "A poisoned creature has disadvantage on attack rolls and ability checks.",
      Prone: "A prone creatureâ€™s only movement is to crawl unless it stands up. Attack rolls against it have advantage within 5 ft, otherwise disadvantage.",
      Restrained: "A restrained creatureâ€™s speed becomes 0, attack rolls against it have advantage, its attack rolls have disadvantage, and it has disadvantage on Dex saves.",
      Stunned: "A stunned creature is incapacitated, canâ€™t move, can only speak falteringly, automatically fails Str/Dex saves, and attack rolls against it have advantage.",
      Unconscious: "An unconscious creature is incapacitated, prone, unaware, automatically fails Str/Dex saves, and attacks have advantage; hits are critical within 5 ft."
    };

    const CONDITION_SEVERITY = [
      "Unconscious","Petrified","Paralyzed","Stunned","Restrained","Blinded",
      "Poisoned","Frightened","Charmed","Grappled","Prone","Incapacitated","Invisible","Deafened"
    ];

    const DURATION_UNITS = {
      turns: { label: "turns", seconds: 6 },
      seconds: { label: "seconds", seconds: 1 },
      minutes: { label: "minutes", seconds: 60 },
      hours: { label: "hours", seconds: 3600 },
      days: { label: "days", seconds: 86400 },
      indefinite: { label: "indefinite", seconds: Infinity },
      permanent: { label: "permanent", seconds: Infinity }
    };

    const baseSkills = [
      { name:"Acrobatics",       abil:"dex", custom:false },
      { name:"Animal Handling",  abil:"wis", custom:false },
      { name:"Arcana",           abil:"int", custom:false },
      { name:"Athletics",        abil:"str", custom:false },
      { name:"Deception",        abil:"cha", custom:false },
      { name:"History",          abil:"int", custom:false },
      { name:"Insight",          abil:"wis", custom:false },
      { name:"Intimidation",     abil:"cha", custom:false },
      { name:"Investigation",    abil:"int", custom:false },
      { name:"Medicine",         abil:"wis", custom:false },
      { name:"Nature",           abil:"int", custom:false },
      { name:"Perception",       abil:"wis", custom:false },
      { name:"Performance",      abil:"cha", custom:false },
      { name:"Persuasion",       abil:"cha", custom:false },
      { name:"Religion",         abil:"int", custom:false },
      { name:"Sleight of Hand",  abil:"dex", custom:false },
      { name:"Stealth",          abil:"dex", custom:false },
      { name:"Survival",         abil:"wis", custom:false }
    ];

    const state = {
      name: "Elaria Thornbloom",
      tagline: "Of the order of History",
      race: "Wood Elf",
      classSummary: "Druid 10",
      ac: 16,
      init: +3,
      speed: 35,
      prof: +4,

      hp: { cur: 73, max: 73, temp: 0 },

      status: { conditions: [], exhaustion: 0 },

      coins: { pp: 2, gp: 121, ep: 0, sp: 35, cp: 70 },
      customCurrencies: [],

      hitDice: { total: 10, remaining: 7, die: 8, conMod: 2 },
      wildShape: { max: 2, remaining: 1 },

      abilities: [
        { key:"str", label:"STR", score:10, saveProf:false, custom:false },
        { key:"dex", label:"DEX", score:16, saveProf:false, custom:false },
        { key:"con", label:"CON", score:14, saveProf:false, custom:false },
        { key:"int", label:"INT", score:12, saveProf:false, custom:false },
        { key:"wis", label:"WIS", score:15, saveProf:true, custom:false },
        { key:"cha", label:"CHA", score:10, saveProf:false, custom:false }
      ],

      skills: [...baseSkills],
      skillProfs: {
        "Perception": 2,
        "Nature": 2,
        "Insight": 2,
        "Survival": 2,
        "Animal Handling": 2,
        "Medicine": 2
      },

      xpMode: "milestone", // "milestone" | "xp"
      xp: 0,
      xpLevel: 1,

      spells: {
        dc: 16,
        atk: +8,
        prepared: 14,
        list: [
          { lvl:"Cantrip", name:"Guidance", note:"Add d4 to ability checks." },
          { lvl:"Cantrip", name:"Produce Flame", note:"Light / ranged fire." },
          { lvl:"1st", name:"Faerie Fire", note:"Outline targets; advantage." },
          { lvl:"2nd", name:"Pass without Trace", note:"+10 Stealth aura." },
          { lvl:"3rd", name:"Call Lightning", note:"Sustained storm damage." },
          { lvl:"4th", name:"Polymorph", note:"Transform creature." },
          { lvl:"5th", name:"Greater Restoration", note:"End major conditions." }
        ]
      },

      combat: {
        actions: [
          { name:"Shillelagh (Quarterstaff)", toHit:"+8", dmg:"1d8+4 bludgeoning", notes:"Wis-based via Shillelagh" },
          { name:"Produce Flame", toHit:"+8", dmg:"2d8 fire", notes:"60 ft range" },
          { name:"Entangle", toHit:"DC 16", dmg:"Restrained (save)", notes:"Difficult terrain" }
        ],
        bonus: [
          "Wild Shape â€” transform (if feature allows).",
          "Healing Word â€” bonus action heal (range).",
          "Shillelagh â€” imbue staff/club."
        ],
        reactions: [
          "Opportunity Attack â€” melee attack when a creature leaves reach.",
          "Readied Action â€” reaction to trigger a prepared action."
        ],
        free: [
          "Speak a few words.",
          "Drop an item.",
          "Interact with one object (DM dependent)."
        ]
      },

      inventory: {
        attunements: [
          { item: "Moonstone Charm", notes:"Attuned â€¢ faint warmth near fey crossings", detail:"A polished charm that hums softly near fey crossings. Grants a faint lunar glow in moonlight." },
          { item: "Ring of Warmth", notes:"Attuned â€¢ cold resistance (example)", detail:"Grants resistance to cold damage. Keeps the wearer comfortable in frigid climates." },
          { item: "", notes:"(empty)", detail:"No attunement item slotted." }
        ],
        equipped: ["", "", "", "", "", ""],
        sections: [
          { id: "attunement", type: "attunement", title: "Attunement", span: 3, lockedTitle: true },
          { id: "equipped", type: "equipped", title: "Equipped", span: 3 },
          {
            id: "equipment",
            type: "detailed",
            title: "Equipment",
            span: 2,
            items: [
              { name:"Quarterstaff", qty: 1, notes:"Focus (wooden staff)" },
              { name:"Leather Armor", qty: 1, notes:"AC baseline" },
              { name:"Explorerâ€™s Pack", qty: 1, notes:"Bedroll, rations, etc." },
              { name:"Herbalism Kit", qty: 1, notes:"Poultices & remedies" }
            ]
          },
          {
            id: "magic",
            type: "basic",
            title: "Magic & Special",
            span: 1,
            items: [
              "Cloak of the Grove (flavor) â€” smells faintly of cedar.",
              "Stone charm â€” warms near fey crossings."
            ]
          },
          {
            id: "tools",
            type: "basic",
            title: "Tools / Kits",
            span: 1,
            items: [
              "Herbalism Kit",
              "Calligrapherâ€™s Supplies"
            ]
          }
        ]
      },

      notesTabs: [
        {
          id: "notes",
          label: "Notes",
          sections: [
            {
              id: "notes-main",
              title: "Notes",
              collapsed: false,
              notes: [
                { id: "note-1", title:"Travel Prep", body:"Keep a slot for Speak with Animals when traveling.", starred:false, starColor:"", status:null },
                { id: "note-2", title:"Fey Signs", body:"Mark fey signs near the old stone bridge.", starred:false, starColor:"", status:null },
                { id: "note-3", title:"Debts", body:"Owes a favor to the apothecary in Westhollow.", starred:false, starColor:"", status:null }
              ]
            }
          ]
        },
        {
          id: "people",
          label: "People",
          sections: [
            { id: "people-main", title: "Notes", collapsed: false, notes: [] }
          ]
        },
        {
          id: "locations",
          label: "Locations",
          sections: [
            { id: "locations-main", title: "Notes", collapsed: false, notes: [] }
          ]
        },
        {
          id: "quests",
          label: "Quests",
          sections: [
            { id: "quests-main", title: "Notes", collapsed: false, notes: [] }
          ]
        },
        {
          id: "items",
          label: "Items",
          sections: [
            { id: "items-main", title: "Notes", collapsed: false, notes: [] }
          ]
        },
        {
          id: "other",
          label: "Other",
          sections: [
            { id: "other-main", title: "Notes", collapsed: false, notes: [] }
          ]
        }
      ],
      notesActiveTabId: "notes",

      portrait: {
        url: PORTRAIT_URL,
        zoom: 1.00,
        x: 0,
        y: 0,
        rotate: 0
      },

      settings: {
        theme: "midnight",
        wide: false,
        editUnlocked: false,
        debugEnabled: false
      }
    };

    const diceState = {
      history: []
    };
    let cheatRollQueued = false;
    const debugState = {
      entries: []
    };

    function debugLog(message, extra){
      const ts = new Date().toLocaleTimeString();
      let line = `[${ts}] ${message}`;
      if (extra){
        if (extra instanceof Error){
          line += ` (${extra.message})`;
        }else if (typeof extra === "string"){
          line += ` (${extra})`;
        }else{
          try{ line += ` ${JSON.stringify(extra)}`; }catch{}
        }
      }
      debugState.entries.push(line);
      if (debugState.entries.length > 200){
        debugState.entries.shift();
      }
      renderDebugLog();
    }

    function renderDebugLog(){
      const logEl = document.getElementById("debugLog");
      const panel = document.getElementById("debugPanel");
      if (!logEl || !panel) return;
      logEl.textContent = debugState.entries.join("\n");
      panel.dataset.active = state.settings.debugEnabled ? "true" : "false";
    }

    /**********************************************************************
     * Helpers
     **********************************************************************/
    const $ = (sel, root=document) => root.querySelector(sel);
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function modFromScore(score){ return Math.floor((score - 10) / 2); }
    function formatSigned(n){ return (n>=0? "+" : "") + n; }
    function escapeHTML(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function normalizeNumberText(s){
      const t = String(s).trim();
      const cleaned = t.replace(/[^\d+\-]/g, "");
      const n = parseInt(cleaned, 10);
      return Number.isFinite(n) ? n : null;
    }
    function formatSpellLevel(level){
      if (level === 0) return "Cantrip";
      const suffix = level === 1 ? "st" : level === 2 ? "nd" : level === 3 ? "rd" : "th";
      return `${level}${suffix}`;
    }
    function buildTopbarNameHTML(name){
      const words = String(name || "").trim().split(/\s+/).filter(Boolean);
      if (words.length <= 1){
        return `<span class="id-name-line">${escapeHTML(name || "")}</span>`;
      }
      const splitIndex = words.length === 2 ? 1 : Math.ceil(words.length / 2);
      const firstLine = words.slice(0, splitIndex).join(" ");
      const secondLine = words.slice(splitIndex).join(" ");
      return `
        <span class="id-name-line">${escapeHTML(firstLine)}</span>
        <span class="id-name-line">${escapeHTML(secondLine)}</span>
      `.trim();
    }

    // currency values in gp
    const DEFAULT_CURRENCIES = [
      { k:"pp", name:"Platinum", val: 10, icon:"https://i.imgur.com/ve9Wxm3.png" },
      { k:"gp", name:"Gold",     val: 1,  icon:"https://i.imgur.com/bbdjD7q.png" },
      { k:"ep", name:"Electrum", val: 0.5, icon:"https://i.imgur.com/kInHPBm.png" },
      { k:"sp", name:"Silver",   val: 0.1, icon:"https://i.imgur.com/WsWriqq.png" },
      { k:"cp", name:"Copper",   val: 0.01, icon:"https://i.imgur.com/szyG7Ec.png" }
    ];
    function getCurrencies(){
      return [...DEFAULT_CURRENCIES, ...(state.customCurrencies || [])];
    }
    function getCurrency(key){
      return getCurrencies().find(c => c.k === key);
    }
    function coinTotalGP(coins){
      let t = 0;
      for (const c of getCurrencies()) t += (coins[c.k] || 0) * c.val;
      return Math.round(t * 100) / 100;
    }

    function getAbilityByKey(key){
      return state.abilities.find(a => a.key === key);
    }

    /**********************************************************************
     * XP
     **********************************************************************/
    function levelFromXP(xp){
      let lvl = 1;
      for (const row of XP_THRESHOLDS){
        if (xp >= row.xp) lvl = row.lvl;
      }
      return lvl;
    }
    function renderXPBox(){
      const xp = Math.max(0, state.xp|0);
      const rawLevel = parseInt($("#mainTotalLevel").textContent, 10);
      const lvl = clamp(Number.isFinite(rawLevel) ? rawLevel : state.xpLevel || 1, 1, 20);
      state.xpLevel = lvl;
      const nextRow = XP_THRESHOLDS.find(r => r.lvl === Math.min(20, lvl + 1));
      const next = nextRow ? nextRow.xp : XP_THRESHOLDS[XP_THRESHOLDS.length - 1].xp;
      const toNext = Math.max(0, next - xp);

      $("#xpCurrent").value = xp;
      $("#xpLevel").textContent = lvl;
      $("#xpNext").textContent = next;
      $("#xpToNext").textContent = toNext;

      $("#xpLevelUpBtn").style.display = nextRow && xp >= nextRow.xp ? "inline-flex" : "none";
    }
    function applyXPMode(){
      const isXP = state.xpMode === "xp";
      $("#xpCard").style.display = isXP ? "block" : "none";
      $("#progressValue").textContent = isXP ? "XP" : "Milestone";
      $("#btnModeMilestone").setAttribute("aria-pressed", isXP ? "false" : "true");
      $("#btnModeXP").setAttribute("aria-pressed", isXP ? "true" : "false");
      if (isXP) renderXPBox();
    }

    /**********************************************************************
     * Status
     **********************************************************************/
    function getActiveStatusList(){
      return getStatusEntries()
        .sort((a, b)=> a.remaining - b.remaining)
        .map(entry => entry.label);
    }
    function getStatusEntries(){
      const list = state.status.conditions.map((c)=>({
        name: c.name,
        duration: formatStatusDuration(c),
        label: `${c.name}${formatStatusDuration(c) ? ` (${formatStatusDuration(c)})` : ""}`,
        remaining: getStatusRemainingValue(c)
      }));
      if (state.status.exhaustion > 0){
        list.push({
          name: `Exhaustion ${state.status.exhaustion}`,
          duration: "permanent",
          label: `Exhaustion ${state.status.exhaustion}`,
          remaining: Infinity
        });
      }
      return list;
    }
    function formatStatusDuration(status){
      const unit = status.durationUnit || "indefinite";
      if (unit === "indefinite" || unit === "permanent") return DURATION_UNITS[unit].label;
      const value = status.durationValue || 0;
      const label = DURATION_UNITS[unit]?.label || unit;
      return `${value} ${label}`;
    }
    function getStatusRemainingValue(status){
      const unit = status.durationUnit || "indefinite";
      if (unit === "indefinite" || unit === "permanent") return Infinity;
      const seconds = DURATION_UNITS[unit]?.seconds ?? 0;
      const value = status.durationValue || 0;
      return value * seconds;
    }
    function summarizeStatus(active){
      if (!active.length) return "None";
      return active[0];
    }
    function getMostSeriousStatus(){
      if (!state.status.conditions.length){
        return state.status.exhaustion > 0 ? `Exhaustion ${state.status.exhaustion}` : "None";
      }
      const order = new Map(CONDITION_SEVERITY.map((name, idx)=>[name, idx]));
      const sorted = [...state.status.conditions].sort((a, b)=>{
        const aRank = order.has(a.name) ? order.get(a.name) : CONDITION_SEVERITY.length;
        const bRank = order.has(b.name) ? order.get(b.name) : CONDITION_SEVERITY.length;
        return aRank - bRank;
      });
      return sorted[0]?.name || "None";
    }
    function getToolbarStatusLabel(){
      const entries = getStatusEntries();
      if (!entries.length) return "None";
      const primary = state.status.conditions.length
        ? getMostSeriousStatus()
        : `Exhaustion ${state.status.exhaustion}`;
      if (entries.length > 1){
        return `${primary} +${entries.length - 1}`;
      }
      return primary;
    }
    function renderCurrentStatusList(){
      const list = $("#currentStatusList");
      if (!list) return;
      const entries = getStatusEntries().sort((a, b)=> a.remaining - b.remaining);
      if (!entries.length){
        list.innerHTML = `<div class="small muted">No active statuses.</div>`;
        return;
      }
      list.innerHTML = entries.map(entry => `
        <div class="status-item">
          <div class="name">${escapeHTML(entry.name)}</div>
          <div class="meta">${escapeHTML(entry.duration || "")}</div>
        </div>
      `).join("");
    }
    function normalizeStatusConditions(){
      if (!Array.isArray(state.status.conditions)) state.status.conditions = [];
      if (state.status.conditions.length && typeof state.status.conditions[0] === "string"){
        state.status.conditions = state.status.conditions.map((name)=>({
          name,
          durationUnit: "indefinite",
          durationValue: null,
          addedAt: Date.now()
        }));
      } else {
        state.status.conditions = state.status.conditions.map((cond)=>({
          name: cond.name || "Unknown",
          durationUnit: cond.durationUnit || "indefinite",
          durationValue: cond.durationUnit === "indefinite" || cond.durationUnit === "permanent" ? null : (cond.durationValue ?? 1),
          addedAt: cond.addedAt || Date.now()
        }));
      }
    }

    /**********************************************************************
     * Dice Roller
     **********************************************************************/
    let diceDrag = null;
    const diceFlashItems = [];
    let lastDiceFlashAt = 0;
    let diceFlashTimer = null;
    function toggleDicePanel(open){
      const panel = $("#dicePanel");
      const next = open ?? panel.dataset.open !== "true";
      panel.dataset.open = next ? "true" : "false";
      $("#diceFab").setAttribute("aria-pressed", next ? "true" : "false");
    }
    function renderDiceHistory(){
      const history = $("#diceHistory");
      history.innerHTML = diceState.history.length
        ? diceState.history.map(item => `<div class="dice-history-item">${item}</div>`).join("")
        : `<div class="dice-history-item">No rolls yet.</div>`;
    }
    function updateDiceCustomLabel(){
      const value = parseInt($("#diceCustomSides").value, 10);
      const label = Number.isFinite(value) && value > 1 ? `d${value}` : "d?";
      $("#diceCustomLabel").textContent = label;
    }
    function getDiceSets(){
      const sets = [];
      document.querySelectorAll("#diceSetGrid .dice-set").forEach((row)=>{
        const isCustom = row.dataset.custom === "true";
        const sidesInput = isCustom ? $("#diceCustomSides") : null;
        const sidesValue = isCustom ? parseInt(sidesInput.value, 10) : parseInt(row.dataset.sides, 10);
        const sides = Number.isFinite(sidesValue) ? sidesValue : 0;
        const count = Math.max(0, parseInt(row.querySelector(".dice-count").value, 10) || 0);
        const mod = parseInt(row.querySelector(".dice-mod").value, 10) || 0;
        if (count > 0 && sides > 1){
          sets.push({
            sides,
            count,
            mod,
            label: `d${sides}`
          });
        }
      });
      return sets;
    }
    function formatRollSpan(value, sides, chosen, showChoice){
      const classes = ["dice-roll"];
      if (value === sides) classes.push("is-max");
      if (value === 1) classes.push("is-min");
      if (showChoice && !chosen) classes.push("is-unused");
      if (chosen) classes.push("is-chosen");
      return `<span class="${classes.join(" ")}">${value}</span>`;
    }
    function toggleDiceAnimation(){
      const animation = $("#diceRollAnimation");
      animation.dataset.active = "false";
      void animation.offsetWidth;
      animation.dataset.active = "true";
      setTimeout(()=>{ animation.dataset.active = "false"; }, 5000);
    }
    function clearDiceFlash(){
      diceFlashItems.forEach(item=> item.remove());
      diceFlashItems.length = 0;
    }
    function flashDiceResult(total, allMax, allMin){
      const flash = $("#diceRollFlash");
      clearDiceFlash();
      lastDiceFlashAt = Date.now();
      if (diceFlashTimer){
        clearTimeout(diceFlashTimer);
        diceFlashTimer = null;
      }
      const alert = document.createElement("div");
      const inner = document.createElement("div");
      alert.className = "dice-roll-alert";
      inner.className = "dice-roll-flash-inner";
      inner.textContent = total;
      inner.classList.toggle("is-max", allMax);
      inner.classList.toggle("is-min", allMin);
      alert.appendChild(inner);
      flash.appendChild(alert);
      diceFlashItems.push(alert);
      diceFlashTimer = setTimeout(()=> dismissDiceFlash(), 5000);
    }
    function dismissDiceFlash(){
      if (!diceFlashItems.length) return;
      diceFlashItems.forEach(alert=>{
        if (alert.dataset.dismissed) return;
        alert.dataset.dismissed = "true";
        alert.classList.add("is-dismissed");
        alert.addEventListener("animationend", ()=> alert.remove(), { once: true });
      });
      diceFlashItems.length = 0;
    }
    function rollRandom(sides){
      return 1 + Math.floor(Math.random() * sides);
    }
    function rollTopTwo(sides){
      return sides - Math.floor(Math.random() * 2);
    }
    function queueCheatRoll(){
      cheatRollQueued = true;
    }
    function consumeCheatRoll(){
      const queued = cheatRollQueued;
      cheatRollQueued = false;
      return queued;
    }
    function rollDiceSets(sets, mode="normal", cheat=false, labelPrefix=""){
      if (!sets.length){
        $("#diceSummary").textContent = "Select at least one dice set to roll.";
        $("#diceSummary").classList.remove("is-max", "is-min");
        $("#diceDetail").textContent = "";
        return;
      }
      const modeLabel = mode === "adv" ? "Advantage" : mode === "dis" ? "Disadvantage" : "Roll";
      const setLabels = [];
      const detailRows = [];
      let grandTotal = 0;
      let allMax = true;
      let allMin = true;
      for (const set of sets){
        const rollsHtml = [];
        let setTotal = 0;
        for (let i = 0; i < set.count; i++){
          if (mode === "adv" || mode === "dis"){
            let rollA;
            let rollB;
            if (cheat){
              if (mode === "adv"){
                const highRoll = rollTopTwo(set.sides);
                const other = rollRandom(set.sides);
                if (Math.random() < 0.5){
                  rollA = highRoll;
                  rollB = other;
                } else {
                  rollA = other;
                  rollB = highRoll;
                }
              } else {
                rollA = rollTopTwo(set.sides);
                rollB = rollTopTwo(set.sides);
              }
            } else {
              rollA = rollRandom(set.sides);
              rollB = rollRandom(set.sides);
            }
            const chosen = mode === "adv" ? Math.max(rollA, rollB) : Math.min(rollA, rollB);
            setTotal += chosen;
            allMax = allMax && chosen === set.sides;
            allMin = allMin && chosen === 1;
            const first = formatRollSpan(rollA, set.sides, rollA === chosen, true);
            const second = formatRollSpan(rollB, set.sides, rollB === chosen, true);
            rollsHtml.push(`<span class="dice-roll-group">[${first}, ${second}]</span>`);
          } else {
            const roll = cheat ? rollTopTwo(set.sides) : rollRandom(set.sides);
            setTotal += roll;
            allMax = allMax && roll === set.sides;
            allMin = allMin && roll === 1;
            rollsHtml.push(formatRollSpan(roll, set.sides, true, false));
          }
        }
        setTotal += set.mod;
        grandTotal += setTotal;
        const modLabel = set.mod ? (set.mod > 0 ? `+${set.mod}` : `${set.mod}`) : "";
        const setLabel = `${set.count}d${set.sides}${modLabel}`;
        setLabels.push(setLabel);
        detailRows.push(`
          <div class="dice-detail-row">
            <div class="dice-detail-label">${escapeHTML(setLabel)}</div>
            <div class="dice-detail-rolls">${rollsHtml.join(" ")}</div>
            <div class="dice-detail-total">= ${setTotal}</div>
          </div>
        `);
      }
      const prefix = labelPrefix ? `${labelPrefix} (${modeLabel})` : modeLabel;
      const summaryText = `${prefix}: ${setLabels.join(" + ")} = ${grandTotal}`;
      const summaryEl = $("#diceSummary");
      summaryEl.textContent = summaryText;
      summaryEl.classList.toggle("is-max", allMax);
      summaryEl.classList.toggle("is-min", allMin);
      $("#diceDetail").innerHTML = detailRows.join("");
      const historyHtml = `
        <div class="dice-history-summary ${allMax ? "is-max" : allMin ? "is-min" : ""}">${escapeHTML(summaryText)}</div>
        <div class="dice-history-rolls">${detailRows.join("")}</div>
      `;
      diceState.history.unshift(historyHtml.trim());
      diceState.history = diceState.history.slice(0, 10);
      renderDiceHistory();
      toggleDiceAnimation();
      flashDiceResult(grandTotal, allMax, allMin);
    }
    function rollDice(mode="normal", options = {}){
      const sets = options.sets ?? getDiceSets();
      const cheat = options.cheat ?? consumeCheatRoll();
      rollDiceSets(sets, mode, cheat, options.label);
    }
    function rollPreset(label, mod, cheat){
      const cheatRoll = cheat ?? consumeCheatRoll();
      rollDiceSets([{ sides: 20, count: 1, mod, label: "d20" }], "normal", cheatRoll, label);
    }
    function getSkillBonus(name){
      const skill = state.skills.find(s => s.name === name);
      if (!skill) return 0;
      const abil = getAbilityByKey(skill.abil) || getAbilityByKey("int");
      const base = modFromScore(abil.score);
      const level = state.skillProfs[skill.name] ?? 0;
      let bonus = base;
      if (level === 1) bonus += Math.floor(state.prof / 2);
      if (level === 2) bonus += state.prof;
      if (level === 3) bonus += state.prof * 2;
      return bonus;
    }
    function rollSkillCheck(name, cheat){
      rollPreset(`${name} Check`, getSkillBonus(name), cheat);
    }
    function rollAbilityCheck(key, cheat){
      const ability = getAbilityByKey(key);
      if (!ability) return;
      rollPreset(`${ability.label} Check`, modFromScore(ability.score), cheat);
    }
    function rollSaveCheck(key, cheat){
      const ability = getAbilityByKey(key);
      if (!ability) return;
      const mod = modFromScore(ability.score) + (ability.saveProf ? state.prof : 0);
      rollPreset(`${ability.label} Save`, mod, cheat);
    }
    function startDiceDrag(e){
      if (e.button !== 0) return;
      const panel = $("#dicePanel");
      const rect = panel.getBoundingClientRect();
      e.preventDefault();
      diceDrag = {
        pointerId: e.pointerId,
        offsetX: e.clientX - rect.left,
        offsetY: e.clientY - rect.top
      };
      panel.style.left = `${rect.left}px`;
      panel.style.top = `${rect.top}px`;
      panel.style.right = "auto";
      panel.style.bottom = "auto";
      panel.setPointerCapture(e.pointerId);
    }
    function moveDiceDrag(e){
      if (!diceDrag || diceDrag.pointerId !== e.pointerId) return;
      const panel = $("#dicePanel");
      const maxX = window.innerWidth - panel.offsetWidth;
      const maxY = window.innerHeight - panel.offsetHeight;
      const x = clamp(e.clientX - diceDrag.offsetX, 10, Math.max(10, maxX - 10));
      const y = clamp(e.clientY - diceDrag.offsetY, 10, Math.max(10, maxY - 10));
      panel.style.left = `${x}px`;
      panel.style.top = `${y}px`;
    }
    function endDiceDrag(e){
      if (!diceDrag || diceDrag.pointerId !== e.pointerId) return;
      const panel = $("#dicePanel");
      panel.releasePointerCapture(e.pointerId);
      diceDrag = null;
    }

    /**********************************************************************
     * Rendering
     **********************************************************************/
    function applyDebugMode(){
      renderDebugLog();
    }

    function applyWide(){
      document.body.setAttribute("data-wide", state.settings.wide ? "on" : "off");
    }

    function fitTextToLines(el, baseSize, minSize, lines){
      if (!el) return;
      const prevClamp = el.style.webkitLineClamp;
      const prevDisplay = el.style.display;
      const prevBoxOrient = el.style.webkitBoxOrient;
      el.style.webkitLineClamp = "unset";
      el.style.webkitBoxOrient = "initial";
      el.style.display = "block";
      el.style.fontSize = `${baseSize}px`;
      const computed = getComputedStyle(el);
      const lineHeight = parseFloat(computed.lineHeight);
      const baseLineHeight = Number.isFinite(lineHeight) ? lineHeight / baseSize : 1.2;
      let size = baseSize;
      let maxHeight = baseLineHeight * size * lines;
      while (el.scrollHeight > maxHeight + 1 && size > minSize){
        size -= 1;
        el.style.fontSize = `${size}px`;
        maxHeight = baseLineHeight * size * lines;
      }
      el.style.webkitLineClamp = prevClamp;
      el.style.webkitBoxOrient = prevBoxOrient;
      el.style.display = prevDisplay;
    }
    function fitTopbarText(){
      fitTextToLines($("#tb_name"), 44, 18, 2);
      fitTextToLines($("#tb_sub"), 14, 10, 2);
      fitTextToLines($("#mainName"), 34, 18, 2);
    }
    function fitTextToWidth(el, baseSize, minSize){
      if (!el || !el.parentElement) return;
      const parent = el.parentElement;
      let size = baseSize;
      el.style.fontSize = `${size}px`;
      const maxWidth = parent.clientWidth - 12;
      while (el.scrollWidth > maxWidth && size > minSize){
        size -= 1;
        el.style.fontSize = `${size}px`;
      }
    }

    function renderTopbar(){
      const tbName = $("#tb_name");
      tbName.innerHTML = buildTopbarNameHTML(state.name);
      tbName.setAttribute("aria-label", state.name);
      $("#tb_sub").textContent = `${state.race} â€¢ ${state.classSummary}`;
      $("#tb_ac").textContent = state.ac;
      $("#tb_init").textContent = formatSigned(state.init);
      $("#tb_speed").textContent = state.speed;
      $("#tb_pb").textContent = formatSigned(state.prof);

      const total = coinTotalGP(state.coins);
      const rounded = Math.round(total);
      $("#tb_money_total").textContent = `${rounded} gp`;
      $("#i_money").textContent = `${rounded} gp`;
      const goldIcon = getCurrency("gp")?.icon;
      if (goldIcon){
        $("#tb_money_icon").src = goldIcon;
      }

      const active = getActiveStatusList();
      $("#tb_status").textContent = getToolbarStatusLabel();
      $("#statusTooltipText").textContent = active.length ? active.join(", ") : "None";
      fitTextToWidth($("#tb_status"), 13, 9);
      fitTextToWidth($("#tb_money_total"), 13, 9);
      fitTopbarText();
      renderCurrentStatusList();

      // main quickstats mirror
      $("#m_hp_cur").textContent = state.hp.cur;
      $("#m_hp_max").textContent = state.hp.max;
      $("#m_hp_temp").textContent = state.hp.temp>0 ? ` (+${state.hp.temp})` : "";
      $("#m_ac").textContent = state.ac;
      $("#m_init").textContent = formatSigned(state.init);
      $("#m_prof").textContent = formatSigned(state.prof);
      $("#m_spd").textContent = state.speed;
    }

    function renderHP(){
      $("#tb_hp_cur").textContent = state.hp.cur;
      $("#tb_hp_max").textContent = state.hp.max;
      $("#tb_temp_label").textContent = `+${state.hp.temp}`;

      // scaling: total width represents max+temp
      const total = Math.max(1, state.hp.max + state.hp.temp);
      const curW = clamp((state.hp.cur / total) * 100, 0, 100);
      const maxW = clamp((state.hp.max / total) * 100, 0, 100);
      const tempW = clamp((state.hp.temp / total) * 100, 0, 100);

      $("#hpGreen").style.width = `${curW}%`;
      $("#hpTemp").style.left = `${maxW}%`;
      $("#hpTemp").style.width = `${tempW}%`;
      const hpRatio = state.hp.max > 0 ? state.hp.cur / state.hp.max : 0;
      $("#hpGreen").classList.toggle("is-danger", hpRatio <= 0.1);
      $("#hpGreen").classList.toggle("is-warning", hpRatio > 0.1 && hpRatio <= 0.3);
    }

    function renderMain(){
      $("#mainName").textContent = state.name;
      $("#mainTagline").textContent = state.tagline;
      $("#mainSummaryLine").innerHTML = [
        `<span class="tag">${escapeHTML(state.race)}</span>`,
        `<span class="tag">${escapeHTML(state.classSummary)}</span>`
      ].join("");
    }

    function renderPortrait(){
      const img = $("#portraitImg");
      if (!img) return;
      img.src = state.portrait.url;
      img.style.setProperty("--pz", state.portrait.zoom);
      img.style.setProperty("--px", `${state.portrait.x}%`);
      img.style.setProperty("--py", `${state.portrait.y}%`);
      img.style.setProperty("--pr", `${state.portrait.rotate}deg`);
      const thumb = $("#tb_portrait");
      if (thumb){
        thumb.src = state.portrait.url;
        const posX = 50 + (state.portrait.x || 0);
        const posY = 50 + (state.portrait.y || 0);
        thumb.style.objectPosition = `${posX}% ${posY}%`;
        thumb.style.transform = `scale(${state.portrait.zoom}) rotate(${state.portrait.rotate}deg)`;
      }
    }

    function updatePortraitPreview(){
      const preview = $("#portraitPreviewImg");
      if (!preview) return;
      preview.src = state.portrait.url;
      preview.style.setProperty("--pz", state.portrait.zoom);
      preview.style.setProperty("--px", `${state.portrait.x}%`);
      preview.style.setProperty("--py", `${state.portrait.y}%`);
      preview.style.setProperty("--pr", `${state.portrait.rotate}deg`);
      $("#portraitPosLabel").textContent = `${state.portrait.x}% / ${state.portrait.y}%`;
    }

    function renderAbilities(){
      const grid = $("#abilGrid");
      grid.innerHTML = "";

      const isEditable = state.settings.editUnlocked;
      for (const a of state.abilities){
        const mod = modFromScore(a.score);
        const save = mod + (a.saveProf ? state.prof : 0);

        grid.insertAdjacentHTML("beforeend", `
          <div class="abil-card rollable" data-ability-roll="${escapeHTML(a.key)}">
            ${a.custom && isEditable ? `<button class="ability-remove" type="button" data-ability="${escapeHTML(a.key)}">Remove</button>` : ""}
            <div class="abil-head">${escapeHTML(a.label)}</div>
            <div class="abil-box">
              <div class="abil-score">${a.score}</div>
            </div>
            <div class="abil-box" style="padding:10px 10px;">
              <div class="abil-subk">MOD</div>
              <div class="abil-subv">${formatSigned(mod)}</div>
            </div>
            <div style="display:flex; justify-content:center;">
              <span class="save-pill ${a.saveProf ? "pro":""} ${isEditable ? "is-editable":""}" data-ability="${escapeHTML(a.key)}" data-save-roll="${escapeHTML(a.key)}" role="button" aria-pressed="${a.saveProf ? "true" : "false"}">
                SAVING THROW ${formatSigned(save)}
              </span>
            </div>
          </div>
        `);
      }

      renderSkills();
      populateAbilityDropdowns();
    }

    function renderSkills(){
      const cols = [[],[],[]];
      state.skills.forEach((s,i)=> cols[i%3].push(s));

      $("#skillsGrid").innerHTML = cols.map(col => `
        <div class="skill-col">
          ${col.map(s => renderSkillRow(s)).join("")}
        </div>
      `).join("");
    }

    function renderSkillRow(skill){
      const abil = getAbilityByKey(skill.abil) || getAbilityByKey("int");
      const base = modFromScore(abil.score);
      const level = state.skillProfs[skill.name] ?? 0;
      const isEditable = state.settings.editUnlocked;

      let bonus = base;
      if (level === 1) bonus += Math.floor(state.prof / 2);
      if (level === 2) bonus += state.prof;
      if (level === 3) bonus += state.prof * 2;

      return `
        <div class="skill-row rollable ${skill.custom && isEditable ? "has-remove" : ""}" data-skill-roll="${escapeHTML(skill.name)}">
          <div class="skill-left">
            <button class="dot-btn" type="button" data-skill="${escapeHTML(skill.name)}" aria-label="Toggle proficiency for ${escapeHTML(skill.name)}">
              <span class="dot ${level===1?"fill": level>=2?"gold":""}" style="${level===3 ? "box-shadow:0 0 0 2px rgba(216,192,138,0.22) inset;" : ""}"></span>
            </button>
            <span class="skill-name">${escapeHTML(skill.name)}</span>
          </div>
          <div class="skill-mid">${escapeHTML(abil.label)}</div>
          <div class="skill-right">${formatSigned(bonus)}</div>
          ${skill.custom && isEditable ? `<button class="skill-remove" type="button" data-skill-remove="${escapeHTML(skill.name)}">Remove</button>` : ""}
        </div>
      `;
    }

    function cycleSkillProficiency(name){
      if (!state.settings.editUnlocked) return;
      const current = state.skillProfs[name] ?? 0;
      state.skillProfs[name] = (current + 1) % 4;
      renderAbilities();
    }

    function toggleSaveProficiency(key){
      if (!state.settings.editUnlocked) return;
      const ability = state.abilities.find(a => a.key === key);
      if (!ability) return;
      ability.saveProf = !ability.saveProf;
      renderAbilities();
    }

    function removeCustomSkill(name){
      if (!state.settings.editUnlocked) return;
      state.skills = state.skills.filter(s => s.name !== name);
      delete state.skillProfs[name];
      renderAbilities();
    }

    function removeCustomAbility(key){
      if (!state.settings.editUnlocked) return;
      state.abilities = state.abilities.filter(a => a.key !== key);
      renderAbilities();
    }

    function renderCombat(){
      $("#sp_dc").textContent = state.spells.dc;
      $("#sp_atk").textContent = formatSigned(state.spells.atk);

      $("#c_attacks").innerHTML = state.combat.actions.map(a => `
        <tr>
          <td><strong>${escapeHTML(a.name)}</strong></td>
          <td class="right"><span class="num">${escapeHTML(a.toHit)}</span></td>
          <td>${escapeHTML(a.dmg)}</td>
          <td class="muted">${escapeHTML(a.notes)}</td>
        </tr>
      `).join("");

      $("#c_bonus").innerHTML = state.combat.bonus.map(x => `<li class="muted">${escapeHTML(x)}</li>`).join("");
      $("#c_reactions").innerHTML = state.combat.reactions.map(x => `<li class="muted">${escapeHTML(x)}</li>`).join("");
      $("#c_free").innerHTML = state.combat.free.map(x => `<li class="muted">${escapeHTML(x)}</li>`).join("");
    }

    /**********************************************************************
     * Spells: spellbooks + spell cache
     **********************************************************************/
    const SPELL_DATA_URL = "https://raw.githubusercontent.com/Kemsypt/Character-Sheet/main/Data/Spells.json";
    const SPELL_SOURCES_URL = "https://raw.githubusercontent.com/Kemsypt/Character-Sheet/main/Data/Spells%20Sources.json";
    const SPELL_CACHE_DB = "dnd_spell_cache_v2";
    const SPELL_CACHE_META_KEY = "dnd_spell_cache_meta_v2";
    const SPELL_LIST_CACHE_KEY = "dnd_spell_list_cache_v2";

    function slugify(s){
      return String(s||"").toLowerCase().trim()
        .replace(/["'`]/g, "")
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");
    }

    const SPELL_SCHOOL_MAP = {
      A: "Abjuration",
      C: "Conjuration",
      D: "Divination",
      E: "Enchantment",
      V: "Evocation",
      I: "Illusion",
      N: "Necromancy",
      T: "Transmutation"
    };

    function formatSpellSchool(code){
      return SPELL_SCHOOL_MAP[code] || code || "";
    }

    function formatSpellTime(timeArr){
      if (!Array.isArray(timeArr) || !timeArr.length) return "";
      return timeArr.map(t=>{
        const num = t.number || 1;
        let unit = t.unit || "action";
        if (unit === "bonus") unit = "bonus action";
        if (unit === "reaction") unit = "reaction";
        const plural = num === 1 ? "" : "s";
        return `${num} ${unit}${plural}`;
      }).join(", ");
    }

    function formatSpellRange(range){
      if (!range || typeof range !== "object") return "";
      if (range.type === "self") return "Self";
      const dist = range.distance || {};
      if (dist.type === "self") return "Self";
      if (dist.type === "touch") return "Touch";
      if (dist.type === "sight") return "Sight";
      if (dist.type === "unlimited") return "Unlimited";
      if (dist.type === "special") return "Special";
      if (dist.amount && dist.type){
        const unit = dist.type === "feet" ? "ft." : dist.type;
        return `${dist.amount} ${unit}`;
      }
      return range.type || "";
    }

    function formatSpellComponents(components){
      if (!components || typeof components !== "object") return "";
      const parts = [];
      if (components.v) parts.push("V");
      if (components.s) parts.push("S");
      if (components.m){
        let mat = components.m;
        if (typeof mat === "object" && mat.text) mat = mat.text;
        parts.push(mat ? `M (${mat})` : "M");
      }
      return parts.join(", ");
    }

    function formatSpellDuration(durations){
      if (!Array.isArray(durations) || !durations.length) return "";
      const d = durations[0];
      if (!d) return "";
      if (d.type === "instant") return "Instantaneous";
      if (d.type === "permanent") return "Permanent";
      if (d.type === "special") return "Special";
      if (d.type === "timed" && d.duration){
        const amt = d.duration.amount || 1;
        const unit = d.duration.type || "round";
        const label = `${amt} ${unit}${amt === 1 ? "" : "s"}`;
        return d.concentration ? `Concentration, up to ${label}` : label;
      }
      return d.type || "";
    }

    function normalizeDiceText(text){
      return String(text || "").replace(/\{@(?:damage|dice)\s+([^}]+)\}/gi, "$1");
    }

    function formatDiceInline(text){
      const cleaned = normalizeDiceText(text);
      const escaped = escapeHTML(cleaned);
      return escaped.replace(/(\b\d+d\d+(?:\s*[+-]\s*\d+)?\b)/gi, (match)=>{
        const expr = match.replace(/\s+/g, "");
        return `<button class="dice-inline" type="button" data-dice="${escapeHTML(expr)}">${escapeHTML(match)}</button>`;
      });
    }

    function parseDiceExpression(expr){
      const raw = String(expr || "").replace(/\s+/g, "");
      if (!raw) return null;
      const parts = raw.match(/[+-]?[^+-]+/g) || [];
      const sets = [];
      let flatMod = 0;
      parts.forEach(part=>{
        const sign = part.startsWith("-") ? -1 : 1;
        const token = part.replace(/^[+-]/, "");
        if (/^\d*d\d+$/i.test(token)){
          const [countRaw, sidesRaw] = token.toLowerCase().split("d");
          const count = parseInt(countRaw || "1", 10) || 1;
          const sides = parseInt(sidesRaw, 10) || 0;
          if (sides > 1){
            sets.push({ count: Math.max(1, count), sides, mod: 0 });
          }
        }else if (/^\d+$/.test(token)){
          flatMod += sign * (parseInt(token, 10) || 0);
        }
      });
      if (!sets.length) return null;
      if (flatMod){
        sets[0].mod = (sets[0].mod || 0) + flatMod;
      }
      return sets;
    }

    function rollDiceExpression(expr){
      const sets = parseDiceExpression(expr);
      if (!sets) return;
      rollDice("normal", { sets, label: expr });
    }

    function flattenSpellEntries(entries){
      const out = [];
      const walk = (entry)=>{
        if (!entry) return;
        if (typeof entry === "string"){
          out.push(entry);
          return;
        }
        if (Array.isArray(entry)){
          entry.forEach(walk);
          return;
        }
        if (typeof entry === "object" && Array.isArray(entry.entries)){
          entry.entries.forEach(walk);
        }
      };
      walk(entries);
      return out;
    }

    function buildSpellId(spell){
      const source = spell.source ? String(spell.source).toLowerCase() : "unknown";
      return `${slugify(spell.name)}-${source}`;
    }

    function extractSpellClasses(spell, sources){
      if (!spell || !sources || !spell.source) return [];
      const bySource = sources[spell.source];
      if (!bySource || !bySource[spell.name]) return [];
      const classes = bySource[spell.name].class || [];
      return classes.map(c=> c.name).filter(Boolean);
    }

    function normalizeSpellEntry(spell, sources){
      const id = buildSpellId(spell);
      const entries = flattenSpellEntries(spell.entries || []);
      const higher = flattenSpellEntries(spell.entriesHigherLevel || []);
      return {
        id,
        name: spell.name,
        level: spell.level ?? 0,
        school: formatSpellSchool(spell.school),
        casting_time: formatSpellTime(spell.time),
        range: formatSpellRange(spell.range),
        components: formatSpellComponents(spell.components),
        duration: formatSpellDuration(spell.duration),
        concentration: Array.isArray(spell.duration) ? spell.duration.some(d=> d && d.concentration) : false,
        ritual: !!spell.ritual,
        classes: extractSpellClasses(spell, sources),
        source: spell.source || "",
        page: spell.page ?? "",
        desc: entries,
        higher_level: higher,
        brief: entries[0] || ""
      };
    }

    async function loadSpellData(){
      const [spellResp, sourcesResp] = await Promise.all([
        fetch(SPELL_DATA_URL, { cache: "no-store" }),
        fetch(SPELL_SOURCES_URL, { cache: "no-store" })
      ]);
      if (!spellResp.ok) throw new Error("Failed to load spells");
      const spellsRaw = await spellResp.json();
      const sourcesRaw = sourcesResp.ok ? await sourcesResp.json() : null;
      const list = (spellsRaw?.spell || []).map(spell=> normalizeSpellEntry(spell, sourcesRaw));
      return { list, sources: sourcesRaw };
    }

    const SpellCache = {
      _db: null,
      async open(){
        if (this._db) return this._db;
        const db = await new Promise((resolve, reject)=>{
          const req = indexedDB.open(SPELL_CACHE_DB, 1);
          req.onupgradeneeded = ()=>{
            const d = req.result;
            const store = d.createObjectStore('spells', { keyPath: 'key' });
            store.createIndex('nameLower', 'nameLower', { unique: false });
          };
          req.onsuccess = ()=> resolve(req.result);
          req.onerror = ()=> reject(req.error);
        });
        this._db = db;
        return db;
      },
      async put(key, data){
        const db = await this.open();
        await new Promise((resolve)=>{
          const tx = db.transaction('spells', 'readwrite');
          tx.oncomplete = ()=> resolve(true);
          tx.onerror = ()=> resolve(true);
          tx.objectStore('spells').put({
            key,
            nameLower: String(data?.name||"").toLowerCase(),
            data
          });
        });
      },
      async getByKey(key){
        if (!key) return null;
        const db = await this.open();
        return await new Promise((resolve)=>{
          const tx = db.transaction('spells', 'readonly');
          const req = tx.objectStore('spells').get(key);
          req.onsuccess = ()=> resolve(req.result ? req.result.data : null);
          req.onerror = ()=> resolve(null);
        });
      },
      async getByName(name){
        const n = String(name||"").toLowerCase().trim();
        if (!n) return null;
        const db = await this.open();
        return await new Promise((resolve)=>{
          const tx = db.transaction('spells', 'readonly');
          const idx = tx.objectStore('spells').index('nameLower');
          const req = idx.get(n);
          req.onsuccess = ()=> resolve(req.result ? req.result.data : null);
          req.onerror = ()=> resolve(null);
        });
      },
      async clear({ silent = false } = {}){
        try{
          const db = await this.open();
          await new Promise((resolve)=>{
            const tx = db.transaction('spells', 'readwrite');
            tx.oncomplete = ()=> resolve(true);
            tx.onerror = ()=> resolve(true);
            tx.objectStore('spells').clear();
          });
        }catch{}
        try{ localStorage.removeItem(SPELL_CACHE_META_KEY); }catch{}
        try{ localStorage.removeItem(SPELL_LIST_CACHE_KEY); }catch{}
        spellImportState.data = null;
        spellImportState.byId = null;
        spellImportState.selected.clear();
        if (!silent) updateSpellCacheStatus();
        debugLog("Spell cache cleared.");
      }
    };

    function getSpellCacheMeta(){
      try{ return JSON.parse(localStorage.getItem(SPELL_CACHE_META_KEY) || 'null'); }catch{ return null; }
    }
    function setSpellCacheMeta(meta){
      try{ localStorage.setItem(SPELL_CACHE_META_KEY, JSON.stringify(meta)); }catch{}
      updateSpellCacheStatus();
    }
    function updateSpellCacheStatus(message){
      const el = document.getElementById('spellCacheStatus');
      if (!el) return;
      if (message){
        el.textContent = message;
        return;
      }
      const meta = getSpellCacheMeta();
      if (!meta || !meta.count){
        el.textContent = 'Cache: not loaded';
        return;
      }
      const when = meta.updatedAt ? new Date(meta.updatedAt).toLocaleString() : 'unknown';
      el.textContent = `Cache: ${meta.count} spells (last updated ${when})`;
    }

    async function refreshSpellData({ silent = false } = {}){
      if (!silent) updateSpellCacheStatus('Cache: downloadingâ€¦');
      try{
        const { list } = await loadSpellData();
        if (!list.length){
          updateSpellCacheStatus('Cache: unavailable (no spells)');
          return false;
        }
        await SpellCache.clear({ silent: true });
        localStorage.setItem(SPELL_LIST_CACHE_KEY, JSON.stringify({ at: Date.now(), list }));
        spellImportState.data = list;
        spellImportState.byId = new Map(list.map(sp=> [sp.id, sp]));
        spellImportState.selected.clear();
        buildSpellImportFilters();
        applySpellImportUiToState();
        renderSpellImportList();
        updateSpellImportConfirm();
        const total = list.length;
        let done = 0;
        for (const spell of list){
          await SpellCache.put(spell.id, spell);
          done++;
          if (!silent && (done % 50 === 0 || done === total)){
            updateSpellCacheStatus(`Cache: downloadingâ€¦ ${done}/${total}`);
          }
        }
        setSpellCacheMeta({ count: total, updatedAt: Date.now() });
        if (!silent) updateSpellCacheStatus();
        debugLog(`Spell cache refreshed (${total} spells).`);
        return true;
      }catch(err){
        updateSpellCacheStatus('Cache: unavailable (offline?)');
        debugLog('Spell cache refresh failed.', err);
        return false;
      }
    }

    async function warmSpellCache(){
      const meta = getSpellCacheMeta();
      if (meta && meta.count && meta.count > 0){
        updateSpellCacheStatus();
        return;
      }
      await refreshSpellData();
    }

    async function getSpellDetails(importSpell){
      if (!importSpell) return null;
      // try id key, then name
      const byId = await SpellCache.getByKey(importSpell.id);
      if (byId) return byId;
      const byName = await SpellCache.getByName(importSpell.name);
      if (byName) return byName;
      return importSpell;
    }

    function ensureSpellbooks(){
      if (Array.isArray(state.spellbooks) && state.spellbooks.length){
        state.spellbooks.forEach(book=>{
          if (!book.spellModType) book.spellModType = "int";
          if (!Number.isFinite(book.spellModCustom)) book.spellModCustom = 0;
        });
        return;
      }
      const migrated = (state.spells?.list || []).map((sp, idx)=>{
        const levelNum = parseLevelLabel(sp.lvl);
        return {
          key: `m${idx}-${slugify(sp.name)}`,
          name: sp.name,
          level: levelNum,
          castingTime: '',
          range: '',
          components: '',
          duration: '',
          summary: sp.note || ''
        };
      });
      state.spellbooks = [
        {
          id: 'book-main',
          name: 'Spellbook',
          colors: { hi: '#d8c08a', mid: '#0f1422', text: '#f2f4f8' },
          spellModType: "wis",
          spellModCustom: 0,
          spells: migrated
        }
      ];
    }

    function parseLevelLabel(label){
      const s = String(label||'').toLowerCase();
      if (s.includes('cantrip')) return 0;
      const m = s.match(/(\d+)/);
      if (m) return parseInt(m[1],10) || 0;
      return 0;
    }

    function getSpellbookModValue(book){
      if (!book) return 0;
      if (book.spellModType === "custom"){
        return parseInt(book.spellModCustom, 10) || 0;
      }
      const ability = getAbilityByKey(book.spellModType || "int");
      return ability ? modFromScore(ability.score) : 0;
    }

    function getSpellbookSaveDc(book){
      return 8 + (state.prof || 0) + getSpellbookModValue(book);
    }

    const SPELLBOOK_PRESETS = {
      Warlock: { hi: '#8b5cf6', mid: '#1b1035', text: '#f8fafc' },
      Wizard: { hi: '#60a5fa', mid: '#0b1e3a', text: '#f8fafc' },
      Sorcerer: { hi: '#f97316', mid: '#2a1206', text: '#fff7ed' },
      Fire: { hi: '#fb7185', mid: '#2a0b12', text: '#fff1f2' },
      Water: { hi: '#38bdf8', mid: '#041b25', text: '#e0f2fe' },
      Earth: { hi: '#a3e635', mid: '#141f07', text: '#f7fee7' },
      Air: { hi: '#e5e7eb', mid: '#111827', text: '#f9fafb' },
      Wildmagic: { hi: '#f472b6', mid: '#2a0b1e', text: '#fdf2f8' }
    };

    function addSpellbook(){
      if (!state.settings.editUnlocked) return;
      ensureSpellbooks();
      openSpellbookEdit(null);
    }

    function openSpellbookEdit(bookId){
      if (!state.settings.editUnlocked) return;
      ensureSpellbooks();
      const dlg = $('#spellbookEditDialog');
      const book = bookId ? state.spellbooks.find(b=> b.id === bookId) : null;
      dlg.dataset.bookId = bookId || "";
      dlg.dataset.mode = book ? "edit" : "new";
      $('#spellbookEditName').value = book?.name || `Spellbook ${state.spellbooks.length + 1}`;
      $('#spellbookEditHi').value = book?.colors?.hi || '#d8c08a';
      $('#spellbookEditMid').value = book?.colors?.mid || '#0f1422';
      $('#spellbookEditText').value = book?.colors?.text || '#f2f4f8';
      $('#spellbookEditModType').value = book?.spellModType || "int";
      $('#spellbookEditModCustom').value = Number.isFinite(book?.spellModCustom) ? book.spellModCustom : 0;
      dlg.showModal();
    }

    function saveSpellbookEdit(){
      const dlg = $('#spellbookEditDialog');
      const mode = dlg.dataset.mode || "edit";
      const bookId = dlg.dataset.bookId;
      ensureSpellbooks();
      const name = $('#spellbookEditName').value.trim() || `Spellbook ${state.spellbooks.length + 1}`;
      const colors = {
        hi: $('#spellbookEditHi').value,
        mid: $('#spellbookEditMid').value,
        text: $('#spellbookEditText').value
      };
      const spellModType = $('#spellbookEditModType').value;
      const spellModCustom = parseInt($('#spellbookEditModCustom').value, 10) || 0;

      if (mode === "new"){
        const id = `book-${Date.now()}`;
        state.spellbooks.push({
          id,
          name,
          colors,
          spellModType,
          spellModCustom,
          spells: []
        });
      }else{
        const book = state.spellbooks.find(b=> b.id === bookId);
        if (!book) return;
        book.name = name;
        book.colors = colors;
        book.spellModType = spellModType;
        book.spellModCustom = spellModCustom;
      }
      dlg.close();
      saveSettings();
      renderSpells();
    }

    function removeSpellFromBook(bookId, spellKey){
      ensureSpellbooks();
      const book = state.spellbooks.find(b=> b.id === bookId);
      if (!book) return;
      book.spells = (book.spells || []).filter(s=> s.key !== spellKey);
      saveSettings();
      renderSpells();
    }

    function deleteSpellbook(bookId){
      if (!state.settings.editUnlocked) return;
      ensureSpellbooks();
      const book = state.spellbooks.find(b=> b.id === bookId);
      if (!book) return;
      const confirmText = prompt(`Type "delete" to delete the ${book.name || "spellbook"} spellbook.`);
      if ((confirmText || "").trim().toLowerCase() !== "delete") return;
      state.spellbooks = (state.spellbooks || []).filter(b=> b.id !== bookId);
      saveSettings();
      renderSpells();
    }

    function handleSpellbookClick(e){
      const importBtn = e.target.closest('[data-book-import]');
      if (importBtn){
        openSpellImporter(importBtn.dataset.bookImport);
        return;
      }
      const editBtn = e.target.closest('[data-book-edit]');
      if (editBtn){
        openSpellbookEdit(editBtn.dataset.bookEdit);
        return;
      }
      const delBtn = e.target.closest('[data-book-delete]');
      if (delBtn){
        deleteSpellbook(delBtn.dataset.bookDelete);
        return;
      }
      const rmBtn = e.target.closest('[data-spell-remove]');
      if (rmBtn){
        removeSpellFromBook(rmBtn.dataset.bookId, rmBtn.dataset.spellRemove);
        return;
      }
    }

    function renderSpells(){
      ensureSpellbooks();
      $('#sp_prep').textContent = state.spells.prepared;
      const canEdit = !!state.settings.editUnlocked;
      $('#sp_list').innerHTML = (state.spellbooks || []).map(book=>{
        const colors = book.colors || { hi:'#d8c08a', mid:'#0f1422', text:'#f2f4f8' };
        const saveDc = getSpellbookSaveDc(book);
        const rows = (book.spells || []).map(sp=>{
          const removeBtn = canEdit ? `<button class="icon-btn spell-remove" type="button" data-spell-remove="${escapeHTML(sp.key)}" data-book-id="${escapeHTML(book.id)}" aria-label="Remove spell">âœ•</button>` : '';
          const summaryHtml = formatDiceInline(sp.summary || "");
          return `
            <tr data-spell-key="${escapeHTML(sp.key)}" data-book-id="${escapeHTML(book.id)}" ${canEdit ? `draggable="true"` : ""}>
              <td>
                <div class="spell-name-row">
                  ${removeBtn}
                  <strong>${escapeHTML(sp.name)}</strong>
                </div>
              </td>
              <td class="muted">${escapeHTML(formatSpellLevel(sp.level))}</td>
              <td class="muted">${escapeHTML(sp.castingTime||'')}</td>
              <td class="muted">${escapeHTML(sp.range||'')}</td>
              <td class="muted">${escapeHTML(sp.components||'')}</td>
              <td class="muted">${escapeHTML(sp.duration||'')}</td>
              <td class="muted">${summaryHtml}</td>
            </tr>
          `;
        }).join('');

        const headBtn = canEdit
          ? `<button class="spellbook-name-btn" type="button" data-book-edit="${escapeHTML(book.id)}">${escapeHTML(book.name||'Spellbook')}</button>`
          : `<div class="spellbook-name">${escapeHTML(book.name||'Spellbook')}</div>`;

        return `
          <div class="spellbook-card" data-book="${escapeHTML(book.id)}" style="--sb-hi:${escapeHTML(colors.hi)}; --sb-mid:${escapeHTML(colors.mid)}; --sb-text:${escapeHTML(colors.text)};">
            <div class="spellbook-head">
              ${headBtn}
              <div class="spellbook-head-actions">
                <button class="tag" type="button" data-book-import="${escapeHTML(book.id)}">Import Spells</button>
                ${canEdit ? `<button class="tag spellbook-delete" type="button" data-book-delete="${escapeHTML(book.id)}">Delete Spellbook</button>` : ""}
              </div>
            </div>
            <div class="spellbook-metrics">
              <div class="spellbook-metric">Spell Mod <strong>${formatSigned(getSpellbookModValue(book))}</strong></div>
              <div class="spellbook-metric">Save DC <strong>${saveDc}</strong></div>
            </div>
            <div class="spellbook-body">
              <table class="spellbook-table">
                <thead><tr>
                  <th>Name</th><th>Level</th><th>Casting</th><th>Range</th><th>Components</th><th>Duration</th><th>Notes</th>
                </tr></thead>
                <tbody>
                  ${rows || `<tr><td class="muted" colspan="7">No spells yet.</td></tr>`}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }).join('');
    }

    // Spell importer state
    const spellImportState = {
      data: null,
      byId: null,
      selected: new Set(),
      levelOptions: Array.from({ length: 10 }, (_, idx)=> idx),
      classOptions: [],
      // applied filters
      search: "",
      sort: "name",
      levelFilters: new Set(),
      classFilters: new Set(),
      dirty: false,
      targetBookId: null
    };

    function markSpellImportDirty(){
      spellImportState.dirty = true;
      const btn = $('#spellImportApplyFilters');
      if (btn) btn.disabled = false;
    }

    function buildSpellImportFilters(){
      const levelWrap = $('#spellImportLevelFilters');
      const classWrap = $('#spellImportClassFilters');
      if (!levelWrap || !classWrap) return;

      levelWrap.innerHTML = spellImportState.levelOptions.map(level=>{
        return `<button class="spell-chip" type="button" aria-pressed="true" data-level="${level}">${escapeHTML(formatSpellLevel(level))}</button>`;
      }).join('');

      const ban = new Set(['wizard chronurgy','wizard graviturgy','wizard (chronurgy)','wizard (graviturgy)']);
      const allClasses = [...new Set((spellImportState.data||[]).flatMap(sp=> sp.classes||[]))]
        .filter(c=> !ban.has(String(c||'').toLowerCase().trim()))
        .sort((a,b)=> a.localeCompare(b));

      spellImportState.classOptions = allClasses;
      classWrap.innerHTML = allClasses.map(cls=>{
        return `<button class="spell-chip" type="button" aria-pressed="true" data-class="${escapeHTML(cls)}">${escapeHTML(cls)}</button>`;
      }).join('');

      // initial applied filters = all
      spellImportState.levelFilters = new Set(spellImportState.levelOptions);
      spellImportState.classFilters = new Set(allClasses);
    }

    function readChips(containerSel, attr){
      return new Set([...document.querySelectorAll(`${containerSel} .spell-chip[${attr}]`)]
        .filter(b=> b.getAttribute('aria-pressed') === 'true')
        .map(b=> b.getAttribute(attr)));
    }

    function applySpellImportUiToState(){
      spellImportState.search = ($('#spellImportSearch').value || '').trim();
      spellImportState.sort = $('#spellImportSort').value || 'name';
      const levels = readChips('#spellImportLevelFilters', 'data-level');
      const classes = readChips('#spellImportClassFilters', 'data-class');
      spellImportState.levelFilters = new Set([...levels].map(x=> parseInt(x,10)));
      spellImportState.classFilters = new Set([...classes].map(x=> x));
      spellImportState.dirty = false;
      const btn = $('#spellImportApplyFilters');
      if (btn) btn.disabled = true;
    }

    function applySpellImportFilters(){
      if (!spellImportState.data) return [];
      const search = spellImportState.search.toLowerCase();
      const levels = spellImportState.levelFilters;
      const classes = spellImportState.classFilters;
      let list = spellImportState.data.filter(spell=>{
        const nameMatch = !search || String(spell.name||'').toLowerCase().includes(search);
        const levelMatch = levels.size === 0 || levels.has(spell.level);
        const classMatch = classes.size === 0 || (spell.classes || []).some(cls => classes.has(cls));
        return nameMatch && levelMatch && classMatch;
      });
      list = list.slice().sort((a,b)=>{
        switch(spellImportState.sort){
          case 'level': return a.level - b.level || a.name.localeCompare(b.name);
          case 'time': return String(a.casting_time||'').localeCompare(String(b.casting_time||'')) || a.name.localeCompare(b.name);
          case 'school': return String(a.school||'').localeCompare(String(b.school||'')) || a.name.localeCompare(b.name);
          case 'range': return String(a.range||'').localeCompare(String(b.range||'')) || a.name.localeCompare(b.name);
          case 'concentration':
            return (a.concentration === b.concentration) ? a.name.localeCompare(b.name) : (a.concentration ? 1 : -1);
          default: return a.name.localeCompare(b.name);
        }
      });
      return list;
    }

    function updateSpellImportConfirm(){
      const btn = $('#spellImportConfirm');
      if (btn) btn.disabled = spellImportState.selected.size === 0;
      const countEl = $('#spellImportSelectedCount');
      if (countEl) countEl.textContent = String(spellImportState.selected.size);
      renderSpellImportSelectedPanel();
    }

    function clearSpellImportSelection(){
      spellImportState.selected.clear();
      updateSpellImportConfirm();
      renderSpellImportList();
    }

    function renderSpellImportSelectedPanel(){
      const listEl = $('#spellImportSelectedList');
      const totalsEl = $('#spellImportSelectedTotals');
      const breakdownEl = $('#spellImportSelectedBreakdown');
      if (!listEl || !totalsEl || !breakdownEl) return;

      if (!spellImportState.byId || spellImportState.selected.size === 0){
        totalsEl.textContent = '0 spells selected';
        breakdownEl.innerHTML = '';
        listEl.innerHTML = '<div class="muted">No spells selected.</div>';
        return;
      }

      const selectedSpells = [...spellImportState.selected]
        .map(id=> spellImportState.byId.get(id))
        .filter(Boolean)
        .sort((a,b)=> a.level - b.level || a.name.localeCompare(b.name));

      totalsEl.textContent = `${selectedSpells.length} spells selected`;

      const byLevel = new Map();
      for (const sp of selectedSpells){
        byLevel.set(sp.level, (byLevel.get(sp.level) || 0) + 1);
      }
      breakdownEl.innerHTML = [...byLevel.entries()].sort((a,b)=> a[0]-b[0]).map(([lvl, n])=>{
        return `<span class="tag">${escapeHTML(formatSpellLevel(lvl))}: <span class="num">${n}</span></span>`;
      }).join('');

      listEl.innerHTML = selectedSpells.map(sp=>{
        return `
          <div class="spell-selected-item">
            <div>
              <div style="font-weight:900;">${escapeHTML(sp.name)}</div>
              <div class="small muted">${escapeHTML(formatSpellLevel(sp.level))}</div>
            </div>
            <button class="icon-btn" type="button" data-selected-remove="${escapeHTML(sp.id)}" aria-label="Remove">âœ•</button>
          </div>
        `;
      }).join('');
    }

    function renderSpellImportList(){
      const listEl = $('#spellImportList');
      if (!listEl) return;
      if (!spellImportState.data){
        listEl.innerHTML = '<div class="muted">Loading spellsâ€¦</div>';
        return;
      }
      const list = applySpellImportFilters();
      if (!list.length){
        listEl.innerHTML = '<div class="muted">No spells match your filters.</div>';
        return;
      }
      listEl.innerHTML = list.map(spell=>{
        const meta = [formatSpellLevel(spell.level), spell.school, spell.casting_time, spell.range];
        if (spell.concentration) meta.push('Concentration');
        if (spell.classes && spell.classes.length) meta.push(spell.classes.join(', '));
        const checked = spellImportState.selected.has(spell.id) ? 'checked' : '';
        return `
          <div class="spell-import-row" data-row>
            <input class="spell-import-check" type="checkbox" data-spell-id="${escapeHTML(spell.id)}" ${checked} />
            <div>
              <div class="spell-import-name">${escapeHTML(spell.name)}</div>
              <div class="spell-import-meta">${meta.map(m=> `<span>${escapeHTML(m)}</span>`).join('')}</div>
            </div>
            <button class="btn spell-import-info" type="button" data-spell-info="${escapeHTML(spell.id)}">Info</button>
          </div>
        `;
      }).join('');
    }

    async function loadSpellImportData(){
      if (spellImportState.data) return;
      const listEl = $('#spellImportList');
      if (listEl) listEl.innerHTML = '<div class="muted">Loading spellsâ€¦</div>';
      try{
        const cachedRaw = localStorage.getItem(SPELL_LIST_CACHE_KEY);
        if (cachedRaw){
          try{
            const cached = JSON.parse(cachedRaw);
            if (cached && Array.isArray(cached.list)){
              spellImportState.data = cached.list;
            }
          }catch{}
        }
        if (!spellImportState.data){
          const { list } = await loadSpellData();
          spellImportState.data = list;
          localStorage.setItem(SPELL_LIST_CACHE_KEY, JSON.stringify({ at: Date.now(), list }));
        }
        spellImportState.byId = new Map(spellImportState.data.map(sp=> [sp.id, sp]));
        buildSpellImportFilters();
        applySpellImportUiToState();
        renderSpellImportList();
        updateSpellImportConfirm();
      }catch(err){
        if (listEl) listEl.innerHTML = '<div class="muted">Unable to load spell list.</div>';
        debugLog('Unable to load spell list.', err);
      }
    }

    function openSpellImporter(bookId){
      spellImportState.targetBookId = bookId || (state.spellbooks?.[0]?.id || null);
      const label = $('#spellImportTargetLabel');
      if (label){
        const book = (state.spellbooks||[]).find(b=> b.id === spellImportState.targetBookId);
        label.textContent = `Importing into: ${book ? book.name : 'â€”'}`;
      }
      $('#spellImportDialog').showModal();
      loadSpellImportData();
      updateSpellImportConfirm();
    }

    function formatSpellTextBlock(text){
      const cleaned = normalizeDiceText(text);
      return String(cleaned || "")
        .split(/\n+/)
        .map(line=> line.trim())
        .map(line=> line ? `<p>${formatDiceInline(line)}</p>` : `<div style="height:8px;"></div>`)
        .join("");
    }

    async function openSpellInfo(spellId){
      if (!spellImportState.byId) return;
      const sp = spellImportState.byId.get(spellId);
      if (!sp) return;
      $('#spellInfoTitle').textContent = sp.name;
      $('#spellInfoBody').innerHTML = '<div class="muted">Loadingâ€¦</div>';
      $('#spellInfoDialog').showModal();

      const details = await getSpellDetails(sp);
      if (!details){
        $('#spellInfoBody').innerHTML = '<div class="muted">Unable to load spell details. (Cache not ready or offline.)</div>';
        return;
      }

      const desc = Array.isArray(details.desc) ? details.desc.join('\n\n') : (details.desc || details.description || '');
      const higher = Array.isArray(details.higher_level) ? details.higher_level.join('\n\n') : (details.higher_level || '');
      const brief = details.brief || '';
      const classList = Array.isArray(details.classes)
        ? details.classes.map(c=> typeof c === "string" ? c : c?.name).filter(Boolean).join(", ")
        : (Array.isArray(sp.classes) ? sp.classes.join(", ") : "");

      const lines = [
        { k:'Level', v: formatSpellLevel(details.level ?? sp.level) },
        { k:'School', v: details.school || sp.school },
        { k:'Casting Time', v: details.casting_time || sp.casting_time },
        { k:'Range', v: details.range || sp.range },
        { k:'Components', v: details.components || sp.components },
        { k:'Duration', v: details.duration || sp.duration },
        { k:'Ritual', v: details.ritual ? 'Yes' : 'No' },
        { k:'Concentration', v: details.concentration ? 'Yes' : 'No' },
        { k:'Classes', v: classList },
        { k:'Source', v: details.source || sp.source },
        { k:'Page', v: details.page || sp.page }
      ];

      const html = `
        <div class="card">
          <h4>Details</h4>
          <div class="kv">
            ${lines.filter(x=>x.v).map(x=> `<div class="k">${escapeHTML(x.k)}</div><div class="v">${escapeHTML(String(x.v))}</div>`).join('')}
          </div>
          ${brief ? `<div style="height:10px"></div><div class="small" style="font-weight:900;">Brief</div><div class="muted" style="margin-top:6px;">${formatSpellTextBlock(brief)}</div>` : ''}
          ${desc ? `<div style="height:10px"></div><div class="small" style="font-weight:900;">Description</div><div class="muted" style="margin-top:6px;">${formatSpellTextBlock(desc)}</div>` : ''}
          ${higher ? `<div style="height:10px"></div><div class="small" style="font-weight:900;">At Higher Levels</div><div class="muted" style="margin-top:6px;">${formatSpellTextBlock(higher)}</div>` : ''}
        </div>
      `;

      $('#spellInfoBody').innerHTML = html;
    }

    async function applySpellImportSelection(){
      if (!spellImportState.selected.size || !spellImportState.byId) return;
      ensureSpellbooks();
      const bookId = spellImportState.targetBookId || state.spellbooks[0].id;
      const book = state.spellbooks.find(b=> b.id === bookId);
      if (!book) return;

      const existing = new Set((book.spells||[]).map(s=> String(s.name||'').toLowerCase()));
      for (const id of spellImportState.selected){
        const sp = spellImportState.byId.get(id);
        if (!sp) continue;
        if (existing.has(String(sp.name||'').toLowerCase())) continue;

        const details = await getSpellDetails(sp);
        const summary = details?.brief || '';

        book.spells.push({
          key: `${Date.now()}-${slugify(sp.name)}`,
          name: sp.name,
          level: sp.level,
          castingTime: details?.casting_time || sp.casting_time || '',
          range: details?.range || sp.range || '',
          components: details?.components || sp.components || '',
          duration: details?.duration || sp.duration || '',
          summary
        });
        existing.add(String(sp.name||'').toLowerCase());
      }
      spellImportState.selected.clear();
      saveSettings();
      renderSpells();
      $('#spellImportDialog').close();
      updateSpellImportConfirm();
    }

    function normalizeInventorySections(){
      if (!state.inventory) state.inventory = {};
      if (!Array.isArray(state.inventory.attunements)) state.inventory.attunements = [];
      if (!Array.isArray(state.inventory.equipped) || state.inventory.equipped.length < 6){
        const base = Array.isArray(state.inventory.equipped) ? state.inventory.equipped : [];
        state.inventory.equipped = Array.from({ length: 6 }, (_, idx)=> base[idx] || "");
      }
      if (!Array.isArray(state.inventory.sections) || !state.inventory.sections.length){
        const items = Array.isArray(state.inventory.items) ? state.inventory.items : [];
        const magic = Array.isArray(state.inventory.magic) ? state.inventory.magic : [];
        const tools = Array.isArray(state.inventory.tools) ? state.inventory.tools : [];
        state.inventory.sections = [
          { id: "attunement", type: "attunement", title: "Attunement", span: 3, lockedTitle: true },
          { id: "equipped", type: "equipped", title: "Equipped", span: 3 },
          { id: "equipment", type: "detailed", title: "Equipment", span: 2, items: items.length ? items : [] },
          { id: "magic", type: "basic", title: "Magic & Special", span: 1, items: magic.length ? magic : [] },
          { id: "tools", type: "basic", title: "Tools / Kits", span: 1, items: tools.length ? tools : [] }
        ];
      }
      state.inventory.sections.forEach(section=>{
        if (!Number.isFinite(section.span)) section.span = 3;
        if (section.type === "attunement") section.lockedTitle = true;
        if (section.type === "detailed" && !Array.isArray(section.items)) section.items = [];
        if (section.type === "basic" && !Array.isArray(section.items)) section.items = [];
      });
    }

    function getInventorySectionById(id){
      normalizeInventorySections();
      return (state.inventory.sections || []).find(s=> s.id === id);
    }

    function renderInventory(){
      normalizeInventorySections();
      const grid = $("#inventoryGrid");
      if (!grid) return;
      const canEdit = !!state.settings.editUnlocked;
      grid.innerHTML = (state.inventory.sections || []).map(section=>{
        const span = clamp(parseInt(section.span, 10) || 3, 1, 3);
        const baseAttrs = `data-section-id="${escapeHTML(section.id)}" data-section-type="${escapeHTML(section.type)}" style="grid-column: span ${span};" ${canEdit ? `draggable="true"` : ""}`;
        const titleBtn = canEdit
          ? `<button class="inventory-section-title" type="button" data-inventory-action="edit-section">${escapeHTML(section.title || "Section")}</button>`
          : `<div class="inventory-section-title" style="cursor:default;">${escapeHTML(section.title || "Section")}</div>`;
        const actionButtons = section.type === "attunement"
          ? `<button class="mini" id="addAttuneBtn" type="button" data-inventory-action="add-attune" title="Add attunement slot (edit mode only)" style="display:${canEdit ? "grid" : "none"};">ï¼‹</button>`
          : `${canEdit ? `<button class="note-icon-btn" type="button" data-inventory-action="add-row" title="Add row">ï¼‹</button>` : ""}`;

        if (section.type === "attunement"){
          const attuneRows = (state.inventory.attunements || []).map((a, idx) => `
            <div class="attune-row" role="button" tabindex="0" data-attune-index="${idx}">
              <strong class="attune-slot">Slot ${idx+1}</strong>
              <div>${escapeHTML(a.item || "(empty)")}</div>
              <div class="attune-notes">${escapeHTML(a.notes || "")}</div>
            </div>
          `).join("");
          return `
            <div class="inventory-section" ${baseAttrs}>
              <div class="inventory-section-header">
                <div class="inventory-section-title" style="cursor:default;">${escapeHTML(section.title || "Attunement")}</div>
                <div class="inventory-section-actions">${actionButtons}</div>
              </div>
              <div class="small">Three slots by default. In edit mode you can add more slots.</div>
              <div class="attune" id="attuneList">${attuneRows}</div>
            </div>
          `;
        }
        if (section.type === "equipped"){
          const equippedRows = (state.inventory.equipped || []).map((item, idx)=>`
            <div class="equipped-row">
              <div class="small muted">Slot ${idx + 1}</div>
              <input class="inventory-input" data-equipped-index="${idx}" data-inventory-field="equipped" value="${escapeHTML(item || "")}" placeholder="Equipped item" ${canEdit ? "" : "readonly"} />
            </div>
          `).join("");
          return `
            <div class="inventory-section" ${baseAttrs}>
              <div class="inventory-section-header">
                ${titleBtn}
                <div class="inventory-section-actions"></div>
              </div>
              <div class="equipped-list">${equippedRows}</div>
            </div>
          `;
        }
        if (section.type === "detailed"){
          const rows = (section.items || []).map((item, idx)=>`
            <tr data-item-index="${idx}">
              <td><input class="inventory-input" data-inventory-field="name" value="${escapeHTML(item.name || "")}" placeholder="Item" ${canEdit ? "" : "readonly"} /></td>
              <td>
                <div class="qty-stepper">
                  <input class="inventory-input" data-inventory-field="qty" type="number" value="${item.qty ?? 0}" min="0" />
                  <div class="qty-stepper-buttons">
                    <button class="qty-stepper-btn" type="button" data-inventory-action="qty-up">â–²</button>
                    <button class="qty-stepper-btn" type="button" data-inventory-action="qty-down">â–¼</button>
                  </div>
                </div>
              </td>
              <td><input class="inventory-input" data-inventory-field="notes" value="${escapeHTML(item.notes || "")}" placeholder="Notes" ${canEdit ? "" : "readonly"} /></td>
              ${canEdit ? `<td><button class="note-icon-btn" type="button" data-inventory-action="remove-row">âœ•</button></td>` : ""}
            </tr>
          `).join("");
          return `
            <div class="inventory-section" ${baseAttrs}>
              <div class="inventory-section-header">
                ${titleBtn}
                <div class="inventory-section-actions">${actionButtons}</div>
              </div>
              <div class="inventory-section-body">
                <table>
                  <thead><tr><th>Item</th><th class="right">Qty</th><th>Notes</th>${canEdit ? `<th></th>` : ""}</tr></thead>
                  <tbody>
                    ${rows || `<tr><td class="muted" colspan="${canEdit ? 4 : 3}">No items yet.</td></tr>`}
                  </tbody>
                </table>
              </div>
            </div>
          `;
        }
        const basicItems = (section.items || []).map((item, idx)=>`
          <div class="inventory-basic-item" data-item-index="${idx}">
            <input class="inventory-input" data-inventory-field="basic" value="${escapeHTML(item || "")}" placeholder="Item" ${canEdit ? "" : "readonly"} />
            ${canEdit ? `<button class="note-icon-btn" type="button" data-inventory-action="remove-row">âœ•</button>` : ""}
          </div>
        `).join("");
        return `
          <div class="inventory-section" ${baseAttrs}>
            <div class="inventory-section-header">
              ${titleBtn}
              <div class="inventory-section-actions">${actionButtons}</div>
            </div>
            <div class="inventory-basic-list">
              ${basicItems || `<div class="notes-empty">No entries yet.</div>`}
            </div>
          </div>
        `;
      }).join("");
    }

    const INVENTORY_PRESET_PACKS = {
      "explorers-pack": {
        title: "Explorerâ€™s Pack",
        items: [
          { name: "Backpack", qty: 1, notes: "" },
          { name: "Bedroll", qty: 1, notes: "" },
          { name: "Rations (10 days)", qty: 1, notes: "" },
          { name: "Waterskin", qty: 1, notes: "" }
        ]
      },
      "burglar-pack": {
        title: "Burglarâ€™s Pack",
        items: [
          { name: "Backpack", qty: 1, notes: "" },
          { name: "Ball Bearings (1,000)", qty: 1, notes: "" },
          { name: "Hooded Lantern", qty: 1, notes: "" },
          { name: "Oil (2 flasks)", qty: 2, notes: "" }
        ]
      },
      "diplomat-pack": {
        title: "Diplomatâ€™s Pack",
        items: [
          { name: "Chest", qty: 1, notes: "" },
          { name: "Fine Clothes", qty: 1, notes: "" },
          { name: "Ink (1 oz bottle)", qty: 1, notes: "" },
          { name: "Paper (5 sheets)", qty: 5, notes: "" }
        ]
      },
      "priest-pack": {
        title: "Priestâ€™s Pack",
        items: [
          { name: "Backpack", qty: 1, notes: "" },
          { name: "Blanket", qty: 1, notes: "" },
          { name: "Rations (10 days)", qty: 1, notes: "" },
          { name: "Waterskin", qty: 1, notes: "" }
        ]
      },
      "scholar-pack": {
        title: "Scholarâ€™s Pack",
        items: [
          { name: "Backpack", qty: 1, notes: "" },
          { name: "Book of Lore", qty: 1, notes: "" },
          { name: "Ink (1 oz bottle)", qty: 1, notes: "" },
          { name: "Parchment (10 sheets)", qty: 10, notes: "" }
        ]
      },
      "disguise-kit": {
        title: "Disguise Kit",
        items: [
          { name: "Cosmetics", qty: 1, notes: "" },
          { name: "Wig", qty: 1, notes: "" },
          { name: "Small Props", qty: 1, notes: "" },
          { name: "Pouch", qty: 1, notes: "" }
        ]
      }
    };

    function addInventorySection(section){
      normalizeInventorySections();
      state.inventory.sections.push(section);
      saveSettings();
      renderInventory();
    }

    function openAddBagDialog(){
      if (!state.settings.editUnlocked) return;
      normalizeInventorySections();
      $("#addBagTitle").value = "";
      $("#addBagType").value = "detailed";
      $("#addBagSpan").value = "3";
      $("#addBagDialog").showModal();
    }

    function handleAddBagApply(){
      const title = $("#addBagTitle").value.trim() || `Bag ${state.inventory.sections.length + 1}`;
      const type = $("#addBagType").value;
      const span = parseInt($("#addBagSpan").value, 10) || 3;
      const section = {
        id: `inv-${Date.now()}`,
        type,
        title,
        span,
        items: type === "detailed" ? [] : []
      };
      addInventorySection(section);
      $("#addBagDialog").close();
    }

    function openInventorySectionDialog(section){
      if (!state.settings.editUnlocked) return;
      if (!section) return;
      const dlg = $("#inventorySectionDialog");
      dlg.dataset.sectionId = section.id;
      $("#inventorySectionTitle").value = section.title || "";
      $("#inventorySectionSpan").value = String(section.span || 3);
      $("#inventorySectionTitle").disabled = !!section.lockedTitle;
      dlg.showModal();
    }

    function saveInventorySectionDialog(){
      const dlg = $("#inventorySectionDialog");
      const sectionId = dlg.dataset.sectionId;
      const section = getInventorySectionById(sectionId);
      if (!section) return;
      if (!section.lockedTitle){
        section.title = $("#inventorySectionTitle").value.trim() || section.title;
      }
      section.span = parseInt($("#inventorySectionSpan").value, 10) || section.span;
      dlg.close();
      saveSettings();
      renderInventory();
    }

    let notesSearchQuery = "";

    function createNoteId(){
      return `note-${Date.now()}-${Math.floor(Math.random() * 10000)}`;
    }

    function createSectionId(){
      return `section-${Date.now()}-${Math.floor(Math.random() * 10000)}`;
    }

    function normalizeNotesTabs(tabs){
      if (!Array.isArray(tabs) || tabs.length === 0){
        return state.notesTabs;
      }
      return tabs.map((tab, tabIdx)=>({
        id: tab.id || `tab-${tabIdx}-${Date.now()}`,
        label: tab.label || `Tab ${tabIdx + 1}`,
        sections: Array.isArray(tab.sections) && tab.sections.length
          ? tab.sections.map((section, secIdx)=>({
            id: section.id || `section-${tabIdx}-${secIdx}-${Date.now()}`,
            title: section.title || "Notes",
            collapsed: !!section.collapsed,
            notes: Array.isArray(section.notes)
              ? section.notes.map((note, noteIdx)=>({
                id: note.id || `note-${tabIdx}-${secIdx}-${noteIdx}-${Date.now()}`,
                title: note.title || "Untitled",
                body: toNoteHtml(note.body || ""),
                starred: !!note.starred,
                starColor: note.starColor || "",
                status: note.status || null
              }))
              : []
          }))
          : [{ id: createSectionId(), title: "Notes", collapsed: false, notes: [] }]
      }));
    }

    function getActiveNotesTab(){
      return (state.notesTabs || []).find(t=> t.id === state.notesActiveTabId) || state.notesTabs[0];
    }

    function setActiveNotesTab(tabId){
      state.notesActiveTabId = tabId;
      renderNotes();
      saveSettings();
    }

    function stripHtml(html){
      const temp = document.createElement("div");
      temp.innerHTML = html;
      return temp.textContent || temp.innerText || "";
    }

    function isHtmlContent(text){
      return /<\/?[a-z][\s\S]*>/i.test(String(text || ""));
    }

    function toNoteHtml(text){
      if (!text) return "";
      if (isHtmlContent(text)) return text;
      return String(text || "")
        .split(/\r?\n/)
        .map(line=> line.trim())
        .map(line=> line ? `<p>${escapeHTML(line)}</p>` : `<div style="height:8px;"></div>`)
        .join("");
    }

    function matchesNotesQuery(note, query){
      if (!query) return true;
      const q = query.toLowerCase();
      const title = String(note.title || "").toLowerCase();
      const bodyText = stripHtml(String(note.body || "")).toLowerCase();
      return title.includes(q) || bodyText.includes(q);
    }

    function renderNotesSubtabs(){
      const tabsWrap = $("#notesSubtabs");
      if (!tabsWrap) return;
      const canEdit = !!state.settings.editUnlocked;
      const tabs = (state.notesTabs || []).map(tab=>{
        const active = tab.id === state.notesActiveTabId;
        return `<button class="notes-tab" type="button" data-notes-tab="${escapeHTML(tab.id)}" aria-selected="${active ? "true" : "false"}">${escapeHTML(tab.label)}</button>`;
      }).join("");
      const addTabBtn = canEdit ? `<button class="notes-tab notes-tab-add" type="button" data-notes-tab-add aria-label="Add tab">ï¼‹</button>` : "";
      tabsWrap.innerHTML = tabs + addTabBtn;
    }

    function renderNotes(){
      renderNotesSubtabs();
      const searchInput = $("#notesSearchInput");
      if (searchInput && searchInput.value !== notesSearchQuery){
        searchInput.value = notesSearchQuery;
      }
      const sectionsWrap = $("#notesSections");
      if (!sectionsWrap) return;
      const tab = getActiveNotesTab();
      if (!tab){
        sectionsWrap.innerHTML = `<div class="notes-empty">No notes tabs available.</div>`;
        return;
      }
      const query = notesSearchQuery.trim().toLowerCase();
      const canEdit = !!state.settings.editUnlocked;
      sectionsWrap.innerHTML = (tab.sections || []).map(section=>{
        const matches = (section.notes || []).filter(note=> matchesNotesQuery(note, query));
        const notesHtml = matches.length ? matches.map(note=>{
          const status = note.status || "none";
          const starred = note.starred ? "is-starred" : "";
          const starStyle = note.starColor ? `style="--note-star: ${escapeHTML(note.starColor)};"` : "";
          const bodyHtml = toNoteHtml(note.body || "");
          const titleText = escapeHTML(note.title || "Untitled");
          return `
            <div class="note-card ${starred}" data-note-id="${escapeHTML(note.id)}" data-section-id="${escapeHTML(section.id)}" data-tab-id="${escapeHTML(tab.id)}" data-status="${escapeHTML(status)}" ${starStyle} ${canEdit ? `draggable="true"` : ""}>
              <div class="note-header">
                <div class="note-title">
                  <button class="note-title-btn" type="button" data-note-action="open" title="Edit note">${titleText}</button>
                </div>
                <div class="note-actions">
                  <button class="note-icon-btn" type="button" data-note-action="star" aria-pressed="${note.starred ? "true" : "false"}" title="Star (shift-click to remove)">â˜…</button>
                  <button class="note-icon-btn" type="button" data-note-action="done" aria-pressed="${note.status === "done" ? "true" : "false"}" title="Complete">âœ“</button>
                  <button class="note-icon-btn" type="button" data-note-action="failed" aria-pressed="${note.status === "failed" ? "true" : "false"}" title="Failed">âœ•</button>
                  <button class="note-icon-btn" type="button" data-note-action="important" aria-pressed="${note.status === "important" ? "true" : "false"}" title="Important">â—</button>
                  ${canEdit ? `
                    <button class="note-icon-btn" type="button" data-note-action="edit" title="Edit">âœŽ</button>
                    <button class="note-icon-btn" type="button" data-note-action="delete" title="Delete">ðŸ—‘</button>
                  ` : ""}
                </div>
              </div>
              <div class="note-body">${bodyHtml}</div>
            </div>
          `;
        }).join("") : `<div class="notes-empty">No matching notes in this section.</div>`;

        return `
          <div class="notes-section ${section.collapsed ? "collapsed" : ""}" data-section-id="${escapeHTML(section.id)}">
            <div class="notes-section-header">
              <div class="notes-section-title">${escapeHTML(section.title)}</div>
              <div class="notes-section-actions">
                <button class="note-icon-btn notes-section-toggle" type="button" data-section-action="toggle" title="Collapse / expand">â–¾</button>
              </div>
            </div>
            <div class="notes-section-body">
              ${notesHtml}
            </div>
          </div>
        `;
      }).join("");
    }

    function addNotesSection(){
      if (!state.settings.editUnlocked) return;
      const tab = getActiveNotesTab();
      if (!tab) return;
      const title = prompt("Section title", "Notes");
      if (!title) return;
      tab.sections.push({
        id: createSectionId(),
        title: title.trim(),
        collapsed: false,
        notes: []
      });
      saveSettings();
      renderNotes();
    }

    function addNotesTab(){
      if (!state.settings.editUnlocked) return;
      const label = prompt("Tab name", "Notes");
      if (!label) return;
      const id = `tab-${Date.now()}`;
      state.notesTabs.push({
        id,
        label: label.trim(),
        sections: [{ id: createSectionId(), title: "Notes", collapsed: false, notes: [] }]
      });
      state.notesActiveTabId = id;
      saveSettings();
      renderNotes();
    }

    function addNoteToActiveTab(note, tabId, sectionId){
      const target = resolveNotesTarget(tabId, sectionId);
      if (!target) return;
      target.section.notes.unshift(note);
      saveSettings();
      renderNotes();
    }

    function openNoteEditor(context = {}){
      const dialog = $("#noteEditorDialog");
      const titleInput = $("#noteEditorTitleInput");
      const body = $("#noteEditorBody");
      titleInput.value = context.note ? (context.note.title || "") : "";
      body.innerHTML = context.note ? toNoteHtml(context.note.body || "") : "";
      dialog.dataset.noteId = context.note ? context.note.id : "";
      dialog.dataset.sectionId = context.sectionId || "";
      dialog.dataset.tabId = context.tabId || "";
      $("#noteEditorDialogTitle").textContent = context.note ? "Edit Note" : "New Note";
      dialog.showModal();
      setTimeout(()=> body.focus(), 10);
    }

    function findNoteById(tabId, sectionId, noteId){
      const tab = (state.notesTabs || []).find(t=> t.id === tabId);
      if (!tab) return null;
      const section = (tab.sections || []).find(s=> s.id === sectionId);
      if (!section) return null;
      const note = (section.notes || []).find(n=> n.id === noteId);
      return { tab, section, note };
    }

    function resolveNotesTarget(tabId, sectionId){
      const tab = (state.notesTabs || []).find(t=> t.id === tabId) || getActiveNotesTab();
      if (!tab) return null;
      const section = (tab.sections || []).find(s=> s.id === sectionId) || tab.sections?.[0];
      if (!section) return null;
      return { tab, section };
    }

    function toggleNoteStatus(note, status){
      if (!note) return;
      note.status = note.status === status ? null : status;
    }

    function moveNote(section, noteId, direction){
      if (!section || !Array.isArray(section.notes)) return;
      const idx = section.notes.findIndex(n=> n.id === noteId);
      if (idx < 0) return;
      const next = idx + direction;
      if (next < 0 || next >= section.notes.length) return;
      const [note] = section.notes.splice(idx, 1);
      section.notes.splice(next, 0, note);
    }

    function renderCustomCurrencyPanel(){
      const panel = $("#customCurrencyPanel");
      if (!panel) return;
      const canEdit = !!state.settings.editUnlocked;
      panel.style.display = canEdit ? "block" : "none";
      if (!canEdit) return;

      const list = $("#customCoinList");
      list.innerHTML = state.customCurrencies.map(c => `
        <div class="row" style="align-items:center; justify-content:space-between; margin-bottom:8px;">
          <div class="small">${escapeHTML(c.name)} (${escapeHTML(c.k)}) â€¢ ${c.val} gp</div>
          <button class="btn" type="button" data-custom-coin="${escapeHTML(c.k)}">Remove</button>
        </div>
      `).join("");
    }

    function addCustomCurrency(){
      const name = $("#customCoinName").value.trim();
      const key = $("#customCoinKey").value.trim().toLowerCase();
      const val = parseFloat($("#customCoinValue").value);
      const icon = $("#customCoinIcon").value.trim();
      if (!name || !key || !Number.isFinite(val)) return;
      if (getCurrencies().some(c => c.k === key)) return;

      state.customCurrencies.push({ k: key, name, val, icon });
      state.coins[key] = state.coins[key] || 0;
      $("#customCoinName").value = "";
      $("#customCoinKey").value = "";
      $("#customCoinValue").value = "";
      $("#customCoinIcon").value = "";
      renderCoinPurse();
    }

    function removeCustomCurrency(key){
      state.customCurrencies = state.customCurrencies.filter(c => c.k !== key);
      delete state.coins[key];
      renderCoinPurse();
    }

    function renderCoinPurse(){
      const total = coinTotalGP(state.coins);
      $("#coinTotal").textContent = total.toFixed(2);

      const cards = getCurrencies().map(c => {
        const amt = state.coins[c.k] || 0;
        const isStandard = DEFAULT_CURRENCIES.some(d => d.k === c.k);
        return `
          <div class="coin-card ${isStandard ? "is-standard" : ""}" data-coin="${c.k}" role="button" tabindex="0" aria-label="Adjust ${escapeHTML(c.name)} coins">
            <div class="coin-left">
              <div class="coin-ic">${c.icon ? `<img src="${c.icon}" alt="${escapeHTML(c.name)}" />` : escapeHTML(c.k.toUpperCase())}</div>
              <div class="coin-meta">
                <div class="coin-name">${escapeHTML(c.name)} (${escapeHTML(c.k)})</div>
              </div>
            </div>
            <div class="coin-amt">${amt}</div>
          </div>
        `;
      }).join("");

      $("#coinCards").innerHTML = cards;
      renderCustomCurrencyPanel();
    }

    /**********************************************************************
     * UI / dialogs
     **********************************************************************/
    function openStatusDialog(){
      normalizeStatusConditions();
      renderConditionList();
      $("#exhaustSel").value = String(state.status.exhaustion);
      renderCurrentStatusList();
      $("#statusDialog").showModal();
    }
    function renderConditionList(){
      const list = $("#condList");
      if (!list || list.dataset.built) return;
      list.innerHTML = CONDITIONS.map(c => `
        <button class="cond-btn" type="button" data-condition="${escapeHTML(c)}">${escapeHTML(c)}</button>
      `).join("");
      list.dataset.built = "1";
    }
    function openStatusAddDialog(name){
      const dialog = $("#statusAddDialog");
      dialog.dataset.condition = name;
      $("#statusAddTitle").textContent = `Add ${name}`;
      $("#statusAddDesc").textContent = CONDITION_DETAILS[name] || "";
      $("#statusAddValue").value = 1;
      $("#statusAddUnit").value = "turns";
      updateStatusAddControls();
      dialog.showModal();
    }
    function updateStatusAddControls(){
      const unit = $("#statusAddUnit").value;
      const valueInput = $("#statusAddValue");
      const isFixed = unit === "indefinite" || unit === "permanent";
      valueInput.style.display = isFixed ? "none" : "inline-flex";
      valueInput.disabled = isFixed;
    }
    function applyStatusAdd(){
      const dialog = $("#statusAddDialog");
      const name = dialog.dataset.condition;
      if (!name) return;
      const unit = $("#statusAddUnit").value;
      const value = unit === "indefinite" || unit === "permanent"
        ? null
        : Math.max(1, parseInt($("#statusAddValue").value, 10) || 1);
      state.status.conditions = state.status.conditions.filter(c => c.name !== name);
      state.status.conditions.push({
        name,
        durationUnit: unit,
        durationValue: value,
        addedAt: Date.now()
      });
      dialog.close();
      renderCurrentStatusList();
      renderTopbar();
    }
    function clearStatus(){
      state.status.conditions = [];
      state.status.exhaustion = 0;
      $("#exhaustSel").value = "0";
      renderCurrentStatusList();
      renderTopbar();
    }

    function openCoinDialog(){
      renderCoinPurse();
      $("#coinDialog").showModal();
    }
    function openCoinAdjustDialog(key){
      const currency = getCurrency(key);
      if (!currency) return;
      const dialog = $("#coinAdjustDialog");
      dialog.dataset.coin = key;
      $("#coinAdjustTitle").textContent = `${currency.name} (${currency.k.toUpperCase()})`;
      $("#coinAdjustCurrent").textContent = String(state.coins[key] ?? 0);
      setCoinAdjustMode("set");
      dialog.showModal();
    }
    function setCoinAdjustMode(mode){
      const dialog = $("#coinAdjustDialog");
      const key = dialog.dataset.coin;
      if (!key) return;
      const currency = getCurrency(key);
      if (!currency) return;
      dialog.dataset.mode = mode;
      dialog.querySelectorAll("[data-coin-mode]").forEach((btn)=>{
        btn.setAttribute("aria-pressed", btn.dataset.coinMode === mode ? "true" : "false");
      });
      const current = state.coins[key] ?? 0;
      const hint = $("#coinAdjustHint");
      if (mode === "add"){
        hint.textContent = `Add ${currency.name} coins.`;
        $("#coinAdjustValue").value = "";
      } else if (mode === "remove"){
        hint.textContent = `Remove ${currency.name} coins.`;
        $("#coinAdjustValue").value = "";
      } else {
        hint.textContent = `Set total ${currency.name} coins.`;
        $("#coinAdjustValue").value = String(current);
      }
      $("#coinAdjustCurrent").textContent = String(current);
    }
    function applyCoinAmount(){
      const dialog = $("#coinAdjustDialog");
      const key = dialog.dataset.coin;
      if (!key) return;
      const mode = dialog.dataset.mode || "set";
      const current = state.coins[key] ?? 0;
      const amount = Math.max(0, parseInt($("#coinAdjustValue").value, 10) || 0);
      let next = current;
      if (mode === "add"){
        next = current + amount;
      } else if (mode === "remove"){
        next = Math.max(0, current - amount);
      } else {
        next = amount;
      }
      state.coins[key] = next;
      $("#coinAdjustCurrent").textContent = String(next);
      renderCoinPurse();
      renderTopbar();
      dialog.close();
    }
    function openAttuneDialog(index){
      const item = state.inventory.attunements[index];
      if (!item) return;
      $("#attuneDialogTitle").textContent = item.item || "Attunement Slot";
      $("#attuneDialogBrief").textContent = item.notes || "";
      $("#attuneDialogDetail").textContent = item.detail || "";
      $("#attuneDialog").showModal();
    }

    // HP
    function damageHP(amount){
      amount = Math.max(0, amount|0);
      if (amount === 0) return;

      const fromTemp = Math.min(state.hp.temp, amount);
      state.hp.temp -= fromTemp;
      amount -= fromTemp;

      state.hp.cur = clamp(state.hp.cur - amount, 0, state.hp.max);
    }
    function healHP(amount){
      amount = Math.max(0, amount|0);
      state.hp.cur = clamp(state.hp.cur + amount, 0, state.hp.max);
    }
    function setTempHP(amount){
      amount = Math.max(0, amount|0);
      state.hp.temp = Math.max(state.hp.temp, amount); // temp doesn't stack
    }
    function adjustHpAmount(delta){
      const input = $("#hpAmt");
      const value = parseInt(input.value, 10) || 0;
      input.value = Math.max(0, value + delta);
    }

    // Rest
    function openShortRest(){
      $("#hdDieLabel").textContent = `d${state.hitDice.die}`;
      $("#hdTotal").textContent = state.hitDice.total;
      $("#hdRemain").textContent = state.hitDice.remaining;
      $("#hdCon").textContent = formatSigned(state.hitDice.conMod);
      $("#hdSpend").value = "1";
      $("#hdResult").textContent = `Wild Shape uses remaining: ${state.wildShape.remaining}/${state.wildShape.max}`;
      $("#shortRestDialog").showModal();
    }
    function rollHitDice(){
      let spend = parseInt($("#hdSpend").value, 10) || 0;
      spend = clamp(spend, 0, state.hitDice.remaining);
      if (spend === 0){
        $("#hdResult").textContent = "No hit dice spent.";
        return;
      }

      const rolls = [];
      let totalRoll = 0;
      for (let i=0; i<spend; i++){
        const r = 1 + Math.floor(Math.random() * state.hitDice.die);
        rolls.push(r);
        totalRoll += r;
      }
      const heal = totalRoll + (state.hitDice.conMod * spend);
      state.hitDice.remaining -= spend;
      healHP(heal);

      $("#hdRemain").textContent = state.hitDice.remaining;
      $("#hdResult").textContent = `Rolled: [${rolls.join(", ")}] + ${state.hitDice.conMod}Ã—${spend} = ${heal} healed.`;
      renderHP();
      renderTopbar();
    }
    function completeShortRest(){
      state.wildShape.remaining = state.wildShape.max;
      $("#hdResult").textContent = `Short rest complete. Wild Shape reset to ${state.wildShape.remaining}/${state.wildShape.max}.`;
      renderTopbar();
    }
    function applyLongRest(){
      state.hp.cur = state.hp.max;
      state.hp.temp = 0;

      const half = Math.max(1, Math.floor(state.hitDice.total / 2));
      state.hitDice.remaining = Math.min(state.hitDice.total, state.hitDice.remaining + half);

      state.wildShape.remaining = state.wildShape.max;

      renderHP();
      renderTopbar();
    }

    /**********************************************************************
     * Tabs
     **********************************************************************/
    function setActiveTab(tab){
      document.querySelectorAll(".tab").forEach(b=>{
        const active = (b.dataset.tab === tab);
        b.setAttribute("aria-selected", active ? "true" : "false");
      });
      document.querySelectorAll("[data-tabpanel]").forEach(p=>{
        p.dataset.active = (p.id === `tab-${tab}`) ? "true" : "false";
      });
      const dock = $("#notesTabDock");
      if (dock) dock.dataset.active = tab === "notes" ? "true" : "false";
    }

    function setSubtab(which, scopeEl){
      const scope = scopeEl || document;
      scope.querySelectorAll('.subtab').forEach(b=>{
        const active = (b.dataset.subtab === which);
        b.setAttribute('aria-selected', active ? 'true' : 'false');
      });
      scope.querySelectorAll('[data-subpanel]').forEach(p=>{
        p.dataset.active = (p.dataset.subpanel === which) ? 'true' : 'false';
      });
    }

    /**********************************************************************
     * Settings (theme + wide)
     **********************************************************************/
    function loadSettings(){
      try{
        const raw = localStorage.getItem("dnd_sheet_settings_v3");
        if (raw){
          const s = JSON.parse(raw);
          if (s && typeof s === "object"){
            state.settings.theme = s.theme ?? state.settings.theme;
            state.settings.wide = (s.wide ?? state.settings.wide);
            state.settings.editUnlocked = (s.editUnlocked ?? state.settings.editUnlocked);
            state.settings.debugEnabled = (s.debugEnabled ?? state.settings.debugEnabled);
            state.xpMode = s.xpMode ?? state.xpMode;
            state.xp = s.xp ?? state.xp;
            state.xpLevel = s.xpLevel ?? state.xpLevel;
            state.customCurrencies = Array.isArray(s.customCurrencies) ? s.customCurrencies : state.customCurrencies;
            state.coins = s.coins ?? state.coins;
            if (s.inventory && typeof s.inventory === "object"){
              state.inventory = { ...state.inventory, ...s.inventory };
            }

            // spells / spellbooks persisted
            if (Array.isArray(s.spellbooks)) state.spellbooks = s.spellbooks;
            if (s.spells && typeof s.spells === 'object') state.spells = { ...state.spells, ...s.spells };

            // portrait persisted
            if (s.portrait){
              state.portrait.url = s.portrait.url ?? state.portrait.url;
              state.portrait.zoom = s.portrait.zoom ?? state.portrait.zoom;
              const rawX = s.portrait.x ?? state.portrait.x;
              const rawY = s.portrait.y ?? state.portrait.y;
              const legacy = rawX >= 0 && rawX <= 100 && rawY >= 0 && rawY <= 100;
              state.portrait.x = legacy ? rawX - 50 : rawX;
              state.portrait.y = legacy ? rawY - 50 : rawY;
              state.portrait.rotate = s.portrait.rotate ?? state.portrait.rotate ?? 0;
            }

            if (Array.isArray(s.notesTabs)){
              state.notesTabs = normalizeNotesTabs(s.notesTabs);
            }
            if (s.notesActiveTabId){
              state.notesActiveTabId = s.notesActiveTabId;
            }
          }
        }
      }catch{}
      if (!state.notesTabs.find(t=> t.id === state.notesActiveTabId)){
        state.notesActiveTabId = state.notesTabs[0]?.id || "notes";
      }
      applyTheme(state.settings.theme);
      applyWide();
      applyDebugMode();
      applyEditMode(state.settings.editUnlocked);
      renderPortrait();
    }

    function saveSettings(){
      localStorage.setItem("dnd_sheet_settings_v3", JSON.stringify({
        theme: state.settings.theme,
        wide: state.settings.wide,
        editUnlocked: state.settings.editUnlocked,
        debugEnabled: state.settings.debugEnabled,
        portrait: { ...state.portrait },
        xpMode: state.xpMode,
        xp: state.xp,
        xpLevel: state.xpLevel,
        coins: state.coins,
        customCurrencies: state.customCurrencies,
        inventory: state.inventory,
        spells: state.spells,
        spellbooks: state.spellbooks,
        notesTabs: state.notesTabs,
        notesActiveTabId: state.notesActiveTabId
      }));
    }

    function exportCharacter(){
      const payload = {
        version: 1,
        exportedAt: new Date().toISOString(),
        state
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `${slugify(state.name || "character") || "character"}-sheet.json`;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
    }

    function applyImportedState(data){
      if (!data || typeof data !== "object") return;
      const incoming = data.state && typeof data.state === "object" ? data.state : data;
      Object.keys(incoming).forEach(key=>{
        state[key] = incoming[key];
      });
      if (Array.isArray(state.notesTabs)){
        state.notesTabs = normalizeNotesTabs(state.notesTabs);
      }
      normalizeStatusConditions();
      normalizeInventorySections();
      applyTheme(state.settings.theme);
      applyWide();
      applyDebugMode();
      renderPortrait();
      renderTopbar();
      renderHP();
      renderMain();
      renderAbilities();
      renderCoinPurse();
      renderCombat();
      renderSpells();
      renderInventory();
      renderNotes();
      applyXPMode();
      saveSettings();
    }

    function applyTheme(theme){
      document.documentElement.setAttribute("data-theme", theme);
      state.settings.theme = theme;
      document.querySelectorAll('input[name="theme"]').forEach(r=>{
        r.checked = (r.value === theme);
      });
    }

    function openSettings(){
      applyTheme(state.settings.theme);
      $("#wideToggle").checked = !!state.settings.wide;
      $("#debugToggle").checked = !!state.settings.debugEnabled;
      const isXP = state.xpMode === "xp";
      $("#btnModeMilestone").setAttribute("aria-pressed", isXP ? "false" : "true");
      $("#btnModeXP").setAttribute("aria-pressed", isXP ? "true" : "false");
      $("#progressValue").textContent = isXP ? "XP" : "Milestone";
      $("#settingsDialog").showModal();
    }

    /**********************************************************************
     * Edit mode (lock)
     **********************************************************************/
    function applyEditMode(unlocked){
      state.settings.editUnlocked = !!unlocked;
      document.body.setAttribute("data-edit", unlocked ? "on" : "off");

      $("#lockFab").setAttribute("aria-pressed", unlocked ? "true" : "false");
      $("#lockFab").title = unlocked ? "Lock to stop editing" : "Unlock to edit";
      $("#lockIconClosed").style.display = unlocked ? "none" : "block";
      $("#lockIconOpen").style.display = unlocked ? "block" : "none";

      document.querySelectorAll(".editable").forEach(el=>{
        el.contentEditable = unlocked ? "true" : "false";
        if (!unlocked) el.blur();
      });

      // show/hide edit-only buttons
      $("#addSkillBtn").style.display = unlocked ? "grid" : "none";
      $("#addAbilityBtn").style.display = unlocked ? "grid" : "none";
      const attuneBtn = $("#addAttuneBtn");
      if (attuneBtn) attuneBtn.style.display = unlocked ? "grid" : "none";
      if (document.getElementById('addSpellbookBtn')) $("#addSpellbookBtn").style.display = unlocked ? 'inline-flex' : 'none';
      const addBagBtn = $("#addBagBtn");
      if (addBagBtn) addBagBtn.style.display = unlocked ? "inline-flex" : "none";
      ["addNoteSectionBtn"].forEach(id=>{
        const btn = document.getElementById(id);
        if (!btn) return;
        btn.disabled = !unlocked;
      });

      renderAbilities();
      renderCoinPurse();
      renderNotes();
      renderInventory();
      saveSettings();
    }

    function syncEditableToState(){
      const mainName = $("#mainName").textContent.trim();
      if (mainName) state.name = mainName;

      const tag = $("#mainTagline").textContent.trim();
      if (tag) state.tagline = tag;

      const cls = $("#mainClasses").textContent.trim();
      if (cls) state.classSummary = cls;

      const race = $("#mainRace").textContent.trim();
      if (race) state.race = race;

      const mAc = normalizeNumberText($("#m_ac").textContent);
      if (mAc !== null) state.ac = mAc;

      const mInit = normalizeNumberText($("#m_init").textContent);
      if (mInit !== null) state.init = mInit;

      const mSpd = normalizeNumberText($("#m_spd").textContent);
      if (mSpd !== null) state.speed = mSpd;

      const mProf = normalizeNumberText($("#m_prof").textContent);
      if (mProf !== null) state.prof = mProf;

      const mHpMax = normalizeNumberText($("#m_hp_max").textContent);
      if (mHpMax !== null) {
        state.hp.max = Math.max(1, mHpMax);
        state.hp.cur = clamp(state.hp.cur, 0, state.hp.max);
      }
      const mHpCur = normalizeNumberText($("#m_hp_cur").textContent);
      if (mHpCur !== null) state.hp.cur = clamp(mHpCur, 0, state.hp.max);

      const spDc = normalizeNumberText($("#sp_dc").textContent);
      if (spDc !== null) state.spells.dc = spDc;

      const spAtk = normalizeNumberText($("#sp_atk").textContent);
      if (spAtk !== null) state.spells.atk = spAtk;

      renderTopbar();
      renderHP();
      renderMain();
      renderCombat();
      if (state.xpMode === "xp") renderXPBox();
    }

    /**********************************************************************
     * Custom Skills / Abilities
     **********************************************************************/
    function populateAbilityDropdowns(){
      const sel = $("#newSkillAbility");
      if (!sel) return;
      sel.innerHTML = state.abilities.map(a => `<option value="${a.key}">${escapeHTML(a.label)}</option>`).join("");
    }

    function openAddSkill(){
      if (!state.settings.editUnlocked) return;
      $("#newSkillName").value = "";
      populateAbilityDropdowns();
      $("#addSkillDialog").showModal();
    }
    function addSkillConfirm(){
      const name = $("#newSkillName").value.trim();
      const abil = $("#newSkillAbility").value;
      if (!name) return;
      if (state.skills.some(s => s.name.toLowerCase() === name.toLowerCase())) return;

      state.skills.push({ name, abil });
      state.skills[state.skills.length - 1].custom = true;
      state.skillProfs[name] = 0;
      $("#addSkillDialog").close();
      renderAbilities();
    }

    function openAddAbility(){
      if (!state.settings.editUnlocked) return;
      $("#newAbilityLabel").value = "";
      $("#newAbilityScore").value = 10;
      $("#addAbilityDialog").showModal();
    }
    function makeKeyFromLabel(label){
      return label.toLowerCase().replace(/[^a-z0-9]+/g,"").slice(0,10) || ("abil" + Math.floor(Math.random()*9999));
    }
    function addAbilityConfirm(){
      const label = $("#newAbilityLabel").value.trim().toUpperCase();
      const score = clamp(parseInt($("#newAbilityScore").value,10) || 10, 1, 30);
      if (!label) return;

      const key = makeKeyFromLabel(label);
      if (state.abilities.some(a => a.label === label)) return;

      state.abilities.push({ key, label, score, saveProf:false, custom:true });
      $("#addAbilityDialog").close();
      renderAbilities();
    }

    /**********************************************************************
     * Portrait editing
     **********************************************************************/
    let portraitDrag = null;
    function openPortraitEditor(){
      $("#portraitUrl").value = state.portrait.url || "";
      $("#portraitZoom").value = state.portrait.zoom ?? 1;
      $("#portraitRotate").value = state.portrait.rotate ?? 0;
      $("#portraitPosX").value = state.portrait.x ?? 0;
      $("#portraitPosY").value = state.portrait.y ?? 0;
      updatePortraitLabels();
      updatePortraitPreview();
      $("#portraitDialog").showModal();
    }
    function applyPortraitUrl(){
      const url = $("#portraitUrl").value.trim();
      if (!url) return;
      state.portrait.url = url;
      renderPortrait();
      updatePortraitPreview();
      saveSettings();
    }
    function updatePortraitLabels(){
      $("#portraitZoomVal").textContent = Number(state.portrait.zoom || 1).toFixed(2);
      $("#portraitRotateVal").textContent = `${state.portrait.rotate || 0}Â°`;
      $("#portraitPosXVal").textContent = `${state.portrait.x || 0}%`;
      $("#portraitPosYVal").textContent = `${state.portrait.y || 0}%`;
      $("#portraitPosLabel").textContent = `${state.portrait.x || 0}% / ${state.portrait.y || 0}%`;
    }
    function applyPortraitControls(){
      state.portrait.zoom = parseFloat($("#portraitZoom").value) || 1;
      state.portrait.rotate = parseInt($("#portraitRotate").value, 10) || 0;
      state.portrait.x = clamp(parseInt($("#portraitPosX").value, 10) || 0, -40, 40);
      state.portrait.y = clamp(parseInt($("#portraitPosY").value, 10) || 0, -40, 40);
      updatePortraitLabels();
      renderPortrait();
      updatePortraitPreview();
      saveSettings();
    }
    function resetPortraitCrop(){
      state.portrait.zoom = 1.00;
      state.portrait.rotate = 0;
      state.portrait.x = 0;
      state.portrait.y = 0;
      $("#portraitZoom").value = state.portrait.zoom;
      $("#portraitRotate").value = state.portrait.rotate;
      $("#portraitPosX").value = state.portrait.x;
      $("#portraitPosY").value = state.portrait.y;
      updatePortraitLabels();
      renderPortrait();
      updatePortraitPreview();
      saveSettings();
    }
    function startPortraitDrag(e){
      const preview = $("#portraitPreview");
      if (!preview || (e.pointerType === "mouse" && e.button !== 0)) return;
      e.preventDefault();
      const rect = preview.getBoundingClientRect();
      preview.classList.add("is-dragging");
      if (preview.setPointerCapture){
        preview.setPointerCapture(e.pointerId);
      }
      portraitDrag = {
        startX: e.clientX,
        startY: e.clientY,
        originX: state.portrait.x,
        originY: state.portrait.y,
        rectW: rect.width || 1,
        rectH: rect.height || 1,
        pointerId: e.pointerId,
        active: true
      };
      window.addEventListener("pointermove", movePortraitDrag);
      window.addEventListener("pointerup", endPortraitDrag);
      window.addEventListener("pointercancel", endPortraitDrag);
    }
    function movePortraitDrag(e){
      if (!portraitDrag) return;
      if (portraitDrag.pointerId !== undefined && e.pointerId !== portraitDrag.pointerId) return;
      e.preventDefault();
      const dx = (e.clientX - portraitDrag.startX) / portraitDrag.rectW * 100;
      const dy = (e.clientY - portraitDrag.startY) / portraitDrag.rectH * 100;
      state.portrait.x = clamp(Math.round(portraitDrag.originX + dx), -40, 40);
      state.portrait.y = clamp(Math.round(portraitDrag.originY + dy), -40, 40);
      $("#portraitPosX").value = state.portrait.x;
      $("#portraitPosY").value = state.portrait.y;
      updatePortraitLabels();
      renderPortrait();
      updatePortraitPreview();
    }
    function endPortraitDrag(e){
      const preview = $("#portraitPreview");
      if (!portraitDrag) return;
      if (portraitDrag.pointerId !== undefined && e.pointerId !== portraitDrag.pointerId) return;
      preview.classList.remove("is-dragging");
      if (preview && preview.releasePointerCapture && portraitDrag.pointerId !== undefined){
        preview.releasePointerCapture(portraitDrag.pointerId);
      }
      portraitDrag = null;
      saveSettings();
      window.removeEventListener("pointermove", movePortraitDrag);
      window.removeEventListener("pointerup", endPortraitDrag);
      window.removeEventListener("pointercancel", endPortraitDrag);
    }

    /**********************************************************************
     * Attunement slots
     **********************************************************************/
    function addAttunementSlot(){
      if (!state.settings.editUnlocked) return;
      state.inventory.attunements.push({ item:"", notes:"(empty)", detail:"No attunement item slotted." });
      renderInventory();
    }

    /**********************************************************************
     * Init
     **********************************************************************/
    function init(){
      state.xpLevel = levelFromXP(state.xp);
      normalizeStatusConditions();
      // portrait
      renderPortrait();
      $("#portraitImg").addEventListener("click", openPortraitEditor);

      // status
      $("#statusBtn").addEventListener("click", openStatusDialog);
      $("#statusClose").addEventListener("click", ()=> $("#statusDialog").close());
      $("#cancelStatusBtn").addEventListener("click", ()=> $("#statusDialog").close());
      $("#clearStatusBtn").addEventListener("click", clearStatus);
      $("#condList").addEventListener("click", (e)=>{
        const btn = e.target.closest("[data-condition]");
        if (!btn) return;
        openStatusAddDialog(btn.dataset.condition);
      });
      $("#exhaustSel").addEventListener("change", ()=>{
        state.status.exhaustion = parseInt($("#exhaustSel").value, 10) || 0;
        renderCurrentStatusList();
        renderTopbar();
      });
      $("#statusAddClose").addEventListener("click", ()=> $("#statusAddDialog").close());
      $("#statusAddApply").addEventListener("click", applyStatusAdd);
      $("#statusAddUnit").addEventListener("change", updateStatusAddControls);

      // money
      $("#moneyBtn").addEventListener("click", openCoinDialog);
      $("#inventoryCurrencyBtn").addEventListener("click", openCoinDialog);
      $("#coinClose").addEventListener("click", ()=> $("#coinDialog").close());
      $("#coinCards").addEventListener("click", (e)=>{
        const card = e.target.closest(".coin-card");
        if (!card) return;
        openCoinAdjustDialog(card.dataset.coin);
      });
      $("#coinCards").addEventListener("keydown", (e)=>{
        if (e.key !== "Enter" && e.key !== " ") return;
        const card = e.target.closest(".coin-card");
        if (!card) return;
        e.preventDefault();
        openCoinAdjustDialog(card.dataset.coin);
      });
      $("#coinAdjustClose").addEventListener("click", ()=> $("#coinAdjustDialog").close());
      $("#coinAdjustApply").addEventListener("click", applyCoinAmount);
      $("#coinAdjustMode").addEventListener("click", (e)=>{
        const btn = e.target.closest("[data-coin-mode]");
        if (!btn) return;
        setCoinAdjustMode(btn.dataset.coinMode);
      });
      $("#coinAdjustValue").addEventListener("keydown", (e)=>{
        if (e.key === "Enter") applyCoinAmount();
      });
      $("#attuneClose").addEventListener("click", ()=> $("#attuneDialog").close());
      // spell importer + spellbooks
      if (document.getElementById('sp_list')){
        $("#sp_list").addEventListener('click', handleSpellbookClick);
        let draggedSpell = null;
        $("#sp_list").addEventListener("dragstart", (e)=>{
          if (!state.settings.editUnlocked) return;
          const row = e.target.closest("tr[data-spell-key]");
          if (!row) return;
          draggedSpell = {
            bookId: row.dataset.bookId,
            spellKey: row.dataset.spellKey
          };
          e.dataTransfer.effectAllowed = "move";
        });
        $("#sp_list").addEventListener("dragover", (e)=>{
          if (!state.settings.editUnlocked) return;
          const row = e.target.closest("tr[data-spell-key]");
          if (!row) return;
          e.preventDefault();
        });
        $("#sp_list").addEventListener("drop", (e)=>{
          if (!state.settings.editUnlocked) return;
          const row = e.target.closest("tr[data-spell-key]");
          if (!row || !draggedSpell) return;
          const bookId = row.dataset.bookId;
          if (bookId !== draggedSpell.bookId) return;
          const book = (state.spellbooks || []).find(b=> b.id === bookId);
          if (!book) return;
          const fromIdx = (book.spells || []).findIndex(s=> s.key === draggedSpell.spellKey);
          const toIdx = (book.spells || []).findIndex(s=> s.key === row.dataset.spellKey);
          if (fromIdx < 0 || toIdx < 0 || fromIdx === toIdx) return;
          const [moved] = book.spells.splice(fromIdx, 1);
          book.spells.splice(toIdx, 0, moved);
          draggedSpell = null;
          saveSettings();
          renderSpells();
        });
      }
      if (document.getElementById('addSpellbookBtn')){
        $("#addSpellbookBtn").addEventListener('click', addSpellbook);
      }

      $("#spellImportClose").addEventListener('click', ()=> $("#spellImportDialog").close());
      $("#spellImportCancel").addEventListener('click', ()=> $("#spellImportDialog").close());
      $("#spellImportConfirm").addEventListener('click', applySpellImportSelection);
      $("#spellImportDialog").addEventListener("close", clearSpellImportSelection);
      $("#spellImportApplyFilters").addEventListener('click', ()=>{
        applySpellImportUiToState();
        renderSpellImportList();
      });

      $("#spellImportSearch").addEventListener('input', markSpellImportDirty);
      $("#spellImportSearch").addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); $("#spellImportApplyFilters").click(); } });
      $("#spellImportSort").addEventListener('change', markSpellImportDirty);

      $("#spellImportLevelFilters").addEventListener('click', (e)=>{
        const action = e.target.closest('[data-level-action]');
        if (action){
          const on = action.dataset.levelAction === 'select-all';
          document.querySelectorAll('#spellImportLevelFilters .spell-chip[data-level]').forEach(b=> b.setAttribute('aria-pressed', on ? 'true' : 'false'));
          markSpellImportDirty();
          return;
        }
        const chip = e.target.closest('.spell-chip[data-level]');
        if (!chip) return;
        chip.setAttribute('aria-pressed', chip.getAttribute('aria-pressed') === 'true' ? 'false' : 'true');
        markSpellImportDirty();
      });

      $("#spellImportClassFilters").addEventListener('click', (e)=>{
        const action = e.target.closest('[data-class-action]');
        if (action){
          const on = action.dataset.classAction === 'select-all';
          document.querySelectorAll('#spellImportClassFilters .spell-chip[data-class]').forEach(b=> b.setAttribute('aria-pressed', on ? 'true' : 'false'));
          markSpellImportDirty();
          return;
        }
        const chip = e.target.closest('.spell-chip[data-class]');
        if (!chip) return;
        chip.setAttribute('aria-pressed', chip.getAttribute('aria-pressed') === 'true' ? 'false' : 'true');
        markSpellImportDirty();
      });

      $("#spellImportList").addEventListener('change', (e)=>{
        const input = e.target.closest('input[data-spell-id]');
        if (!input) return;
        if (input.checked) spellImportState.selected.add(input.dataset.spellId);
        else spellImportState.selected.delete(input.dataset.spellId);
        updateSpellImportConfirm();
      });

      $("#spellImportList").addEventListener('click', (e)=>{
        const info = e.target.closest('[data-spell-info]');
        if (info){
          openSpellInfo(info.dataset.spellInfo);
          return;
        }
      });

      $("#spellImportSelectedList").addEventListener('click', (e)=>{
        const rm = e.target.closest('[data-selected-remove]');
        if (!rm) return;
        spellImportState.selected.delete(rm.dataset.selectedRemove);
        const cb = document.querySelector(`#spellImportList input[data-spell-id="${CSS.escape(rm.dataset.selectedRemove)}"]`);
        if (cb) cb.checked = false;
        updateSpellImportConfirm();
      });

      // spell info dialog
      $("#spellInfoClose").addEventListener('click', ()=> $("#spellInfoDialog").close());

      // spellbook edit dialog
      $("#spellbookEditClose").addEventListener('click', ()=> $("#spellbookEditDialog").close());
      $("#spellbookEditCancel").addEventListener('click', ()=> $("#spellbookEditDialog").close());
      $("#spellbookEditSave").addEventListener('click', saveSpellbookEdit);
      $("#spellbookPresetRow").addEventListener('click', (e)=>{
        const b = e.target.closest('[data-sb-preset]');
        if (!b) return;
        const preset = SPELLBOOK_PRESETS[b.dataset.sbPreset];
        if (!preset) return;
        $("#spellbookEditHi").value = preset.hi;
        $("#spellbookEditMid").value = preset.mid;
        $("#spellbookEditText").value = preset.text;
      });

      // spell cache controls
      if (document.getElementById('clearSpellCacheBtn')){
        $("#clearSpellCacheBtn").addEventListener('click', ()=> SpellCache.clear());
      }
      if (document.getElementById('refreshSpellCacheBtn')){
        $("#refreshSpellCacheBtn").addEventListener('click', ()=> refreshSpellData());
      }

      // dice roller
      renderDiceHistory();
      updateDiceCustomLabel();
      $("#diceFab").addEventListener("click", ()=> toggleDicePanel());
      $("#diceClose").addEventListener("click", ()=> toggleDicePanel(false));
      $("#diceRollBtn").addEventListener("click", ()=> rollDice("normal"));
      $("#diceAdvBtn").addEventListener("click", ()=> rollDice("adv"));
      $("#diceDisBtn").addEventListener("click", ()=> rollDice("dis"));
      $("#diceCustomSides").addEventListener("input", updateDiceCustomLabel);
      $("#diceDragHandle").addEventListener("pointerdown", startDiceDrag);
      $("#dicePanel").addEventListener("pointermove", moveDiceDrag);
      $("#dicePanel").addEventListener("pointerup", endDiceDrag);
      $("#dicePanel").addEventListener("pointercancel", endDiceDrag);
      document.body.addEventListener("click", (e)=>{
        const btn = e.target.closest(".dice-inline");
        if (!btn) return;
        rollDiceExpression(btn.dataset.dice);
      });
      document.addEventListener("click", (e)=>{
        if (Date.now() - lastDiceFlashAt < 200) return;
        if (diceFlashItems.length) dismissDiceFlash();
      });

      // HP controls
      $("#hpAmtUp").addEventListener("click", ()=> adjustHpAmount(1));
      $("#hpAmtDown").addEventListener("click", ()=> adjustHpAmount(-1));
      $("#btnDamage").addEventListener("click", ()=>{
        const amt = parseInt($("#hpAmt").value, 10) || 0;
        damageHP(amt);
        renderHP(); renderTopbar();
      });
      $("#btnHeal").addEventListener("click", ()=>{
        const amt = parseInt($("#hpAmt").value, 10) || 0;
        healHP(amt);
        renderHP(); renderTopbar();
      });
      $("#btnTemp").addEventListener("click", ()=>{
        const amt = parseInt($("#hpAmt").value, 10) || 0;
        setTempHP(amt);
        renderHP(); renderTopbar();
      });

      // rest
      $("#restTabBtn").addEventListener("click", ()=> $("#restDialog").showModal());
      $("#restClose").addEventListener("click", ()=> $("#restDialog").close());
      $("#restShortBtn").addEventListener("click", ()=>{
        $("#restDialog").close();
        openShortRest();
      });
      $("#restLongBtn").addEventListener("click", ()=>{
        $("#restDialog").close();
        applyLongRest();
      });
      $("#shortRestClose").addEventListener("click", ()=> $("#shortRestDialog").close());
      $("#shortRestCancel").addEventListener("click", ()=> $("#shortRestDialog").close());
      $("#rollHdBtn").addEventListener("click", rollHitDice);
      $("#completeShortRestBtn").addEventListener("click", completeShortRest);

      // tabs
      document.querySelectorAll(".tab[data-tab]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          setActiveTab(btn.dataset.tab);
        });
      });
      // subtabs (combat + creatures)
      document.querySelectorAll('.subtab').forEach(btn=>{
        btn.addEventListener('click', ()=> setSubtab(btn.dataset.subtab, btn.closest('section[data-tabpanel]')));
      });

      // progress toggle (milestone/XP)
      $("#btnModeMilestone").addEventListener("click", ()=>{
        state.xpMode = "milestone";
        applyXPMode();
      });
      $("#btnModeXP").addEventListener("click", ()=>{
        state.xpMode = "xp";
        applyXPMode();
      });

      // XP actions
      $("#xpCurrent").addEventListener("change", ()=>{
        state.xp = Math.max(0, parseInt($("#xpCurrent").value,10) || 0);
        renderXPBox();
      });
      $("#xpAddBtn").addEventListener("click", ()=>{
        const add = Math.max(0, parseInt($("#xpAddAmt").value,10) || 0);
        state.xp = Math.max(0, (state.xp|0) + add);
        $("#xpAddAmt").value = 0;
        renderXPBox();
      });
      $("#xpLevelUpBtn").addEventListener("click", ()=>{
        const target = levelFromXP(state.xp);
        state.xpLevel = Math.max(state.xpLevel || 1, target);
        renderXPBox();
      });

      // settings
      $("#settingsFab").addEventListener("click", openSettings);
      $("#settingsClose").addEventListener("click", ()=> $("#settingsDialog").close());
      $("#resetTheme").addEventListener("click", ()=>{
        state.settings.theme = "midnight";
        state.settings.wide = false;
        state.settings.debugEnabled = false;
        applyTheme(state.settings.theme);
        $("#wideToggle").checked = false;
        $("#debugToggle").checked = false;
        applyWide();
        applyDebugMode();
        saveSettings();
      });
      $("#saveTheme").addEventListener("click", ()=>{
        saveSettings();
        $("#settingsDialog").close();
      });
      $("#exportCharacterBtn").addEventListener("click", exportCharacter);
      $("#importCharacterInput").addEventListener("change", (e)=>{
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try{
            const data = JSON.parse(reader.result);
            applyImportedState(data);
          }catch(err){
            alert("Unable to import character JSON.");
          }
        };
        reader.readAsText(file);
        e.target.value = "";
      });
      $("#deleteCharacterBtn").addEventListener("click", ()=>{
        const confirmText = prompt('Type "delete" to delete this character.');
        if ((confirmText || "").trim().toLowerCase() !== "delete") return;
        localStorage.removeItem("dnd_sheet_settings_v3");
        location.reload();
      });
      document.querySelectorAll('input[name="theme"]').forEach(r=>{
        r.addEventListener("change", ()=> applyTheme(r.value));
      });
      $("#wideToggle").addEventListener("change", ()=>{
        state.settings.wide = $("#wideToggle").checked;
        applyWide();
        saveSettings();
      });
      $("#debugToggle").addEventListener("change", ()=>{
        state.settings.debugEnabled = $("#debugToggle").checked;
        applyDebugMode();
        saveSettings();
      });

      // lock
      $("#lockFab").addEventListener("click", ()=>{
        applyEditMode(!state.settings.editUnlocked);
      });

      // edit-only: add skill/ability/attunement
      $("#addSkillBtn").addEventListener("click", openAddSkill);
      $("#addSkillClose").addEventListener("click", ()=> $("#addSkillDialog").close());
      $("#addSkillCancel").addEventListener("click", ()=> $("#addSkillDialog").close());
      $("#addSkillConfirm").addEventListener("click", addSkillConfirm);

      $("#addAbilityBtn").addEventListener("click", openAddAbility);
      $("#addAbilityClose").addEventListener("click", ()=> $("#addAbilityDialog").close());
      $("#addAbilityCancel").addEventListener("click", ()=> $("#addAbilityDialog").close());
      $("#addAbilityConfirm").addEventListener("click", addAbilityConfirm);

      // skills/abilities toggle
      $("#skillsGrid").addEventListener("click", (e)=>{
        const remove = e.target.closest("[data-skill-remove]");
        if (remove){
          removeCustomSkill(remove.dataset.skillRemove);
          return;
        }
        const dot = e.target.closest("[data-skill]");
        if (dot && state.settings.editUnlocked){
          cycleSkillProficiency(dot.dataset.skill);
          return;
        }
        const roll = e.target.closest("[data-skill-roll]");
        if (roll && !state.settings.editUnlocked){
          rollSkillCheck(roll.dataset.skillRoll);
        }
      });
      $("#abilGrid").addEventListener("click", (e)=>{
        const remove = e.target.closest("[data-ability]");
        if (remove && remove.classList.contains("ability-remove")){
          removeCustomAbility(remove.dataset.ability);
          return;
        }
        const save = e.target.closest(".save-pill[data-ability]");
        if (save && state.settings.editUnlocked){
          toggleSaveProficiency(save.dataset.ability);
          return;
        }
        if (save && !state.settings.editUnlocked){
          rollSaveCheck(save.dataset.saveRoll);
          return;
        }
        const card = e.target.closest("[data-ability-roll]");
        if (card && !state.settings.editUnlocked){
          rollAbilityCheck(card.dataset.abilityRoll);
        }
      });

      // attunement details
      $("#inventoryGrid").addEventListener("click", (e)=>{
        const row = e.target.closest("[data-attune-index]");
        if (!row) return;
        openAttuneDialog(parseInt(row.dataset.attuneIndex, 10));
      });
      $("#inventoryGrid").addEventListener("keydown", (e)=>{
        if (e.key !== "Enter" && e.key !== " ") return;
        const row = e.target.closest("[data-attune-index]");
        if (!row) return;
        e.preventDefault();
        openAttuneDialog(parseInt(row.dataset.attuneIndex, 10));
      });

      // notes
      $("#addQuickNoteBtn").addEventListener("click", ()=> openNoteEditor());
      $("#addAdvancedNoteBtn").addEventListener("click", ()=> openNoteEditor());
      $("#addNoteSectionBtn").addEventListener("click", addNotesSection);
      $("#notesSearchInput").addEventListener("input", (e)=>{
        notesSearchQuery = e.target.value || "";
        renderNotes();
      });
      $("#notesSearchClear").addEventListener("click", ()=>{
        notesSearchQuery = "";
        renderNotes();
      });
      $("#notesSubtabs").addEventListener("click", (e)=>{
        const tabBtn = e.target.closest("[data-notes-tab]");
        if (tabBtn){
          setActiveNotesTab(tabBtn.dataset.notesTab);
          return;
        }
        const addBtn = e.target.closest("[data-notes-tab-add]");
        if (addBtn){
          addNotesTab();
        }
      });
      let pendingStarTarget = null;
      const starPalette = $("#noteStarPalette");
      const hideStarPalette = ()=>{
        if (!starPalette) return;
        starPalette.dataset.active = "false";
        starPalette.setAttribute("aria-hidden", "true");
      };
      const showStarPalette = (anchor)=>{
        if (!starPalette || !anchor) return;
        starPalette.dataset.active = "true";
        starPalette.setAttribute("aria-hidden", "false");
        const rect = anchor.getBoundingClientRect();
        const paletteWidth = starPalette.offsetWidth || 180;
        starPalette.style.left = `${Math.min(rect.left, window.innerWidth - paletteWidth - 10)}px`;
        starPalette.style.top = `${rect.bottom + 8}px`;
      };
      if (starPalette){
        starPalette.addEventListener("click", (e)=>{
          const swatch = e.target.closest("[data-star-color]");
          if (!swatch || !pendingStarTarget) return;
          const found = findNoteById(pendingStarTarget.tabId, pendingStarTarget.sectionId, pendingStarTarget.noteId);
          if (!found) return;
          found.note.starred = true;
          found.note.starColor = swatch.dataset.starColor;
          pendingStarTarget = null;
          hideStarPalette();
          saveSettings();
          renderNotes();
        });
        document.addEventListener("click", (e)=>{
          if (!starPalette.dataset.active || starPalette.dataset.active === "false") return;
          if (e.target.closest("#noteStarPalette") || e.target.closest('[data-note-action="star"]')) return;
          pendingStarTarget = null;
          hideStarPalette();
        });
      }

      $("#notesSections").addEventListener("click", (e)=>{
        const sectionToggle = e.target.closest("[data-section-action]");
        if (sectionToggle){
          const sectionEl = sectionToggle.closest(".notes-section");
          if (!sectionEl) return;
          const sectionId = sectionEl.dataset.sectionId;
          const tab = getActiveNotesTab();
          const section = (tab?.sections || []).find(s=> s.id === sectionId);
          if (section){
            section.collapsed = !section.collapsed;
            saveSettings();
            renderNotes();
          }
          return;
        }
        const noteAction = e.target.closest("[data-note-action]");
        if (!noteAction) return;
        const card = noteAction.closest(".note-card");
        if (!card) return;
        const tabId = card.dataset.tabId;
        const sectionId = card.dataset.sectionId;
        const noteId = card.dataset.noteId;
        const found = findNoteById(tabId, sectionId, noteId);
        if (!found) return;
        const action = noteAction.dataset.noteAction;
        if (action === "star"){
          if (found.note.starred){
            found.note.starred = false;
            found.note.starColor = "";
            pendingStarTarget = null;
            hideStarPalette();
          }else{
            pendingStarTarget = { tabId, sectionId, noteId };
            showStarPalette(e.target.closest('[data-note-action="star"]'));
          }
        }else if (action === "done"){
          toggleNoteStatus(found.note, "done");
        }else if (action === "failed"){
          toggleNoteStatus(found.note, "failed");
        }else if (action === "important"){
          toggleNoteStatus(found.note, "important");
        }else if (action === "delete"){
          if (!state.settings.editUnlocked) return;
          const ok = confirm("Delete this note?");
          if (ok){
            found.section.notes = found.section.notes.filter(n=> n.id !== noteId);
          }
        }else if (action === "open" || action === "edit"){
          openNoteEditor({ note: found.note, tabId, sectionId });
          return;
        }
        saveSettings();
        renderNotes();
      });

      let draggedNote = null;
      let noteDropTarget = null;
      $("#notesSections").addEventListener("dragstart", (e)=>{
        if (!state.settings.editUnlocked) return;
        const card = e.target.closest(".note-card");
        if (!card) return;
        draggedNote = {
          tabId: card.dataset.tabId,
          sectionId: card.dataset.sectionId,
          noteId: card.dataset.noteId
        };
        e.dataTransfer.effectAllowed = "move";
      });
      $("#notesSections").addEventListener("dragover", (e)=>{
        if (!state.settings.editUnlocked) return;
        const section = e.target.closest(".notes-section");
        if (section){
          e.preventDefault();
        }
        const card = e.target.closest(".note-card");
        if (card && card.dataset.noteId){
          if (noteDropTarget && noteDropTarget !== card){
            noteDropTarget.classList.remove("drop-target");
          }
          noteDropTarget = card;
          noteDropTarget.classList.add("drop-target");
        }else if (noteDropTarget){
          noteDropTarget.classList.remove("drop-target");
          noteDropTarget = null;
        }
      });
      $("#notesSections").addEventListener("dragend", ()=>{
        if (noteDropTarget){
          noteDropTarget.classList.remove("drop-target");
          noteDropTarget = null;
        }
      });
      $("#notesSections").addEventListener("drop", (e)=>{
        if (!state.settings.editUnlocked) return;
        const sectionEl = e.target.closest(".notes-section");
        if (!sectionEl || !draggedNote) return;
        e.preventDefault();
        const targetSectionId = sectionEl.dataset.sectionId;
        const tab = getActiveNotesTab();
        if (!tab) return;
        const source = findNoteById(draggedNote.tabId, draggedNote.sectionId, draggedNote.noteId);
        const targetSection = (tab.sections || []).find(s=> s.id === targetSectionId);
        if (!source || !targetSection) return;
        source.section.notes = source.section.notes.filter(n=> n.id !== draggedNote.noteId);
        const beforeCard = e.target.closest(".note-card");
        if (beforeCard && beforeCard.dataset.noteId){
          const targetIdx = targetSection.notes.findIndex(n=> n.id === beforeCard.dataset.noteId);
          if (targetIdx >= 0){
            targetSection.notes.splice(targetIdx, 0, source.note);
          }else{
            targetSection.notes.push(source.note);
          }
        }else{
          targetSection.notes.push(source.note);
        }
        if (noteDropTarget){
          noteDropTarget.classList.remove("drop-target");
          noteDropTarget = null;
        }
        draggedNote = null;
        saveSettings();
        renderNotes();
      });

      // note editor dialog
      $("#noteEditorClose").addEventListener("click", ()=> $("#noteEditorDialog").close());
      $("#noteEditorCancel").addEventListener("click", ()=> $("#noteEditorDialog").close());
      $("#noteEditorSave").addEventListener("click", ()=>{
        const dialog = $("#noteEditorDialog");
        const title = $("#noteEditorTitleInput").value.trim() || "Untitled";
        const bodyHtml = $("#noteEditorBody").innerHTML.trim();
        const noteId = dialog.dataset.noteId;
        const target = resolveNotesTarget(dialog.dataset.tabId, dialog.dataset.sectionId);
        if (!target) return;
        if (noteId){
          const found = findNoteById(target.tab.id, target.section.id, noteId);
          if (found && found.note){
            found.note.title = title;
            found.note.body = bodyHtml;
          }
          saveSettings();
          renderNotes();
        }else{
          addNoteToActiveTab({
            id: createNoteId(),
            title,
            body: bodyHtml,
            starred: false,
            starColor: "",
            status: null
          }, target.tab.id, target.section.id);
        }
        dialog.close();
      });

      $("#noteEditorToolbar").addEventListener("click", (e)=>{
        const btn = e.target.closest("[data-cmd]");
        if (!btn) return;
        const cmd = btn.dataset.cmd;
        document.execCommand(cmd, false, null);
        $("#noteEditorBody").focus();
      });
      $("#noteTextColor").addEventListener("input", (e)=>{
        document.execCommand("foreColor", false, e.target.value);
        $("#noteEditorBody").focus();
      });
      $("#noteHighlightColor").addEventListener("input", (e)=>{
        document.execCommand("hiliteColor", false, e.target.value);
        $("#noteEditorBody").focus();
      });
      $("#noteFontSize").addEventListener("change", (e)=>{
        const size = parseInt(e.target.value, 10);
        if (!Number.isFinite(size)) return;
        const selection = window.getSelection();
        if (!selection || selection.rangeCount === 0) return;
        const range = selection.getRangeAt(0);
        const span = document.createElement("span");
        span.style.fontSize = `${size}px`;
        span.appendChild(range.extractContents());
        range.insertNode(span);
        selection.removeAllRanges();
        $("#noteEditorBody").focus();
      });
      $("#noteInsertLink").addEventListener("click", ()=>{
        const url = prompt("Enter link URL");
        if (!url) return;
        document.execCommand("createLink", false, url);
        $("#noteEditorBody").focus();
      });
      const makeNoteImagesResizable = ()=>{
        $("#noteEditorBody").querySelectorAll("img").forEach(img=>{
          img.style.maxWidth = "100%";
          img.style.height = "auto";
          img.style.resize = "both";
          img.style.overflow = "auto";
          img.style.display = "inline-block";
        });
      };
      $("#noteInsertImage").addEventListener("click", ()=>{
        const url = prompt("Enter image URL");
        if (!url) return;
        document.execCommand("insertImage", false, url);
        makeNoteImagesResizable();
        $("#noteEditorBody").focus();
      });
      $("#noteEditorBody").addEventListener("paste", (e)=>{
        const items = e.clipboardData?.items || [];
        for (const item of items){
          if (item.type.startsWith("image/")){
            const file = item.getAsFile();
            if (!file) continue;
            e.preventDefault();
            const reader = new FileReader();
            reader.onload = () => {
              document.execCommand("insertImage", false, reader.result);
              makeNoteImagesResizable();
            };
            reader.readAsDataURL(file);
            break;
          }
        }
      });

      // custom currencies
      $("#addCustomCoinBtn").addEventListener("click", addCustomCurrency);
      $("#customCoinList").addEventListener("click", (e)=>{
        const btn = e.target.closest("[data-custom-coin]");
        if (!btn) return;
        removeCustomCurrency(btn.dataset.customCoin);
      });

      // inventory
      $("#addBagBtn").addEventListener("click", openAddBagDialog);
      $("#addBagClose").addEventListener("click", ()=> $("#addBagDialog").close());
      $("#addBagCancel").addEventListener("click", ()=> $("#addBagDialog").close());
      $("#addBagApply").addEventListener("click", handleAddBagApply);
      $("#addBagDialog").addEventListener("click", (e)=>{
        const btn = e.target.closest("[data-pack]");
        if (!btn) return;
        const preset = INVENTORY_PRESET_PACKS[btn.dataset.pack];
        if (!preset) return;
        addInventorySection({
          id: `inv-${Date.now()}`,
          type: "detailed",
          title: preset.title,
          span: 1,
          items: preset.items.map(item=> ({ ...item }))
        });
        $("#addBagDialog").close();
      });
      $("#inventorySectionClose").addEventListener("click", ()=> $("#inventorySectionDialog").close());
      $("#inventorySectionCancel").addEventListener("click", ()=> $("#inventorySectionDialog").close());
      $("#inventorySectionSave").addEventListener("click", saveInventorySectionDialog);

      const inventoryGrid = $("#inventoryGrid");
      inventoryGrid.addEventListener("click", (e)=>{
        const sectionEl = e.target.closest(".inventory-section");
        if (!sectionEl) return;
        const section = getInventorySectionById(sectionEl.dataset.sectionId);
        if (!section) return;
        const actionBtn = e.target.closest("[data-inventory-action]");
        if (!actionBtn) return;
        const action = actionBtn.dataset.inventoryAction;
        const row = actionBtn.closest("[data-item-index]");
        if (action === "edit-section"){
          openInventorySectionDialog(section);
          return;
        }
        if (action === "add-attune"){
          if (!state.settings.editUnlocked) return;
          addAttunementSlot();
          return;
        }
        if (action === "add-row"){
          if (!state.settings.editUnlocked) return;
          if (section.type === "detailed"){
            section.items.push({ name:"", qty: 1, notes: "" });
          }else if (section.type === "basic"){
            section.items.push("");
          }
          saveSettings();
          renderInventory();
          return;
        }
        if (action === "remove-row"){
          if (!state.settings.editUnlocked) return;
          const idx = row ? parseInt(row.dataset.itemIndex, 10) : -1;
          if (idx < 0) return;
          if (section.type === "detailed" || section.type === "basic"){
            section.items.splice(idx, 1);
          }
          saveSettings();
          renderInventory();
          return;
        }
        if (action === "qty-up" || action === "qty-down"){
          const idx = row ? parseInt(row.dataset.itemIndex, 10) : -1;
          if (idx < 0 || section.type !== "detailed") return;
          const item = section.items[idx];
          const delta = action === "qty-up" ? 1 : -1;
          item.qty = Math.max(0, (parseInt(item.qty, 10) || 0) + delta);
          saveSettings();
          renderInventory();
        }
      });
      inventoryGrid.addEventListener("input", (e)=>{
        const input = e.target;
        if (!(input instanceof HTMLInputElement)) return;
        const sectionEl = input.closest(".inventory-section");
        if (!sectionEl) return;
        const section = getInventorySectionById(sectionEl.dataset.sectionId);
        if (!section) return;
        if (section.type === "equipped"){
          const idx = parseInt(input.dataset.equippedIndex, 10);
          if (!Number.isFinite(idx)) return;
          state.inventory.equipped[idx] = input.value;
          saveSettings();
          return;
        }
        const row = input.closest("[data-item-index]");
        const idx = row ? parseInt(row.dataset.itemIndex, 10) : -1;
        if (idx < 0) return;
        const field = input.dataset.inventoryField;
        if (section.type === "detailed"){
          const item = section.items[idx];
          if (field === "name") item.name = input.value;
          if (field === "notes") item.notes = input.value;
          if (field === "qty") item.qty = Math.max(0, parseInt(input.value, 10) || 0);
        }else if (section.type === "basic"){
          section.items[idx] = input.value;
        }
        saveSettings();
      });
      let draggedSectionId = null;
      inventoryGrid.addEventListener("dragstart", (e)=>{
        if (!state.settings.editUnlocked) return;
        const sectionEl = e.target.closest(".inventory-section");
        if (!sectionEl) return;
        draggedSectionId = sectionEl.dataset.sectionId;
        e.dataTransfer.effectAllowed = "move";
      });
      inventoryGrid.addEventListener("dragover", (e)=>{
        if (!state.settings.editUnlocked) return;
        const sectionEl = e.target.closest(".inventory-section");
        if (!sectionEl) return;
        e.preventDefault();
        sectionEl.classList.add("drag-over");
      });
      inventoryGrid.addEventListener("dragleave", (e)=>{
        const sectionEl = e.target.closest(".inventory-section");
        if (!sectionEl) return;
        sectionEl.classList.remove("drag-over");
      });
      inventoryGrid.addEventListener("drop", (e)=>{
        if (!state.settings.editUnlocked) return;
        const sectionEl = e.target.closest(".inventory-section");
        if (!sectionEl || !draggedSectionId) return;
        e.preventDefault();
        sectionEl.classList.remove("drag-over");
        const targetId = sectionEl.dataset.sectionId;
        if (targetId === draggedSectionId) return;
        const sections = state.inventory.sections || [];
        const fromIdx = sections.findIndex(s=> s.id === draggedSectionId);
        const toIdx = sections.findIndex(s=> s.id === targetId);
        if (fromIdx < 0 || toIdx < 0) return;
        const [moved] = sections.splice(fromIdx, 1);
        sections.splice(toIdx, 0, moved);
        draggedSectionId = null;
        saveSettings();
        renderInventory();
      });

      // portrait dialog
      $("#portraitClose").addEventListener("click", ()=> $("#portraitDialog").close());
      $("#portraitDone").addEventListener("click", ()=> $("#portraitDialog").close());
      $("#portraitApplyUrl").addEventListener("click", applyPortraitUrl);
      $("#portraitReset").addEventListener("click", resetPortraitCrop);
      ["portraitZoom", "portraitRotate", "portraitPosX", "portraitPosY"].forEach(id=>{
        const input = document.getElementById(id);
        if (input) input.addEventListener("input", applyPortraitControls);
      });
      $("#portraitPreview").addEventListener("pointerdown", startPortraitDrag);

      // Editable blur commits to state
      document.addEventListener("focusout", (e)=>{
        const t = e.target;
        if (!state.settings.editUnlocked) return;
        if (t && t.classList && t.classList.contains("editable")){
          syncEditableToState();
        }
      });
      document.addEventListener("keydown", (e)=>{
        if (e.code === "Backquote" && !e.repeat){
          queueCheatRoll();
        }
      });
      document.addEventListener("keydown", (e)=>{
        if (!state.settings.editUnlocked) return;
        const t = e.target;
        if (!(t instanceof HTMLElement)) return;
        if (!t.classList.contains("editable")) return;
        if (e.key === "Enter"){
          e.preventDefault();
          t.blur();
        }
      });

      // initial
      loadSettings();

      // warm spell cache (offline spell details + summaries)
      updateSpellCacheStatus();
      warmSpellCache();

      renderTopbar();
      renderHP();
      renderMain();
      renderAbilities();
      renderCombat();
      renderSpells();
      renderInventory();
      renderNotes();
      fitTopbarText();
      window.addEventListener("resize", fitTopbarText);

      // default combat subtab
      setSubtab('actions', $('#tab-actions'));
      setSubtab('companions', $('#tab-creatures'));
      // default xp mode view
      applyXPMode();
    }

    init();
  </script>
</body>
</html>
