<!doctype html>
<html lang="en" data-theme="midnight">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>D&D 5e Character Sheet ‚Äî Template</title>

  <style>
    :root{
      --page-max: 1200px;

      --bg0:#070A14;
      --bg1:#0B1020;

      --surface: rgba(255,255,255,0.06);
      --surface2: rgba(255,255,255,0.10);
      --line: rgba(255,255,255,0.14);

      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --faint: rgba(255,255,255,0.56);

      --green:#7CF59C;
      --blue:#5DB2FF;
      --red:#FB7185;

      --accent:#d8c08a;
      --shadow: 0 18px 60px rgba(0,0,0,0.55);

      --radius: 18px;
      --radius-sm: 14px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    html[data-theme="parchment"]{
      --bg0:#FBF6E9;
      --bg1:#F4E9D1;
      --surface: rgba(25,18,8,0.06);
      --surface2: rgba(25,18,8,0.10);
      --line: rgba(25,18,8,0.12);
      --text: rgba(25,18,8,0.92);
      --muted: rgba(25,18,8,0.72);
      --faint: rgba(25,18,8,0.56);
      --accent:#7C3AED;
      --shadow: 0 14px 45px rgba(25,18,8,0.18);
    }

    html[data-theme="forest"]{
      --bg0:#07120D;
      --bg1:#0A1A12;
      --surface: rgba(236,253,245,0.06);
      --surface2: rgba(236,253,245,0.10);
      --line: rgba(236,253,245,0.13);
      --text: rgba(236,253,245,0.93);
      --muted: rgba(236,253,245,0.72);
      --faint: rgba(236,253,245,0.56);
      --accent:#34D399;
      --shadow: 0 16px 55px rgba(0,0,0,0.45);
    }

    body[data-wide="on"]{ --page-max: 100%; }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(900px 520px at 20% 10%, rgba(255,255,255,0.06), transparent 55%),
        radial-gradient(700px 520px at 80% 0%, rgba(125,211,252,0.06), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    /* Inspiration edge glow (optional via settings) */
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1;
      opacity: 0;
      transition: opacity 140ms ease;
      box-shadow:
        inset 0 0 0 1px rgba(216,192,138,0.20),
        inset 0 0 60px rgba(216,192,138,0.18),
        inset 0 0 120px rgba(216,192,138,0.10);
    }
    body[data-insp-glow="on"]::before{ opacity: 1; }

    /* =======================
      TOP BAR
    ======================= */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(18px);
      background: linear-gradient(180deg, rgba(8,10,16,0.92), rgba(8,10,16,0.70));
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }

    .topbar-inner{
      max-width: var(--page-max);
      margin: 0 auto;
      padding: 14px 16px 10px;

      display: grid;
      grid-template-columns: minmax(240px, 320px) 1fr;
      gap: 14px;
      align-items: start;
    }

    .id-block{
      min-width: 0;
      padding: 6px 2px;
      display:flex;
      flex-direction: column;
      justify-content: center;
    }
    .id-name{
      margin:0;
      font-size: 34px;
      letter-spacing: 0.02em;
      font-weight: 900;
      line-height: 0.98;
    }
    .id-sub{
      margin-top: 8px;
      color: var(--muted);
      font-weight: 650;
      font-size: 14px;
    }

    .cap{
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.04));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .head-right{
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: stretch;
    }

    .top-row,
    .bottom-row{
      display: flex;
      gap: 10px;
      align-items: stretch;
      flex-wrap: wrap;
      min-width: 0;
    }

    .stat-cap, .chip-cap, .hp-cap{ min-height: 74px; }

    .stat-cap{
      width: 72px;
      padding: 10px 10px;
      display:flex;
      flex-direction: column;
      gap: 6px;
      justify-content: center;
      align-items: center;
      flex: 0 0 auto;
    }
    .stat-k{
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--faint);
      font-weight: 900;
    }
    .stat-v{
      font-size: 18px;
      font-weight: 900;
      color: var(--text);
    }

    .chip-cap{
      padding: 10px 12px;
      display:flex;
      flex-direction: column;
      justify-content:center;
      align-items: stretch;
      min-width: 0;
      position: relative;
    }
    .chip-k{
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--faint);
      font-weight: 900;
      white-space: nowrap;
    }
    .chip-row{
      display:flex;
      gap: 8px;
      align-items:center;
      margin-top: 6px;
    }

    .chip-money{ width: 200px; }
    .chip-status{ width: 150px; }
    .chip-insp{ width: 120px; }
    .chip-rest{ width: 190px; }

    .pill-btn{
      width: 100%;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 999px;
      font-weight: 900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
      justify-content: space-between;
    }
    .pill-btn:hover{
      background: rgba(0,0,0,0.28);
      border-color: rgba(255,255,255,0.22);
    }
    .pill-btn .mono{font-family: var(--mono);}
    .pill-btn[aria-pressed="true"]{
      border-color: rgba(216,192,138,0.45);
      background: linear-gradient(180deg, rgba(216,192,138,0.30), rgba(216,192,138,0.14));
    }
    .pill-btn.compact{
      justify-content: center;
      padding: 9px 10px;
      gap: 8px;
    }

    /* Rest split buttons */
    .split{
      display:flex;
      gap: 8px;
      margin-top: 6px;
    }
    .split .pill-btn{
      padding: 9px 10px;
      justify-content: center;
      gap: 8px;
    }
    .split .pill-btn.short{ border-color: rgba(93,178,255,0.30); }
    .split .pill-btn.long{ border-color: rgba(124,245,156,0.30); }

    /* Tooltip (Status hover) */
    .tooltip{
      position: absolute;
      left: 12px;
      top: calc(100% + 10px);
      z-index: 90;
      width: max-content;
      max-width: 360px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(10,12,18,0.94);
      box-shadow: var(--shadow);
      color: var(--text);
      opacity: 0;
      transform: translateY(-4px);
      pointer-events: none;
      transition: opacity 120ms ease, transform 120ms ease;
      font-size: 12px;
      line-height: 1.45;
    }
    .tooltip .t-title{
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 950;
      margin-bottom: 6px;
    }
    .chip-status:hover .tooltip,
    .chip-status:focus-within .tooltip{
      opacity: 1;
      transform: translateY(0);
    }

    /* HP capsule */
    .hp-cap{
      flex: 1 1 520px;
      min-width: min(520px, 100%);
      padding: 10px 12px;

      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 12px;
    }
    .hp-left{
      display:flex;
      align-items: baseline;
      gap: 10px;
      min-width: 140px;
    }
    .hp-text{
      font-weight: 950;
      font-size: 16px;
    }
    .hp-text .num{font-family: var(--mono);}
    .hp-mod{
      color: var(--blue);
      font-weight: 900;
    }

    /* Temp HP scales to fit inside bar (no overflow) */
    .hp-bar{
      position: relative;
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.10);
      min-width: 140px;
      overflow: hidden;
    }
    .hp-green{
      position:absolute;
      left:0; top:0; bottom:0;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(124,245,156,0.95), rgba(124,245,156,0.70));
      z-index: 1;
    }
    .hp-temp{
      position:absolute;
      top:0; bottom:0;
      left: 0%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(93,178,255,0.95), rgba(93,178,255,0.70));
      box-shadow: 0 0 14px rgba(93,178,255,0.15);
      z-index: 2;
    }

    .hp-controls{
      display:flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
    }
    .amt{
      width: 56px;
      text-align:center;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.20);
      color: var(--text);
      outline: none;
      font-weight: 900;
      font-family: var(--mono);
    }
    .hp-btn{
      height: 36px;
      min-width: 36px;
      padding: 0 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      cursor:pointer;
      font-weight: 950;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .hp-btn:hover{
      border-color: rgba(255,255,255,0.22);
      background: rgba(0,0,0,0.28);
    }
    .hp-btn.temp{ border-color: rgba(93,178,255,0.35); }
    .hp-btn.damage{ border-color: rgba(251,113,133,0.35); }
    .hp-btn.heal{ border-color: rgba(124,245,156,0.35); }

    /* Tabs */
    .tabs{
      max-width: var(--page-max);
      margin: 0 auto;
      padding: 0 16px 14px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }
    .tab{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: rgba(255,255,255,0.78);
      padding: 9px 14px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 13px;
      cursor:pointer;
    }
    .tab:hover{background: rgba(0,0,0,0.28);}
    .tab[aria-selected="true"]{
      background: linear-gradient(180deg, rgba(216,192,138,0.30), rgba(216,192,138,0.16));
      border-color: rgba(216,192,138,0.40);
      color: rgba(255,255,255,0.92);
    }

    /* Actions sub-tabs */
    .subtabs{
      margin-top: 10px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }
    .subtab{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.16);
      color: rgba(255,255,255,0.78);
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
    }
    .subtab:hover{background: rgba(0,0,0,0.26);}
    .subtab[aria-selected="true"]{
      background: rgba(216,192,138,0.16);
      border-color: rgba(216,192,138,0.36);
      color: rgba(255,255,255,0.92);
    }

    /* Responsive */
    @media (max-width: 980px){
      .topbar-inner{ grid-template-columns: 1fr; }
      .chip-money, .chip-status, .chip-insp, .chip-rest{ width: auto; flex: 1 1 170px; }
      .hp-cap{ grid-template-columns: 1fr; }
      .hp-left{ min-width: 0; }
      .tooltip{ max-width: calc(100vw - 40px); }
    }

    /* =======================
      CONTENT AREA
    ======================= */
    .wrap{
      max-width: var(--page-max);
      margin: 0 auto;
      padding: 18px 16px 72px;
      position: relative;
      z-index: 2;
    }
    .panel{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-header{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 12px;
      background: rgba(255,255,255,0.06);
    }
    .panel-title{
      margin:0;
      font-size: 12px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 950;
    }
    .panel-body{padding: 14px 16px;}

    table{width:100%; border-collapse: collapse; font-size: 13px;}
    th,td{padding: 10px 10px; border-bottom: 1px solid rgba(255,255,255,0.10); vertical-align: top;}
    th{color: var(--faint); font-weight: 950; text-transform: uppercase; letter-spacing: 0.12em; font-size: 11px;}
    .right{text-align:right}
    .muted{color: var(--muted)}
    .num{font-family: var(--mono);}

    .tag{
      font-size: 11px;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      padding: 4px 8px;
      border-radius: 999px;
      white-space:nowrap;
      font-weight: 850;
    }

    [data-tabpanel]{display:none;}
    [data-tabpanel][data-active="true"]{display:block;}
    [data-subpanel]{display:none;}
    [data-subpanel][data-active="true"]{display:block;}

    /* =======================
      MAIN TAB (Bio + portrait right, aligned to hero top)
    ======================= */
    .main-grid{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap: 12px;
      align-items: start;
    }
    @media (max-width: 980px){
      .main-grid{ grid-template-columns: 1fr; }
    }

    .hero{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
      border-radius: 18px;
      padding: 14px 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .hero-name{
      font-size: 22px;
      font-weight: 950;
      margin: 0;
      letter-spacing: 0.01em;
    }
    .hero-tagline{
      margin: -6px 0 0;
      color: var(--muted);
      font-weight: 800;
      font-size: 13px;
    }
    .chips{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 2px;
    }

    .card{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      border-radius: 16px;
      padding: 12px 12px;
    }
    .card h4{
      margin:0 0 8px;
      font-size: 12px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 950;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }
    .kv{
      display:grid;
      grid-template-columns: 150px 1fr;
      gap: 8px 12px;
      font-size: 13px;
    }
    .kv .k{
      color: var(--faint);
      font-weight: 900;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 11px;
      padding-top: 2px;
    }
    .kv .v{
      color: var(--text);
      font-weight: 750;
      min-width: 0;
    }

    /* Smaller milestone/XP toggle */
    .progress-toggle{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }
    .seg{
      display:flex;
      gap: 6px;
      align-items:center;
      padding: 4px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
    }
    .seg button{
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: 6px 8px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 900;
      font-size: 11px;
      letter-spacing: 0.02em;
    }
    .seg button[aria-pressed="true"]{
      color: var(--text);
      border-color: rgba(216,192,138,0.35);
      background: rgba(216,192,138,0.14);
    }
    .seg button:hover{ color: var(--text); }

    .portrait-frame{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      border-radius: 20px;
      overflow:hidden;
      box-shadow: var(--shadow);
      /* NOT sticky; aligns with hero top */
    }

    /* exact 2:3 ratio frame (600x900) */
    .portrait{
      aspect-ratio: 2 / 3;
      width: 100%;
      height: auto;
      display:block;
      object-fit: cover;
      object-position: var(--px, 50%) var(--py, 30%);
      transform: scale(var(--pz, 1));
      transform-origin: center;
      filter: saturate(1.05) contrast(1.03);
      cursor: pointer;
    }
    .portrait-overlay{
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(60% 45% at 55% 20%, rgba(255,255,255,0.10), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,0.05), rgba(0,0,0,0.35));
      mix-blend-mode: screen;
      opacity: 0.65;
    }
    .portrait-vignette{
      position:absolute;
      inset:0;
      pointer-events:none;
      box-shadow: inset 0 0 80px rgba(0,0,0,0.55);
      opacity: 0.85;
    }
    .portrait-preview{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      border-radius: 16px;
      overflow: hidden;
      aspect-ratio: 2 / 3;
      width: min(260px, 100%);
      margin-top: 10px;
      position: relative;
      cursor: grab;
      user-select: none;
      touch-action: none;
    }
    .portrait-preview.is-dragging{
      cursor: grabbing;
    }
    .portrait-preview img{
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
      object-position: var(--px, 50%) var(--py, 30%);
      transform: scale(var(--pz, 1));
      transform-origin: center;
      filter: saturate(1.05) contrast(1.03);
      pointer-events: none;
    }
    .portrait-preview-grid{
      position: absolute;
      inset: 0;
      pointer-events: none;
      background:
        linear-gradient(90deg, rgba(255,255,255,0.08) 1px, transparent 1px) 0 0 / 33.33% 100%,
        linear-gradient(180deg, rgba(255,255,255,0.08) 1px, transparent 1px) 0 0 / 100% 33.33%;
      opacity: 0.35;
    }

    /* Main "Quick Combat" row under hero */
    .quickstats{
      display:grid;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap: 10px;
      margin-top: 8px;
    }
    @media (max-width: 980px){
      .quickstats{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    .qs{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.14);
      border-radius: 16px;
      padding: 10px 10px;
      display:flex;
      flex-direction: column;
      gap: 6px;
      align-items:center;
      justify-content:center;
      min-height: 70px;
    }
    .qs .k{
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--faint);
      font-weight: 950;
    }
    .qs .v{
      font-size: 16px;
      font-weight: 950;
      font-family: var(--mono);
    }

    /* XP box (shown when XP mode) */
    .xpbox{
      margin-top: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.14);
      border-radius: 16px;
      padding: 10px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .xpgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 700px){
      .xpgrid{ grid-template-columns: 1fr; }
    }
    .field{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      border-radius: 14px;
      padding: 10px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }
    .field label{
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--faint);
      font-weight: 950;
    }
    .field .val{
      font-family: var(--mono);
      font-weight: 950;
      color: var(--text);
      white-space: nowrap;
    }
    .field input{
      width: 130px;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.20);
      color: var(--text);
      outline: none;
      font-weight: 900;
      font-family: var(--mono);
      text-align:right;
    }

    /* =======================
      ABILITIES PAGE (layout)
    ======================= */
    .abil-wrap{ display:flex; flex-direction: column; gap: 12px; }

    .abil-grid{
      display:grid;
      grid-template-columns: repeat(6, minmax(0,1fr));
      gap: 10px;
    }
    @media (max-width: 1100px){
      .abil-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }
    @media (max-width: 700px){
      .abil-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }

    .abil-card{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      border-radius: 16px;
      padding: 10px;
      display:flex;
      flex-direction: column;
      gap: 8px;
      min-height: 140px;
    }
    .abil-head{
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--accent);
      font-weight: 950;
      margin-top: 2px;
    }
    .abil-box{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      border-radius: 14px;
      padding: 10px 10px;
      display:flex;
      flex-direction: column;
      align-items:center;
      justify-content:center;
      gap: 6px;
    }
    .abil-score{ font-size: 20px; font-weight: 950; font-family: var(--mono); }
    .abil-subk{
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--faint);
      font-weight: 950;
    }
    .abil-subv{ font-size: 13px; font-weight: 950; font-family: var(--mono); }
    .save-pill{
      margin-top: 6px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      padding: 7px 10px;
      border-radius: 999px;
      font-family: var(--mono);
      font-weight: 950;
      font-size: 12px;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      justify-content: center;
    }
    .save-pill.pro{
      border-color: rgba(216,192,138,0.40);
      background: rgba(216,192,138,0.12);
    }

    .skills-head{
      display:flex;
      align-items:flex-end;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .legend{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .dot{
      width: 10px; height: 10px; border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.30);
      display:inline-block;
      transform: translateY(1px);
    }
    .dot.fill{ background: rgba(255,255,255,0.18); border-color: rgba(255,255,255,0.40); }
    .dot.gold{ background: rgba(216,192,138,0.18); border-color: rgba(216,192,138,0.50); }

    .skills-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 980px){
      .skills-grid{ grid-template-columns: 1fr; }
    }
    .skill-col{ display:flex; flex-direction: column; gap: 10px; }
    .skill-row{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
    }
    .skill-left{ display:flex; align-items:center; gap: 10px; min-width: 0; }
    .skill-name{
      font-weight: 900;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .skill-mid{
      font-size: 12px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--accent);
      font-weight: 950;
      margin-left: 6px;
    }
    .skill-right{ font-family: var(--mono); font-weight: 950; }

    /* =======================
      BUTTONS / DIALOGS
    ======================= */
    dialog{
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(10,12,18,0.92);
      color: var(--text);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 0;
      width: min(720px, calc(100vw - 28px));
      z-index: 120;
    }
    dialog::backdrop{background: rgba(0,0,0,0.62); backdrop-filter: blur(6px);}
    .dlg-head{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: rgba(255,255,255,0.06);
    }
    .dlg-title{
      margin:0;
      font-size: 12px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 950;
    }
    .dlg-body{padding: 14px 16px;}
    .icon-btn{
      width: 36px; height: 36px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      cursor:pointer;
      font-weight: 900;
    }

    .btn{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: var(--muted);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      cursor:pointer;
      font-weight: 900;
    }
    .btn:hover{background: rgba(0,0,0,0.28); color: var(--text);}
    .btn.primary{
      border-color: rgba(216,192,138,0.40);
      background: rgba(216,192,138,0.18);
      color: var(--text);
    }
    .btn.danger{
      border-color: rgba(251,113,133,0.40);
      background: rgba(251,113,133,0.10);
      color: var(--text);
    }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content: space-between;
    }
    .small{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }

    .checkgrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px 12px;
      margin-top: 8px;
    }
    @media (max-width: 520px){
      .checkgrid{ grid-template-columns: 1fr; }
    }
    .check{
      display:flex;
      gap: 10px;
      align-items:center;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      cursor:pointer;
      user-select:none;
    }
    .check:hover{ border-color: rgba(255,255,255,0.20); background: rgba(0,0,0,0.25); }
    .check input{ accent-color: var(--accent); }
    .select{
      width: 100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      font-weight: 850;
      outline: none;
    }

    /* Settings + Lock FABs */
    .fab-wrap{
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 140;
      display:flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end;
    }
    .fab{
      width: 52px;
      height: 52px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.22);
      box-shadow: var(--shadow);
      color: var(--text);
      cursor:pointer;
      display:grid;
      place-items:center;
      transition: transform 120ms ease, border-color 120ms ease, background 120ms ease;
    }
    .fab:hover{transform: translateY(-2px);}
    .fab[aria-pressed="true"]{
      border-color: rgba(216,192,138,0.45);
      background: rgba(216,192,138,0.14);
    }

    .radio-row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .radio{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      cursor:pointer;
      color: var(--muted);
      user-select:none;
      font-weight: 850;
    }
    .radio input{accent-color: var(--accent);}
    .radio:hover{color: var(--text); border-color: rgba(255,255,255,0.22);}

    .toggle{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
      margin-top: 12px;
    }
    .toggle strong{font-weight: 950;}
    .switch{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      cursor:pointer;
      user-select:none;
      color: var(--muted);
      font-weight: 850;
    }
    .switch input{accent-color: var(--accent); transform: scale(1.1);}

    /* =======================
      EDIT MODE (lock toggle)
    ======================= */
    .editable{
      outline: none;
      border-radius: 8px;
      padding: 2px 4px;
      margin: -2px -4px;
      transition: background 120ms ease, box-shadow 120ms ease;
    }
    body[data-edit="on"] .editable{ cursor: text; }
    body[data-edit="on"] .editable:hover{ background: rgba(216,192,138,0.10); }
    body[data-edit="on"] .editable:focus{
      background: rgba(216,192,138,0.12);
      box-shadow: 0 0 0 2px rgba(216,192,138,0.20);
    }

    /* Small icon button for "add custom" */
    .mini{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      cursor:pointer;
      font-weight: 950;
      display:grid;
      place-items:center;
    }
    .mini:hover{ background: rgba(0,0,0,0.28); border-color: rgba(255,255,255,0.22); }

    /* Coin purse styling */
    .coin-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 640px){
      .coin-grid{ grid-template-columns: 1fr; }
    }
    .coin-card{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }
    .coin-left{
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .coin-ic{
      width: 36px; height: 36px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      font-size: 16px;
    }
    .coin-meta{
      display:flex;
      flex-direction: column;
      gap: 2px;
    }
    .coin-name{
      font-weight: 950;
    }
    .coin-val{
      font-size: 12px;
      color: var(--muted);
      font-family: var(--mono);
    }
    .coin-amt{
      font-family: var(--mono);
      font-weight: 950;
      font-size: 16px;
    }
    .coin-card[data-coin="pp"] .coin-ic{ box-shadow: inset 0 0 0 1px rgba(219,234,254,0.25); }
    .coin-card[data-coin="gp"] .coin-ic{ box-shadow: inset 0 0 0 1px rgba(254,243,199,0.30); }
    .coin-card[data-coin="ep"] .coin-ic{ box-shadow: inset 0 0 0 1px rgba(226,232,240,0.25); }
    .coin-card[data-coin="sp"] .coin-ic{ box-shadow: inset 0 0 0 1px rgba(229,231,235,0.28); }
    .coin-card[data-coin="cp"] .coin-ic{ box-shadow: inset 0 0 0 1px rgba(253,186,116,0.30); }

    /* Inventory attunement */
    .attune{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .attune-row{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }
    .attune-row strong{ font-weight: 950; }
    .attune-slot{
      color: var(--muted);
      font-weight: 850;
    }
  </style>
</head>

<body data-edit="off" data-wide="off">
  <header class="topbar">
    <div class="topbar-inner">
      <!-- Name block -->
      <div class="id-block">
        <h1 class="id-name editable" id="tb_name">Elaria Thornbloom</h1>
        <div class="id-sub editable" id="tb_sub">Wood Elf ‚Ä¢ Druid 10</div>
      </div>

      <!-- Right side -->
      <div class="head-right">
        <!-- TOP ROW: AC, INIT, SPD, PROF, MONEY, STATUS, INSP -->
        <div class="top-row" aria-label="Top stats row">
          <div class="cap stat-cap" title="Armor Class">
            <div class="stat-k">AC</div>
            <div class="stat-v editable" id="tb_ac">16</div>
          </div>

          <div class="cap stat-cap" title="Initiative">
            <div class="stat-k">INIT</div>
            <div class="stat-v editable" id="tb_init">+3</div>
          </div>

          <div class="cap stat-cap" title="Speed">
            <div class="stat-k">SPD</div>
            <div class="stat-v editable" id="tb_speed">35</div>
          </div>

          <div class="cap stat-cap" title="Proficiency Bonus">
            <div class="stat-k">PROF</div>
            <div class="stat-v editable" id="tb_pb">+4</div>
          </div>

          <div class="cap chip-cap chip-money" title="Money">
            <div class="chip-k">MONEY</div>
            <div class="chip-row">
              <button class="pill-btn" id="moneyBtn" type="button" aria-haspopup="dialog" title="Open coin purse">
                <span>üí∞</span>
                <span class="mono" id="tb_money_total">‚Äî gp</span>
                <span>‚ñæ</span>
              </button>
            </div>
          </div>

          <div class="cap chip-cap chip-status" title="Status / Conditions">
            <div class="chip-k">STATUS</div>
            <div class="chip-row">
              <button class="pill-btn" id="statusBtn" type="button" aria-haspopup="dialog" title="Select conditions">
                <span>‚ò∞</span>
                <span id="tb_status">None</span>
                <span>‚ñæ</span>
              </button>
            </div>

            <!-- hover tooltip -->
            <div class="tooltip" id="statusTooltip" aria-hidden="true">
              <div class="t-title">Active Status</div>
              <div id="statusTooltipText" class="small" style="color: var(--text);"></div>
            </div>
          </div>

          <div class="cap chip-cap chip-insp" title="Inspiration">
            <div class="chip-k">INSP</div>
            <div class="chip-row">
              <button class="pill-btn compact" id="inspBtn" type="button" aria-pressed="false" title="Toggle inspiration">
                <span>‚ú¶</span>
                <span id="tb_insp">No</span>
              </button>
            </div>
          </div>
        </div>

        <!-- SECOND ROW: HP + Rest -->
        <div class="bottom-row" aria-label="Health and rest row">
          <div class="cap hp-cap" title="Health">
            <div class="hp-left">
              <div class="hp-text">
                <span class="num editable" id="tb_hp_cur">73</span>/<span class="num editable" id="tb_hp_max">73</span>
              </div>
              <div class="hp-mod" id="tb_temp_label">+0</div>
            </div>

            <div class="hp-bar" aria-label="Health bar">
              <div class="hp-green" id="hpGreen"></div>
              <div class="hp-temp" id="hpTemp"></div>
            </div>

            <div class="hp-controls" aria-label="Health controls">
              <input class="amt" id="hpAmt" type="number" value="12" min="0" inputmode="numeric" />
              <button class="hp-btn damage" id="btnDamage" type="button" title="Damage (uses temp first)">‚àí</button>
              <button class="hp-btn heal" id="btnHeal" type="button" title="Heal (up to max)">+</button>
              <button class="hp-btn temp" id="btnTemp" type="button" title="Set Temp HP (takes the higher)">‚õ®</button>
            </div>
          </div>

          <!-- Rest: Short + Long -->
          <div class="cap chip-cap chip-rest" title="Rest">
            <div class="chip-k">REST</div>
            <div class="split" aria-label="Rest buttons">
              <button class="pill-btn short" id="shortRestOpenBtn" type="button" aria-haspopup="dialog" title="Open short rest tools">
                <span>‚è≥</span><span>Short</span>
              </button>
              <button class="pill-btn long" id="longRestBtnTop" type="button" title="Apply a long rest">
                <span>üåô</span><span>Long</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <nav class="tabs" role="tablist" aria-label="Character sheet tabs">
      <button class="tab" role="tab" aria-selected="true"  aria-controls="tab-main"      id="tabbtn-main"      data-tab="main">Main</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="tab-abilities" id="tabbtn-abilities" data-tab="abilities">Abilities</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="tab-actions"   id="tabbtn-actions"   data-tab="actions">Actions</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="tab-spells"    id="tabbtn-spells"    data-tab="spells">Spell Book</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="tab-inventory" id="tabbtn-inventory" data-tab="inventory">Inventory</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="tab-notes"     id="tabbtn-notes"     data-tab="notes">Notes</button>
    </nav>
  </header>

  <main class="wrap">
    <!-- MAIN -->
    <section class="panel" id="tab-main" data-tabpanel data-active="true" role="tabpanel" aria-labelledby="tabbtn-main">
      <div class="panel-header">
        <h2 class="panel-title">Character Bio</h2>
        <div class="chips" id="mainChips"></div>
      </div>

      <div class="panel-body">
        <div class="main-grid">
          <!-- LEFT -->
          <div style="display:flex; flex-direction:column; gap:12px;">
            <div class="hero" id="heroBlock">
              <h3 class="hero-name editable" id="mainName">Elaria Thornbloom</h3>
              <div class="hero-tagline editable" id="mainTagline">Of the order of History</div>
              <div class="chips" id="mainSummaryLine"></div>

              <!-- NEW: Quick combat block under hero -->
              <div class="quickstats" aria-label="Main quick stats">
                <div class="qs"><div class="k">HP</div><div class="v"><span class="num" id="m_hp">73/73</span></div></div>
                <div class="qs"><div class="k">AC</div><div class="v"><span class="num" id="m_ac">16</span></div></div>
                <div class="qs"><div class="k">INIT</div><div class="v"><span class="num" id="m_init">+3</span></div></div>
                <div class="qs"><div class="k">PROF</div><div class="v"><span class="num" id="m_prof">+4</span></div></div>
                <div class="qs"><div class="k">SPD</div><div class="v"><span class="num" id="m_spd">35</span></div></div>
              </div>
            </div>

            <div class="card">
              <h4>Identity</h4>
              <div class="kv">
                <div class="k">Player</div><div class="v editable" id="mainPlayer">Lukas Schulze</div>
                <div class="k">Pronouns</div><div class="v editable" id="mainPronouns">she / her</div>
                <div class="k">Campaign / Party</div><div class="v editable" id="mainCampaign">The Verdant Accord</div>
              </div>
            </div>

            <div class="card">
              <h4>Build</h4>
              <div class="kv">
                <div class="k">Class & Level</div><div class="v editable" id="mainClasses">Druid 10</div>
                <div class="k">Total Level</div><div class="v"><span class="num editable" id="mainTotalLevel">10</span></div>
                <div class="k">Race / Species</div><div class="v editable" id="mainRace">Wood Elf</div>
                <div class="k">Background</div><div class="v editable" id="mainBackground">Sage</div>
                <div class="k">Alignment</div><div class="v editable" id="mainAlignment">Neutral Good</div>
                <div class="k">Progress</div>
                <div class="v">
                  <div class="progress-toggle">
                    <div class="seg" role="group" aria-label="Progress toggle">
                      <button id="btnModeMilestone" type="button" aria-pressed="true">Milestone</button>
                      <button id="btnModeXP" type="button" aria-pressed="false">XP</button>
                    </div>
                    <span class="tag" id="progressValue">Milestone</span>
                  </div>

                  <!-- XP UI (hidden unless XP mode) -->
                  <div class="xpbox" id="xpBox" style="display:none;">
                    <div class="xpgrid">
                      <div class="field">
                        <label>Current XP</label>
                        <div style="display:flex; gap:8px; align-items:center;">
                          <input id="xpCurrent" type="number" min="0" value="0" inputmode="numeric" />
                          <span class="val">xp</span>
                        </div>
                      </div>
                      <div class="field">
                        <label>Next Level</label>
                        <div class="val"><span id="xpNext">300</span> xp</div>
                      </div>
                      <div class="field">
                        <label>Level</label>
                        <div class="val">Lv <span id="xpLevel">1</span></div>
                      </div>
                      <div class="field">
                        <label>To Next</label>
                        <div class="val"><span id="xpToNext">300</span> xp</div>
                      </div>
                    </div>

                    <div class="row">
                      <div class="small">Add XP updates level automatically using standard 5e XP thresholds.</div>
                      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
                        <input class="amt" id="xpAddAmt" type="number" min="0" value="0" inputmode="numeric" style="width:86px;" />
                        <button class="btn primary" id="xpAddBtn" type="button">Add XP</button>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>

            <div class="card">
              <h4>Roleplay</h4>
              <div class="kv">
                <div class="k">Traits</div><div class="v editable" id="mainTraits">Curious, patient, speaks softly‚Äîuntil the wild answers back.</div>
                <div class="k">Ideals</div><div class="v editable" id="mainIdeals">Knowledge should protect life, not dominate it.</div>
                <div class="k">Bonds</div><div class="v editable" id="mainBonds">A living grove-archive entrusted to her care.</div>
                <div class="k">Flaws</div><div class="v editable" id="mainFlaws">Will take dangerous risks to preserve a rare creature or secret.</div>
              </div>
            </div>

            <div class="card">
              <h4>Appearance</h4>
              <div class="kv">
                <div class="k">Description</div><div class="v editable" id="mainDesc">Pale-haired wanderer draped in living greens; carries a staff carved like roots.</div>
                <div class="k">Age</div><div class="v editable" id="mainAge">148</div>
                <div class="k">Weight / Size</div><div class="v editable" id="mainSize">Lean ‚Ä¢ Medium</div>
                <div class="k">Hair / Eyes / Skin</div><div class="v editable" id="mainHES">White hair ‚Ä¢ amber eyes ‚Ä¢ sun-kissed skin</div>
                <div class="k">Marks</div><div class="v editable" id="mainMarks">Vine-like tattoos along the left arm; scar at the collarbone.</div>
              </div>
            </div>
          </div>

          <!-- RIGHT PORTRAIT (600x900), aligned with hero top -->
          <div class="portrait-frame" aria-label="Character portrait">
            <div style="position:relative;">
              <img class="portrait" id="portraitImg" alt="Character portrait" />
              <div class="portrait-overlay"></div>
              <div class="portrait-vignette"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ABILITIES -->
    <section class="panel" id="tab-abilities" data-tabpanel data-active="false" role="tabpanel" aria-labelledby="tabbtn-abilities">
      <div class="panel-header">
        <h2 class="panel-title">Ability Scores</h2>
        <button class="mini" id="addAbilityBtn" type="button" title="Add custom ability (edit mode only)" style="display:none;">Ôºã</button>
      </div>
      <div class="panel-body">
        <div class="abil-wrap">
          <div class="abil-grid" id="abilGrid"></div>

          <div class="panel" style="box-shadow:none;">
            <div class="panel-header skills-head">
              <h3 class="panel-title">Skills</h3>
              <div style="display:flex; gap:10px; align-items:center;">
                <div class="legend" aria-label="Proficiency legend">
                  <span>Proficiency:</span>
                  <span><span class="dot"></span> none</span>
                  <span><span class="dot fill"></span> half</span>
                  <span><span class="dot gold"></span> proficiency</span>
                  <span><span class="dot gold" style="box-shadow:0 0 0 2px rgba(216,192,138,0.22) inset;"></span> expertise</span>
                </div>
                <button class="mini" id="addSkillBtn" type="button" title="Add custom skill (edit mode only)" style="display:none;">Ôºã</button>
              </div>
            </div>
            <div class="panel-body" style="padding-top:12px;">
              <div class="skills-grid" id="skillsGrid"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ACTIONS (with subtabs) -->
    <section class="panel" id="tab-actions" data-tabpanel data-active="false" role="tabpanel" aria-labelledby="tabbtn-actions">
      <div class="panel-header">
        <h2 class="panel-title">Combat</h2>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <span class="tag">Spell DC: <span class="num" id="sp_dc">16</span></span>
          <span class="tag">Spell Atk: <span class="num" id="sp_atk">+8</span></span>
        </div>
      </div>

      <div class="panel-body">
        <div class="subtabs" role="tablist" aria-label="Combat sub-tabs">
          <button class="subtab" role="tab" aria-selected="true"  data-subtab="actions">Actions</button>
          <button class="subtab" role="tab" aria-selected="false" data-subtab="bonus">Bonus Actions</button>
          <button class="subtab" role="tab" aria-selected="false" data-subtab="reactions">Reactions</button>
          <button class="subtab" role="tab" aria-selected="false" data-subtab="free">Free Actions</button>
        </div>

        <div style="height:10px"></div>

        <div data-subpanel id="sub-actions" data-active="true">
          <div class="panel" style="box-shadow:none;">
            <div class="panel-header"><h3 class="panel-title">Actions</h3></div>
            <div class="panel-body" style="padding:0;">
              <table>
                <thead><tr><th>Action</th><th class="right">To Hit / DC</th><th>Damage / Effect</th><th>Notes</th></tr></thead>
                <tbody id="c_attacks"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div data-subpanel id="sub-bonus" data-active="false">
          <div class="panel" style="box-shadow:none;">
            <div class="panel-header"><h3 class="panel-title">Bonus Actions</h3></div>
            <div class="panel-body">
              <ul style="margin:0; padding-left:18px;" id="c_bonus"></ul>
            </div>
          </div>
        </div>

        <div data-subpanel id="sub-reactions" data-active="false">
          <div class="panel" style="box-shadow:none;">
            <div class="panel-header"><h3 class="panel-title">Reactions</h3></div>
            <div class="panel-body">
              <ul style="margin:0; padding-left:18px;" id="c_reactions"></ul>
            </div>
          </div>
        </div>

        <div data-subpanel id="sub-free" data-active="false">
          <div class="panel" style="box-shadow:none;">
            <div class="panel-header"><h3 class="panel-title">Free Actions</h3></div>
            <div class="panel-body">
              <ul style="margin:0; padding-left:18px;" id="c_free"></ul>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SPELLS -->
    <section class="panel" id="tab-spells" data-tabpanel data-active="false" role="tabpanel" aria-labelledby="tabbtn-spells">
      <div class="panel-header">
        <h2 class="panel-title">Spell Book</h2>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <span class="tag">Prepared: <span class="num" id="sp_prep">14</span></span>
          <span class="tag">Ability: Wisdom</span>
        </div>
      </div>
      <div class="panel-body" id="sp_list"></div>
    </section>

    <!-- INVENTORY -->
    <section class="panel" id="tab-inventory" data-tabpanel data-active="false" role="tabpanel" aria-labelledby="tabbtn-inventory">
      <div class="panel-header">
        <h2 class="panel-title">Inventory</h2>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <span class="tag">Encumbrance: <span id="i_enc">Light</span></span>
          <span class="tag">Currency: <span id="i_money">‚Äî</span></span>
        </div>
      </div>

      <div class="panel-body">
        <!-- NEW: Attunement top section -->
        <div class="card" style="margin-bottom:12px;">
          <h4>
            Attunement
            <button class="mini" id="addAttuneBtn" type="button" title="Add attunement slot (edit mode only)" style="display:none;">Ôºã</button>
          </h4>
          <div class="small">Three slots by default. In edit mode you can add more slots.</div>
          <div style="height:10px"></div>
          <div class="attune" id="attuneList"></div>
        </div>

        <div style="display:grid; grid-template-columns: 1.2fr 0.8fr; gap: 12px;">
          <div class="panel" style="box-shadow:none;">
            <div class="panel-header"><h3 class="panel-title">Equipment</h3></div>
            <div class="panel-body" style="padding:0;">
              <table>
                <thead><tr><th>Item</th><th class="right">Qty</th><th>Notes</th></tr></thead>
                <tbody id="i_items"></tbody>
              </table>
            </div>
          </div>

          <div class="panel" style="box-shadow:none;">
            <div class="panel-header"><h3 class="panel-title">Magic & Special</h3></div>
            <div class="panel-body" id="i_magic"></div>

            <div style="height:12px"></div>

            <div class="panel" style="box-shadow:none;">
              <div class="panel-header"><h3 class="panel-title">Tools / Kits</h3></div>
              <div class="panel-body" id="i_tools"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- NOTES -->
    <section class="panel" id="tab-notes" data-tabpanel data-active="false" role="tabpanel" aria-labelledby="tabbtn-notes">
      <div class="panel-header"><h2 class="panel-title">Notes</h2></div>
      <div class="panel-body" id="n_notes"></div>
    </section>
  </main>

  <!-- Coin purse dialog (nicer) -->
  <dialog id="coinDialog" aria-label="Coin purse">
    <div class="dlg-head">
      <h3 class="dlg-title">Coin Purse</h3>
      <button class="icon-btn" id="coinClose" type="button" aria-label="Close">‚úï</button>
    </div>
    <div class="dlg-body">
      <div class="row">
        <div class="small">Total value</div>
        <div style="font-weight:950; font-size:18px;">
          <span id="coinTotal" class="num">‚Äî</span>
          <span class="muted" style="font-size:12px; font-weight:900;">gp</span>
        </div>
      </div>

      <div class="coin-grid" id="coinCards"></div>

      <div style="height:10px"></div>

      <div class="small">
        Values: pp=10gp, gp=1gp, ep=0.5gp, sp=0.1gp, cp=0.01gp.
      </div>
    </div>
  </dialog>

  <!-- Status dialog -->
  <dialog id="statusDialog" aria-label="Status and conditions">
    <div class="dlg-head">
      <h3 class="dlg-title">Status</h3>
      <button class="icon-btn" id="statusClose" type="button" aria-label="Close">‚úï</button>
    </div>
    <div class="dlg-body">
      <div class="card">
        <h4>Conditions</h4>
        <div class="small">Select one or more conditions.</div>
        <div class="checkgrid" id="condGrid"></div>
      </div>

      <div style="height:10px"></div>

      <div class="card">
        <h4>Exhaustion</h4>
        <div class="small">Set exhaustion level (0‚Äì6). Included in Status display.</div>
        <div style="display:flex; gap:10px; align-items:center; margin-top:8px;">
          <select class="select" id="exhaustSel" aria-label="Exhaustion level">
            <option value="0">0 ‚Äî None</option>
            <option value="1">1</option><option value="2">2</option><option value="3">3</option>
            <option value="4">4</option><option value="5">5</option><option value="6">6</option>
          </select>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="row">
        <button class="btn danger" id="clearStatusBtn" type="button">Clear All</button>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn" id="cancelStatusBtn" type="button">Cancel</button>
          <button class="btn primary" id="applyStatusBtn" type="button">Apply</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Short Rest dialog -->
  <dialog id="shortRestDialog" aria-label="Short rest tools">
    <div class="dlg-head">
      <h3 class="dlg-title">Short Rest</h3>
      <button class="icon-btn" id="shortRestClose" type="button" aria-label="Close">‚úï</button>
    </div>
    <div class="dlg-body">
      <div class="card">
        <h4>Hit Dice</h4>
        <div class="small">
          Spend hit dice to heal. Each die heals <strong>roll + Con mod</strong>.
        </div>

        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px;">
          <span class="tag">Die: <span class="num" id="hdDieLabel">d8</span></span>
          <span class="tag">Remaining: <span class="num" id="hdRemain">‚Äî</span>/<span class="num" id="hdTotal">‚Äî</span></span>
          <span class="tag">Con Mod: <span class="num" id="hdCon">‚Äî</span></span>
        </div>

        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px;">
          <label class="small" for="hdSpend">Spend</label>
          <input class="amt" id="hdSpend" type="number" min="0" value="1" inputmode="numeric" />
          <button class="btn primary" id="rollHdBtn" type="button">Roll &amp; Heal</button>
        </div>

        <div class="small" id="hdResult" style="margin-top:10px;"></div>
      </div>

      <div style="height:12px"></div>

      <div class="row">
        <div class="small">Completing the rest applies short-rest resets (example: Wild Shape).</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn" id="shortRestCancel" type="button">Close</button>
          <button class="btn primary" id="completeShortRestBtn" type="button">Complete Short Rest</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Settings dialog -->
  <dialog id="settingsDialog" aria-label="Settings">
    <div class="dlg-head">
      <h3 class="dlg-title">Settings</h3>
      <button class="icon-btn" id="settingsClose" type="button" aria-label="Close">‚úï</button>
    </div>
    <div class="dlg-body">
      <div style="font-weight:950;">Theme</div>
      <div class="muted" style="font-size:12px; margin-top:4px;">Choose a palette. Saved to localStorage.</div>

      <div class="radio-row" role="radiogroup" aria-label="Theme selection">
        <label class="radio"><input type="radio" name="theme" value="midnight" /> Midnight</label>
        <label class="radio"><input type="radio" name="theme" value="parchment" /> Parchment</label>
        <label class="radio"><input type="radio" name="theme" value="forest" /> Forest</label>
      </div>

      <div class="toggle">
        <div>
          <strong>Inspiration Edge Glow</strong>
          <div class="muted" style="font-size:12px; margin-top:4px;">When Inspiration is active, show a gold glow around the screen edge.</div>
        </div>
        <label class="switch" for="glowToggle">
          <input id="glowToggle" type="checkbox" />
          <span>Enabled</span>
        </label>
      </div>

      <div class="toggle">
        <div>
          <strong>Wide Screen</strong>
          <div class="muted" style="font-size:12px; margin-top:4px;">Let the sheet expand to full screen width.</div>
        </div>
        <label class="switch" for="wideToggle">
          <input id="wideToggle" type="checkbox" />
          <span>Enabled</span>
        </label>
      </div>

      <div style="height:12px"></div>

      <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
        <button class="btn" id="resetTheme" type="button">Reset</button>
        <button class="btn primary" id="saveTheme" type="button">Save</button>
      </div>
    </div>
  </dialog>

  <!-- Portrait edit dialog -->
  <dialog id="portraitDialog" aria-label="Edit portrait">
    <div class="dlg-head">
      <h3 class="dlg-title">Portrait</h3>
      <button class="icon-btn" id="portraitClose" type="button" aria-label="Close">‚úï</button>
    </div>
    <div class="dlg-body">
      <div class="card">
        <h4>Image URL</h4>
        <div class="small">Paste a new URL. (Only works in edit mode.)</div>
        <div style="display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap;">
          <input class="select" id="portraitUrl" type="url" placeholder="https://..." />
          <button class="btn primary" id="portraitApplyUrl" type="button">Apply</button>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <h4>Crop / Position</h4>
        <div class="small">Use zoom + position to ‚Äúcrop‚Äù inside the frame.</div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
          <div class="field">
            <label>Zoom</label>
            <div style="display:flex; align-items:center; gap:8px;">
              <input id="pz" type="range" min="1" max="2.2" step="0.01" style="width:160px;">
              <span class="val" id="pzVal">1.00</span>
            </div>
          </div>
          <div class="field">
            <label>Reset</label>
            <button class="btn" id="portraitReset" type="button">Default crop</button>
          </div>
        </div>

        <div class="portrait-preview" id="portraitPreview" aria-label="Portrait position preview">
          <img id="portraitPreviewImg" alt="Portrait preview" />
          <div class="portrait-preview-grid"></div>
        </div>
        <div class="small" style="margin-top:8px;">
          Drag inside the preview to reposition. Position: <strong id="portraitPosLabel">50% / 30%</strong>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="row">
        <div class="small">Tip: set Y lower (e.g. 20‚Äì35%) to keep face higher in frame.</div>
        <button class="btn primary" id="portraitDone" type="button">Done</button>
      </div>
    </div>
  </dialog>

  <!-- Add custom skill dialog -->
  <dialog id="addSkillDialog" aria-label="Add custom skill">
    <div class="dlg-head">
      <h3 class="dlg-title">Add Skill</h3>
      <button class="icon-btn" id="addSkillClose" type="button" aria-label="Close">‚úï</button>
    </div>
    <div class="dlg-body">
      <div class="card">
        <h4>Skill Details</h4>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
          <div class="field" style="justify-content:flex-start;">
            <label style="min-width:110px;">Name</label>
            <input id="newSkillName" class="select" placeholder="e.g., Tactics" />
          </div>
          <div class="field" style="justify-content:flex-start;">
            <label style="min-width:110px;">Ability</label>
            <select id="newSkillAbility" class="select"></select>
          </div>
        </div>
        <div class="small" style="margin-top:10px;">Proficiency can be changed later by editing the data model; this template defaults to ‚Äúnone‚Äù.</div>
      </div>
      <div style="height:12px"></div>
      <div class="row">
        <button class="btn" id="addSkillCancel" type="button">Cancel</button>
        <button class="btn primary" id="addSkillConfirm" type="button">Add Skill</button>
      </div>
    </div>
  </dialog>

  <!-- Add custom ability dialog -->
  <dialog id="addAbilityDialog" aria-label="Add custom ability">
    <div class="dlg-head">
      <h3 class="dlg-title">Add Ability</h3>
      <button class="icon-btn" id="addAbilityClose" type="button" aria-label="Close">‚úï</button>
    </div>
    <div class="dlg-body">
      <div class="card">
        <h4>Ability Details</h4>
        <div class="small">Creates a new ability score card. (Example: ‚ÄúLCK‚Äù or ‚ÄúSAN‚Äù.)</div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
          <div class="field" style="justify-content:flex-start;">
            <label style="min-width:110px;">Label</label>
            <input id="newAbilityLabel" class="select" placeholder="e.g., LCK" />
          </div>
          <div class="field" style="justify-content:flex-start;">
            <label style="min-width:110px;">Score</label>
            <input id="newAbilityScore" type="number" min="1" value="10" class="select" style="font-family:var(--mono);" />
          </div>
        </div>
      </div>
      <div style="height:12px"></div>
      <div class="row">
        <button class="btn" id="addAbilityCancel" type="button">Cancel</button>
        <button class="btn primary" id="addAbilityConfirm" type="button">Add Ability</button>
      </div>
    </div>
  </dialog>

  <!-- FABs: Lock + Settings -->
  <div class="fab-wrap" aria-label="Quick controls">
    <button class="fab" id="lockFab" type="button" aria-label="Toggle edit lock" aria-pressed="false" title="Unlock to edit">
      <svg id="lockIconClosed" width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M7 11V8a5 5 0 0 1 10 0v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M7 11h10a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
      </svg>
      <svg id="lockIconOpen" width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="display:none;">
        <path d="M17 11V8a5 5 0 0 0-9.7-1.7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M7 11h10a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
      </svg>
    </button>

    <button class="fab" id="settingsFab" type="button" aria-label="Open settings" title="Settings">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M12 15.2a3.2 3.2 0 1 0 0-6.4 3.2 3.2 0 0 0 0 6.4Z" stroke="currentColor" stroke-width="2"/>
        <path d="M19.4 15a8.6 8.6 0 0 0 .1-1l2-1.2-2-3.4-2.2.6c-.5-.4-1-.7-1.6-.9L13.9 6h-3.8L9.3 8.9c-.6.2-1.1.5-1.6.9l-2.2-.6-2 3.4 2 1.2a8.6 8.6 0 0 0 0 2l-2 1.2 2 3.4 2.2-.6c.5.4 1 .7 1.6.9L10.1 22h3.8l.8-2.9c.6-.2 1.1-.5 1.6-.9l2.2.6 2-3.4-2-1.2c.1-.3.1-.7.1-1Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>

  <script>
    /**********************************************************************
     * State
     **********************************************************************/
    const PORTRAIT_URL = "https://i.pinimg.com/736x/1d/bc/14/1dbc1450cd029714c234af43363dd87b.jpg";

    const XP_THRESHOLDS = [
      { lvl:1, xp:0 },
      { lvl:2, xp:300 },
      { lvl:3, xp:900 },
      { lvl:4, xp:2700 },
      { lvl:5, xp:6500 },
      { lvl:6, xp:14000 },
      { lvl:7, xp:23000 },
      { lvl:8, xp:34000 },
      { lvl:9, xp:48000 },
      { lvl:10, xp:64000 },
      { lvl:11, xp:85000 },
      { lvl:12, xp:100000 },
      { lvl:13, xp:120000 },
      { lvl:14, xp:140000 },
      { lvl:15, xp:165000 },
      { lvl:16, xp:195000 },
      { lvl:17, xp:225000 },
      { lvl:18, xp:265000 },
      { lvl:19, xp:305000 },
      { lvl:20, xp:355000 }
    ];

    const CONDITIONS = [
      "Blinded","Charmed","Deafened","Frightened","Grappled","Incapacitated",
      "Invisible","Paralyzed","Petrified","Poisoned","Prone","Restrained",
      "Stunned","Unconscious"
    ];

    const baseSkills = [
      { name:"Acrobatics",       abil:"dex" },
      { name:"Animal Handling",  abil:"wis" },
      { name:"Arcana",           abil:"int" },
      { name:"Athletics",        abil:"str" },
      { name:"Deception",        abil:"cha" },
      { name:"History",          abil:"int" },
      { name:"Insight",          abil:"wis" },
      { name:"Intimidation",     abil:"cha" },
      { name:"Investigation",    abil:"int" },
      { name:"Medicine",         abil:"wis" },
      { name:"Nature",           abil:"int" },
      { name:"Perception",       abil:"wis" },
      { name:"Performance",      abil:"cha" },
      { name:"Persuasion",       abil:"cha" },
      { name:"Religion",         abil:"int" },
      { name:"Sleight of Hand",  abil:"dex" },
      { name:"Stealth",          abil:"dex" },
      { name:"Survival",         abil:"wis" }
    ];

    const state = {
      name: "Elaria Thornbloom",
      tagline: "Of the order of History",
      race: "Wood Elf",
      classSummary: "Druid 10",
      ac: 16,
      init: +3,
      speed: 35,
      prof: +4,

      hp: { cur: 73, max: 73, temp: 0 },

      inspiration: false,
      status: { conditions: [], exhaustion: 0 },

      coins: { pp: 2, gp: 121, ep: 0, sp: 35, cp: 70 },

      hitDice: { total: 10, remaining: 7, die: 8, conMod: 2 },
      wildShape: { max: 2, remaining: 1 },

      abilities: [
        { key:"str", label:"STR", score:10, saveProf:false },
        { key:"dex", label:"DEX", score:16, saveProf:false },
        { key:"con", label:"CON", score:14, saveProf:false },
        { key:"int", label:"INT", score:12, saveProf:false },
        { key:"wis", label:"WIS", score:15, saveProf:true  },
        { key:"cha", label:"CHA", score:10, saveProf:false }
      ],

      skills: [...baseSkills],
      skillProfs: {
        "Perception": 2,
        "Nature": 2,
        "Insight": 2,
        "Survival": 2,
        "Animal Handling": 2,
        "Medicine": 2
      },

      xpMode: "milestone", // "milestone" | "xp"
      xp: 0,

      spells: {
        dc: 16,
        atk: +8,
        prepared: 14,
        list: [
          { lvl:"Cantrip", name:"Guidance", note:"Add d4 to ability checks." },
          { lvl:"Cantrip", name:"Produce Flame", note:"Light / ranged fire." },
          { lvl:"1st", name:"Faerie Fire", note:"Outline targets; advantage." },
          { lvl:"2nd", name:"Pass without Trace", note:"+10 Stealth aura." },
          { lvl:"3rd", name:"Call Lightning", note:"Sustained storm damage." },
          { lvl:"4th", name:"Polymorph", note:"Transform creature." },
          { lvl:"5th", name:"Greater Restoration", note:"End major conditions." }
        ]
      },

      combat: {
        actions: [
          { name:"Shillelagh (Quarterstaff)", toHit:"+8", dmg:"1d8+4 bludgeoning", notes:"Wis-based via Shillelagh" },
          { name:"Produce Flame", toHit:"+8", dmg:"2d8 fire", notes:"60 ft range" },
          { name:"Entangle", toHit:"DC 16", dmg:"Restrained (save)", notes:"Difficult terrain" }
        ],
        bonus: [
          "Wild Shape ‚Äî transform (if feature allows).",
          "Healing Word ‚Äî bonus action heal (range).",
          "Shillelagh ‚Äî imbue staff/club."
        ],
        reactions: [
          "Opportunity Attack ‚Äî melee attack when a creature leaves reach.",
          "Readied Action ‚Äî reaction to trigger a prepared action."
        ],
        free: [
          "Speak a few words.",
          "Drop an item.",
          "Interact with one object (DM dependent)."
        ]
      },

      inventory: {
        attunements: [
          { item: "Moonstone Charm", notes:"Attuned ‚Ä¢ faint warmth near fey crossings" },
          { item: "Ring of Warmth", notes:"Attuned ‚Ä¢ cold resistance (example)" },
          { item: "", notes:"(empty)" }
        ],
        items: [
          { name:"Quarterstaff", qty: 1, notes:"Focus (wooden staff)" },
          { name:"Leather Armor", qty: 1, notes:"AC baseline" },
          { name:"Explorer‚Äôs Pack", qty: 1, notes:"Bedroll, rations, etc." },
          { name:"Herbalism Kit", qty: 1, notes:"Poultices & remedies" }
        ],
        magic: [
          "Cloak of the Grove (flavor) ‚Äî smells faintly of cedar.",
          "Stone charm ‚Äî warms near fey crossings."
        ],
        tools: [
          "Herbalism Kit",
          "Calligrapher‚Äôs Supplies"
        ]
      },

      notes: [
        "Keep a slot for Speak with Animals when traveling.",
        "Mark fey signs near the old stone bridge.",
        "Owes a favor to the apothecary in Westhollow."
      ],

      portrait: {
        url: PORTRAIT_URL,
        zoom: 1.00,
        x: 50,
        y: 30
      },

      settings: {
        theme: "midnight",
        inspGlowEnabled: true,
        wide: false,
        editUnlocked: false
      }
    };

    /**********************************************************************
     * Helpers
     **********************************************************************/
    const $ = (sel, root=document) => root.querySelector(sel);
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function modFromScore(score){ return Math.floor((score - 10) / 2); }
    function formatSigned(n){ return (n>=0? "+" : "") + n; }
    function escapeHTML(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function normalizeNumberText(s){
      const t = String(s).trim();
      const cleaned = t.replace(/[^\d+\-]/g, "");
      const n = parseInt(cleaned, 10);
      return Number.isFinite(n) ? n : null;
    }

    // currency values in gp
    const COIN_VALUE = { pp: 10, gp: 1, ep: 0.5, sp: 0.1, cp: 0.01 };
    function coinTotalGP(coins){
      let t = 0;
      for (const k of Object.keys(COIN_VALUE)) t += (coins[k] || 0) * COIN_VALUE[k];
      return Math.round(t * 100) / 100;
    }

    function getAbilityByKey(key){
      return state.abilities.find(a => a.key === key);
    }

    /**********************************************************************
     * XP
     **********************************************************************/
    function levelFromXP(xp){
      let lvl = 1;
      for (const row of XP_THRESHOLDS){
        if (xp >= row.xp) lvl = row.lvl;
      }
      return lvl;
    }
    function nextThreshold(xp){
      const lvl = levelFromXP(xp);
      const next = XP_THRESHOLDS.find(r => r.lvl === Math.min(20, lvl + 1));
      return next ? next.xp : XP_THRESHOLDS[XP_THRESHOLDS.length - 1].xp;
    }
    function renderXPBox(){
      const xp = Math.max(0, state.xp|0);
      const lvl = levelFromXP(xp);
      const next = nextThreshold(xp);
      const toNext = Math.max(0, next - xp);

      $("#xpCurrent").value = xp;
      $("#xpLevel").textContent = lvl;
      $("#xpNext").textContent = next;
      $("#xpToNext").textContent = toNext;

      // reflect into total level (display-only for now)
      $("#mainTotalLevel").textContent = lvl;
    }

    /**********************************************************************
     * Status
     **********************************************************************/
    function getActiveStatusList(){
      const out = [...state.status.conditions];
      if (state.status.exhaustion > 0) out.push(`Exhaustion ${state.status.exhaustion}`);
      return out;
    }
    function summarizeStatus(active){
      if (!active.length) return "None";
      if (active.length === 1) return active[0];
      return `${active[0]} +${active.length - 1}`;
    }

    /**********************************************************************
     * Rendering
     **********************************************************************/
    function applyInspirationGlow(){
      const enabled = !!state.settings.inspGlowEnabled;
      const on = state.inspiration && enabled;
      document.body.setAttribute("data-insp-glow", on ? "on" : "off");
    }

    function applyWide(){
      document.body.setAttribute("data-wide", state.settings.wide ? "on" : "off");
    }

    function renderTopbar(){
      $("#tb_name").textContent = state.name;
      $("#tb_sub").textContent = `${state.race} ‚Ä¢ ${state.classSummary}`;
      $("#tb_ac").textContent = state.ac;
      $("#tb_init").textContent = formatSigned(state.init);
      $("#tb_speed").textContent = state.speed;
      $("#tb_pb").textContent = formatSigned(state.prof);

      const total = coinTotalGP(state.coins);
      $("#tb_money_total").textContent = `${total.toFixed(2)} gp`;
      $("#i_money").textContent = `${total.toFixed(2)} gp`;

      $("#tb_insp").textContent = state.inspiration ? "Yes" : "No";
      $("#inspBtn").setAttribute("aria-pressed", state.inspiration ? "true" : "false");
      applyInspirationGlow();

      const active = getActiveStatusList();
      $("#tb_status").textContent = summarizeStatus(active);
      $("#statusTooltipText").textContent = active.length ? active.join(", ") : "None";

      // main quickstats mirror
      $("#m_hp").textContent = `${state.hp.cur}/${state.hp.max}${state.hp.temp>0 ? ` (+${state.hp.temp})` : ""}`;
      $("#m_ac").textContent = state.ac;
      $("#m_init").textContent = formatSigned(state.init);
      $("#m_prof").textContent = formatSigned(state.prof);
      $("#m_spd").textContent = state.speed;
    }

    function renderHP(){
      $("#tb_hp_cur").textContent = state.hp.cur;
      $("#tb_hp_max").textContent = state.hp.max;
      $("#tb_temp_label").textContent = `+${state.hp.temp}`;

      // scaling: total width represents max+temp
      const total = Math.max(1, state.hp.max + state.hp.temp);
      const curW = clamp((state.hp.cur / total) * 100, 0, 100);
      const maxW = clamp((state.hp.max / total) * 100, 0, 100);
      const tempW = clamp((state.hp.temp / total) * 100, 0, 100);

      $("#hpGreen").style.width = `${curW}%`;
      $("#hpTemp").style.left = `${maxW}%`;
      $("#hpTemp").style.width = `${tempW}%`;
    }

    function renderMain(){
      $("#mainName").textContent = state.name;
      $("#mainTagline").textContent = state.tagline;
      $("#mainSummaryLine").innerHTML = [
        `<span class="tag">${escapeHTML(state.race)}</span>`,
        `<span class="tag">${escapeHTML(state.classSummary)}</span>`
      ].join("");
    }

    function renderPortrait(){
      const img = $("#portraitImg");
      img.src = state.portrait.url;
      img.style.setProperty("--pz", String(state.portrait.zoom));
      img.style.setProperty("--px", `${state.portrait.x}%`);
      img.style.setProperty("--py", `${state.portrait.y}%`);
      // applied via CSS vars on element, but we set them on root of img:
      img.style.setProperty("--pz", state.portrait.zoom);
      img.style.setProperty("--px", `${state.portrait.x}%`);
      img.style.setProperty("--py", `${state.portrait.y}%`);
      // also set on inline style for object-position
      img.style.objectPosition = `${state.portrait.x}% ${state.portrait.y}%`;
      img.style.transform = `scale(${state.portrait.zoom})`;
    }

    function updatePortraitPreview(){
      const preview = $("#portraitPreviewImg");
      if (!preview) return;
      preview.src = state.portrait.url;
      preview.style.setProperty("--pz", state.portrait.zoom);
      preview.style.setProperty("--px", `${state.portrait.x}%`);
      preview.style.setProperty("--py", `${state.portrait.y}%`);
      preview.style.objectPosition = `${state.portrait.x}% ${state.portrait.y}%`;
      preview.style.transform = `scale(${state.portrait.zoom})`;
      $("#portraitPosLabel").textContent = `${state.portrait.x}% / ${state.portrait.y}%`;
    }

    function renderAbilities(){
      const grid = $("#abilGrid");
      grid.innerHTML = "";

      for (const a of state.abilities){
        const mod = modFromScore(a.score);
        const save = mod + (a.saveProf ? state.prof : 0);

        grid.insertAdjacentHTML("beforeend", `
          <div class="abil-card">
            <div class="abil-head">${escapeHTML(a.label)}</div>
            <div class="abil-box">
              <div class="abil-score">${a.score}</div>
            </div>
            <div class="abil-box" style="padding:10px 10px;">
              <div class="abil-subk">MOD</div>
              <div class="abil-subv">${formatSigned(mod)}</div>
            </div>
            <div style="display:flex; justify-content:center;">
              <span class="save-pill ${a.saveProf ? "pro":""}">
                SAVING THROW ${formatSigned(save)}
              </span>
            </div>
          </div>
        `);
      }

      renderSkills();
      populateAbilityDropdowns();
    }

    function renderSkills(){
      const cols = [[],[],[]];
      state.skills.forEach((s,i)=> cols[i%3].push(s));

      $("#skillsGrid").innerHTML = cols.map(col => `
        <div class="skill-col">
          ${col.map(s => renderSkillRow(s)).join("")}
        </div>
      `).join("");
    }

    function renderSkillRow(skill){
      const abil = getAbilityByKey(skill.abil) || getAbilityByKey("int");
      const base = modFromScore(abil.score);
      const level = state.skillProfs[skill.name] ?? 0;

      let bonus = base;
      if (level === 1) bonus += Math.floor(state.prof / 2);
      if (level === 2) bonus += state.prof;
      if (level === 3) bonus += state.prof * 2;

      return `
        <div class="skill-row">
          <div class="skill-left">
            <span class="dot ${level===1?"fill": level>=2?"gold":""}"></span>
            <span class="skill-name">${escapeHTML(skill.name)}</span>
          </div>
          <div class="skill-mid">${escapeHTML(abil.label)}</div>
          <div class="skill-right">${formatSigned(bonus)}</div>
        </div>
      `;
    }

    function renderCombat(){
      $("#sp_dc").textContent = state.spells.dc;
      $("#sp_atk").textContent = formatSigned(state.spells.atk);

      $("#c_attacks").innerHTML = state.combat.actions.map(a => `
        <tr>
          <td><strong>${escapeHTML(a.name)}</strong></td>
          <td class="right"><span class="num">${escapeHTML(a.toHit)}</span></td>
          <td>${escapeHTML(a.dmg)}</td>
          <td class="muted">${escapeHTML(a.notes)}</td>
        </tr>
      `).join("");

      $("#c_bonus").innerHTML = state.combat.bonus.map(x => `<li class="muted">${escapeHTML(x)}</li>`).join("");
      $("#c_reactions").innerHTML = state.combat.reactions.map(x => `<li class="muted">${escapeHTML(x)}</li>`).join("");
      $("#c_free").innerHTML = state.combat.free.map(x => `<li class="muted">${escapeHTML(x)}</li>`).join("");
    }

    function renderSpells(){
      $("#sp_prep").textContent = state.spells.prepared;
      const byLvl = new Map();
      for (const sp of state.spells.list){
        if (!byLvl.has(sp.lvl)) byLvl.set(sp.lvl, []);
        byLvl.get(sp.lvl).push(sp);
      }
      $("#sp_list").innerHTML = [...byLvl.entries()].map(([lvl, list]) => `
        <div class="card" style="margin-bottom:12px;">
          <h4>${escapeHTML(lvl)}</h4>
          <table>
            <thead><tr><th>Spell</th><th>Notes</th></tr></thead>
            <tbody>
              ${list.map(s => `
                <tr>
                  <td><strong>${escapeHTML(s.name)}</strong></td>
                  <td class="muted">${escapeHTML(s.note)}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      `).join("");
    }

    function renderInventory(){
      $("#i_items").innerHTML = state.inventory.items.map(it => `
        <tr>
          <td><strong>${escapeHTML(it.name)}</strong></td>
          <td class="right"><span class="num">${it.qty}</span></td>
          <td class="muted">${escapeHTML(it.notes)}</td>
        </tr>
      `).join("");

      $("#i_magic").innerHTML = `
        <ul style="margin:0; padding-left:18px;">
          ${state.inventory.magic.map(m => `<li class="muted">${escapeHTML(m)}</li>`).join("")}
        </ul>
      `;
      $("#i_tools").innerHTML = `
        <ul style="margin:0; padding-left:18px;">
          ${state.inventory.tools.map(t => `<li class="muted">${escapeHTML(t)}</li>`).join("")}
        </ul>
      `;

      // attunement list
      $("#attuneList").innerHTML = state.inventory.attunements.map((a, idx) => `
        <div class="attune-row">
          <div style="min-width:0;">
            <strong class="attune-slot">Slot ${idx+1}</strong>
            <div class="muted" style="margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
              ${escapeHTML(a.item || "(empty)")}
            </div>
          </div>
          <div class="muted" style="text-align:right; max-width: 52%;">
            ${escapeHTML(a.notes || "")}
          </div>
        </div>
      `).join("");
    }

    function renderNotes(){
      $("#n_notes").innerHTML = `
        <ul style="margin:0; padding-left:18px;">
          ${state.notes.map(n => `<li class="muted">${escapeHTML(n)}</li>`).join("")}
        </ul>
      `;
    }

    function renderCoinPurse(){
      const total = coinTotalGP(state.coins);
      $("#coinTotal").textContent = total.toFixed(2);

      const cards = [
        { k:"pp", name:"Platinum", icon:"üëë", val: COIN_VALUE.pp },
        { k:"gp", name:"Gold",     icon:"ü™ô", val: COIN_VALUE.gp },
        { k:"ep", name:"Electrum", icon:"‚¨°", val: COIN_VALUE.ep },
        { k:"sp", name:"Silver",   icon:"üåô", val: COIN_VALUE.sp },
        { k:"cp", name:"Copper",   icon:"üî•", val: COIN_VALUE.cp }
      ].map(c => {
        const amt = state.coins[c.k] || 0;
        const gp = (amt * c.val).toFixed(2);
        return `
          <div class="coin-card" data-coin="${c.k}">
            <div class="coin-left">
              <div class="coin-ic">${c.icon}</div>
              <div class="coin-meta">
                <div class="coin-name">${c.name} (${c.k})</div>
                <div class="coin-val">${c.val} gp each ‚Ä¢ ${gp} gp value</div>
              </div>
            </div>
            <div class="coin-amt">${amt}</div>
          </div>
        `;
      }).join("");

      $("#coinCards").innerHTML = cards;
    }

    /**********************************************************************
     * UI / dialogs
     **********************************************************************/
    function openStatusDialog(){
      const grid = $("#condGrid");
      if (!grid.dataset.built){
        grid.innerHTML = CONDITIONS.map(c => `
          <label class="check">
            <input type="checkbox" value="${escapeHTML(c)}" />
            <span>${escapeHTML(c)}</span>
          </label>
        `).join("");
        grid.dataset.built = "1";
      }
      grid.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
        cb.checked = state.status.conditions.includes(cb.value);
      });
      $("#exhaustSel").value = String(state.status.exhaustion);
      $("#statusDialog").showModal();
    }
    function applyStatusFromDialog(){
      const selected = [...$("#condGrid").querySelectorAll('input[type="checkbox"]:checked')].map(x=>x.value);
      state.status.conditions = selected;
      state.status.exhaustion = parseInt($("#exhaustSel").value, 10) || 0;
      $("#statusDialog").close();
      renderTopbar();
    }
    function clearStatus(){
      $("#condGrid").querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked=false);
      $("#exhaustSel").value = "0";
    }

    function openCoinDialog(){
      renderCoinPurse();
      $("#coinDialog").showModal();
    }

    // HP
    function damageHP(amount){
      amount = Math.max(0, amount|0);
      if (amount === 0) return;

      const fromTemp = Math.min(state.hp.temp, amount);
      state.hp.temp -= fromTemp;
      amount -= fromTemp;

      state.hp.cur = clamp(state.hp.cur - amount, 0, state.hp.max);
    }
    function healHP(amount){
      amount = Math.max(0, amount|0);
      state.hp.cur = clamp(state.hp.cur + amount, 0, state.hp.max);
    }
    function setTempHP(amount){
      amount = Math.max(0, amount|0);
      state.hp.temp = Math.max(state.hp.temp, amount); // temp doesn't stack
    }

    // Rest
    function openShortRest(){
      $("#hdDieLabel").textContent = `d${state.hitDice.die}`;
      $("#hdTotal").textContent = state.hitDice.total;
      $("#hdRemain").textContent = state.hitDice.remaining;
      $("#hdCon").textContent = formatSigned(state.hitDice.conMod);
      $("#hdSpend").value = "1";
      $("#hdResult").textContent = `Wild Shape uses remaining: ${state.wildShape.remaining}/${state.wildShape.max}`;
      $("#shortRestDialog").showModal();
    }
    function rollHitDice(){
      let spend = parseInt($("#hdSpend").value, 10) || 0;
      spend = clamp(spend, 0, state.hitDice.remaining);
      if (spend === 0){
        $("#hdResult").textContent = "No hit dice spent.";
        return;
      }

      const rolls = [];
      let totalRoll = 0;
      for (let i=0; i<spend; i++){
        const r = 1 + Math.floor(Math.random() * state.hitDice.die);
        rolls.push(r);
        totalRoll += r;
      }
      const heal = totalRoll + (state.hitDice.conMod * spend);
      state.hitDice.remaining -= spend;
      healHP(heal);

      $("#hdRemain").textContent = state.hitDice.remaining;
      $("#hdResult").textContent = `Rolled: [${rolls.join(", ")}] + ${state.hitDice.conMod}√ó${spend} = ${heal} healed.`;
      renderHP();
      renderTopbar();
    }
    function completeShortRest(){
      state.wildShape.remaining = state.wildShape.max;
      $("#hdResult").textContent = `Short rest complete. Wild Shape reset to ${state.wildShape.remaining}/${state.wildShape.max}.`;
      renderTopbar();
    }
    function applyLongRest(){
      state.hp.cur = state.hp.max;
      state.hp.temp = 0;

      const half = Math.max(1, Math.floor(state.hitDice.total / 2));
      state.hitDice.remaining = Math.min(state.hitDice.total, state.hitDice.remaining + half);

      state.wildShape.remaining = state.wildShape.max;

      renderHP();
      renderTopbar();
    }

    /**********************************************************************
     * Tabs
     **********************************************************************/
    function setActiveTab(tab){
      document.querySelectorAll(".tab").forEach(b=>{
        const active = (b.dataset.tab === tab);
        b.setAttribute("aria-selected", active ? "true" : "false");
      });
      document.querySelectorAll("[data-tabpanel]").forEach(p=>{
        p.dataset.active = (p.id === `tab-${tab}`) ? "true" : "false";
      });
    }

    function setCombatSubtab(which){
      document.querySelectorAll(".subtab").forEach(b=>{
        const active = (b.dataset.subtab === which);
        b.setAttribute("aria-selected", active ? "true" : "false");
      });
      document.querySelectorAll("[data-subpanel]").forEach(p=>{
        p.dataset.active = (p.id === `sub-${which}`) ? "true" : "false";
      });
    }

    /**********************************************************************
     * Settings (theme + glow + wide)
     **********************************************************************/
    function loadSettings(){
      try{
        const raw = localStorage.getItem("dnd_sheet_settings_v3");
        if (raw){
          const s = JSON.parse(raw);
          if (s && typeof s === "object"){
            state.settings.theme = s.theme ?? state.settings.theme;
            state.settings.inspGlowEnabled = (s.inspGlowEnabled ?? state.settings.inspGlowEnabled);
            state.settings.wide = (s.wide ?? state.settings.wide);
            state.settings.editUnlocked = (s.editUnlocked ?? state.settings.editUnlocked);

            // portrait persisted
            if (s.portrait){
              state.portrait.url = s.portrait.url ?? state.portrait.url;
              state.portrait.zoom = s.portrait.zoom ?? state.portrait.zoom;
              state.portrait.x = s.portrait.x ?? state.portrait.x;
              state.portrait.y = s.portrait.y ?? state.portrait.y;
            }
          }
        }
      }catch{}
      applyTheme(state.settings.theme);
      applyWide();
      applyInspirationGlow();
      applyEditMode(state.settings.editUnlocked);
      renderPortrait();
    }

    function saveSettings(){
      localStorage.setItem("dnd_sheet_settings_v3", JSON.stringify({
        theme: state.settings.theme,
        inspGlowEnabled: state.settings.inspGlowEnabled,
        wide: state.settings.wide,
        editUnlocked: state.settings.editUnlocked,
        portrait: { ...state.portrait }
      }));
    }

    function applyTheme(theme){
      document.documentElement.setAttribute("data-theme", theme);
      state.settings.theme = theme;
      document.querySelectorAll('input[name="theme"]').forEach(r=>{
        r.checked = (r.value === theme);
      });
    }

    function openSettings(){
      applyTheme(state.settings.theme);
      $("#glowToggle").checked = !!state.settings.inspGlowEnabled;
      $("#wideToggle").checked = !!state.settings.wide;
      $("#settingsDialog").showModal();
    }

    /**********************************************************************
     * Edit mode (lock)
     **********************************************************************/
    function applyEditMode(unlocked){
      state.settings.editUnlocked = !!unlocked;
      document.body.setAttribute("data-edit", unlocked ? "on" : "off");

      $("#lockFab").setAttribute("aria-pressed", unlocked ? "true" : "false");
      $("#lockFab").title = unlocked ? "Lock to stop editing" : "Unlock to edit";
      $("#lockIconClosed").style.display = unlocked ? "none" : "block";
      $("#lockIconOpen").style.display = unlocked ? "block" : "none";

      document.querySelectorAll(".editable").forEach(el=>{
        el.contentEditable = unlocked ? "true" : "false";
        if (!unlocked) el.blur();
      });

      // show/hide edit-only buttons
      $("#addSkillBtn").style.display = unlocked ? "grid" : "none";
      $("#addAbilityBtn").style.display = unlocked ? "grid" : "none";
      $("#addAttuneBtn").style.display = unlocked ? "grid" : "none";

      saveSettings();
    }

    function syncEditableToState(){
      const nm = $("#tb_name").textContent.trim();
      if (nm) state.name = nm;

      const ac = normalizeNumberText($("#tb_ac").textContent);
      if (ac !== null) state.ac = ac;

      const init = normalizeNumberText($("#tb_init").textContent);
      if (init !== null) state.init = init;

      const spd = normalizeNumberText($("#tb_speed").textContent);
      if (spd !== null) state.speed = spd;

      const pb = normalizeNumberText($("#tb_pb").textContent);
      if (pb !== null) state.prof = pb;

      const hpMax = normalizeNumberText($("#tb_hp_max").textContent);
      if (hpMax !== null) {
        state.hp.max = Math.max(1, hpMax);
        state.hp.cur = clamp(state.hp.cur, 0, state.hp.max);
      }
      const hpCur = normalizeNumberText($("#tb_hp_cur").textContent);
      if (hpCur !== null) state.hp.cur = clamp(hpCur, 0, state.hp.max);

      const mainName = $("#mainName").textContent.trim();
      if (mainName) state.name = mainName;

      const tag = $("#mainTagline").textContent.trim();
      if (tag) state.tagline = tag;

      const cls = $("#mainClasses").textContent.trim();
      if (cls) state.classSummary = cls;

      const race = $("#mainRace").textContent.trim();
      if (race) state.race = race;

      renderTopbar();
      renderHP();
      renderMain();
    }

    /**********************************************************************
     * Custom Skills / Abilities
     **********************************************************************/
    function populateAbilityDropdowns(){
      const sel = $("#newSkillAbility");
      if (!sel) return;
      sel.innerHTML = state.abilities.map(a => `<option value="${a.key}">${escapeHTML(a.label)}</option>`).join("");
    }

    function openAddSkill(){
      if (!state.settings.editUnlocked) return;
      $("#newSkillName").value = "";
      populateAbilityDropdowns();
      $("#addSkillDialog").showModal();
    }
    function addSkillConfirm(){
      const name = $("#newSkillName").value.trim();
      const abil = $("#newSkillAbility").value;
      if (!name) return;
      if (state.skills.some(s => s.name.toLowerCase() === name.toLowerCase())) return;

      state.skills.push({ name, abil });
      state.skillProfs[name] = 0;
      $("#addSkillDialog").close();
      renderAbilities();
    }

    function openAddAbility(){
      if (!state.settings.editUnlocked) return;
      $("#newAbilityLabel").value = "";
      $("#newAbilityScore").value = 10;
      $("#addAbilityDialog").showModal();
    }
    function makeKeyFromLabel(label){
      return label.toLowerCase().replace(/[^a-z0-9]+/g,"").slice(0,10) || ("abil" + Math.floor(Math.random()*9999));
    }
    function addAbilityConfirm(){
      const label = $("#newAbilityLabel").value.trim().toUpperCase();
      const score = clamp(parseInt($("#newAbilityScore").value,10) || 10, 1, 30);
      if (!label) return;

      const key = makeKeyFromLabel(label);
      if (state.abilities.some(a => a.label === label)) return;

      state.abilities.push({ key, label, score, saveProf:false });
      $("#addAbilityDialog").close();
      renderAbilities();
    }

    /**********************************************************************
     * Portrait editing
     **********************************************************************/
    function openPortraitEditor(){
      if (!state.settings.editUnlocked) return;
      $("#portraitUrl").value = state.portrait.url;

      $("#pz").value = state.portrait.zoom;
      $("#pzVal").textContent = Number(state.portrait.zoom).toFixed(2);
      updatePortraitPreview();

      $("#portraitDialog").showModal();
    }
    function applyPortraitUrl(){
      const url = $("#portraitUrl").value.trim();
      if (!url) return;
      state.portrait.url = url;
      renderPortrait();
      updatePortraitPreview();
      saveSettings();
    }
    function applyPortraitControls(){
      state.portrait.zoom = parseFloat($("#pz").value);

      $("#pzVal").textContent = Number(state.portrait.zoom).toFixed(2);

      renderPortrait();
      updatePortraitPreview();
      saveSettings();
    }
    function setPortraitPosition(x, y){
      state.portrait.x = clamp(Math.round(x), 0, 100);
      state.portrait.y = clamp(Math.round(y), 0, 100);
      renderPortrait();
      updatePortraitPreview();
      saveSettings();
    }
    function resetPortraitCrop(){
      state.portrait.zoom = 1.00;
      state.portrait.x = 50;
      state.portrait.y = 30;
      $("#pz").value = state.portrait.zoom;
      applyPortraitControls();
    }
    function startPortraitDrag(e){
      const preview = $("#portraitPreview");
      if (!preview || e.button !== 0) return;
      const rect = preview.getBoundingClientRect();
      preview.classList.add("is-dragging");
      preview.setPointerCapture(e.pointerId);
      preview.dataset.dragging = "1";
      preview.dataset.dragStartX = String(e.clientX);
      preview.dataset.dragStartY = String(e.clientY);
      preview.dataset.dragOriginX = String(state.portrait.x);
      preview.dataset.dragOriginY = String(state.portrait.y);
      preview.dataset.dragRectW = String(rect.width || 1);
      preview.dataset.dragRectH = String(rect.height || 1);
    }
    function movePortraitDrag(e){
      const preview = $("#portraitPreview");
      if (!preview || preview.dataset.dragging !== "1") return;
      const startX = parseFloat(preview.dataset.dragStartX || "0");
      const startY = parseFloat(preview.dataset.dragStartY || "0");
      const originX = parseFloat(preview.dataset.dragOriginX || "50");
      const originY = parseFloat(preview.dataset.dragOriginY || "30");
      const rectW = parseFloat(preview.dataset.dragRectW || "1");
      const rectH = parseFloat(preview.dataset.dragRectH || "1");
      const dx = (e.clientX - startX) / rectW * 100;
      const dy = (e.clientY - startY) / rectH * 100;
      setPortraitPosition(originX + dx, originY + dy);
    }
    function endPortraitDrag(e){
      const preview = $("#portraitPreview");
      if (!preview || preview.dataset.dragging !== "1") return;
      preview.classList.remove("is-dragging");
      preview.dataset.dragging = "0";
      preview.releasePointerCapture(e.pointerId);
    }

    /**********************************************************************
     * Attunement slots
     **********************************************************************/
    function addAttunementSlot(){
      if (!state.settings.editUnlocked) return;
      state.inventory.attunements.push({ item:"", notes:"(empty)" });
      renderInventory();
    }

    /**********************************************************************
     * Init
     **********************************************************************/
    function init(){
      // portrait
      renderPortrait();
      $("#portraitImg").addEventListener("click", openPortraitEditor);

      // status
      $("#statusBtn").addEventListener("click", openStatusDialog);
      $("#statusClose").addEventListener("click", ()=> $("#statusDialog").close());
      $("#cancelStatusBtn").addEventListener("click", ()=> $("#statusDialog").close());
      $("#applyStatusBtn").addEventListener("click", applyStatusFromDialog);
      $("#clearStatusBtn").addEventListener("click", clearStatus);

      // money
      $("#moneyBtn").addEventListener("click", openCoinDialog);
      $("#coinClose").addEventListener("click", ()=> $("#coinDialog").close());

      // inspiration
      $("#inspBtn").addEventListener("click", ()=>{
        state.inspiration = !state.inspiration;
        renderTopbar();
      });

      // HP controls
      $("#btnDamage").addEventListener("click", ()=>{
        const amt = parseInt($("#hpAmt").value, 10) || 0;
        damageHP(amt);
        renderHP(); renderTopbar();
      });
      $("#btnHeal").addEventListener("click", ()=>{
        const amt = parseInt($("#hpAmt").value, 10) || 0;
        healHP(amt);
        renderHP(); renderTopbar();
      });
      $("#btnTemp").addEventListener("click", ()=>{
        const amt = parseInt($("#hpAmt").value, 10) || 0;
        setTempHP(amt);
        renderHP(); renderTopbar();
      });

      // rest
      $("#shortRestOpenBtn").addEventListener("click", openShortRest);
      $("#shortRestClose").addEventListener("click", ()=> $("#shortRestDialog").close());
      $("#shortRestCancel").addEventListener("click", ()=> $("#shortRestDialog").close());
      $("#rollHdBtn").addEventListener("click", rollHitDice);
      $("#completeShortRestBtn").addEventListener("click", completeShortRest);
      $("#longRestBtnTop").addEventListener("click", applyLongRest);

      // tabs
      document.querySelectorAll(".tab").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          setActiveTab(btn.dataset.tab);
        });
      });

      // combat subtabs
      document.querySelectorAll(".subtab").forEach(btn=>{
        btn.addEventListener("click", ()=> setCombatSubtab(btn.dataset.subtab));
      });

      // progress toggle (milestone/XP)
      $("#btnModeMilestone").addEventListener("click", ()=>{
        state.xpMode = "milestone";
        $("#btnModeMilestone").setAttribute("aria-pressed","true");
        $("#btnModeXP").setAttribute("aria-pressed","false");
        $("#progressValue").textContent = "Milestone";
        $("#xpBox").style.display = "none";
      });
      $("#btnModeXP").addEventListener("click", ()=>{
        state.xpMode = "xp";
        $("#btnModeMilestone").setAttribute("aria-pressed","false");
        $("#btnModeXP").setAttribute("aria-pressed","true");
        $("#progressValue").textContent = "XP";
        $("#xpBox").style.display = "block";
        renderXPBox();
      });

      // XP actions
      $("#xpCurrent").addEventListener("change", ()=>{
        state.xp = Math.max(0, parseInt($("#xpCurrent").value,10) || 0);
        renderXPBox();
      });
      $("#xpAddBtn").addEventListener("click", ()=>{
        const add = Math.max(0, parseInt($("#xpAddAmt").value,10) || 0);
        state.xp = Math.max(0, (state.xp|0) + add);
        $("#xpAddAmt").value = 0;
        renderXPBox();
      });

      // settings
      $("#settingsFab").addEventListener("click", openSettings);
      $("#settingsClose").addEventListener("click", ()=> $("#settingsDialog").close());
      $("#resetTheme").addEventListener("click", ()=>{
        state.settings.theme = "midnight";
        state.settings.inspGlowEnabled = true;
        state.settings.wide = false;
        applyTheme(state.settings.theme);
        $("#glowToggle").checked = true;
        $("#wideToggle").checked = false;
        applyInspirationGlow();
        applyWide();
        saveSettings();
      });
      $("#saveTheme").addEventListener("click", ()=>{
        saveSettings();
        $("#settingsDialog").close();
      });
      document.querySelectorAll('input[name="theme"]').forEach(r=>{
        r.addEventListener("change", ()=> applyTheme(r.value));
      });
      $("#glowToggle").addEventListener("change", ()=>{
        state.settings.inspGlowEnabled = $("#glowToggle").checked;
        applyInspirationGlow();
        saveSettings();
      });
      $("#wideToggle").addEventListener("change", ()=>{
        state.settings.wide = $("#wideToggle").checked;
        applyWide();
        saveSettings();
      });

      // lock
      $("#lockFab").addEventListener("click", ()=>{
        applyEditMode(!state.settings.editUnlocked);
      });

      // edit-only: add skill/ability/attunement
      $("#addSkillBtn").addEventListener("click", openAddSkill);
      $("#addSkillClose").addEventListener("click", ()=> $("#addSkillDialog").close());
      $("#addSkillCancel").addEventListener("click", ()=> $("#addSkillDialog").close());
      $("#addSkillConfirm").addEventListener("click", addSkillConfirm);

      $("#addAbilityBtn").addEventListener("click", openAddAbility);
      $("#addAbilityClose").addEventListener("click", ()=> $("#addAbilityDialog").close());
      $("#addAbilityCancel").addEventListener("click", ()=> $("#addAbilityDialog").close());
      $("#addAbilityConfirm").addEventListener("click", addAbilityConfirm);

      $("#addAttuneBtn").addEventListener("click", addAttunementSlot);

      // portrait dialog
      $("#portraitClose").addEventListener("click", ()=> $("#portraitDialog").close());
      $("#portraitDone").addEventListener("click", ()=> $("#portraitDialog").close());
      $("#portraitApplyUrl").addEventListener("click", applyPortraitUrl);
      $("#portraitReset").addEventListener("click", resetPortraitCrop);
      $("#pz").addEventListener("input", applyPortraitControls);
      $("#portraitPreview").addEventListener("pointerdown", startPortraitDrag);
      $("#portraitPreview").addEventListener("pointermove", movePortraitDrag);
      $("#portraitPreview").addEventListener("pointerup", endPortraitDrag);
      $("#portraitPreview").addEventListener("pointercancel", endPortraitDrag);

      // Editable blur commits to state
      document.addEventListener("focusout", (e)=>{
        const t = e.target;
        if (!state.settings.editUnlocked) return;
        if (t && t.classList && t.classList.contains("editable")){
          syncEditableToState();
        }
      });
      document.addEventListener("keydown", (e)=>{
        if (!state.settings.editUnlocked) return;
        const t = e.target;
        if (!(t instanceof HTMLElement)) return;
        if (!t.classList.contains("editable")) return;
        if (e.key === "Enter"){
          e.preventDefault();
          t.blur();
        }
      });

      // initial
      loadSettings();

      renderTopbar();
      renderHP();
      renderMain();
      renderAbilities();
      renderCombat();
      renderSpells();
      renderInventory();
      renderNotes();

      // default combat subtab
      setCombatSubtab("actions");
      // default xp mode view
      $("#xpBox").style.display = "none";
      $("#progressValue").textContent = "Milestone";
    }

    init();
  </script>
</body>
</html>
