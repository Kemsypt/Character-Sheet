<!doctype html>
<html lang="en" data-theme="midnight">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>D2&D 5e Character Sheet â€” Template</title>

  <style>
    :root{
      --page-max: 1200px;

      --bg0:#070A14;
      --bg1:#0B1020;

      --surface: rgba(255,255,255,0.06);
      --surface2: rgba(255,255,255,0.10);
      --line: rgba(255,255,255,0.14);

      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --faint: rgba(255,255,255,0.56);

      --green:#7CF59C;
      --blue:#5DB2FF;
      --red:#FB7185;

      --accent:#d8c08a;
      --shadow: 0 18px 60px rgba(0,0,0,0.55);

      --radius: 18px;
      --radius-sm: 14px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    html[data-theme="parchment"]{
      --bg0:#FBF6E9;
      --bg1:#F4E9D1;
      --surface: rgba(25,18,8,0.06);
      --surface2: rgba(25,18,8,0.10);
      --line: rgba(25,18,8,0.12);
      --text: rgba(25,18,8,0.92);
      --muted: rgba(25,18,8,0.72);
      --faint: rgba(25,18,8,0.56);
      --accent:#7C3AED;
      --shadow: 0 14px 45px rgba(25,18,8,0.18);
    }

    html[data-theme="forest"]{
      --bg0:#07120D;
      --bg1:#0A1A12;
      --surface: rgba(236,253,245,0.06);
      --surface2: rgba(236,253,245,0.10);
      --line: rgba(236,253,245,0.13);
      --text: rgba(236,253,245,0.93);
      --muted: rgba(236,253,245,0.72);
      --faint: rgba(236,253,245,0.56);
      --accent:#34D399;
      --shadow: 0 16px 55px rgba(0,0,0,0.45);
    }

    body[data-wide="on"]{ --page-max: 100%; }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(900px 520px at 20% 10%, rgba(255,255,255,0.06), transparent 55%),
        radial-gradient(700px 520px at 80% 0%, rgba(125,211,252,0.06), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    /* Inspiration edge glow (optional via settings) */
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 200;
      opacity: 0;
      transition: opacity 220ms ease;
      background:
        linear-gradient(90deg, rgba(216,192,138,0.18), transparent 6%),
        linear-gradient(270deg, rgba(216,192,138,0.18), transparent 6%),
        linear-gradient(0deg, rgba(216,192,138,0.18), transparent 14%);
      animation: inspPulse 4.8s ease-in-out infinite;
    }
    body[data-insp-glow="on"]::before{ opacity: 1; }
    @keyframes inspPulse{
      0%,100%{
        background:
          linear-gradient(90deg, rgba(216,192,138,0.16), transparent 6%),
          linear-gradient(270deg, rgba(216,192,138,0.16), transparent 6%),
          linear-gradient(0deg, rgba(216,192,138,0.16), transparent 14%);
      }
      50%{
        background:
          linear-gradient(90deg, rgba(255,225,162,0.26), transparent 6%),
          linear-gradient(270deg, rgba(255,225,162,0.26), transparent 6%),
          linear-gradient(0deg, rgba(255,219,143,0.24), transparent 14%);
      }
    }

    /* =======================
      TOP BAR
    ======================= */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(18px);
      background: linear-gradient(180deg, rgba(8,10,16,0.92), rgba(8,10,16,0.70));
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }
    .topbar-inner{
      max-width: var(--page-max);
      margin: 0 auto;
      padding: 14px 16px 10px;

      display: grid;
      grid-template-columns: minmax(240px, 320px) 1fr;
      gap: 14px;
      align-items: start;
    }

    .id-block{
      min-width: 0;
      padding: 6px 2px;
      display: grid;
      grid-template-columns: 100px 1fr;
      align-items: center;
      gap: 20px;
    }
    .id-text{
      min-width: 0;
      display:flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }
    .id-text{
      min-width: 0;
      display:flex;
      flex-direction: column;
      align-items: flex-start;
      text-align: left;
    }
    .id-name{
      margin:0;
      font-size: 34px;
      letter-spacing: 0.02em;
      font-weight: 900;
      line-height: 0.98;
      max-width: 100%;
      overflow: hidden;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
    }
    .id-sub{
      margin-top: 8px;
      color: var(--muted);
      font-weight: 650;
      font-size: 14px;
      line-height: 1.2;
      max-width: 100%;
      overflow: hidden;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
    }
    .id-portrait{
      width: 100px;
      height: 150px;
      border-radius: 18px;
      object-fit: cover;
      object-position: var(--px, 50%) var(--py, 30%);
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      box-shadow: var(--shadow);
    }

    .cap{
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.04));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .head-right{
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: stretch;
    }

    .top-row,
    .bottom-row{
      display: flex;
      gap: 10px;
      align-items: stretch;
      flex-wrap: wrap;
      min-width: 0;
    }

    .stat-cap, .chip-cap{ min-height: 74px; }

    .stat-cap{
      width: 72px;
      padding: 10px 10px;
      display:flex;
      flex-direction: column;
      gap: 6px;
      justify-content: center;
      align-items: center;
      flex: 0 0 auto;
    }
    .stat-k{
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--faint);
      font-weight: 900;
    }
    .stat-v{
      font-size: 18px;
      font-weight: 900;
      color: var(--text);
    }

    .chip-cap{
      padding: 10px 12px;
      display:flex;
      flex-direction: column;
      justify-content:center;
      align-items: stretch;
      min-width: 0;
      position: relative;
    }
    .chip-k{
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--faint);
      font-weight: 900;
      white-space: nowrap;
    }
    .chip-row{
      display:flex;
      gap: 8px;
      align-items:center;
      margin-top: 6px;
    }
    .chip-icon{
      width: 18px;
      height: 18px;
      display: inline-block;
    }

    .chip-money{ width: 150px; }
    .chip-status{ width: 150px; }
    .chip-insp{ width: 120px; }
    .chip-rest{ width: 190px; }

    .pill-btn{
      width: 100%;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 999px;
      font-weight: 900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
      justify-content: space-between;
    }
    .pill-btn:hover{
      background: rgba(0,0,0,0.28);
      border-color: rgba(255,255,255,0.22);
    }
    .pill-btn .mono{font-family: var(--mono);}
    .pill-btn[aria-pressed="true"]{
      border-color: rgba(216,192,138,0.45);
      background: linear-gradient(180deg, rgba(216,192,138,0.30), rgba(216,192,138,0.14));
    }
    .pill-btn.compact{
      justify-content: center;
      padding: 9px 10px;
      gap: 8px;
    }
    .chip-money .pill-btn::after,
    .chip-status .pill-btn::after{
      content: none !important;
    }

    /* Rest split buttons */
    .split{
      display:flex;
      gap: 8px;
      margin-top: 6px;
    }
    .split .pill-btn{
      padding: 9px 10px;
      justify-content: center;
      gap: 8px;
    }
    .split .pill-btn.short{ border-color: rgba(93,178,255,0.30); }
    .split .pill-btn.long{ border-color: rgba(124,245,156,0.30); }

    /* Tooltip (Status hover) */
    .tooltip{
      position: absolute;
      left: 12px;
      top: calc(100% + 10px);
      z-index: 90;
      width: max-content;
      max-width: 360px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(10,12,18,0.94);
      box-shadow: var(--shadow);
      color: var(--text);
      opacity: 0;
      transform: translateY(-4px);
      pointer-events: none;
      transition: opacity 120ms ease, transform 120ms ease;
      font-size: 12px;
      line-height: 1.45;
    }
    .tooltip .t-title{
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 950;
      margin-bottom: 6px;
    }
    .chip-status:hover .tooltip,
    .chip-status:focus-within .tooltip{
      opacity: 1;
      transform: translateY(0);
    }

    /* HP capsule */
    .hp-cap{
      flex: 1 1 520px;
      min-width: min(520px, 100%);
      padding: 10px 12px;
      min-height: 60px;

      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 12px;
    }
    .hp-left{
      display:flex;
      align-items: baseline;
      gap: 10px;
      min-width: 140px;
    }
    .hp-text{
      font-weight: 950;
      font-size: 16px;
    }
    .hp-text .num{font-family: var(--mono);}
    .hp-mod{
      color: var(--blue);
      font-weight: 900;
    }

    /* Temp HP scales to fit inside bar (no overflow) */
    .hp-bar{
      position: relative;
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.10);
      min-width: 140px;
      overflow: hidden;
    }
    .hp-green{
      position:absolute;
      left:0; top:0; bottom:0;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(124,245,156,0.95), rgba(124,245,156,0.70));
      z-index: 1;
    }
    .hp-green.is-warning{
      background: linear-gradient(180deg, rgba(251,191,36,0.95), rgba(251,191,36,0.70));
    }
    .hp-green.is-danger{
      background: linear-gradient(180deg, rgba(248,113,113,0.98), rgba(248,113,113,0.75));
    }
    .hp-temp{
      position:absolute;
      top:0; bottom:0;
      left: 0%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(93,178,255,0.95), rgba(93,178,255,0.70));
      box-shadow: 0 0 14px rgba(93,178,255,0.15);
      z-index: 2;
    }

    .hp-controls{
      display:flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
    }
    .amt{
      width: 56px;
      text-align:center;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.20);
      color: var(--text);
      outline: none;
      font-weight: 900;
      font-family: var(--mono);
    }
    .hp-btn{
      height: 36px;
      min-width: 36px;
      padding: 0 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      cursor:pointer;
      font-weight: 950;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .hp-btn:hover{
      border-color: rgba(255,255,255,0.22);
      background: rgba(0,0,0,0.28);
    }
    .hp-btn.temp{ border-color: rgba(93,178,255,0.35); }
    .hp-btn.damage{ border-color: rgba(251,113,133,0.35); }
    .hp-btn.heal{ border-color: rgba(124,245,156,0.35); }

    /* Tabs */
    .tabs{
      max-width: var(--page-max);
      margin: 0 auto;
      padding: 0 16px 14px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }
    .tab{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: rgba(255,255,255,0.78);
      padding: 9px 14px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 13px;
      cursor:pointer;
    }
    .tab:hover{background: rgba(0,0,0,0.28);}
    .tab[aria-selected="true"]{
      background: linear-gradient(180deg, rgba(216,192,138,0.30), rgba(216,192,138,0.16));
      border-color: rgba(216,192,138,0.40);
      color: rgba(255,255,255,0.92);
    }
    .tab-spacer{
      flex: 1 1 auto;
    }

    /* Actions sub-tabs */
    .subtabs{
      margin-top: 10px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }
    .subtab{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.16);
      color: rgba(255,255,255,0.78);
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
    }
    .subtab:hover{background: rgba(0,0,0,0.26);}
    .subtab[aria-selected="true"]{
      background: rgba(216,192,138,0.16);
      border-color: rgba(216,192,138,0.36);
      color: rgba(255,255,255,0.92);
    }

    /* Responsive */
    @media (max-width: 980px){
      .topbar-inner{ grid-template-columns: 1fr; }
      .chip-money, .chip-status, .chip-insp, .chip-rest{ width: auto; flex: 1 1 170px; }
      .hp-cap{ grid-template-columns: 1fr; }
      .hp-left{ min-width: 0; }
      .tooltip{ max-width: calc(100vw - 40px); }
    }

    /* =======================
      CONTENT AREA
    ======================= */
    .wrap{
      max-width: var(--page-max);
      margin: 0 auto;
      padding: 18px 16px 72px;
      position: relative;
      z-index: 2;
    }
    .panel{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-header{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 12px;
      background: rgba(255,255,255,0.06);
    }
    .panel-title{
      margin:0;
      font-size: 12px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 950;
    }
    .panel-body{padding: 14px 16px;}

    table{width:100%; border-collapse: collapse; font-size: 13px;}
    th,td{padding: 10px 10px; border-bottom: 1px solid rgba(255,255,255,0.10); vertical-align: top;}
    th{color: var(--faint); font-weight: 950; text-transform: uppercase; letter-spacing: 0.12em; font-size: 11px;}
    .right{text-align:right}
    .muted{color: var(--muted)}
    .num{font-family: var(--mono);}

    .tag{
      font-size: 11px;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      padding: 4px 8px;
      border-radius: 999px;
      white-space:nowrap;
      font-weight: 850;
    }

    [data-tabpanel]{display:none;}
    [data-tabpanel][data-active="true"]{display:block;}
    [data-subpanel]{display:none;}
    [data-subpanel][data-active="true"]{display:block;}

    /* =======================
      MAIN TAB (Bio + portrait right, aligned to hero top)
    ======================= */
    .main-grid{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap: 12px;
      align-items: start;
    }
    @media (max-width: 980px){
      .main-grid{ grid-template-columns: 1fr; }
    }

    .hero{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
      border-radius: 18px;
      padding: 14px 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .hero-name{
      font-size: 22px;
      font-weight: 950;
      margin: 0;
      letter-spacing: 0.01em;
    }
    .hero-tagline{
      margin: -6px 0 0;
      color: var(--muted);
      font-weight: 800;
      font-size: 13px;
    }
    .chips{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 2px;
    }

    .card{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      border-radius: 16px;
      padding: 12px 12px;
    }
    .card h4{
      margin:0 0 8px;
      font-size: 12px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 950;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }
    .kv{
      display:grid;
      grid-template-columns: 150px 1fr;
      gap: 8px 12px;
      font-size: 13px;
    }
    .kv .k{
      color: var(--faint);
      font-weight: 900;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 11px;
      padding-top: 2px;
    }
    .kv .v{
      color: var(--text);
      font-weight: 750;
      min-width: 0;
    }

    /* Smaller milestone/XP toggle */
    .progress-toggle{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }
    .seg{
      display:flex;
      gap: 6px;
      align-items:center;
      padding: 4px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
    }
    .seg button{
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: 6px 8px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 900;
      font-size: 11px;
      letter-spacing: 0.02em;
    }
    .seg button[aria-pressed="true"]{
      color: var(--text);
      border-color: rgba(216,192,138,0.35);
      background: rgba(216,192,138,0.14);
    }
    .seg button:hover{ color: var(--text); }

    .portrait-frame{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      border-radius: 20px;
      overflow:hidden;
      box-shadow: var(--shadow);
      /* NOT sticky; aligns with hero top */
    }

    /* exact 2:3 ratio frame (600x900) */
    .portrait{
      aspect-ratio: 2 / 3;
      width: 100%;
      height: auto;
      display:block;
      object-fit: cover;
      object-position: var(--px, 50%) var(--py, 30%);
      transform: scale(var(--pz, 1));
      transform-origin: center;
      filter: saturate(1.05) contrast(1.03);
      cursor: pointer;
    }
    .portrait-overlay{
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(60% 45% at 55% 20%, rgba(255,255,255,0.10), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,0.05), rgba(0,0,0,0.35));
      mix-blend-mode: screen;
      opacity: 0.65;
    }
    .portrait-vignette{
      position:absolute;
      inset:0;
      pointer-events:none;
      box-shadow: inset 0 0 80px rgba(0,0,0,0.55);
      opacity: 0.85;
    }
    .portrait-preview{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      border-radius: 16px;
      overflow: hidden;
      aspect-ratio: 2 / 3;
      width: min(260px, 100%);
      margin-top: 10px;
      position: relative;
      cursor: grab;
      user-select: none;
      touch-action: none;
    }
    .portrait-preview.is-dragging{
      cursor: grabbing;
    }
    .portrait-preview img{
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
      object-position: var(--px, 50%) var(--py, 30%);
      transform: scale(var(--pz, 1));
      transform-origin: center;
      filter: saturate(1.05) contrast(1.03);
      pointer-events: none;
    }
    .portrait-preview-grid{
      position: absolute;
      inset: 0;
      pointer-events: none;
      background:
        linear-gradient(90deg, rgba(255,255,255,0.08) 1px, transparent 1px) 0 0 / 33.33% 100%,
        linear-gradient(180deg, rgba(255,255,255,0.08) 1px, transparent 1px) 0 0 / 100% 33.33%;
      opacity: 0.35;
    }

    /* Main "Quick Combat" row under hero */
    .quickstats{
      display:grid;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap: 10px;
      margin-top: 8px;
    }
    @media (max-width: 980px){
      .quickstats{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    .qs{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.14);
      border-radius: 16px;
      padding: 10px 10px;
      display:flex;
      flex-direction: column;
      gap: 6px;
      align-items:center;
      justify-content:center;
      min-height: 70px;
    }
    .qs .k{
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--faint);
      font-weight: 950;
    }
    .qs .v{
      font-size: 16px;
      font-weight: 950;
      font-family: var(--mono);
    }

    /* XP box (shown when XP mode) */
    .xpbox{
      margin-top: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.14);
      border-radius: 16px;
      padding: 10px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .xpgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 700px){
      .xpgrid{ grid-template-columns: 1fr; }
    }
    .field{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      border-radius: 14px;
      padding: 10px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }
    .field label{
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--faint);
      font-weight: 950;
    }
    .field .val{
      font-family: var(--mono);
      font-weight: 950;
      color: var(--text);
      white-space: nowrap;
    }
    .field input{
      width: 130px;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.20);
      color: var(--text);
      outline: none;
      font-weight: 900;
      font-family: var(--mono);
      text-align:right;
    }

    /* =======================
      ABILITIES PAGE (layout)
    ======================= */
    .abil-wrap{ display:flex; flex-direction: column; gap: 12px; }

    .abil-grid{
      display:grid;
      grid-template-columns: repeat(6, minmax(0,1fr));
      gap: 10px;
    }
    @media (max-width: 1100px){
      .abil-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }
    @media (max-width: 700px){
      .abil-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }

    .abil-card{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      border-radius: 16px;
      padding: 10px;
      display:flex;
      flex-direction: column;
      gap: 8px;
      min-height: 140px;
    }
    .abil-head{
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--accent);
      font-weight: 950;
      margin-top: 2px;
    }
    .abil-box{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      border-radius: 14px;
      padding: 10px 10px;
      display:flex;
      flex-direction: column;
      align-items:center;
      justify-content:center;
      gap: 6px;
    }
    .abil-score{ font-size: 20px; font-weight: 950; font-family: var(--mono); }
    .abil-subk{
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--faint);
      font-weight: 950;
    }
    .abil-subv{ font-size: 13px; font-weight: 950; font-family: var(--mono); }
    .save-pill{
      margin-top: 6px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      padding: 7px 10px;
      border-radius: 999px;
      font-family: var(--mono);
      font-weight: 950;
      font-size: 12px;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      justify-content: center;
    }
    .save-pill.pro{
      border-color: rgba(216,192,138,0.40);
      background: rgba(216,192,138,0.12);
    }

    .skills-head{
      display:flex;
      align-items:flex-end;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .legend{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .dot{
      width: 10px; height: 10px; border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.30);
      display:inline-block;
      transform: translateY(1px);
    }
    .dot.fill{ background: rgba(255,255,255,0.18); border-color: rgba(255,255,255,0.40); }
    .dot.gold{ background: rgba(216,192,138,0.18); border-color: rgba(216,192,138,0.50); }

    .skills-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 980px){
      .skills-grid{ grid-template-columns: 1fr; }
    }
    .skill-col{ display:flex; flex-direction: column; gap: 10px; }
    .skill-row{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
    }
    .skill-row .dot-btn{
      border: none;
      background: transparent;
      padding: 0;
      cursor: pointer;
    }
    body[data-edit="on"] .skill-row .dot-btn:focus-visible{
      outline: 2px solid rgba(216,192,138,0.6);
      outline-offset: 2px;
    }
    .skill-remove{
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 11px;
      cursor: pointer;
    }
    .skill-remove:hover{ background: rgba(216,192,138,0.14); }

    .save-pill.is-editable{
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease;
    }
    body[data-edit="on"] .save-pill.is-editable:hover{
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.35);
    }
    .ability-remove{
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 11px;
      cursor: pointer;
      align-self: flex-end;
    }
    .skill-left{ display:flex; align-items:center; gap: 10px; min-width: 0; }
    .skill-name{
      font-weight: 900;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .skill-mid{
      font-size: 12px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--accent);
      font-weight: 950;
      margin-left: 6px;
    }
    .skill-right{ font-family: var(--mono); font-weight: 950; }

    /* =======================
      BUTTONS / DIALOGS
    ======================= */
    dialog{
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(10,12,18,0.92);
      color: var(--text);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 0;
      width: min(720px, calc(100vw - 28px));
      z-index: 120;
    }
    #coinAdjustDialog{
      width: 200px;
    }
    dialog::backdrop{background: rgba(0,0,0,0.62); backdrop-filter: blur(6px);}
    .dlg-head{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: rgba(255,255,255,0.06);
    }
    .dlg-title{
      margin:0;
      font-size: 12px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 950;
    }
    .dlg-body{padding: 14px 16px;}
    .icon-btn{
      width: 36px; height: 36px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      cursor:pointer;
      font-weight: 900;
    }
    .status-layout{
      display:grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 0.9fr);
      gap: 12px;
    }
    @media (max-width: 900px){
      .status-layout{ grid-template-columns: 1fr; }
    }
    .cond-list{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .cond-btn{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 850;
      text-align:left;
    }
    .cond-btn:hover{ border-color: rgba(255,255,255,0.2); background: rgba(0,0,0,0.28); }
    .status-current{
      display:flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
    }
    .status-item{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.2);
      padding: 10px 12px;
      border-radius: 12px;
      display:flex;
      flex-direction: column;
      gap: 4px;
    }
    .status-item .name{
      font-weight: 900;
    }
    .status-item .meta{
      font-size: 12px;
      color: var(--muted);
    }

    .btn{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: var(--muted);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      cursor:pointer;
      font-weight: 900;
    }
    .btn:hover{background: rgba(0,0,0,0.28); color: var(--text);}
    .btn.primary{
      border-color: rgba(216,192,138,0.40);
      background: rgba(216,192,138,0.18);
      color: var(--text);
    }
    .btn.danger{
      border-color: rgba(251,113,133,0.40);
      background: rgba(251,113,133,0.10);
      color: var(--text);
    }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content: space-between;
    }
    .small{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }

    .checkgrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px 12px;
      margin-top: 8px;
    }
    @media (max-width: 520px){
      .checkgrid{ grid-template-columns: 1fr; }
    }
    .check{
      display:flex;
      gap: 10px;
      align-items:center;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      cursor:pointer;
      user-select:none;
    }
    .check:hover{ border-color: rgba(255,255,255,0.20); background: rgba(0,0,0,0.25); }
    .check input{ accent-color: var(--accent); }
    .select{
      width: 100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      font-weight: 850;
      outline: none;
    }

    /* Settings + Lock FABs */
    .fab-wrap{
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 140;
      display:flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end;
    }
    .fab{
      width: 52px;
      height: 52px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.22);
      box-shadow: var(--shadow);
      color: var(--text);
      cursor:pointer;
      display:grid;
      place-items:center;
      transition: transform 120ms ease, border-color 120ms ease, background 120ms ease;
    }
    .fab:hover{transform: translateY(-2px);}
    .fab[aria-pressed="true"]{
      border-color: rgba(216,192,138,0.45);
      background: rgba(216,192,138,0.14);
    }

    .dice-panel{
      position: fixed;
      right: 90px;
      bottom: 90px;
      width: 360px;
      max-width: calc(100vw - 40px);
      min-height: 420px;
      max-height: calc(100vh - 140px);
      background: rgba(10,12,18,0.96);
      border: 1px solid rgba(255,255,255,0.16);
      border-radius: 16px;
      box-shadow: var(--shadow);
      z-index: 130;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }
    .dice-panel[data-open="true"]{ display:flex; }
    .dice-head{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      cursor: grab;
      background: rgba(255,255,255,0.06);
    }
    .dice-head:active{ cursor: grabbing; }
    .dice-body{
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap: 12px;
      flex: 1 1 auto;
      overflow: auto;
    }
    .dice-row{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
    }
    .dice-set-grid{
      display:flex;
      flex-direction: column;
      gap: 8px;
    }
    .dice-set{
      display:grid;
      grid-template-columns: auto auto minmax(0, 1fr) auto minmax(0, 1fr);
      gap: 8px;
      align-items:center;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.2);
    }
    .dice-set-custom{
      grid-template-columns: auto auto minmax(0, 1fr) auto minmax(0, 1fr) auto minmax(0, 1fr);
    }
    .dice-label{
      font-weight: 900;
      color: var(--text);
      font-size: 13px;
    }
    .dice-actions{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items:center;
    }
    .dice-actions .btn{
      flex: 1 1 110px;
      justify-content: center;
    }
    .dice-results{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 10px;
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    .dice-summary.is-max{ color: var(--green); }
    .dice-summary.is-min{ color: var(--red); }
    .dice-detail-row{
      display:flex;
      flex-wrap: wrap;
      gap: 6px 8px;
      align-items:center;
    }
    .dice-detail-label{
      font-weight: 900;
      color: var(--muted);
    }
    .dice-detail-rolls{
      display:flex;
      flex-wrap: wrap;
      gap: 6px;
      color: var(--text);
    }
    .dice-detail-total{
      font-weight: 900;
      color: var(--text);
    }
    .dice-roll{
      font-weight: 900;
      color: var(--text);
    }
    .dice-roll.is-max{ color: var(--green); }
    .dice-roll.is-min{ color: var(--red); }
    .dice-roll.is-unused{ opacity: 0.45; text-decoration: line-through; }
    .dice-roll.is-chosen{ text-shadow: 0 0 10px rgba(255,255,255,0.18); }
    .dice-roll-group{
      display:inline-flex;
      align-items:center;
      gap: 4px;
      color: var(--muted);
    }
    .dice-history{
      max-height: 200px;
      overflow: auto;
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    .dice-history-item{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      flex-direction: column;
      gap: 4px;
    }
    .dice-history-summary{
      font-weight: 900;
      color: var(--text);
    }
    .dice-history-summary.is-max{ color: var(--green); }
    .dice-history-summary.is-min{ color: var(--red); }
    .dice-history-rolls{
      display:flex;
      flex-direction: column;
      gap: 4px;
    }

    .dice-roll-flash{
      position: fixed;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events: none;
      z-index: 210;
      opacity: 0;
    }
    .dice-roll-flash[data-active="true"]{
      animation: diceFlash 2.6s ease-out;
    }
    .dice-roll-flash-inner{
      font-size: clamp(32px, 5vw, 64px);
      font-weight: 950;
      padding: 14px 26px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.4);
      background: rgba(5,8,14,0.86);
      color: var(--text);
      box-shadow: var(--shadow);
    }
    .dice-roll-flash-inner.is-max{ color: var(--green); border-color: rgba(124,245,156,0.6); }
    .dice-roll-flash-inner.is-min{ color: var(--red); border-color: rgba(251,113,133,0.6); }

    .dice-roll-animation{
      position: fixed;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      z-index: 205;
      opacity: 0;
    }
    .dice-roll-animation[data-active="true"]{
      opacity: 1;
    }
    .dice-roll-animation .dice-cube{
      font-size: 36px;
      margin: 0 6px;
      animation: diceTumble 0.9s ease-in-out infinite;
    }
    .dice-roll-animation .dice-cube:nth-child(2){ animation-delay: 0.1s; }
    .dice-roll-animation .dice-cube:nth-child(3){ animation-delay: 0.2s; }

    @keyframes diceFlash{
      0%{ opacity: 0; transform: scale(0.85); }
      12%{ opacity: 1; transform: scale(1); }
      80%{ opacity: 1; transform: scale(1.02); }
      100%{ opacity: 0; transform: scale(1.08); }
    }
    @keyframes diceTumble{
      0%{ transform: translateY(0) rotate(0deg); }
      35%{ transform: translateY(-12px) rotate(140deg); }
      70%{ transform: translateY(6px) rotate(280deg); }
      100%{ transform: translateY(0) rotate(360deg); }
    }

    .radio-row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .radio{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      cursor:pointer;
      color: var(--muted);
      user-select:none;
      font-weight: 850;
    }
    .radio input{accent-color: var(--accent);}
    .radio:hover{color: var(--text); border-color: rgba(255,255,255,0.22);}

    .toggle{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
      margin-top: 12px;
    }
    .toggle strong{font-weight: 950;}
    .switch{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      cursor:pointer;
      user-select:none;
      color: var(--muted);
      font-weight: 850;
    }
    .switch input{accent-color: var(--accent); transform: scale(1.1);}

    /* =======================
      EDIT MODE (lock toggle)
    ======================= */
    .editable{
      outline: none;
      border-radius: 8px;
      padding: 2px 4px;
      margin: -2px -4px;
      transition: background 120ms ease, box-shadow 120ms ease;
    }
    body[data-edit="on"] .editable{ cursor: text; }
    body[data-edit="on"] .editable:hover{ background: rgba(216,192,138,0.10); }
    body[data-edit="on"] .editable:focus{
      background: rgba(216,192,138,0.12);
      box-shadow: 0 0 0 2px rgba(216,192,138,0.20);
    }

    /* Small icon button for "add custom" */
    .mini{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      cursor:pointer;
      font-weight: 950;
      display:grid;
      place-items:center;
    }
    .mini:hover{ background: rgba(0,0,0,0.28); border-color: rgba(255,255,255,0.22); }

    /* Coin purse styling */
    .coin-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 640px){
      .coin-grid{ grid-template-columns: 1fr; }
    }
    .coin-card{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      cursor: pointer;
    }
    .coin-card:hover{
      border-color: rgba(216,192,138,0.35);
      background: rgba(216,192,138,0.10);
    }
    .coin-left{
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .coin-ic{
      width: 36px; height: 36px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      overflow: hidden;
    }
    .coin-ic img{
      width: 26px;
      height: 26px;
      object-fit: contain;
      display: block;
    }
    .coin-meta{
      display:flex;
      flex-direction: column;
      gap: 2px;
    }
    .coin-name{
      font-weight: 950;
    }
    .coin-val{
      font-size: 12px;
      color: var(--muted);
      font-family: var(--mono);
    }
    .coin-amt{
      font-family: var(--mono);
      font-weight: 950;
      font-size: 16px;
    }
    .coin-card.is-standard .coin-ic{
      border: none;
      background: transparent;
      box-shadow: none;
    }

    /* Inventory attunement */
    .attune{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 12px;
    }
    .attune-row{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
      border-radius: 14px;
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap: 8px;
      cursor: pointer;
    }
    .attune-row:hover{
      border-color: rgba(216,192,138,0.45);
      background: rgba(216,192,138,0.10);
    }
    .attune-row strong{ font-weight: 950; }
    .attune-slot{
      color: var(--muted);
      font-weight: 850;
    }
    .attune-notes{
      font-size: 12px;
      color: var(--muted);
    }

    .note-card{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }
    .note-title{
      font-weight: 950;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 12px;
    }
    .note-body{
      min-height: 48px;
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 8px 10px;
    }
  </style>
</head>

<body data-edit="off" data-wide="off">
  <header class="topbar">
    <div class="topbar-inner">
      <!-- Name block -->
      <div class="id-block">
        <img class="id-portrait" id="tb_portrait" alt="Character portrait thumbnail" />
        <div class="id-text">
          <h1 class="id-name" id="tb_name">Elaria Thornbloom</h1>
          <div class="id-sub" id="tb_sub">Wood Elf â€¢ Druid 10</div>
        </div>
      </div>

      <!-- Right side -->
      <div class="head-right">
        <!-- TOP ROW: AC, INIT, SPD, PROF, MONEY, STATUS, INSP -->
        <div class="top-row" aria-label="Top stats row">
          <div class="cap stat-cap" title="Armor Class">
            <div class="stat-k">AC</div>
            <div class="stat-v" id="tb_ac">16</div>
          </div>

          <div class="cap stat-cap" title="Initiative">
            <div class="stat-k">INIT</div>
            <div class="stat-v" id="tb_init">+3</div>
          </div>

          <div class="cap stat-cap" title="Speed">
            <div class="stat-k">SPD</div>
            <div class="stat-v" id="tb_speed">35</div>
          </div>

          <div class="cap stat-cap" title="Proficiency Bonus">
            <div class="stat-k">PROF</div>
            <div class="stat-v" id="tb_pb">+4</div>
          </div>

          <div class="cap chip-cap chip-money" title="Gold">
            <div class="chip-k">GOLD</div>
            <div class="chip-row">
              <button class="pill-btn" id="moneyBtn" type="button" aria-haspopup="dialog" title="Open coin purse">
                <img class="chip-icon" id="tb_money_icon" src="https://i.imgur.com/bbdjD7q.png" alt="Gold" />
                <span class="mono" id="tb_money_total">â€” gp</span>
              </button>
            </div>
          </div>

          <div class="cap chip-cap chip-status" title="Status / Conditions">
            <div class="chip-k">STATUS</div>
            <div class="chip-row">
              <button class="pill-btn" id="statusBtn" type="button" aria-haspopup="dialog" title="Select conditions">
                <span id="tb_status">None</span>
              </button>
            </div>

            <!-- hover tooltip -->
            <div class="tooltip" id="statusTooltip" aria-hidden="true">
              <div class="t-title">Active Status</div>
              <div id="statusTooltipText" class="small" style="color: var(--text);"></div>
            </div>
          </div>

          <div class="cap chip-cap chip-insp" title="Inspiration">
            <div class="chip-k">INSP</div>
            <div class="chip-row">
              <button class="pill-btn compact" id="inspBtn" type="button" aria-pressed="false" title="Toggle inspiration">
                <span>âœ¦</span>
                <span id="tb_insp">No</span>
              </button>
            </div>
          </div>
        </div>

        <!-- SECOND ROW: HP + Rest -->
        <div class="bottom-row" aria-label="Health row">
          <div class="cap hp-cap" title="Health">
            <div class="hp-left">
              <div class="hp-text">
                <span class="num" id="tb_hp_cur">73</span>/<span class="num" id="tb_hp_max">73</span>
              </div>
              <div class="hp-mod" id="tb_temp_label">+0</div>
            </div>

            <div class="hp-bar" aria-label="Health bar">
              <div class="hp-green" id="hpGreen"></div>
              <div class="hp-temp" id="hpTemp"></div>
            </div>

            <div class="hp-controls" aria-label="Health controls">
              <input class="amt" id="hpAmt" type="number" value="12" min="0" inputmode="numeric" />
              <button class="hp-btn damage" id="btnDamage" type="button" title="Damage (uses temp first)">âˆ’</button>
              <button class="hp-btn heal" id="btnHeal" type="button" title="Heal (up to max)">+</button>
              <button class="hp-btn temp" id="btnTemp" type="button" title="Set Temp HP (takes the higher)">â›¨</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <nav class="tabs" role="tablist" aria-label="Character sheet tabs">
      <button class="tab" role="tab" aria-selected="true"  aria-controls="tab-main"      id="tabbtn-main"      data-tab="main">Main</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="tab-abilities" id="tabbtn-abilities" data-tab="abilities">Abilities</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="tab-actions"   id="tabbtn-actions"   data-tab="actions">Actions</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="tab-spells"    id="tabbtn-spells"    data-tab="spells">Spell Book</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="tab-inventory" id="tabbtn-inventory" data-tab="inventory">Inventory</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="tab-notes"     id="tabbtn-notes"     data-tab="notes">Notes</button>
      <span class="tab-spacer" aria-hidden="true"></span>
      <button class="tab rest-tab" id="restTabBtn" type="button" aria-haspopup="dialog" aria-label="Open rest options">ðŸŒ™ Rest</button>
    </nav>
  </header>

  <main class="wrap">
    <!-- MAIN -->
    <section class="panel" id="tab-main" data-tabpanel data-active="true" role="tabpanel" aria-labelledby="tabbtn-main">
      <div class="panel-header">
        <h2 class="panel-title">Character Bio</h2>
        <div class="chips" id="mainChips"></div>
      </div>

      <div class="panel-body">
        <div class="main-grid">
          <!-- LEFT -->
          <div style="display:flex; flex-direction:column; gap:12px;">
            <div class="hero" id="heroBlock">
              <h3 class="hero-name editable" id="mainName">Elaria Thornbloom</h3>
              <div class="hero-tagline editable" id="mainTagline">Of the order of History</div>
              <div class="chips" id="mainSummaryLine"></div>

              <!-- NEW: Quick combat block under hero -->
              <div class="quickstats" aria-label="Main quick stats">
                <div class="qs">
                  <div class="k">HP</div>
                  <div class="v">
                    <span class="num editable" id="m_hp_cur">73</span>/<span class="num editable" id="m_hp_max">73</span>
                    <span class="muted" id="m_hp_temp"></span>
                  </div>
                </div>
                <div class="qs"><div class="k">AC</div><div class="v"><span class="num editable" id="m_ac">16</span></div></div>
                <div class="qs"><div class="k">INIT</div><div class="v"><span class="num editable" id="m_init">+3</span></div></div>
                <div class="qs"><div class="k">PROF</div><div class="v"><span class="num editable" id="m_prof">+4</span></div></div>
                <div class="qs"><div class="k">SPD</div><div class="v"><span class="num editable" id="m_spd">35</span></div></div>
              </div>
            </div>

            <div class="card" id="xpCard" style="display:none;">
              <h4>Progress</h4>
              <div class="xpbox" id="xpBox">
                <div class="xpgrid">
                  <div class="field">
                    <label>Current XP</label>
                    <div style="display:flex; gap:8px; align-items:center;">
                      <input id="xpCurrent" type="number" min="0" value="0" inputmode="numeric" />
                      <span class="val">xp</span>
                    </div>
                  </div>
                  <div class="field">
                    <label>Next Level</label>
                    <div class="val"><span id="xpNext">300</span> xp</div>
                  </div>
                  <div class="field">
                    <label>Level</label>
                    <div class="val">Lv <span id="xpLevel">1</span></div>
                  </div>
                  <div class="field">
                    <label>To Next</label>
                    <div class="val"><span id="xpToNext">300</span> xp</div>
                  </div>
                </div>

                <div class="row">
                  <div class="small">Add XP updates thresholds. Use â€œLevel Upâ€ when ready.</div>
                  <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
                    <input class="amt" id="xpAddAmt" type="number" min="0" value="0" inputmode="numeric" style="width:86px;" />
                    <button class="btn primary" id="xpAddBtn" type="button">Add XP</button>
                    <button class="btn" id="xpLevelUpBtn" type="button" style="display:none;">Level Up</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <h4>Identity</h4>
              <div class="kv">
                <div class="k">Player</div><div class="v editable" id="mainPlayer">Lukas Schulze</div>
                <div class="k">Pronouns</div><div class="v editable" id="mainPronouns">she / her</div>
                <div class="k">Campaign / Party</div><div class="v editable" id="mainCampaign">The Verdant Accord</div>
              </div>
            </div>

            <div class="card">
              <h4>Build</h4>
              <div class="kv">
                <div class="k">Class & Level</div><div class="v editable" id="mainClasses">Druid 10</div>
                <div class="k">Total Level</div><div class="v"><span class="num editable" id="mainTotalLevel">10</span></div>
                <div class="k">Race / Species</div><div class="v editable" id="mainRace">Wood Elf</div>
                <div class="k">Background</div><div class="v editable" id="mainBackground">Sage</div>
                <div class="k">Alignment</div><div class="v editable" id="mainAlignment">Neutral Good</div>
              </div>
            </div>

            <div class="card">
              <h4>Defense</h4>
              <div class="kv">
                <div class="k">Hit Dice</div><div class="v editable" id="defHitDice">Druid d8 Ã—10</div>
                <div class="k">Healing Surges</div><div class="v editable" id="defSurges">â€”</div>
                <div class="k">Death Saves</div><div class="v editable" id="defDeathSaves">0 success / 0 fail</div>
              </div>

              <div style="height:10px"></div>

              <div class="kv">
                <div class="k">AC: Armor</div><div class="v editable" id="defArmor">Leather (11)</div>
                <div class="k">AC: Shield</div><div class="v editable" id="defShield">None</div>
                <div class="k">AC: Dex Cap</div><div class="v editable" id="defDexCap">+3</div>
                <div class="k">AC: Magic</div><div class="v editable" id="defMagic">+0</div>
                <div class="k">AC: Other</div><div class="v editable" id="defOther">â€”</div>
              </div>

              <div style="height:10px"></div>

              <div class="kv">
                <div class="k">Resistances</div><div class="v editable" id="defResist">â€”</div>
                <div class="k">Immunities</div><div class="v editable" id="defImmune">â€”</div>
                <div class="k">Vulnerabilities</div><div class="v editable" id="defVuln">â€”</div>
                <div class="k">Condition Immunities</div><div class="v editable" id="defCondImmune">â€”</div>
                <div class="k">Senses</div><div class="v editable" id="defSenses">Darkvision 60 ft.</div>
                <div class="k">Passive Scores</div><div class="v editable" id="defPassive">Perception 14 â€¢ Insight 13 â€¢ Investigation 12</div>
              </div>
            </div>

            <div class="card">
              <h4>Roleplay</h4>
              <div class="kv">
                <div class="k">Traits</div><div class="v editable" id="mainTraits">Curious, patient, speaks softlyâ€”until the wild answers back.</div>
                <div class="k">Ideals</div><div class="v editable" id="mainIdeals">Knowledge should protect life, not dominate it.</div>
                <div class="k">Bonds</div><div class="v editable" id="mainBonds">A living grove-archive entrusted to her care.</div>
                <div class="k">Flaws</div><div class="v editable" id="mainFlaws">Will take dangerous risks to preserve a rare creature or secret.</div>
              </div>
            </div>

            <div class="card">
              <h4>Appearance</h4>
              <div class="kv">
                <div class="k">Description</div><div class="v editable" id="mainDesc">Pale-haired wanderer draped in living greens; carries a staff carved like roots.</div>
                <div class="k">Age</div><div class="v editable" id="mainAge">148</div>
                <div class="k">Weight / Size</div><div class="v editable" id="mainSize">Lean â€¢ Medium</div>
                <div class="k">Hair / Eyes / Skin</div><div class="v editable" id="mainHES">White hair â€¢ amber eyes â€¢ sun-kissed skin</div>
                <div class="k">Marks</div><div class="v editable" id="mainMarks">Vine-like tattoos along the left arm; scar at the collarbone.</div>
              </div>
            </div>
          </div>

          <!-- RIGHT PORTRAIT (600x900), aligned with hero top -->
          <div class="portrait-frame" aria-label="Character portrait">
            <div style="position:relative;">
              <img class="portrait" id="portraitImg" alt="Character portrait" />
              <div class="portrait-overlay"></div>
              <div class="portrait-vignette"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ABILITIES -->
    <section class="panel" id="tab-abilities" data-tabpanel data-active="false" role="tabpanel" aria-labelledby="tabbtn-abilities">
      <div class="panel-header">
        <h2 class="panel-title">Ability Scores</h2>
        <button class="mini" id="addAbilityBtn" type="button" title="Add custom ability (edit mode only)" style="display:none;">ï¼‹</button>
      </div>
      <div class="panel-body">
        <div class="abil-wrap">
          <div class="abil-grid" id="abilGrid"></div>

          <div class="panel" style="box-shadow:none;">
            <div class="panel-header skills-head">
              <h3 class="panel-title">Skills</h3>
              <div style="display:flex; gap:10px; align-items:center;">
                <div class="legend" aria-label="Proficiency legend">
                  <span>Proficiency:</span>
                  <span><span class="dot"></span> none</span>
                  <span><span class="dot fill"></span> half</span>
                  <span><span class="dot gold"></span> proficiency</span>
                  <span><span class="dot gold" style="box-shadow:0 0 0 2px rgba(216,192,138,0.22) inset;"></span> expertise</span>
                </div>
                <button class="mini" id="addSkillBtn" type="button" title="Add custom skill (edit mode only)" style="display:none;">ï¼‹</button>
              </div>
            </div>
            <div class="panel-body" style="padding-top:12px;">
              <div class="skills-grid" id="skillsGrid"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ACTIONS (with subtabs) -->
    <section class="panel" id="tab-actions" data-tabpanel data-active="false" role="tabpanel" aria-labelledby="tabbtn-actions">
      <div class="panel-header">
        <h2 class="panel-title">Combat</h2>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <span class="tag">Spell DC: <span class="num editable" id="sp_dc">16</span></span>
          <span class="tag">Spell Atk: <span class="num editable" id="sp_atk">+8</span></span>
        </div>
      </div>

      <div class="panel-body">
        <div class="subtabs" role="tablist" aria-label="Combat sub-tabs">
          <button class="subtab" role="tab" aria-selected="true"  data-subtab="actions">Actions</button>
          <button class="subtab" role="tab" aria-selected="false" data-subtab="bonus">Bonus Actions</button>
          <button class="subtab" role="tab" aria-selected="false" data-subtab="reactions">Reactions</button>
          <button class="subtab" role="tab" aria-selected="false" data-subtab="free">Free Actions</button>
        </div>

        <div style="height:10px"></div>

        <div data-subpanel id="sub-actions" data-active="true">
          <div class="panel" style="box-shadow:none;">
            <div class="panel-header"><h3 class="panel-title">Actions</h3></div>
            <div class="panel-body" style="padding:0;">
              <table>
                <thead><tr><th>Action</th><th class="right">To Hit / DC</th><th>Damage / Effect</th><th>Notes</th></tr></thead>
                <tbody id="c_attacks"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div data-subpanel id="sub-bonus" data-active="false">
          <div class="panel" style="box-shadow:none;">
            <div class="panel-header"><h3 class="panel-title">Bonus Actions</h3></div>
            <div class="panel-body">
              <ul style="margin:0; padding-left:18px;" id="c_bonus"></ul>
            </div>
          </div>
        </div>

        <div data-subpanel id="sub-reactions" data-active="false">
          <div class="panel" style="box-shadow:none;">
            <div class="panel-header"><h3 class="panel-title">Reactions</h3></div>
            <div class="panel-body">
              <ul style="margin:0; padding-left:18px;" id="c_reactions"></ul>
            </div>
          </div>
        </div>

        <div data-subpanel id="sub-free" data-active="false">
          <div class="panel" style="box-shadow:none;">
            <div class="panel-header"><h3 class="panel-title">Free Actions</h3></div>
            <div class="panel-body">
              <ul style="margin:0; padding-left:18px;" id="c_free"></ul>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SPELLS -->
    <section class="panel" id="tab-spells" data-tabpanel data-active="false" role="tabpanel" aria-labelledby="tabbtn-spells">
      <div class="panel-header">
        <h2 class="panel-title">Spell Book</h2>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <span class="tag">Prepared: <span class="num" id="sp_prep">14</span></span>
          <span class="tag">Ability: Wisdom</span>
        </div>
      </div>
      <div class="panel-body" id="sp_list"></div>
    </section>

    <!-- INVENTORY -->
    <section class="panel" id="tab-inventory" data-tabpanel data-active="false" role="tabpanel" aria-labelledby="tabbtn-inventory">
      <div class="panel-header">
        <h2 class="panel-title">Inventory</h2>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <span class="tag">Encumbrance: <span id="i_enc">Light</span></span>
          <button class="tag" id="inventoryCurrencyBtn" type="button">Currency: <span id="i_money">â€”</span></button>
        </div>
      </div>

      <div class="panel-body">
        <!-- NEW: Attunement top section -->
        <div class="card" style="margin-bottom:12px;">
          <h4>
            Attunement
            <button class="mini" id="addAttuneBtn" type="button" title="Add attunement slot (edit mode only)" style="display:none;">ï¼‹</button>
          </h4>
          <div class="small">Three slots by default. In edit mode you can add more slots.</div>
          <div style="height:10px"></div>
          <div class="attune" id="attuneList"></div>
        </div>

        <div style="display:grid; grid-template-columns: 1.2fr 0.8fr; gap: 12px;">
          <div class="panel" style="box-shadow:none;">
            <div class="panel-header"><h3 class="panel-title">Equipment</h3></div>
            <div class="panel-body" style="padding:0;">
              <table>
                <thead><tr><th>Item</th><th class="right">Qty</th><th>Notes</th></tr></thead>
                <tbody id="i_items"></tbody>
              </table>
            </div>
          </div>

          <div class="panel" style="box-shadow:none;">
            <div class="panel-header"><h3 class="panel-title">Magic & Special</h3></div>
            <div class="panel-body" id="i_magic"></div>

            <div style="height:12px"></div>

            <div class="panel" style="box-shadow:none;">
              <div class="panel-header"><h3 class="panel-title">Tools / Kits</h3></div>
              <div class="panel-body" id="i_tools"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- NOTES -->
    <section class="panel" id="tab-notes" data-tabpanel data-active="false" role="tabpanel" aria-labelledby="tabbtn-notes">
      <div class="panel-header">
        <h2 class="panel-title">Notes</h2>
        <button class="mini" id="addNoteBtn" type="button">ï¼‹</button>
      </div>
      <div class="panel-body" id="n_notes"></div>
    </section>
  </main>

  <!-- Coin purse dialog (nicer) -->
  <dialog id="coinDialog" aria-label="Coin purse">
    <div class="dlg-head">
      <h3 class="dlg-title">Coin Purse</h3>
      <button class="icon-btn" id="coinClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div class="row">
        <div class="small">Total value</div>
        <div style="font-weight:950; font-size:18px;">
          <span id="coinTotal" class="num">â€”</span>
          <span class="muted" style="font-size:12px; font-weight:900;">gp</span>
        </div>
      </div>

      <div class="coin-grid" id="coinCards"></div>

      <div style="height:10px"></div>

      <div class="card" id="customCurrencyPanel" style="display:none;">
        <h4>Custom Currency</h4>
        <div class="small">Add or remove custom coin types while in edit mode.</div>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:10px; margin-top:10px;">
          <input class="select" id="customCoinName" placeholder="Name" />
          <input class="select" id="customCoinKey" placeholder="Code (e.g. tc)" />
          <input class="select" id="customCoinValue" type="number" step="0.01" min="0" placeholder="gp value" />
          <input class="select" id="customCoinIcon" placeholder="Icon URL (optional)" />
          <button class="btn primary" id="addCustomCoinBtn" type="button">Add</button>
        </div>
        <div style="height:10px"></div>
        <div id="customCoinList"></div>
      </div>

      <div class="small">
        Values: pp=10gp, gp=1gp, ep=0.5gp, sp=0.1gp, cp=0.01gp.
      </div>
    </div>
  </dialog>

  <!-- Rest dialog -->
  <dialog id="restDialog" aria-label="Rest options">
    <div class="dlg-head">
      <h3 class="dlg-title">Rest</h3>
      <button class="icon-btn" id="restClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div class="card">
        <div class="small muted">Choose a rest action.</div>
        <div style="height:12px"></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="restShortBtn" type="button">Open Short Rest</button>
          <button class="btn primary" id="restLongBtn" type="button">Apply Long Rest</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Coin adjust dialog -->
  <dialog id="coinAdjustDialog" aria-label="Adjust coin amount">
    <div class="dlg-head">
      <h3 class="dlg-title" id="coinAdjustTitle">Adjust Coin</h3>
      <button class="icon-btn" id="coinAdjustClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div class="card">
        <div class="small muted" id="coinAdjustHint">Update the amount for this coin type.</div>
        <div style="height:12px"></div>
        <div class="row">
          <div class="small">Current</div>
          <div style="font-weight:900;" id="coinAdjustCurrent">0</div>
        </div>
        <div style="height:12px"></div>
        <div class="seg" id="coinAdjustMode" role="group" aria-label="Coin adjustment mode">
          <button type="button" data-coin-mode="set" aria-pressed="true">Set</button>
          <button type="button" data-coin-mode="add" aria-pressed="false">Add</button>
          <button type="button" data-coin-mode="remove" aria-pressed="false">Remove</button>
        </div>
        <div style="height:12px"></div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <input class="select" id="coinAdjustValue" type="number" min="0" step="1" inputmode="numeric" aria-label="Coin amount" />
          <button class="btn primary" id="coinAdjustApply" type="button">Apply</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Attunement detail dialog -->
  <dialog id="attuneDialog" aria-label="Attunement detail">
    <div class="dlg-head">
      <h3 class="dlg-title" id="attuneDialogTitle">Attunement</h3>
      <button class="icon-btn" id="attuneClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div class="card">
        <div class="small muted" id="attuneDialogBrief"></div>
        <div style="height:10px"></div>
        <div id="attuneDialogDetail"></div>
      </div>
    </div>
  </dialog>

  <!-- Status dialog -->
  <dialog id="statusDialog" aria-label="Status and conditions">
    <div class="dlg-head">
      <h3 class="dlg-title">Status</h3>
      <button class="icon-btn" id="statusClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div class="status-layout">
        <div>
          <div class="card">
            <h4>Conditions</h4>
            <div class="small">Click a condition to add it with a duration.</div>
            <div class="cond-list" id="condList"></div>
          </div>

          <div style="height:10px"></div>

          <div class="card">
            <h4>Exhaustion</h4>
            <div class="small">Set exhaustion level (0â€“6). Included in Status display.</div>
            <div style="display:flex; gap:10px; align-items:center; margin-top:8px;">
              <select class="select" id="exhaustSel" aria-label="Exhaustion level">
                <option value="0">0 â€” None</option>
                <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                <option value="4">4</option><option value="5">5</option><option value="6">6</option>
              </select>
            </div>
          </div>
        </div>

        <div class="card">
          <h4>Active Statuses</h4>
          <div class="small">Ordered by shortest remaining duration.</div>
          <div class="status-current" id="currentStatusList"></div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="row">
        <button class="btn danger" id="clearStatusBtn" type="button">Clear All</button>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn" id="cancelStatusBtn" type="button">Close</button>
        </div>
      </div>
    </div>
  </dialog>

  <dialog id="statusAddDialog" aria-label="Add condition duration">
    <div class="dlg-head">
      <h3 class="dlg-title" id="statusAddTitle">Add Condition</h3>
      <button class="icon-btn" id="statusAddClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div class="card">
        <div class="small muted" id="statusAddDesc"></div>
        <div style="height:12px"></div>
        <div class="field" style="justify-content:flex-start;">
          <label style="min-width:90px;">Duration</label>
          <input class="amt" id="statusAddValue" type="number" min="1" value="1" inputmode="numeric" style="width:90px;" />
          <select class="select" id="statusAddUnit" aria-label="Duration unit">
            <option value="turns">Turns</option>
            <option value="seconds">Seconds</option>
            <option value="minutes">Minutes</option>
            <option value="hours">Hours</option>
            <option value="days">Days</option>
            <option value="indefinite">Indefinite</option>
            <option value="permanent">Permanent</option>
          </select>
        </div>
        <div style="height:12px"></div>
        <div style="display:flex; justify-content:flex-end;">
          <button class="btn primary" id="statusAddApply" type="button">Add Status</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Short Rest dialog -->
  <dialog id="shortRestDialog" aria-label="Short rest tools">
    <div class="dlg-head">
      <h3 class="dlg-title">Short Rest</h3>
      <button class="icon-btn" id="shortRestClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div class="card">
        <h4>Hit Dice</h4>
        <div class="small">
          Spend hit dice to heal. Each die heals <strong>roll + Con mod</strong>.
        </div>

        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px;">
          <span class="tag">Die: <span class="num" id="hdDieLabel">d8</span></span>
          <span class="tag">Remaining: <span class="num" id="hdRemain">â€”</span>/<span class="num" id="hdTotal">â€”</span></span>
          <span class="tag">Con Mod: <span class="num" id="hdCon">â€”</span></span>
        </div>

        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px;">
          <label class="small" for="hdSpend">Spend</label>
          <input class="amt" id="hdSpend" type="number" min="0" value="1" inputmode="numeric" />
          <button class="btn primary" id="rollHdBtn" type="button">Roll &amp; Heal</button>
        </div>

        <div class="small" id="hdResult" style="margin-top:10px;"></div>
      </div>

      <div style="height:12px"></div>

      <div class="row">
        <div class="small">Completing the rest applies short-rest resets (example: Wild Shape).</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn" id="shortRestCancel" type="button">Close</button>
          <button class="btn primary" id="completeShortRestBtn" type="button">Complete Short Rest</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Settings dialog -->
  <dialog id="settingsDialog" aria-label="Settings">
    <div class="dlg-head">
      <h3 class="dlg-title">Settings</h3>
      <button class="icon-btn" id="settingsClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div style="font-weight:950;">Theme</div>
      <div class="muted" style="font-size:12px; margin-top:4px;">Choose a palette. Saved to localStorage.</div>

      <div class="radio-row" role="radiogroup" aria-label="Theme selection">
        <label class="radio"><input type="radio" name="theme" value="midnight" /> Midnight</label>
        <label class="radio"><input type="radio" name="theme" value="parchment" /> Parchment</label>
        <label class="radio"><input type="radio" name="theme" value="forest" /> Forest</label>
      </div>

      <div class="toggle">
        <div>
          <strong>Inspiration Edge Glow</strong>
          <div class="muted" style="font-size:12px; margin-top:4px;">When Inspiration is active, show a gold glow around the screen edge.</div>
        </div>
        <label class="switch" for="glowToggle">
          <input id="glowToggle" type="checkbox" />
          <span>Enabled</span>
        </label>
      </div>

      <div class="toggle">
        <div>
          <strong>Wide Screen</strong>
          <div class="muted" style="font-size:12px; margin-top:4px;">Let the sheet expand to full screen width.</div>
        </div>
        <label class="switch" for="wideToggle">
          <input id="wideToggle" type="checkbox" />
          <span>Enabled</span>
        </label>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <h4>Progress Mode</h4>
        <div class="small">Choose milestone or XP progression for the main view.</div>
        <div class="progress-toggle" style="margin-top:10px;">
          <div class="seg" role="group" aria-label="Progress toggle">
            <button id="btnModeMilestone" type="button" aria-pressed="true">Milestone</button>
            <button id="btnModeXP" type="button" aria-pressed="false">XP</button>
          </div>
          <span class="tag" id="progressValue">Milestone</span>
        </div>
      </div>

      <div style="height:12px"></div>

      <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
        <button class="btn" id="resetTheme" type="button">Reset</button>
        <button class="btn primary" id="saveTheme" type="button">Save</button>
      </div>
    </div>
  </dialog>

  <!-- Portrait edit dialog -->
  <dialog id="portraitDialog" aria-label="Edit portrait">
    <div class="dlg-head">
      <h3 class="dlg-title">Portrait</h3>
      <button class="icon-btn" id="portraitClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div class="card">
        <h4>Image URL</h4>
        <div class="small">Paste a new URL. (Only works in edit mode.)</div>
        <div style="display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap;">
          <input class="select" id="portraitUrl" type="url" placeholder="https://..." />
          <button class="btn primary" id="portraitApplyUrl" type="button">Apply</button>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <h4>Crop / Position</h4>
        <div class="small">Use zoom + position to â€œcropâ€ inside the frame.</div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
          <div class="field">
            <label>Zoom</label>
            <div style="display:flex; align-items:center; gap:8px;">
              <input id="pz" type="range" min="1" max="2.2" step="0.01" style="width:160px;">
              <span class="val" id="pzVal">1.00</span>
            </div>
          </div>
          <div class="field">
            <label>Reset</label>
            <button class="btn" id="portraitReset" type="button">Default crop</button>
          </div>
        </div>

        <div class="portrait-preview" id="portraitPreview" aria-label="Portrait position preview">
          <img id="portraitPreviewImg" alt="Portrait preview" />
          <div class="portrait-preview-grid"></div>
        </div>
        <div class="small" style="margin-top:8px;">
          Drag inside the preview to reposition. Position: <strong id="portraitPosLabel">50% / 30%</strong>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
          <button class="btn" id="portraitNudgeUp" type="button">Up</button>
          <button class="btn" id="portraitNudgeDown" type="button">Down</button>
          <button class="btn" id="portraitNudgeLeft" type="button">Left</button>
          <button class="btn" id="portraitNudgeRight" type="button">Right</button>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="row">
        <div class="small">Tip: set Y lower (e.g. 20â€“35%) to keep face higher in frame.</div>
        <button class="btn primary" id="portraitDone" type="button">Done</button>
      </div>
    </div>
  </dialog>

  <!-- Add custom skill dialog -->
  <dialog id="addSkillDialog" aria-label="Add custom skill">
    <div class="dlg-head">
      <h3 class="dlg-title">Add Skill</h3>
      <button class="icon-btn" id="addSkillClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div class="card">
        <h4>Skill Details</h4>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
          <div class="field" style="justify-content:flex-start;">
            <label style="min-width:110px;">Name</label>
            <input id="newSkillName" class="select" placeholder="e.g., Tactics" />
          </div>
          <div class="field" style="justify-content:flex-start;">
            <label style="min-width:110px;">Ability</label>
            <select id="newSkillAbility" class="select"></select>
          </div>
        </div>
        <div class="small" style="margin-top:10px;">Proficiency can be changed later by editing the data model; this template defaults to â€œnoneâ€.</div>
      </div>
      <div style="height:12px"></div>
      <div class="row">
        <button class="btn" id="addSkillCancel" type="button">Cancel</button>
        <button class="btn primary" id="addSkillConfirm" type="button">Add Skill</button>
      </div>
    </div>
  </dialog>

  <!-- Add custom ability dialog -->
  <dialog id="addAbilityDialog" aria-label="Add custom ability">
    <div class="dlg-head">
      <h3 class="dlg-title">Add Ability</h3>
      <button class="icon-btn" id="addAbilityClose" type="button" aria-label="Close">âœ•</button>
    </div>
    <div class="dlg-body">
      <div class="card">
        <h4>Ability Details</h4>
        <div class="small">Creates a new ability score card. (Example: â€œLCKâ€ or â€œSANâ€.)</div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
          <div class="field" style="justify-content:flex-start;">
            <label style="min-width:110px;">Label</label>
            <input id="newAbilityLabel" class="select" placeholder="e.g., LCK" />
          </div>
          <div class="field" style="justify-content:flex-start;">
            <label style="min-width:110px;">Score</label>
            <input id="newAbilityScore" type="number" min="1" value="10" class="select" style="font-family:var(--mono);" />
          </div>
        </div>
      </div>
      <div style="height:12px"></div>
      <div class="row">
        <button class="btn" id="addAbilityCancel" type="button">Cancel</button>
        <button class="btn primary" id="addAbilityConfirm" type="button">Add Ability</button>
      </div>
    </div>
  </dialog>

  <!-- FABs: Lock + Settings -->
  <div class="fab-wrap" aria-label="Quick controls">
    <button class="fab" id="diceFab" type="button" aria-label="Open dice roller" aria-pressed="false" title="Dice Roller">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M4 8.2 12 3l8 5.2v7.6L12 21l-8-5.2V8.2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        <path d="M8.5 9.5h.01M12 12h.01M15.5 14.5h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
    <button class="fab" id="lockFab" type="button" aria-label="Toggle edit lock" aria-pressed="false" title="Unlock to edit">
      <svg id="lockIconClosed" width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M7 11V8a5 5 0 0 1 10 0v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M7 11h10a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
      </svg>
      <svg id="lockIconOpen" width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="display:none;">
        <path d="M17 11V8a5 5 0 0 0-9.7-1.7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M7 11h10a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
      </svg>
    </button>

    <button class="fab" id="settingsFab" type="button" aria-label="Open settings" title="Settings">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M12 15.2a3.2 3.2 0 1 0 0-6.4 3.2 3.2 0 0 0 0 6.4Z" stroke="currentColor" stroke-width="2"/>
        <path d="M19.4 15a8.6 8.6 0 0 0 .1-1l2-1.2-2-3.4-2.2.6c-.5-.4-1-.7-1.6-.9L13.9 6h-3.8L9.3 8.9c-.6.2-1.1.5-1.6.9l-2.2-.6-2 3.4 2 1.2a8.6 8.6 0 0 0 0 2l-2 1.2 2 3.4 2.2-.6c.5.4 1 .7 1.6.9L10.1 22h3.8l.8-2.9c.6-.2 1.1-.5 1.6-.9l2.2.6 2-3.4-2-1.2c.1-.3.1-.7.1-1Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>

  <div class="dice-panel" id="dicePanel" data-open="false" aria-label="Dice roller">
    <div class="dice-head" id="diceDragHandle">
      <div class="note-title">Dice Roller</div>
      <button class="icon-btn" id="diceClose" type="button" aria-label="Close dice roller">âœ•</button>
    </div>
    <div class="dice-body">
      <div class="dice-set-grid" id="diceSetGrid" aria-label="Dice sets">
        <div class="dice-set" data-sides="4">
          <div class="dice-label">d4</div>
          <label class="small" for="diceCount4">#</label>
          <input class="amt dice-count" id="diceCount4" type="number" min="0" value="0" inputmode="numeric" />
          <label class="small" for="diceMod4">Mod</label>
          <input class="amt dice-mod" id="diceMod4" type="number" value="0" inputmode="numeric" />
        </div>
        <div class="dice-set" data-sides="6">
          <div class="dice-label">d6</div>
          <label class="small" for="diceCount6">#</label>
          <input class="amt dice-count" id="diceCount6" type="number" min="0" value="0" inputmode="numeric" />
          <label class="small" for="diceMod6">Mod</label>
          <input class="amt dice-mod" id="diceMod6" type="number" value="0" inputmode="numeric" />
        </div>
        <div class="dice-set" data-sides="8">
          <div class="dice-label">d8</div>
          <label class="small" for="diceCount8">#</label>
          <input class="amt dice-count" id="diceCount8" type="number" min="0" value="0" inputmode="numeric" />
          <label class="small" for="diceMod8">Mod</label>
          <input class="amt dice-mod" id="diceMod8" type="number" value="0" inputmode="numeric" />
        </div>
        <div class="dice-set" data-sides="10">
          <div class="dice-label">d10</div>
          <label class="small" for="diceCount10">#</label>
          <input class="amt dice-count" id="diceCount10" type="number" min="0" value="0" inputmode="numeric" />
          <label class="small" for="diceMod10">Mod</label>
          <input class="amt dice-mod" id="diceMod10" type="number" value="0" inputmode="numeric" />
        </div>
        <div class="dice-set" data-sides="12">
          <div class="dice-label">d12</div>
          <label class="small" for="diceCount12">#</label>
          <input class="amt dice-count" id="diceCount12" type="number" min="0" value="0" inputmode="numeric" />
          <label class="small" for="diceMod12">Mod</label>
          <input class="amt dice-mod" id="diceMod12" type="number" value="0" inputmode="numeric" />
        </div>
        <div class="dice-set" data-sides="20">
          <div class="dice-label">d20</div>
          <label class="small" for="diceCount20">#</label>
          <input class="amt dice-count" id="diceCount20" type="number" min="0" value="1" inputmode="numeric" />
          <label class="small" for="diceMod20">Mod</label>
          <input class="amt dice-mod" id="diceMod20" type="number" value="0" inputmode="numeric" />
        </div>
        <div class="dice-set" data-sides="100">
          <div class="dice-label">d100</div>
          <label class="small" for="diceCount100">#</label>
          <input class="amt dice-count" id="diceCount100" type="number" min="0" value="0" inputmode="numeric" />
          <label class="small" for="diceMod100">Mod</label>
          <input class="amt dice-mod" id="diceMod100" type="number" value="0" inputmode="numeric" />
        </div>
        <div class="dice-set dice-set-custom" data-custom="true">
          <div class="dice-label" id="diceCustomLabel">d?</div>
          <label class="small" for="diceCustomSides">Sides</label>
          <input class="amt dice-sides" id="diceCustomSides" type="number" min="2" value="20" inputmode="numeric" />
          <label class="small" for="diceCountCustom">#</label>
          <input class="amt dice-count" id="diceCountCustom" type="number" min="0" value="0" inputmode="numeric" />
          <label class="small" for="diceModCustom">Mod</label>
          <input class="amt dice-mod" id="diceModCustom" type="number" value="0" inputmode="numeric" />
        </div>
      </div>
      <div class="dice-actions">
        <button class="btn primary" id="diceRollBtn" type="button">Roll</button>
        <button class="btn" id="diceAdvBtn" type="button">Advantage</button>
        <button class="btn" id="diceDisBtn" type="button">Disadvantage</button>
      </div>
      <div class="dice-results">
        <div class="small dice-summary" id="diceSummary">Ready to roll.</div>
        <div class="small" id="diceDetail"></div>
        <div class="dice-history" id="diceHistory"></div>
      </div>
    </div>
  </div>

  <div class="dice-roll-animation" id="diceRollAnimation" aria-hidden="true">
    <span class="dice-cube">ðŸŽ²</span>
    <span class="dice-cube">ðŸŽ²</span>
    <span class="dice-cube">ðŸŽ²</span>
  </div>
  <div class="dice-roll-flash" id="diceRollFlash" aria-hidden="true">
    <div class="dice-roll-flash-inner" id="diceRollFlashText">â€”</div>
  </div>

  <script>
    /**********************************************************************
     * State
     **********************************************************************/
    const PORTRAIT_URL = "https://i.pinimg.com/736x/1d/bc/14/1dbc1450cd029714c234af43363dd87b.jpg";

    const XP_THRESHOLDS = [
      { lvl:1, xp:0 },
      { lvl:2, xp:300 },
      { lvl:3, xp:900 },
      { lvl:4, xp:2700 },
      { lvl:5, xp:6500 },
      { lvl:6, xp:14000 },
      { lvl:7, xp:23000 },
      { lvl:8, xp:34000 },
      { lvl:9, xp:48000 },
      { lvl:10, xp:64000 },
      { lvl:11, xp:85000 },
      { lvl:12, xp:100000 },
      { lvl:13, xp:120000 },
      { lvl:14, xp:140000 },
      { lvl:15, xp:165000 },
      { lvl:16, xp:195000 },
      { lvl:17, xp:225000 },
      { lvl:18, xp:265000 },
      { lvl:19, xp:305000 },
      { lvl:20, xp:355000 }
    ];

    const CONDITIONS = [
      "Blinded","Charmed","Deafened","Frightened","Grappled","Incapacitated",
      "Invisible","Paralyzed","Petrified","Poisoned","Prone","Restrained",
      "Stunned","Unconscious"
    ];

    const CONDITION_DETAILS = {
      Blinded: "A blinded creature canâ€™t see and automatically fails any ability check that requires sight. Attack rolls against it have advantage, and its attack rolls have disadvantage.",
      Charmed: "A charmed creature canâ€™t attack the charmer or target the charmer with harmful abilities or magical effects. The charmer has advantage on social checks to interact with it.",
      Deafened: "A deafened creature canâ€™t hear and automatically fails any ability check that requires hearing.",
      Frightened: "A frightened creature has disadvantage on ability checks and attack rolls while the source of fear is in line of sight, and it canâ€™t willingly move closer to the source.",
      Grappled: "A grappled creatureâ€™s speed becomes 0, and it canâ€™t benefit from bonuses to speed. The condition ends if the grappler is incapacitated or the creature is moved away.",
      Incapacitated: "An incapacitated creature canâ€™t take actions or reactions.",
      Invisible: "An invisible creature is impossible to see without special senses. Attack rolls against it have disadvantage, and its attack rolls have advantage.",
      Paralyzed: "A paralyzed creature is incapacitated and canâ€™t move or speak. It automatically fails Str/Dex saves, attack rolls against it have advantage, and hits are critical within 5 ft.",
      Petrified: "A petrified creature is transformed to stone, is incapacitated, canâ€™t move or speak, is unaware, automatically fails Str/Dex saves, and has resistance to all damage.",
      Poisoned: "A poisoned creature has disadvantage on attack rolls and ability checks.",
      Prone: "A prone creatureâ€™s only movement is to crawl unless it stands up. Attack rolls against it have advantage within 5 ft, otherwise disadvantage.",
      Restrained: "A restrained creatureâ€™s speed becomes 0, attack rolls against it have advantage, its attack rolls have disadvantage, and it has disadvantage on Dex saves.",
      Stunned: "A stunned creature is incapacitated, canâ€™t move, can only speak falteringly, automatically fails Str/Dex saves, and attack rolls against it have advantage.",
      Unconscious: "An unconscious creature is incapacitated, prone, unaware, automatically fails Str/Dex saves, and attacks have advantage; hits are critical within 5 ft."
    };

    const CONDITION_SEVERITY = [
      "Unconscious","Petrified","Paralyzed","Stunned","Restrained","Blinded",
      "Poisoned","Frightened","Charmed","Grappled","Prone","Incapacitated","Invisible","Deafened"
    ];

    const DURATION_UNITS = {
      turns: { label: "turns", seconds: 6 },
      seconds: { label: "seconds", seconds: 1 },
      minutes: { label: "minutes", seconds: 60 },
      hours: { label: "hours", seconds: 3600 },
      days: { label: "days", seconds: 86400 },
      indefinite: { label: "indefinite", seconds: Infinity },
      permanent: { label: "permanent", seconds: Infinity }
    };

    const baseSkills = [
      { name:"Acrobatics",       abil:"dex", custom:false },
      { name:"Animal Handling",  abil:"wis", custom:false },
      { name:"Arcana",           abil:"int", custom:false },
      { name:"Athletics",        abil:"str", custom:false },
      { name:"Deception",        abil:"cha", custom:false },
      { name:"History",          abil:"int", custom:false },
      { name:"Insight",          abil:"wis", custom:false },
      { name:"Intimidation",     abil:"cha", custom:false },
      { name:"Investigation",    abil:"int", custom:false },
      { name:"Medicine",         abil:"wis", custom:false },
      { name:"Nature",           abil:"int", custom:false },
      { name:"Perception",       abil:"wis", custom:false },
      { name:"Performance",      abil:"cha", custom:false },
      { name:"Persuasion",       abil:"cha", custom:false },
      { name:"Religion",         abil:"int", custom:false },
      { name:"Sleight of Hand",  abil:"dex", custom:false },
      { name:"Stealth",          abil:"dex", custom:false },
      { name:"Survival",         abil:"wis", custom:false }
    ];

    const state = {
      name: "Elaria Thornbloom",
      tagline: "Of the order of History",
      race: "Wood Elf",
      classSummary: "Druid 10",
      ac: 16,
      init: +3,
      speed: 35,
      prof: +4,

      hp: { cur: 73, max: 73, temp: 0 },

      inspiration: false,
      status: { conditions: [], exhaustion: 0 },

      coins: { pp: 2, gp: 121, ep: 0, sp: 35, cp: 70 },
      customCurrencies: [],

      hitDice: { total: 10, remaining: 7, die: 8, conMod: 2 },
      wildShape: { max: 2, remaining: 1 },

      abilities: [
        { key:"str", label:"STR", score:10, saveProf:false, custom:false },
        { key:"dex", label:"DEX", score:16, saveProf:false, custom:false },
        { key:"con", label:"CON", score:14, saveProf:false, custom:false },
        { key:"int", label:"INT", score:12, saveProf:false, custom:false },
        { key:"wis", label:"WIS", score:15, saveProf:true, custom:false },
        { key:"cha", label:"CHA", score:10, saveProf:false, custom:false }
      ],

      skills: [...baseSkills],
      skillProfs: {
        "Perception": 2,
        "Nature": 2,
        "Insight": 2,
        "Survival": 2,
        "Animal Handling": 2,
        "Medicine": 2
      },

      xpMode: "milestone", // "milestone" | "xp"
      xp: 0,
      xpLevel: 1,

      spells: {
        dc: 16,
        atk: +8,
        prepared: 14,
        list: [
          { lvl:"Cantrip", name:"Guidance", note:"Add d4 to ability checks." },
          { lvl:"Cantrip", name:"Produce Flame", note:"Light / ranged fire." },
          { lvl:"1st", name:"Faerie Fire", note:"Outline targets; advantage." },
          { lvl:"2nd", name:"Pass without Trace", note:"+10 Stealth aura." },
          { lvl:"3rd", name:"Call Lightning", note:"Sustained storm damage." },
          { lvl:"4th", name:"Polymorph", note:"Transform creature." },
          { lvl:"5th", name:"Greater Restoration", note:"End major conditions." }
        ]
      },

      combat: {
        actions: [
          { name:"Shillelagh (Quarterstaff)", toHit:"+8", dmg:"1d8+4 bludgeoning", notes:"Wis-based via Shillelagh" },
          { name:"Produce Flame", toHit:"+8", dmg:"2d8 fire", notes:"60 ft range" },
          { name:"Entangle", toHit:"DC 16", dmg:"Restrained (save)", notes:"Difficult terrain" }
        ],
        bonus: [
          "Wild Shape â€” transform (if feature allows).",
          "Healing Word â€” bonus action heal (range).",
          "Shillelagh â€” imbue staff/club."
        ],
        reactions: [
          "Opportunity Attack â€” melee attack when a creature leaves reach.",
          "Readied Action â€” reaction to trigger a prepared action."
        ],
        free: [
          "Speak a few words.",
          "Drop an item.",
          "Interact with one object (DM dependent)."
        ]
      },

      inventory: {
        attunements: [
          { item: "Moonstone Charm", notes:"Attuned â€¢ faint warmth near fey crossings", detail:"A polished charm that hums softly near fey crossings. Grants a faint lunar glow in moonlight." },
          { item: "Ring of Warmth", notes:"Attuned â€¢ cold resistance (example)", detail:"Grants resistance to cold damage. Keeps the wearer comfortable in frigid climates." },
          { item: "", notes:"(empty)", detail:"No attunement item slotted." }
        ],
        items: [
          { name:"Quarterstaff", qty: 1, notes:"Focus (wooden staff)" },
          { name:"Leather Armor", qty: 1, notes:"AC baseline" },
          { name:"Explorerâ€™s Pack", qty: 1, notes:"Bedroll, rations, etc." },
          { name:"Herbalism Kit", qty: 1, notes:"Poultices & remedies" }
        ],
        magic: [
          "Cloak of the Grove (flavor) â€” smells faintly of cedar.",
          "Stone charm â€” warms near fey crossings."
        ],
        tools: [
          "Herbalism Kit",
          "Calligrapherâ€™s Supplies"
        ]
      },

      notes: [
        { title:"Travel Prep", body:"Keep a slot for Speak with Animals when traveling." },
        { title:"Fey Signs", body:"Mark fey signs near the old stone bridge." },
        { title:"Debts", body:"Owes a favor to the apothecary in Westhollow." }
      ],

      portrait: {
        url: PORTRAIT_URL,
        zoom: 1.00,
        x: 50,
        y: 30
      },

      settings: {
        theme: "midnight",
        inspGlowEnabled: true,
        wide: false,
        editUnlocked: false
      }
    };

    const diceState = {
      history: []
    };

    /**********************************************************************
     * Helpers
     **********************************************************************/
    const $ = (sel, root=document) => root.querySelector(sel);
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function modFromScore(score){ return Math.floor((score - 10) / 2); }
    function formatSigned(n){ return (n>=0? "+" : "") + n; }
    function escapeHTML(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function normalizeNumberText(s){
      const t = String(s).trim();
      const cleaned = t.replace(/[^\d+\-]/g, "");
      const n = parseInt(cleaned, 10);
      return Number.isFinite(n) ? n : null;
    }

    // currency values in gp
    const DEFAULT_CURRENCIES = [
      { k:"pp", name:"Platinum", val: 10, icon:"https://i.imgur.com/ve9Wxm3.png" },
      { k:"gp", name:"Gold",     val: 1,  icon:"https://i.imgur.com/bbdjD7q.png" },
      { k:"ep", name:"Electrum", val: 0.5, icon:"https://i.imgur.com/kInHPBm.png" },
      { k:"sp", name:"Silver",   val: 0.1, icon:"https://i.imgur.com/WsWriqq.png" },
      { k:"cp", name:"Copper",   val: 0.01, icon:"https://i.imgur.com/szyG7Ec.png" }
    ];
    function getCurrencies(){
      return [...DEFAULT_CURRENCIES, ...(state.customCurrencies || [])];
    }
    function getCurrency(key){
      return getCurrencies().find(c => c.k === key);
    }
    function coinTotalGP(coins){
      let t = 0;
      for (const c of getCurrencies()) t += (coins[c.k] || 0) * c.val;
      return Math.round(t * 100) / 100;
    }

    function getAbilityByKey(key){
      return state.abilities.find(a => a.key === key);
    }

    /**********************************************************************
     * XP
     **********************************************************************/
    function levelFromXP(xp){
      let lvl = 1;
      for (const row of XP_THRESHOLDS){
        if (xp >= row.xp) lvl = row.lvl;
      }
      return lvl;
    }
    function renderXPBox(){
      const xp = Math.max(0, state.xp|0);
      const rawLevel = parseInt($("#mainTotalLevel").textContent, 10);
      const lvl = clamp(Number.isFinite(rawLevel) ? rawLevel : state.xpLevel || 1, 1, 20);
      state.xpLevel = lvl;
      const nextRow = XP_THRESHOLDS.find(r => r.lvl === Math.min(20, lvl + 1));
      const next = nextRow ? nextRow.xp : XP_THRESHOLDS[XP_THRESHOLDS.length - 1].xp;
      const toNext = Math.max(0, next - xp);

      $("#xpCurrent").value = xp;
      $("#xpLevel").textContent = lvl;
      $("#xpNext").textContent = next;
      $("#xpToNext").textContent = toNext;

      $("#xpLevelUpBtn").style.display = nextRow && xp >= nextRow.xp ? "inline-flex" : "none";
    }
    function applyXPMode(){
      const isXP = state.xpMode === "xp";
      $("#xpCard").style.display = isXP ? "block" : "none";
      $("#progressValue").textContent = isXP ? "XP" : "Milestone";
      $("#btnModeMilestone").setAttribute("aria-pressed", isXP ? "false" : "true");
      $("#btnModeXP").setAttribute("aria-pressed", isXP ? "true" : "false");
      if (isXP) renderXPBox();
    }

    /**********************************************************************
     * Status
     **********************************************************************/
    function getActiveStatusList(){
      return getStatusEntries()
        .sort((a, b)=> a.remaining - b.remaining)
        .map(entry => entry.label);
    }
    function getStatusEntries(){
      const list = state.status.conditions.map((c)=>({
        name: c.name,
        duration: formatStatusDuration(c),
        label: `${c.name}${formatStatusDuration(c) ? ` (${formatStatusDuration(c)})` : ""}`,
        remaining: getStatusRemainingValue(c)
      }));
      if (state.status.exhaustion > 0){
        list.push({
          name: `Exhaustion ${state.status.exhaustion}`,
          duration: "permanent",
          label: `Exhaustion ${state.status.exhaustion}`,
          remaining: Infinity
        });
      }
      return list;
    }
    function formatStatusDuration(status){
      const unit = status.durationUnit || "indefinite";
      if (unit === "indefinite" || unit === "permanent") return DURATION_UNITS[unit].label;
      const value = status.durationValue || 0;
      const label = DURATION_UNITS[unit]?.label || unit;
      return `${value} ${label}`;
    }
    function getStatusRemainingValue(status){
      const unit = status.durationUnit || "indefinite";
      if (unit === "indefinite" || unit === "permanent") return Infinity;
      const seconds = DURATION_UNITS[unit]?.seconds ?? 0;
      const value = status.durationValue || 0;
      return value * seconds;
    }
    function summarizeStatus(active){
      if (!active.length) return "None";
      return active[0];
    }
    function getMostSeriousStatus(){
      if (!state.status.conditions.length){
        return state.status.exhaustion > 0 ? `Exhaustion ${state.status.exhaustion}` : "None";
      }
      const order = new Map(CONDITION_SEVERITY.map((name, idx)=>[name, idx]));
      const sorted = [...state.status.conditions].sort((a, b)=>{
        const aRank = order.has(a.name) ? order.get(a.name) : CONDITION_SEVERITY.length;
        const bRank = order.has(b.name) ? order.get(b.name) : CONDITION_SEVERITY.length;
        return aRank - bRank;
      });
      return sorted[0]?.name || "None";
    }
    function getToolbarStatusLabel(){
      const entries = getStatusEntries();
      if (!entries.length) return "None";
      const primary = state.status.conditions.length
        ? getMostSeriousStatus()
        : `Exhaustion ${state.status.exhaustion}`;
      if (entries.length > 1){
        return `${primary} +${entries.length - 1}`;
      }
      return primary;
    }
    function renderCurrentStatusList(){
      const list = $("#currentStatusList");
      if (!list) return;
      const entries = getStatusEntries().sort((a, b)=> a.remaining - b.remaining);
      if (!entries.length){
        list.innerHTML = `<div class="small muted">No active statuses.</div>`;
        return;
      }
      list.innerHTML = entries.map(entry => `
        <div class="status-item">
          <div class="name">${escapeHTML(entry.name)}</div>
          <div class="meta">${escapeHTML(entry.duration || "")}</div>
        </div>
      `).join("");
    }
    function normalizeStatusConditions(){
      if (!Array.isArray(state.status.conditions)) state.status.conditions = [];
      if (state.status.conditions.length && typeof state.status.conditions[0] === "string"){
        state.status.conditions = state.status.conditions.map((name)=>({
          name,
          durationUnit: "indefinite",
          durationValue: null,
          addedAt: Date.now()
        }));
      } else {
        state.status.conditions = state.status.conditions.map((cond)=>({
          name: cond.name || "Unknown",
          durationUnit: cond.durationUnit || "indefinite",
          durationValue: cond.durationUnit === "indefinite" || cond.durationUnit === "permanent" ? null : (cond.durationValue ?? 1),
          addedAt: cond.addedAt || Date.now()
        }));
      }
    }

    /**********************************************************************
     * Dice Roller
     **********************************************************************/
    let diceDrag = null;
    function toggleDicePanel(open){
      const panel = $("#dicePanel");
      const next = open ?? panel.dataset.open !== "true";
      panel.dataset.open = next ? "true" : "false";
      $("#diceFab").setAttribute("aria-pressed", next ? "true" : "false");
    }
    function renderDiceHistory(){
      const history = $("#diceHistory");
      history.innerHTML = diceState.history.length
        ? diceState.history.map(item => `<div class="dice-history-item">${item}</div>`).join("")
        : `<div class="dice-history-item">No rolls yet.</div>`;
    }
    function updateDiceCustomLabel(){
      const value = parseInt($("#diceCustomSides").value, 10);
      const label = Number.isFinite(value) && value > 1 ? `d${value}` : "d?";
      $("#diceCustomLabel").textContent = label;
    }
    function getDiceSets(){
      const sets = [];
      document.querySelectorAll("#diceSetGrid .dice-set").forEach((row)=>{
        const isCustom = row.dataset.custom === "true";
        const sidesInput = isCustom ? $("#diceCustomSides") : null;
        const sidesValue = isCustom ? parseInt(sidesInput.value, 10) : parseInt(row.dataset.sides, 10);
        const sides = Number.isFinite(sidesValue) ? sidesValue : 0;
        const count = Math.max(0, parseInt(row.querySelector(".dice-count").value, 10) || 0);
        const mod = parseInt(row.querySelector(".dice-mod").value, 10) || 0;
        if (count > 0 && sides > 1){
          sets.push({
            sides,
            count,
            mod,
            label: `d${sides}`
          });
        }
      });
      return sets;
    }
    function formatRollSpan(value, sides, chosen, showChoice){
      const classes = ["dice-roll"];
      if (value === sides) classes.push("is-max");
      if (value === 1) classes.push("is-min");
      if (showChoice && !chosen) classes.push("is-unused");
      if (chosen) classes.push("is-chosen");
      return `<span class="${classes.join(" ")}">${value}</span>`;
    }
    function toggleDiceAnimation(){
      const animation = $("#diceRollAnimation");
      animation.dataset.active = "false";
      void animation.offsetWidth;
      animation.dataset.active = "true";
      setTimeout(()=>{ animation.dataset.active = "false"; }, 900);
    }
    function flashDiceResult(total, allMax, allMin){
      const flash = $("#diceRollFlash");
      const text = $("#diceRollFlashText");
      text.textContent = total;
      text.classList.toggle("is-max", allMax);
      text.classList.toggle("is-min", allMin);
      flash.dataset.active = "false";
      void flash.offsetWidth;
      flash.dataset.active = "true";
      setTimeout(()=>{ flash.dataset.active = "false"; }, 2600);
    }
    function rollDice(mode="normal"){
      const sets = getDiceSets();
      if (!sets.length){
        $("#diceSummary").textContent = "Select at least one dice set to roll.";
        $("#diceSummary").classList.remove("is-max", "is-min");
        $("#diceDetail").textContent = "";
        return;
      }
      const modeLabel = mode === "adv" ? "Advantage" : mode === "dis" ? "Disadvantage" : "Roll";
      const setLabels = [];
      const detailRows = [];
      let grandTotal = 0;
      let allMax = true;
      let allMin = true;
      for (const set of sets){
        const rollsHtml = [];
        let setTotal = 0;
        for (let i = 0; i < set.count; i++){
          if (mode === "adv" || mode === "dis"){
            const rollA = 1 + Math.floor(Math.random() * set.sides);
            const rollB = 1 + Math.floor(Math.random() * set.sides);
            const chosen = mode === "adv" ? Math.max(rollA, rollB) : Math.min(rollA, rollB);
            setTotal += chosen;
            allMax = allMax && chosen === set.sides;
            allMin = allMin && chosen === 1;
            const first = formatRollSpan(rollA, set.sides, rollA === chosen, true);
            const second = formatRollSpan(rollB, set.sides, rollB === chosen, true);
            rollsHtml.push(`<span class="dice-roll-group">[${first}, ${second}]</span>`);
          } else {
            const roll = 1 + Math.floor(Math.random() * set.sides);
            setTotal += roll;
            allMax = allMax && roll === set.sides;
            allMin = allMin && roll === 1;
            rollsHtml.push(formatRollSpan(roll, set.sides, true, false));
          }
        }
        setTotal += set.mod;
        grandTotal += setTotal;
        const modLabel = set.mod ? (set.mod > 0 ? `+${set.mod}` : `${set.mod}`) : "";
        const setLabel = `${set.count}d${set.sides}${modLabel}`;
        setLabels.push(setLabel);
        detailRows.push(`
          <div class="dice-detail-row">
            <div class="dice-detail-label">${escapeHTML(setLabel)}</div>
            <div class="dice-detail-rolls">${rollsHtml.join(" ")}</div>
            <div class="dice-detail-total">= ${setTotal}</div>
          </div>
        `);
      }
      const summaryText = `${modeLabel}: ${setLabels.join(" + ")} = ${grandTotal}`;
      const summaryEl = $("#diceSummary");
      summaryEl.textContent = summaryText;
      summaryEl.classList.toggle("is-max", allMax);
      summaryEl.classList.toggle("is-min", allMin);
      $("#diceDetail").innerHTML = detailRows.join("");
      const historyHtml = `
        <div class="dice-history-summary ${allMax ? "is-max" : allMin ? "is-min" : ""}">${escapeHTML(summaryText)}</div>
        <div class="dice-history-rolls">${detailRows.join("")}</div>
      `;
      diceState.history.unshift(historyHtml.trim());
      diceState.history = diceState.history.slice(0, 10);
      renderDiceHistory();
      toggleDiceAnimation();
      flashDiceResult(grandTotal, allMax, allMin);
    }
    function startDiceDrag(e){
      if (e.button !== 0) return;
      const panel = $("#dicePanel");
      const rect = panel.getBoundingClientRect();
      e.preventDefault();
      diceDrag = {
        pointerId: e.pointerId,
        offsetX: e.clientX - rect.left,
        offsetY: e.clientY - rect.top
      };
      panel.style.left = `${rect.left}px`;
      panel.style.top = `${rect.top}px`;
      panel.style.right = "auto";
      panel.style.bottom = "auto";
      panel.setPointerCapture(e.pointerId);
    }
    function moveDiceDrag(e){
      if (!diceDrag || diceDrag.pointerId !== e.pointerId) return;
      const panel = $("#dicePanel");
      const maxX = window.innerWidth - panel.offsetWidth;
      const maxY = window.innerHeight - panel.offsetHeight;
      const x = clamp(e.clientX - diceDrag.offsetX, 10, Math.max(10, maxX - 10));
      const y = clamp(e.clientY - diceDrag.offsetY, 10, Math.max(10, maxY - 10));
      panel.style.left = `${x}px`;
      panel.style.top = `${y}px`;
    }
    function endDiceDrag(e){
      if (!diceDrag || diceDrag.pointerId !== e.pointerId) return;
      const panel = $("#dicePanel");
      panel.releasePointerCapture(e.pointerId);
      diceDrag = null;
    }

    /**********************************************************************
     * Rendering
     **********************************************************************/
    function applyInspirationGlow(){
      const enabled = !!state.settings.inspGlowEnabled;
      const on = state.inspiration && enabled;
      document.body.setAttribute("data-insp-glow", on ? "on" : "off");
    }

    function applyWide(){
      document.body.setAttribute("data-wide", state.settings.wide ? "on" : "off");
    }

    function fitTextToLines(el, baseSize, minSize, lines){
      if (!el) return;
      el.style.fontSize = `${baseSize}px`;
      const computed = getComputedStyle(el);
      const lineHeight = parseFloat(computed.lineHeight);
      const baseLineHeight = Number.isFinite(lineHeight) ? lineHeight / baseSize : 1.2;
      let size = baseSize;
      let maxHeight = baseLineHeight * size * lines;
      while (el.scrollHeight > maxHeight + 1 && size > minSize){
        size -= 1;
        el.style.fontSize = `${size}px`;
        maxHeight = baseLineHeight * size * lines;
      }
    }
    function fitTopbarText(){
      fitTextToLines($("#tb_name"), 34, 18, 2);
      fitTextToLines($("#tb_sub"), 14, 10, 2);
    }

    function renderTopbar(){
      $("#tb_name").textContent = state.name;
      $("#tb_sub").textContent = `${state.race} â€¢ ${state.classSummary}`;
      $("#tb_ac").textContent = state.ac;
      $("#tb_init").textContent = formatSigned(state.init);
      $("#tb_speed").textContent = state.speed;
      $("#tb_pb").textContent = formatSigned(state.prof);

      const total = coinTotalGP(state.coins);
      const rounded = Math.round(total);
      $("#tb_money_total").textContent = `${rounded} gp`;
      $("#i_money").textContent = `${rounded} gp`;
      const goldIcon = getCurrency("gp")?.icon;
      if (goldIcon){
        $("#tb_money_icon").src = goldIcon;
      }

      $("#tb_insp").textContent = state.inspiration ? "Yes" : "No";
      $("#inspBtn").setAttribute("aria-pressed", state.inspiration ? "true" : "false");
      applyInspirationGlow();

      const active = getActiveStatusList();
      $("#tb_status").textContent = getToolbarStatusLabel();
      $("#statusTooltipText").textContent = active.length ? active.join(", ") : "None";
      fitTopbarText();
      renderCurrentStatusList();

      // main quickstats mirror
      $("#m_hp_cur").textContent = state.hp.cur;
      $("#m_hp_max").textContent = state.hp.max;
      $("#m_hp_temp").textContent = state.hp.temp>0 ? ` (+${state.hp.temp})` : "";
      $("#m_ac").textContent = state.ac;
      $("#m_init").textContent = formatSigned(state.init);
      $("#m_prof").textContent = formatSigned(state.prof);
      $("#m_spd").textContent = state.speed;
    }

    function renderHP(){
      $("#tb_hp_cur").textContent = state.hp.cur;
      $("#tb_hp_max").textContent = state.hp.max;
      $("#tb_temp_label").textContent = `+${state.hp.temp}`;

      // scaling: total width represents max+temp
      const total = Math.max(1, state.hp.max + state.hp.temp);
      const curW = clamp((state.hp.cur / total) * 100, 0, 100);
      const maxW = clamp((state.hp.max / total) * 100, 0, 100);
      const tempW = clamp((state.hp.temp / total) * 100, 0, 100);

      $("#hpGreen").style.width = `${curW}%`;
      $("#hpTemp").style.left = `${maxW}%`;
      $("#hpTemp").style.width = `${tempW}%`;
      const hpRatio = state.hp.max > 0 ? state.hp.cur / state.hp.max : 0;
      $("#hpGreen").classList.toggle("is-danger", hpRatio <= 0.1);
      $("#hpGreen").classList.toggle("is-warning", hpRatio > 0.1 && hpRatio <= 0.3);
    }

    function renderMain(){
      $("#mainName").textContent = state.name;
      $("#mainTagline").textContent = state.tagline;
      $("#mainSummaryLine").innerHTML = [
        `<span class="tag">${escapeHTML(state.race)}</span>`,
        `<span class="tag">${escapeHTML(state.classSummary)}</span>`
      ].join("");
    }

    function renderPortrait(){
      const img = $("#portraitImg");
      img.src = state.portrait.url;
      img.style.setProperty("--pz", state.portrait.zoom);
      img.style.setProperty("--px", `${state.portrait.x}%`);
      img.style.setProperty("--py", `${state.portrait.y}%`);
      // also set on inline style for object-position
      img.style.objectPosition = `${state.portrait.x}% ${state.portrait.y}%`;
      img.style.transform = `scale(${state.portrait.zoom})`;
      const thumb = $("#tb_portrait");
      if (thumb){
        thumb.src = state.portrait.url;
        thumb.style.setProperty("--px", `${state.portrait.x}%`);
        thumb.style.setProperty("--py", `${state.portrait.y}%`);
        thumb.style.objectPosition = `${state.portrait.x}% ${state.portrait.y}%`;
        thumb.style.transform = "none";
      }
    }

    function updatePortraitPreview(){
      const preview = $("#portraitPreviewImg");
      if (!preview) return;
      preview.src = state.portrait.url;
      preview.style.setProperty("--pz", state.portrait.zoom);
      preview.style.setProperty("--px", `${state.portrait.x}%`);
      preview.style.setProperty("--py", `${state.portrait.y}%`);
      preview.style.objectPosition = `${state.portrait.x}% ${state.portrait.y}%`;
      preview.style.transform = `scale(${state.portrait.zoom})`;
      $("#portraitPosLabel").textContent = `${state.portrait.x}% / ${state.portrait.y}%`;
    }

    function renderAbilities(){
      const grid = $("#abilGrid");
      grid.innerHTML = "";

      const isEditable = state.settings.editUnlocked;
      for (const a of state.abilities){
        const mod = modFromScore(a.score);
        const save = mod + (a.saveProf ? state.prof : 0);

        grid.insertAdjacentHTML("beforeend", `
          <div class="abil-card">
            ${a.custom && isEditable ? `<button class="ability-remove" type="button" data-ability="${escapeHTML(a.key)}">Remove</button>` : ""}
            <div class="abil-head">${escapeHTML(a.label)}</div>
            <div class="abil-box">
              <div class="abil-score">${a.score}</div>
            </div>
            <div class="abil-box" style="padding:10px 10px;">
              <div class="abil-subk">MOD</div>
              <div class="abil-subv">${formatSigned(mod)}</div>
            </div>
            <div style="display:flex; justify-content:center;">
              <span class="save-pill ${a.saveProf ? "pro":""} ${isEditable ? "is-editable":""}" data-ability="${escapeHTML(a.key)}" role="button" aria-pressed="${a.saveProf ? "true" : "false"}">
                SAVING THROW ${formatSigned(save)}
              </span>
            </div>
          </div>
        `);
      }

      renderSkills();
      populateAbilityDropdowns();
    }

    function renderSkills(){
      const cols = [[],[],[]];
      state.skills.forEach((s,i)=> cols[i%3].push(s));

      $("#skillsGrid").innerHTML = cols.map(col => `
        <div class="skill-col">
          ${col.map(s => renderSkillRow(s)).join("")}
        </div>
      `).join("");
    }

    function renderSkillRow(skill){
      const abil = getAbilityByKey(skill.abil) || getAbilityByKey("int");
      const base = modFromScore(abil.score);
      const level = state.skillProfs[skill.name] ?? 0;
      const isEditable = state.settings.editUnlocked;

      let bonus = base;
      if (level === 1) bonus += Math.floor(state.prof / 2);
      if (level === 2) bonus += state.prof;
      if (level === 3) bonus += state.prof * 2;

      return `
        <div class="skill-row">
          <div class="skill-left">
            <button class="dot-btn" type="button" data-skill="${escapeHTML(skill.name)}" aria-label="Toggle proficiency for ${escapeHTML(skill.name)}">
              <span class="dot ${level===1?"fill": level>=2?"gold":""}" style="${level===3 ? "box-shadow:0 0 0 2px rgba(216,192,138,0.22) inset;" : ""}"></span>
            </button>
            <span class="skill-name">${escapeHTML(skill.name)}</span>
          </div>
          <div class="skill-mid">${escapeHTML(abil.label)}</div>
          <div class="skill-right">${formatSigned(bonus)}</div>
          ${skill.custom && isEditable ? `<button class="skill-remove" type="button" data-skill-remove="${escapeHTML(skill.name)}">Remove</button>` : ""}
        </div>
      `;
    }

    function cycleSkillProficiency(name){
      if (!state.settings.editUnlocked) return;
      const current = state.skillProfs[name] ?? 0;
      state.skillProfs[name] = (current + 1) % 4;
      renderAbilities();
    }

    function toggleSaveProficiency(key){
      if (!state.settings.editUnlocked) return;
      const ability = state.abilities.find(a => a.key === key);
      if (!ability) return;
      ability.saveProf = !ability.saveProf;
      renderAbilities();
    }

    function removeCustomSkill(name){
      if (!state.settings.editUnlocked) return;
      state.skills = state.skills.filter(s => s.name !== name);
      delete state.skillProfs[name];
      renderAbilities();
    }

    function removeCustomAbility(key){
      if (!state.settings.editUnlocked) return;
      state.abilities = state.abilities.filter(a => a.key !== key);
      renderAbilities();
    }

    function renderCombat(){
      $("#sp_dc").textContent = state.spells.dc;
      $("#sp_atk").textContent = formatSigned(state.spells.atk);

      $("#c_attacks").innerHTML = state.combat.actions.map(a => `
        <tr>
          <td><strong>${escapeHTML(a.name)}</strong></td>
          <td class="right"><span class="num">${escapeHTML(a.toHit)}</span></td>
          <td>${escapeHTML(a.dmg)}</td>
          <td class="muted">${escapeHTML(a.notes)}</td>
        </tr>
      `).join("");

      $("#c_bonus").innerHTML = state.combat.bonus.map(x => `<li class="muted">${escapeHTML(x)}</li>`).join("");
      $("#c_reactions").innerHTML = state.combat.reactions.map(x => `<li class="muted">${escapeHTML(x)}</li>`).join("");
      $("#c_free").innerHTML = state.combat.free.map(x => `<li class="muted">${escapeHTML(x)}</li>`).join("");
    }

    function renderSpells(){
      $("#sp_prep").textContent = state.spells.prepared;
      const byLvl = new Map();
      for (const sp of state.spells.list){
        if (!byLvl.has(sp.lvl)) byLvl.set(sp.lvl, []);
        byLvl.get(sp.lvl).push(sp);
      }
      $("#sp_list").innerHTML = [...byLvl.entries()].map(([lvl, list]) => `
        <div class="card" style="margin-bottom:12px;">
          <h4>${escapeHTML(lvl)}</h4>
          <table>
            <thead><tr><th>Spell</th><th>Notes</th></tr></thead>
            <tbody>
              ${list.map(s => `
                <tr>
                  <td><strong>${escapeHTML(s.name)}</strong></td>
                  <td class="muted">${escapeHTML(s.note)}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      `).join("");
    }

    function renderInventory(){
      $("#i_items").innerHTML = state.inventory.items.map(it => `
        <tr>
          <td><strong>${escapeHTML(it.name)}</strong></td>
          <td class="right"><span class="num">${it.qty}</span></td>
          <td class="muted">${escapeHTML(it.notes)}</td>
        </tr>
      `).join("");

      $("#i_magic").innerHTML = `
        <ul style="margin:0; padding-left:18px;">
          ${state.inventory.magic.map(m => `<li class="muted">${escapeHTML(m)}</li>`).join("")}
        </ul>
      `;
      $("#i_tools").innerHTML = `
        <ul style="margin:0; padding-left:18px;">
          ${state.inventory.tools.map(t => `<li class="muted">${escapeHTML(t)}</li>`).join("")}
        </ul>
      `;

      // attunement list
      $("#attuneList").innerHTML = state.inventory.attunements.map((a, idx) => `
        <div class="attune-row" role="button" tabindex="0" data-attune-index="${idx}">
          <strong class="attune-slot">Slot ${idx+1}</strong>
          <div>${escapeHTML(a.item || "(empty)")}</div>
          <div class="attune-notes">${escapeHTML(a.notes || "")}</div>
        </div>
      `).join("");
    }

    function renderNotes(){
      $("#n_notes").innerHTML = state.notes.map((n, idx) => `
        <div class="note-card" data-note="${idx}">
          <div class="note-title" contenteditable="true" data-note-title="${idx}">${escapeHTML(n.title)}</div>
          <div class="note-body" contenteditable="true" data-note-body="${idx}">${escapeHTML(n.body)}</div>
        </div>
      `).join("");
    }

    function renderCustomCurrencyPanel(){
      const panel = $("#customCurrencyPanel");
      if (!panel) return;
      const canEdit = !!state.settings.editUnlocked;
      panel.style.display = canEdit ? "block" : "none";
      if (!canEdit) return;

      const list = $("#customCoinList");
      list.innerHTML = state.customCurrencies.map(c => `
        <div class="row" style="align-items:center; justify-content:space-between; margin-bottom:8px;">
          <div class="small">${escapeHTML(c.name)} (${escapeHTML(c.k)}) â€¢ ${c.val} gp</div>
          <button class="btn" type="button" data-custom-coin="${escapeHTML(c.k)}">Remove</button>
        </div>
      `).join("");
    }

    function addCustomCurrency(){
      const name = $("#customCoinName").value.trim();
      const key = $("#customCoinKey").value.trim().toLowerCase();
      const val = parseFloat($("#customCoinValue").value);
      const icon = $("#customCoinIcon").value.trim();
      if (!name || !key || !Number.isFinite(val)) return;
      if (getCurrencies().some(c => c.k === key)) return;

      state.customCurrencies.push({ k: key, name, val, icon });
      state.coins[key] = state.coins[key] || 0;
      $("#customCoinName").value = "";
      $("#customCoinKey").value = "";
      $("#customCoinValue").value = "";
      $("#customCoinIcon").value = "";
      renderCoinPurse();
    }

    function removeCustomCurrency(key){
      state.customCurrencies = state.customCurrencies.filter(c => c.k !== key);
      delete state.coins[key];
      renderCoinPurse();
    }

    function addNote(){
      state.notes.push({ title:"New Note", body:"" });
      renderNotes();
    }

    function updateNoteFromElement(el){
      const titleIdx = el.dataset.noteTitle;
      const bodyIdx = el.dataset.noteBody;
      if (titleIdx !== undefined){
        if (!state.notes[titleIdx]) return;
        state.notes[titleIdx].title = el.textContent.trim() || "Untitled";
      }
      if (bodyIdx !== undefined){
        if (!state.notes[bodyIdx]) return;
        state.notes[bodyIdx].body = el.textContent.trim();
      }
    }

    function renderCoinPurse(){
      const total = coinTotalGP(state.coins);
      $("#coinTotal").textContent = total.toFixed(2);

      const cards = getCurrencies().map(c => {
        const amt = state.coins[c.k] || 0;
        const isStandard = DEFAULT_CURRENCIES.some(d => d.k === c.k);
        return `
          <div class="coin-card ${isStandard ? "is-standard" : ""}" data-coin="${c.k}" role="button" tabindex="0" aria-label="Adjust ${escapeHTML(c.name)} coins">
            <div class="coin-left">
              <div class="coin-ic">${c.icon ? `<img src="${c.icon}" alt="${escapeHTML(c.name)}" />` : escapeHTML(c.k.toUpperCase())}</div>
              <div class="coin-meta">
                <div class="coin-name">${escapeHTML(c.name)} (${escapeHTML(c.k)})</div>
              </div>
            </div>
            <div class="coin-amt">${amt}</div>
          </div>
        `;
      }).join("");

      $("#coinCards").innerHTML = cards;
      renderCustomCurrencyPanel();
    }

    /**********************************************************************
     * UI / dialogs
     **********************************************************************/
    function openStatusDialog(){
      normalizeStatusConditions();
      renderConditionList();
      $("#exhaustSel").value = String(state.status.exhaustion);
      renderCurrentStatusList();
      $("#statusDialog").showModal();
    }
    function renderConditionList(){
      const list = $("#condList");
      if (!list || list.dataset.built) return;
      list.innerHTML = CONDITIONS.map(c => `
        <button class="cond-btn" type="button" data-condition="${escapeHTML(c)}">${escapeHTML(c)}</button>
      `).join("");
      list.dataset.built = "1";
    }
    function openStatusAddDialog(name){
      const dialog = $("#statusAddDialog");
      dialog.dataset.condition = name;
      $("#statusAddTitle").textContent = `Add ${name}`;
      $("#statusAddDesc").textContent = CONDITION_DETAILS[name] || "";
      $("#statusAddValue").value = 1;
      $("#statusAddUnit").value = "turns";
      updateStatusAddControls();
      dialog.showModal();
    }
    function updateStatusAddControls(){
      const unit = $("#statusAddUnit").value;
      const valueInput = $("#statusAddValue");
      const isFixed = unit === "indefinite" || unit === "permanent";
      valueInput.style.display = isFixed ? "none" : "inline-flex";
      valueInput.disabled = isFixed;
    }
    function applyStatusAdd(){
      const dialog = $("#statusAddDialog");
      const name = dialog.dataset.condition;
      if (!name) return;
      const unit = $("#statusAddUnit").value;
      const value = unit === "indefinite" || unit === "permanent"
        ? null
        : Math.max(1, parseInt($("#statusAddValue").value, 10) || 1);
      state.status.conditions = state.status.conditions.filter(c => c.name !== name);
      state.status.conditions.push({
        name,
        durationUnit: unit,
        durationValue: value,
        addedAt: Date.now()
      });
      dialog.close();
      renderCurrentStatusList();
      renderTopbar();
    }
    function clearStatus(){
      state.status.conditions = [];
      state.status.exhaustion = 0;
      $("#exhaustSel").value = "0";
      renderCurrentStatusList();
      renderTopbar();
    }

    function openCoinDialog(){
      renderCoinPurse();
      $("#coinDialog").showModal();
    }
    function openCoinAdjustDialog(key){
      const currency = getCurrency(key);
      if (!currency) return;
      const dialog = $("#coinAdjustDialog");
      dialog.dataset.coin = key;
      $("#coinAdjustTitle").textContent = `${currency.name} (${currency.k.toUpperCase()})`;
      $("#coinAdjustCurrent").textContent = String(state.coins[key] ?? 0);
      setCoinAdjustMode("set");
      dialog.showModal();
    }
    function setCoinAdjustMode(mode){
      const dialog = $("#coinAdjustDialog");
      const key = dialog.dataset.coin;
      if (!key) return;
      const currency = getCurrency(key);
      if (!currency) return;
      dialog.dataset.mode = mode;
      dialog.querySelectorAll("[data-coin-mode]").forEach((btn)=>{
        btn.setAttribute("aria-pressed", btn.dataset.coinMode === mode ? "true" : "false");
      });
      const current = state.coins[key] ?? 0;
      const hint = $("#coinAdjustHint");
      if (mode === "add"){
        hint.textContent = `Add ${currency.name} coins.`;
        $("#coinAdjustValue").value = "";
      } else if (mode === "remove"){
        hint.textContent = `Remove ${currency.name} coins.`;
        $("#coinAdjustValue").value = "";
      } else {
        hint.textContent = `Set total ${currency.name} coins.`;
        $("#coinAdjustValue").value = String(current);
      }
      $("#coinAdjustCurrent").textContent = String(current);
    }
    function applyCoinAmount(){
      const dialog = $("#coinAdjustDialog");
      const key = dialog.dataset.coin;
      if (!key) return;
      const mode = dialog.dataset.mode || "set";
      const current = state.coins[key] ?? 0;
      const amount = Math.max(0, parseInt($("#coinAdjustValue").value, 10) || 0);
      let next = current;
      if (mode === "add"){
        next = current + amount;
      } else if (mode === "remove"){
        next = Math.max(0, current - amount);
      } else {
        next = amount;
      }
      state.coins[key] = next;
      $("#coinAdjustCurrent").textContent = String(next);
      renderCoinPurse();
      renderTopbar();
      dialog.close();
    }
    function openAttuneDialog(index){
      const item = state.inventory.attunements[index];
      if (!item) return;
      $("#attuneDialogTitle").textContent = item.item || "Attunement Slot";
      $("#attuneDialogBrief").textContent = item.notes || "";
      $("#attuneDialogDetail").textContent = item.detail || "";
      $("#attuneDialog").showModal();
    }

    // HP
    function damageHP(amount){
      amount = Math.max(0, amount|0);
      if (amount === 0) return;

      const fromTemp = Math.min(state.hp.temp, amount);
      state.hp.temp -= fromTemp;
      amount -= fromTemp;

      state.hp.cur = clamp(state.hp.cur - amount, 0, state.hp.max);
    }
    function healHP(amount){
      amount = Math.max(0, amount|0);
      state.hp.cur = clamp(state.hp.cur + amount, 0, state.hp.max);
    }
    function setTempHP(amount){
      amount = Math.max(0, amount|0);
      state.hp.temp = Math.max(state.hp.temp, amount); // temp doesn't stack
    }

    // Rest
    function openShortRest(){
      $("#hdDieLabel").textContent = `d${state.hitDice.die}`;
      $("#hdTotal").textContent = state.hitDice.total;
      $("#hdRemain").textContent = state.hitDice.remaining;
      $("#hdCon").textContent = formatSigned(state.hitDice.conMod);
      $("#hdSpend").value = "1";
      $("#hdResult").textContent = `Wild Shape uses remaining: ${state.wildShape.remaining}/${state.wildShape.max}`;
      $("#shortRestDialog").showModal();
    }
    function rollHitDice(){
      let spend = parseInt($("#hdSpend").value, 10) || 0;
      spend = clamp(spend, 0, state.hitDice.remaining);
      if (spend === 0){
        $("#hdResult").textContent = "No hit dice spent.";
        return;
      }

      const rolls = [];
      let totalRoll = 0;
      for (let i=0; i<spend; i++){
        const r = 1 + Math.floor(Math.random() * state.hitDice.die);
        rolls.push(r);
        totalRoll += r;
      }
      const heal = totalRoll + (state.hitDice.conMod * spend);
      state.hitDice.remaining -= spend;
      healHP(heal);

      $("#hdRemain").textContent = state.hitDice.remaining;
      $("#hdResult").textContent = `Rolled: [${rolls.join(", ")}] + ${state.hitDice.conMod}Ã—${spend} = ${heal} healed.`;
      renderHP();
      renderTopbar();
    }
    function completeShortRest(){
      state.wildShape.remaining = state.wildShape.max;
      $("#hdResult").textContent = `Short rest complete. Wild Shape reset to ${state.wildShape.remaining}/${state.wildShape.max}.`;
      renderTopbar();
    }
    function applyLongRest(){
      state.hp.cur = state.hp.max;
      state.hp.temp = 0;

      const half = Math.max(1, Math.floor(state.hitDice.total / 2));
      state.hitDice.remaining = Math.min(state.hitDice.total, state.hitDice.remaining + half);

      state.wildShape.remaining = state.wildShape.max;

      renderHP();
      renderTopbar();
    }

    /**********************************************************************
     * Tabs
     **********************************************************************/
    function setActiveTab(tab){
      document.querySelectorAll(".tab").forEach(b=>{
        const active = (b.dataset.tab === tab);
        b.setAttribute("aria-selected", active ? "true" : "false");
      });
      document.querySelectorAll("[data-tabpanel]").forEach(p=>{
        p.dataset.active = (p.id === `tab-${tab}`) ? "true" : "false";
      });
    }

    function setCombatSubtab(which){
      document.querySelectorAll(".subtab").forEach(b=>{
        const active = (b.dataset.subtab === which);
        b.setAttribute("aria-selected", active ? "true" : "false");
      });
      document.querySelectorAll("[data-subpanel]").forEach(p=>{
        p.dataset.active = (p.id === `sub-${which}`) ? "true" : "false";
      });
    }

    /**********************************************************************
     * Settings (theme + glow + wide)
     **********************************************************************/
    function loadSettings(){
      try{
        const raw = localStorage.getItem("dnd_sheet_settings_v3");
        if (raw){
          const s = JSON.parse(raw);
          if (s && typeof s === "object"){
            state.settings.theme = s.theme ?? state.settings.theme;
            state.settings.inspGlowEnabled = (s.inspGlowEnabled ?? state.settings.inspGlowEnabled);
            state.settings.wide = (s.wide ?? state.settings.wide);
            state.settings.editUnlocked = (s.editUnlocked ?? state.settings.editUnlocked);
            state.xpMode = s.xpMode ?? state.xpMode;
            state.xp = s.xp ?? state.xp;
            state.xpLevel = s.xpLevel ?? state.xpLevel;
            state.customCurrencies = Array.isArray(s.customCurrencies) ? s.customCurrencies : state.customCurrencies;
            state.coins = s.coins ?? state.coins;

            // portrait persisted
            if (s.portrait){
              state.portrait.url = s.portrait.url ?? state.portrait.url;
              state.portrait.zoom = s.portrait.zoom ?? state.portrait.zoom;
              state.portrait.x = s.portrait.x ?? state.portrait.x;
              state.portrait.y = s.portrait.y ?? state.portrait.y;
            }
          }
        }
      }catch{}
      applyTheme(state.settings.theme);
      applyWide();
      applyInspirationGlow();
      applyEditMode(state.settings.editUnlocked);
      renderPortrait();
    }

    function saveSettings(){
      localStorage.setItem("dnd_sheet_settings_v3", JSON.stringify({
        theme: state.settings.theme,
        inspGlowEnabled: state.settings.inspGlowEnabled,
        wide: state.settings.wide,
        editUnlocked: state.settings.editUnlocked,
        portrait: { ...state.portrait },
        xpMode: state.xpMode,
        xp: state.xp,
        xpLevel: state.xpLevel,
        coins: state.coins,
        customCurrencies: state.customCurrencies
      }));
    }

    function applyTheme(theme){
      document.documentElement.setAttribute("data-theme", theme);
      state.settings.theme = theme;
      document.querySelectorAll('input[name="theme"]').forEach(r=>{
        r.checked = (r.value === theme);
      });
    }

    function openSettings(){
      applyTheme(state.settings.theme);
      $("#glowToggle").checked = !!state.settings.inspGlowEnabled;
      $("#wideToggle").checked = !!state.settings.wide;
      const isXP = state.xpMode === "xp";
      $("#btnModeMilestone").setAttribute("aria-pressed", isXP ? "false" : "true");
      $("#btnModeXP").setAttribute("aria-pressed", isXP ? "true" : "false");
      $("#progressValue").textContent = isXP ? "XP" : "Milestone";
      $("#settingsDialog").showModal();
    }

    /**********************************************************************
     * Edit mode (lock)
     **********************************************************************/
    function applyEditMode(unlocked){
      state.settings.editUnlocked = !!unlocked;
      document.body.setAttribute("data-edit", unlocked ? "on" : "off");

      $("#lockFab").setAttribute("aria-pressed", unlocked ? "true" : "false");
      $("#lockFab").title = unlocked ? "Lock to stop editing" : "Unlock to edit";
      $("#lockIconClosed").style.display = unlocked ? "none" : "block";
      $("#lockIconOpen").style.display = unlocked ? "block" : "none";

      document.querySelectorAll(".editable").forEach(el=>{
        el.contentEditable = unlocked ? "true" : "false";
        if (!unlocked) el.blur();
      });

      // show/hide edit-only buttons
      $("#addSkillBtn").style.display = unlocked ? "grid" : "none";
      $("#addAbilityBtn").style.display = unlocked ? "grid" : "none";
      $("#addAttuneBtn").style.display = unlocked ? "grid" : "none";

      renderAbilities();
      renderCoinPurse();
      saveSettings();
    }

    function syncEditableToState(){
      const mainName = $("#mainName").textContent.trim();
      if (mainName) state.name = mainName;

      const tag = $("#mainTagline").textContent.trim();
      if (tag) state.tagline = tag;

      const cls = $("#mainClasses").textContent.trim();
      if (cls) state.classSummary = cls;

      const race = $("#mainRace").textContent.trim();
      if (race) state.race = race;

      const mAc = normalizeNumberText($("#m_ac").textContent);
      if (mAc !== null) state.ac = mAc;

      const mInit = normalizeNumberText($("#m_init").textContent);
      if (mInit !== null) state.init = mInit;

      const mSpd = normalizeNumberText($("#m_spd").textContent);
      if (mSpd !== null) state.speed = mSpd;

      const mProf = normalizeNumberText($("#m_prof").textContent);
      if (mProf !== null) state.prof = mProf;

      const mHpMax = normalizeNumberText($("#m_hp_max").textContent);
      if (mHpMax !== null) {
        state.hp.max = Math.max(1, mHpMax);
        state.hp.cur = clamp(state.hp.cur, 0, state.hp.max);
      }
      const mHpCur = normalizeNumberText($("#m_hp_cur").textContent);
      if (mHpCur !== null) state.hp.cur = clamp(mHpCur, 0, state.hp.max);

      const spDc = normalizeNumberText($("#sp_dc").textContent);
      if (spDc !== null) state.spells.dc = spDc;

      const spAtk = normalizeNumberText($("#sp_atk").textContent);
      if (spAtk !== null) state.spells.atk = spAtk;

      renderTopbar();
      renderHP();
      renderMain();
      renderCombat();
      if (state.xpMode === "xp") renderXPBox();
    }

    /**********************************************************************
     * Custom Skills / Abilities
     **********************************************************************/
    function populateAbilityDropdowns(){
      const sel = $("#newSkillAbility");
      if (!sel) return;
      sel.innerHTML = state.abilities.map(a => `<option value="${a.key}">${escapeHTML(a.label)}</option>`).join("");
    }

    function openAddSkill(){
      if (!state.settings.editUnlocked) return;
      $("#newSkillName").value = "";
      populateAbilityDropdowns();
      $("#addSkillDialog").showModal();
    }
    function addSkillConfirm(){
      const name = $("#newSkillName").value.trim();
      const abil = $("#newSkillAbility").value;
      if (!name) return;
      if (state.skills.some(s => s.name.toLowerCase() === name.toLowerCase())) return;

      state.skills.push({ name, abil });
      state.skills[state.skills.length - 1].custom = true;
      state.skillProfs[name] = 0;
      $("#addSkillDialog").close();
      renderAbilities();
    }

    function openAddAbility(){
      if (!state.settings.editUnlocked) return;
      $("#newAbilityLabel").value = "";
      $("#newAbilityScore").value = 10;
      $("#addAbilityDialog").showModal();
    }
    function makeKeyFromLabel(label){
      return label.toLowerCase().replace(/[^a-z0-9]+/g,"").slice(0,10) || ("abil" + Math.floor(Math.random()*9999));
    }
    function addAbilityConfirm(){
      const label = $("#newAbilityLabel").value.trim().toUpperCase();
      const score = clamp(parseInt($("#newAbilityScore").value,10) || 10, 1, 30);
      if (!label) return;

      const key = makeKeyFromLabel(label);
      if (state.abilities.some(a => a.label === label)) return;

      state.abilities.push({ key, label, score, saveProf:false, custom:true });
      $("#addAbilityDialog").close();
      renderAbilities();
    }

    /**********************************************************************
     * Portrait editing
     **********************************************************************/
    let portraitDrag = null;
    function openPortraitEditor(){
      if (!state.settings.editUnlocked) return;
      $("#portraitUrl").value = state.portrait.url;

      $("#pz").value = state.portrait.zoom;
      $("#pzVal").textContent = Number(state.portrait.zoom).toFixed(2);
      updatePortraitPreview();

      $("#portraitDialog").showModal();
    }
    function applyPortraitUrl(){
      const url = $("#portraitUrl").value.trim();
      if (!url) return;
      state.portrait.url = url;
      renderPortrait();
      updatePortraitPreview();
      saveSettings();
    }
    function applyPortraitControls(){
      state.portrait.zoom = parseFloat($("#pz").value);

      $("#pzVal").textContent = Number(state.portrait.zoom).toFixed(2);

      renderPortrait();
      updatePortraitPreview();
      saveSettings();
    }
    function setPortraitPosition(x, y){
      state.portrait.x = clamp(Math.round(x * 10) / 10, 0, 100);
      state.portrait.y = clamp(Math.round(y * 10) / 10, 0, 100);
      renderPortrait();
      updatePortraitPreview();
      saveSettings();
    }
    function nudgePortrait(dx, dy){
      setPortraitPosition(state.portrait.x + dx, state.portrait.y + dy);
    }
    function resetPortraitCrop(){
      state.portrait.zoom = 1.00;
      state.portrait.x = 50;
      state.portrait.y = 30;
      $("#pz").value = state.portrait.zoom;
      applyPortraitControls();
    }
    function startPortraitDrag(e){
      const preview = $("#portraitPreview");
      if (!preview || (e.pointerType === "mouse" && e.button !== 0)) return;
      e.preventDefault();
      const rect = preview.getBoundingClientRect();
      preview.classList.add("is-dragging");
      if (preview.setPointerCapture){
        preview.setPointerCapture(e.pointerId);
      }
      portraitDrag = {
        startX: e.clientX,
        startY: e.clientY,
        originX: state.portrait.x,
        originY: state.portrait.y,
        rectW: rect.width || 1,
        rectH: rect.height || 1,
        pointerId: e.pointerId,
        active: true
      };
    }
    function movePortraitDrag(e){
      if (!portraitDrag) return;
      if (portraitDrag.pointerId !== undefined && e.pointerId !== portraitDrag.pointerId) return;
      e.preventDefault();
      const dx = (e.clientX - portraitDrag.startX) / portraitDrag.rectW * 100;
      const dy = (e.clientY - portraitDrag.startY) / portraitDrag.rectH * 100;
      setPortraitPosition(portraitDrag.originX + dx, portraitDrag.originY + dy);
    }
    function endPortraitDrag(e){
      const preview = $("#portraitPreview");
      if (!portraitDrag) return;
      if (portraitDrag.pointerId !== undefined && e.pointerId !== portraitDrag.pointerId) return;
      preview.classList.remove("is-dragging");
      if (preview && preview.releasePointerCapture && portraitDrag.pointerId !== undefined){
        preview.releasePointerCapture(portraitDrag.pointerId);
      }
      portraitDrag = null;
    }

    /**********************************************************************
     * Attunement slots
     **********************************************************************/
    function addAttunementSlot(){
      if (!state.settings.editUnlocked) return;
      state.inventory.attunements.push({ item:"", notes:"(empty)", detail:"No attunement item slotted." });
      renderInventory();
    }

    /**********************************************************************
     * Init
     **********************************************************************/
    function init(){
      state.xpLevel = levelFromXP(state.xp);
      normalizeStatusConditions();
      // portrait
      renderPortrait();
      $("#portraitImg").addEventListener("click", openPortraitEditor);

      // status
      $("#statusBtn").addEventListener("click", openStatusDialog);
      $("#statusClose").addEventListener("click", ()=> $("#statusDialog").close());
      $("#cancelStatusBtn").addEventListener("click", ()=> $("#statusDialog").close());
      $("#clearStatusBtn").addEventListener("click", clearStatus);
      $("#condList").addEventListener("click", (e)=>{
        const btn = e.target.closest("[data-condition]");
        if (!btn) return;
        openStatusAddDialog(btn.dataset.condition);
      });
      $("#exhaustSel").addEventListener("change", ()=>{
        state.status.exhaustion = parseInt($("#exhaustSel").value, 10) || 0;
        renderCurrentStatusList();
        renderTopbar();
      });
      $("#statusAddClose").addEventListener("click", ()=> $("#statusAddDialog").close());
      $("#statusAddApply").addEventListener("click", applyStatusAdd);
      $("#statusAddUnit").addEventListener("change", updateStatusAddControls);

      // money
      $("#moneyBtn").addEventListener("click", openCoinDialog);
      $("#inventoryCurrencyBtn").addEventListener("click", openCoinDialog);
      $("#coinClose").addEventListener("click", ()=> $("#coinDialog").close());
      $("#coinCards").addEventListener("click", (e)=>{
        const card = e.target.closest(".coin-card");
        if (!card) return;
        openCoinAdjustDialog(card.dataset.coin);
      });
      $("#coinCards").addEventListener("keydown", (e)=>{
        if (e.key !== "Enter" && e.key !== " ") return;
        const card = e.target.closest(".coin-card");
        if (!card) return;
        e.preventDefault();
        openCoinAdjustDialog(card.dataset.coin);
      });
      $("#coinAdjustClose").addEventListener("click", ()=> $("#coinAdjustDialog").close());
      $("#coinAdjustApply").addEventListener("click", applyCoinAmount);
      $("#coinAdjustMode").addEventListener("click", (e)=>{
        const btn = e.target.closest("[data-coin-mode]");
        if (!btn) return;
        setCoinAdjustMode(btn.dataset.coinMode);
      });
      $("#coinAdjustValue").addEventListener("keydown", (e)=>{
        if (e.key === "Enter") applyCoinAmount();
      });
      $("#attuneClose").addEventListener("click", ()=> $("#attuneDialog").close());

      // dice roller
      renderDiceHistory();
      updateDiceCustomLabel();
      $("#diceFab").addEventListener("click", ()=> toggleDicePanel());
      $("#diceClose").addEventListener("click", ()=> toggleDicePanel(false));
      $("#diceRollBtn").addEventListener("click", ()=> rollDice("normal"));
      $("#diceAdvBtn").addEventListener("click", ()=> rollDice("adv"));
      $("#diceDisBtn").addEventListener("click", ()=> rollDice("dis"));
      $("#diceCustomSides").addEventListener("input", updateDiceCustomLabel);
      $("#diceDragHandle").addEventListener("pointerdown", startDiceDrag);
      $("#dicePanel").addEventListener("pointermove", moveDiceDrag);
      $("#dicePanel").addEventListener("pointerup", endDiceDrag);
      $("#dicePanel").addEventListener("pointercancel", endDiceDrag);

      // inspiration
      $("#inspBtn").addEventListener("click", ()=>{
        state.inspiration = !state.inspiration;
        renderTopbar();
      });

      // HP controls
      $("#btnDamage").addEventListener("click", ()=>{
        const amt = parseInt($("#hpAmt").value, 10) || 0;
        damageHP(amt);
        renderHP(); renderTopbar();
      });
      $("#btnHeal").addEventListener("click", ()=>{
        const amt = parseInt($("#hpAmt").value, 10) || 0;
        healHP(amt);
        renderHP(); renderTopbar();
      });
      $("#btnTemp").addEventListener("click", ()=>{
        const amt = parseInt($("#hpAmt").value, 10) || 0;
        setTempHP(amt);
        renderHP(); renderTopbar();
      });

      // rest
      $("#restTabBtn").addEventListener("click", ()=> $("#restDialog").showModal());
      $("#restClose").addEventListener("click", ()=> $("#restDialog").close());
      $("#restShortBtn").addEventListener("click", ()=>{
        $("#restDialog").close();
        openShortRest();
      });
      $("#restLongBtn").addEventListener("click", ()=>{
        $("#restDialog").close();
        applyLongRest();
      });
      $("#shortRestClose").addEventListener("click", ()=> $("#shortRestDialog").close());
      $("#shortRestCancel").addEventListener("click", ()=> $("#shortRestDialog").close());
      $("#rollHdBtn").addEventListener("click", rollHitDice);
      $("#completeShortRestBtn").addEventListener("click", completeShortRest);

      // tabs
      document.querySelectorAll(".tab[data-tab]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          setActiveTab(btn.dataset.tab);
        });
      });

      // combat subtabs
      document.querySelectorAll(".subtab").forEach(btn=>{
        btn.addEventListener("click", ()=> setCombatSubtab(btn.dataset.subtab));
      });

      // progress toggle (milestone/XP)
      $("#btnModeMilestone").addEventListener("click", ()=>{
        state.xpMode = "milestone";
        applyXPMode();
      });
      $("#btnModeXP").addEventListener("click", ()=>{
        state.xpMode = "xp";
        applyXPMode();
      });

      // XP actions
      $("#xpCurrent").addEventListener("change", ()=>{
        state.xp = Math.max(0, parseInt($("#xpCurrent").value,10) || 0);
        renderXPBox();
      });
      $("#xpAddBtn").addEventListener("click", ()=>{
        const add = Math.max(0, parseInt($("#xpAddAmt").value,10) || 0);
        state.xp = Math.max(0, (state.xp|0) + add);
        $("#xpAddAmt").value = 0;
        renderXPBox();
      });
      $("#xpLevelUpBtn").addEventListener("click", ()=>{
        const target = levelFromXP(state.xp);
        state.xpLevel = Math.max(state.xpLevel || 1, target);
        renderXPBox();
      });

      // settings
      $("#settingsFab").addEventListener("click", openSettings);
      $("#settingsClose").addEventListener("click", ()=> $("#settingsDialog").close());
      $("#resetTheme").addEventListener("click", ()=>{
        state.settings.theme = "midnight";
        state.settings.inspGlowEnabled = true;
        state.settings.wide = false;
        applyTheme(state.settings.theme);
        $("#glowToggle").checked = true;
        $("#wideToggle").checked = false;
        applyInspirationGlow();
        applyWide();
        saveSettings();
      });
      $("#saveTheme").addEventListener("click", ()=>{
        saveSettings();
        $("#settingsDialog").close();
      });
      document.querySelectorAll('input[name="theme"]').forEach(r=>{
        r.addEventListener("change", ()=> applyTheme(r.value));
      });
      $("#glowToggle").addEventListener("change", ()=>{
        state.settings.inspGlowEnabled = $("#glowToggle").checked;
        applyInspirationGlow();
        saveSettings();
      });
      $("#wideToggle").addEventListener("change", ()=>{
        state.settings.wide = $("#wideToggle").checked;
        applyWide();
        saveSettings();
      });

      // lock
      $("#lockFab").addEventListener("click", ()=>{
        applyEditMode(!state.settings.editUnlocked);
      });

      // edit-only: add skill/ability/attunement
      $("#addSkillBtn").addEventListener("click", openAddSkill);
      $("#addSkillClose").addEventListener("click", ()=> $("#addSkillDialog").close());
      $("#addSkillCancel").addEventListener("click", ()=> $("#addSkillDialog").close());
      $("#addSkillConfirm").addEventListener("click", addSkillConfirm);

      $("#addAbilityBtn").addEventListener("click", openAddAbility);
      $("#addAbilityClose").addEventListener("click", ()=> $("#addAbilityDialog").close());
      $("#addAbilityCancel").addEventListener("click", ()=> $("#addAbilityDialog").close());
      $("#addAbilityConfirm").addEventListener("click", addAbilityConfirm);

      $("#addAttuneBtn").addEventListener("click", addAttunementSlot);

      // skills/abilities toggle
      $("#skillsGrid").addEventListener("click", (e)=>{
        const remove = e.target.closest("[data-skill-remove]");
        if (remove){
          removeCustomSkill(remove.dataset.skillRemove);
          return;
        }
        const dot = e.target.closest("[data-skill]");
        if (dot){
          cycleSkillProficiency(dot.dataset.skill);
        }
      });
      $("#abilGrid").addEventListener("click", (e)=>{
        const remove = e.target.closest("[data-ability]");
        if (remove && remove.classList.contains("ability-remove")){
          removeCustomAbility(remove.dataset.ability);
          return;
        }
        const save = e.target.closest(".save-pill[data-ability]");
        if (save){
          toggleSaveProficiency(save.dataset.ability);
        }
      });

      // attunement details
      $("#attuneList").addEventListener("click", (e)=>{
        const row = e.target.closest("[data-attune-index]");
        if (!row) return;
        openAttuneDialog(parseInt(row.dataset.attuneIndex, 10));
      });
      $("#attuneList").addEventListener("keydown", (e)=>{
        if (e.key !== "Enter" && e.key !== " ") return;
        const row = e.target.closest("[data-attune-index]");
        if (!row) return;
        e.preventDefault();
        openAttuneDialog(parseInt(row.dataset.attuneIndex, 10));
      });

      // notes
      $("#addNoteBtn").addEventListener("click", addNote);
      $("#n_notes").addEventListener("focusout", (e)=>{
        const el = e.target;
        if (!(el instanceof HTMLElement)) return;
        if (el.dataset.noteTitle !== undefined || el.dataset.noteBody !== undefined){
          updateNoteFromElement(el);
        }
      });

      // custom currencies
      $("#addCustomCoinBtn").addEventListener("click", addCustomCurrency);
      $("#customCoinList").addEventListener("click", (e)=>{
        const btn = e.target.closest("[data-custom-coin]");
        if (!btn) return;
        removeCustomCurrency(btn.dataset.customCoin);
      });

      // portrait dialog
      $("#portraitClose").addEventListener("click", ()=> $("#portraitDialog").close());
      $("#portraitDone").addEventListener("click", ()=> $("#portraitDialog").close());
      $("#portraitApplyUrl").addEventListener("click", applyPortraitUrl);
      $("#portraitReset").addEventListener("click", resetPortraitCrop);
      $("#portraitNudgeUp").addEventListener("click", ()=> nudgePortrait(0, -2));
      $("#portraitNudgeDown").addEventListener("click", ()=> nudgePortrait(0, 2));
      $("#portraitNudgeLeft").addEventListener("click", ()=> nudgePortrait(-2, 0));
      $("#portraitNudgeRight").addEventListener("click", ()=> nudgePortrait(2, 0));
      $("#pz").addEventListener("input", applyPortraitControls);
      $("#portraitPreview").addEventListener("pointerdown", startPortraitDrag);
      $("#portraitPreview").addEventListener("pointermove", movePortraitDrag);
      $("#portraitPreview").addEventListener("pointerup", endPortraitDrag);
      $("#portraitPreview").addEventListener("pointercancel", endPortraitDrag);

      // Editable blur commits to state
      document.addEventListener("focusout", (e)=>{
        const t = e.target;
        if (!state.settings.editUnlocked) return;
        if (t && t.classList && t.classList.contains("editable")){
          syncEditableToState();
        }
      });
      document.addEventListener("keydown", (e)=>{
        if (!state.settings.editUnlocked) return;
        const t = e.target;
        if (!(t instanceof HTMLElement)) return;
        if (!t.classList.contains("editable")) return;
        if (e.key === "Enter"){
          e.preventDefault();
          t.blur();
        }
      });

      // initial
      loadSettings();

      renderTopbar();
      renderHP();
      renderMain();
      renderAbilities();
      renderCombat();
      renderSpells();
      renderInventory();
      renderNotes();
      fitTopbarText();
      window.addEventListener("resize", fitTopbarText);

      // default combat subtab
      setCombatSubtab("actions");
      // default xp mode view
      applyXPMode();
    }

    init();
  </script>
</body>
</html>
